Class CT.BSP.MSG.BL.ActionTypeTmpl Extends %RegisteredObject
{

ClassMethod SaveCheck(Id = "", ActionCode = "", SendMode = "", TmplCode = "")
{
	if ActionCode="" q "-1^消息类型不能为空"
	if SendMode="" q "-1^发送方式不能为空"
	s oid=$o(^CT.BSP.MSG.ActionTypeTmplI("ActSendMode",ActionCode,SendMode,""),-1)
	if (oid'="")&&(oid'=Id) q "-1^此消息类型已经存在此发送方式的模板配置"
	q 1
}

/// Generated by a.util.U5 at 2022-09-29 11:43:58
ClassMethod Save(Id = "", ActionCode = "", SendMode = "", TmplCode = "")
{
	s ck=..SaveCheck(Id , ActionCode , SendMode , TmplCode )
	if ck'=1 q ck
	
	If Id>0{
		Set obj = ##class(CT.BSP.MSG.ActionTypeTmpl).%OpenId(Id)
	}else{
		Set obj = ##class(CT.BSP.MSG.ActionTypeTmpl).%New()
	}
	if $IsObject(obj){
		set obj.ActionCode=ActionCode
		set obj.SendMode=SendMode
		set obj.TmplCode=TmplCode
		set sc = obj.%Save()
		if $$$ISERR(sc){
			Quit "-1^SaveFail"_$system.Status.GetErrorText(sc)
		}
		Set Id = obj.%Id()
		do obj.%Close()
		Set obj = ""
	}else{
		q "对象打开失败Id="_Id	
	}
	q Id
}

/// Generated by a.util.U5 at 2022-09-29 11:43:58
ClassMethod Delete(Id = "")
{
	If Id="" q "-1^IdIsNull"
	set sc = ##class(CT.BSP.MSG.ActionTypeTmpl).%DeleteId(Id)
	if $$$ISERR(sc){
		Quit "-1^DelFail"_$system.Status.GetErrorText(sc)
	}
	Quit Id
}

/// 获取某消息类型关联的消息类型代码
ClassMethod GetActionTmplCode(ActionCode = "", SendMode = "")
{
	if ActionCode="" q ""
	if SendMode="" q ""
	s id=$o(^CT.BSP.MSG.ActionTypeTmplI("ActSendMode",ActionCode,SendMode,""),-1)
	if id>0 {
		s tmplCode=$lg(^CT.BSP.MSG.ActionTypeTmplD(id),4)
		q tmplCode
	}
	q ""
}

/// d ##class(%ResultSet).RunQuery("CT.BSP.MSG.BL.ActionTypeTmpl","Find")
Query Find(pActionCode = "") As websys.Query(CONTAINID = 1, ROWSPEC = "TId,TActionCode,TSendMode,TTmplCode,TActionDesc,TSendModeDesc,TTmplDesc,TTmplContent")
{
}

/// Generated by a.util.U5 at 2022-09-29 11:43:58
ClassMethod FindExecute(ByRef QHandle As %Library.Binary, pActionCode = "") As %Library.Status
{
	s repid=$I(^CacheTemp)
	s ind=1
	s QHandle=$lb(0,repid,0)
	
	d ##class(websys.DHCMessageConfig).BuildSendModeData(.sendModeArr)
	
	
	set TId=""
	for {
		Set TId=$o(^CT.BSP.MSG.ActionTypeTmplD(TId))
		Quit:TId=""
		set g=^CT.BSP.MSG.ActionTypeTmplD(TId)
		set TActionCode=$lg(g,2)
		continue:(pActionCode'="")&&(pActionCode'=TActionCode)
		// 消息类型
		set TActionRowId= $o(^websys.DHCMessageActionTypeI("ActionCode"," "_TActionCode,""))
		continue:(TActionRowId="")
		set TActionDesc=$lg(^websys.DHCMessageActionTypeD(TActionRowId),3)

		set TSendMode=$lg(g,3),TSendModeDesc=""
		
		if TSendMode'="" s TSendModeDesc=$lg($g(sendModeArr(TSendMode)),2)
		
		set TTmplCode=$lg(g,4),TTmplDesc="",TTmplContent=""
		set TTmplId=##class(CT.BSP.MSG.BL.Template).GetTmplId(TTmplCode)
		if TTmplId>0 {
			s TTmplDesc=$lg(^CT.BSP.MSG.TemplateD(TTmplId),3)
			s TTmplContent=$lg(^CT.BSP.MSG.TemplateD(TTmplId),4)
		}
		
		Set ^CacheTemp(repid,ind)=$lb(TId,TActionCode,TSendMode,TTmplCode,TActionDesc,TSendModeDesc,TTmplDesc,TTmplContent)
		set ind=ind+1
	}
	Set QHandle=$lb(0,repid,0) 
	Quit $$$OK
}

}
