/// è¯ºè¯ºç½‘å¼€ç¥¨è¯·æ±‚2.0ç‰ˆæœ¬
/// é€‚ç”¨åŒ»é™¢ï¼ˆæµ™æ±Ÿæ…ˆæ—ï¼Œæµ™æ±ŸèˆŸå±±å¹¿å®‰åŒ»é™¢ï¼‰
Class BILL.EINV.ADP.NNWB Extends %RegisteredObject
{

/// åŠŸèƒ½è¯´æ˜ï¼šæ ¹æ®ä¸åŒçš„ä¸šåŠ¡ç±»å‹åˆ†åˆ«è°ƒç”¨ä¸åŒå¼€å…·æ¥å£æœåŠ¡å¹¶è¿”å›æ¥å£æœåŠ¡ç»“æœ
/// å…¥å‚è¯´æ˜: ObjInvUpDetail    --> äº¤æ˜“å¯¹è±¡
///           ObjInvPrtInfo    	--> å‘ç¥¨å¯¹è±¡
///           InvociePam  		--> å…¶å®ƒå¯¹è±¡(åŒ…æ‹¬ç”µå­ç¥¨æ®å…¥å‚å±æ€§,æ‰©å±•å­—æ®µå±æ€§ç­‰)
/// è¿” å› å€¼ï¼šæˆåŠŸæ ‡å¿—(0 æˆåŠŸ å…¶ä»–å€¼ä»£è¡¨å¤±è´¥)
/// ä¿®æ”¹å±¥å†ï¼šguoyunlong  2022-08-11
/// å…¶    ä»–ï¼šw ##class(BILL.EINV.ADP.NNWA).Invoice("","","") 
ClassMethod Invoice(ObjInvUpDetail As BILL.EINV.DTO.COM.InvUpDetailInfo, ObjInvPrtInfo As BILL.EINV.DTO.COM.InvPrtInfo, InvociePam As BILL.EINV.DTO.COM.InvocieInputPam) As %String
{
	s RtnFlag="0"
    s $zt="InvoiceErr"
	s QueryRtn=..InvoiceQuery(ObjInvUpDetail, ObjInvPrtInfo, InvociePam)  ;æ ¹æ®æµæ°´å·æŸ¥è¯¢æ˜¯å¦å­˜åœ¨å·²ç»å·²ç»å¼€å…·çš„ç”µå­ç¥¨æ®
	q:QueryRtn="0" "0"  ;å­˜åœ¨çš„å¼€å…·è®°å½•çš„æ—¶ è·å–ç»“æœç›´æ¥è¿”å›,æŸ¥è¯¢æˆåŠŸåç›´æ¥è¿”å›
	
	s InputJson=..InvoiceCom(ObjInvUpDetail,ObjInvPrtInfo,InvociePam)  ;ç»„ç»‡å¼€å…·ç”µå­ç¥¨æ®çš„å‚æ•°
	s:InputJson="" InvociePam.ErrMsgInfo="ç»„ç»‡[å¼€å…·ç”µå­ç¥¨æ®]çš„å‚æ•°å¤±è´¥!"
	q:InputJson="" "-1"   ;ç»„ç»‡å…¥å‚å‘ç”Ÿé”™è¯¯
	
	s ServiceCode="issueEInvoiceRecord.do"		;æœåŠ¡åç§°
	s ResOutput=""   ; ##class(BILL.EINV.DTO.FSA.EInvComRes).%New()  ;æ¥æ”¶è¿”å›
	// è°ƒç”¨"å¼€å…·åŒ»ç–—ç”µå­ç¥¨æ®è¯·æ±‚"æ¥å£ï¼Œæ ¹æ®è¿”å›çŠ¶æ€åˆ¤æ–­æ˜¯å¦ç»§ç»­æ“ä½œ
	s SRVRtnFlg=##class(BILL.EINV.BI.NNWB.HTTPRequest).InvoiceRequest(ServiceCode, InputJson, InvociePam, ResOutput,.ObjInvUpDetail)	;è°ƒç”¨å¯Œæ·±httpæ¥å£
	s ObjJsonStream=##class(%GlobalBinaryStream).%New()
	s JsonStr={}.%FromJSON(ResOutput)
	s code=JsonStr.code
	if (code="E0000"){
	  s resultdata=JsonStr.data
	  s ObjInvUpDetail.Xstr1=JsonStr.result.invoiceSerialNum    ;è¯·æ±‚æµæ°´å·
	  ///s ObjInvUpDetail.IUDBusNo =JsonStr.result.invoiceSerialNum    ;è¯·æ±‚æµæ°´å·
	  //s InvStatusRtn=..GetInvStatusOfInvoice(ObjInvUpDetail, ObjInvPrtInfo, InvociePam)  ;è·å–å¼€ç¥¨çŠ¶æ€ä¿¡æ¯
	  //s:InvStatusRtn'="0" RtnFlag="0"
	  //s Errmsg="ç”µå­å‘ç¥¨å¼€ç¥¨æˆåŠŸï¼æŸ¥è¯¢ç¥¨æ®ä¿¡æ¯å¤±è´¥"
	}else{ 
	   //;ä¸ºå¼€ç¥¨å¤±è´¥æˆ–å¼‚å¸¸ï¼Œä¸èƒ½è¿›è¡Œåç»­çš„å¼€ç¥¨çŠ¶æ€æŸ¥è¯¢ã€‚
	   s Errmsg="ç”µå­ç¥¨æ®å¼€å…·å¤±è´¥ï¼"
	   s RtnFlag="-1"
	}		
	q RtnFlag
InvoiceErr
    s RtnFlag="-1"
    b ;$ze
    q RtnFlag
}

/// åŠŸèƒ½è¯´æ˜ï¼šæ•´ç†ç”µå­ç¥¨æ®å¼€å…·ç»„ç»‡å…¥å‚(ä½é™¢ã€é—¨è¯Šå…¬ç”¨)
/// å…¥å‚è¯´æ˜: ObjInvUpDetail    --> äº¤æ˜“å¯¹è±¡
///           ObjInvPrtInfo    	--> å‘ç¥¨å¯¹è±¡
///           InvociePam  		--> å…¶å®ƒå¯¹è±¡(åŒ…æ‹¬ç”µå­ç¥¨æ®å…¥å‚å±æ€§,æ‰©å±•å­—æ®µå±æ€§ç­‰)
/// 		  PayAdmType        --> ç¥¨æ®ä¸šåŠ¡ç±»å‹
/// è¿” å› å€¼ï¼šè¿”å›æ¥å£æ–‡æ¡£å¯¹åº”çš„jsonæ ¼å¼
/// ä¿®æ”¹å±¥å†ï¼šguoyunlong 2022-08-11
/// å…¶    ä»–ï¼šw ##class(BILL.EINV.ADP.NNWA).InvoiceCom("","","","1") 
ClassMethod InvoiceCom(ObjInvUpDetail As BILL.EINV.DTO.COM.InvUpDetailInfo, ObjInvPrtInfo As BILL.EINV.DTO.COM.InvPrtInfo, InvociePam As BILL.EINV.DTO.COM.InvocieInputPam) As %String
{
	s rtn=""
     //ç¥¨æ®ä¿¡æ¯  
    s invobj=##class(BILL.EINV.DTO.NNWB.EInvoiceReq).%New()
	s invobj.buyerName=ObjInvPrtInfo.PatBaseInfo.PatName	///String	Y	ä¼ä¸šåç§°/ä¸ªäºº	100	è´­æ–¹åç§°
    s invobj.buyerTaxNum=""	  ///	String	N		20	è´­æ–¹ç¨å·ï¼ˆä¼ä¸šè¦å¡«ï¼Œä¸ªäººå¯ä¸ºç©ºï¼‰
    s invobj.buyerTel=ObjInvPrtInfo.PatBaseInfo.Mobphone	  ///	String	N	0571-88888888	20	è´­æ–¹ç”µè¯
    s invobj.buyerAddress=ObjInvPrtInfo.PatBaseInfo.Address	  ///	String	N	æ­å·å¸‚	80	è´­æ–¹åœ°å€
    s invobj.buyerAccount=""	  ///	String	ä¸­å›½å·¥å•†é“¶è¡Œ 111111N	100	è´­æ–¹é“¶è¡Œè´¦å·åŠå¼€æˆ·è¡Œåœ°å€
    s invobj.salerTaxNum=""	  ///	String	Y	20	é”€æ–¹ç¨å·ï¼ˆä½¿ç”¨æ²™ç®±ç¯å¢ƒè¯·æ±‚æ—¶æ¶ˆæ¯ä½“å‚æ•°salerTaxNumå’Œæ¶ˆæ¯å¤´å‚æ•°userTax			9		å¡«å†™ğŸ¡ªğŸ¡ª9901999999142ï¼‰
    s invobj.salerTel=""	  ///	String	Y	0571-77777777	20	é”€æ–¹ç”µè¯
    s invobj.salerAddress=""	  ///	String	Y		80	é”€æ–¹åœ°å€
    s invobj.salerAccount=""	  ///	String	N		100	é”€æ–¹é“¶è¡Œè´¦å·å’Œå¼€æˆ·è¡Œåœ°å€			201701051202079		
    s invobj.orderNo=ObjInvUpDetail.IUDBusNo	  ///	String	Y	20	è®¢å•å·ï¼ˆæ¯ä¸ªä¼ä¸šå”¯ä¸€ï¼‰
    s invobj.invoiceDate=$zd(+$h,3)_" "_$zt($P($h,",",2),1)  ///	String	Y2016-01-1ğŸ¡ª 12:ğŸ¡ª0:0020	è®¢å•æ—¶é—´
    s invobj.invoiceNum=""	  ///	String	N	001ğŸ¡ª0865	8å†²çº¢æ—¶å¡«å†™çš„å¯¹åº”è“ç¥¨å‘ç¥¨å·ç ï¼ˆçº¢ç¥¨å¿…å¡«ï¼Œä¸æ»¡8ä½è¯·å·¦è¡¥0ï¼‰
    s invobj.invoiceCode=""	  ///	String	N	1259999156ğŸ¡ª0	12å†²çº¢æ—¶å¡«å†™çš„å¯¹åº”è“ç¥¨å‘ç¥¨ä»£ç ï¼ˆçº¢ç¥¨å¿…å¡«ï¼Œä¸æ»¡12ä½è¯·å·¦è¡¥0ï¼‰
    if ObjInvUpDetail.OriInvUpDetail.IUDBillBatchNo'=""  d
    .s invobj.invoiceCode=ObjInvUpDetail.OriInvUpDetail.IUDBillBatchCode 
    .s invobj.invoiceNum=ObjInvUpDetail.OriInvUpDetail.IUDBillBatchNo
    s invobj.billInfoNo=""	  ///	String	N	16	å‘ç¥¨ä¿¡æ¯è¡¨ç¼–å·ZZZZZZZZZZZZZZZ72Zâ€å­—æ ·ï¼Œå…¶  ä¸­â€œZâ€ä¸ºå¼€å…·çº¢å­—å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨æ‰€éœ€è¦çš„é•¿åº¦ä¸º16ä½ä¿¡æ¯è¡¨ç¼–å·ã€‚
    s invobj.departmentId=""	  ///	String	N	9F7E94ğŸ¡ª9CA8B4 C60A2FFFğŸ¡ªEAğŸ¡ª2	éƒ¨é—¨é—¨åº—idï¼ˆè¯ºè¯ºç³»ç»Ÿä¸­çš„idï¼‰90B088
    s invobj.clerkId=""	  ///	String	N		ğŸ¡ª2	å¼€ç¥¨å‘˜idï¼ˆè¯ºè¯ºç³»ç»Ÿä¸­çš„idï¼‰
    s invobj.remark=""	  ///	String	N	
   /// å¤‡æ³¨ä¿¡æ¯	å†²çº¢æ—¶ï¼Œåœ¨å¤‡æ³¨ä¸­æ³¨æ˜â€œå¯¹åº”æ­£æ•°å‘ç¥¨ä»£ç :XXXXXXXXXå·ç :YYYYYYYYâ€
   /// 2ğŸ¡ª0	æ–‡æ¡ˆï¼Œå…¶ä¸­â€œXâ€ä¸ºå‘ç¥¨ä»£ç ï¼Œâ€œYâ€ä¸ºå‘ç¥¨å·ç ï¼Œå¯ä»¥ä¸å¡«ï¼Œæ¥å£ä¼šè‡ªåŠ¨æ·»åŠ è¯¥æ–‡æ¡ˆï¼›æœºåŠ¨è½¦å‘ç¥¨è“ç¥¨æ—¶å¤‡æ³¨åªèƒ½ä¸ºç©º
   s invobj.checker=InvociePam.UserCode	  ///	String	N	ç‹äº”	20	å¤æ ¸äºº
   s invobj.payee=InvociePam.UserCode	  ///	String	N	æå››	20	æ”¶æ¬¾äºº
   s invobj.clerk=InvociePam.UserCode	  ///	String	Y	å¼ ä¸‰	20	å¼€ç¥¨å‘˜
   s invobj.listFlag="0"	  ///	String	N	0	1	æ¸…å•æ ‡å¿—ï¼šéæ¸…å•:0ï¼›æ¸…å•:1ï¼Œé»˜è®¤:0
   s invobj.listName=""	  ///	String	N	è¯¦è§é”€è´§æ¸…å•	æ¸…å•é¡¹ç›®åç§°ï¼šå¯¹åº”å‘ç¥¨ç¥¨é¢é¡¹ç›®åç§°ï¼ˆli92	stFlagä¸º1æ—¶ï¼Œå¿…å¡«ï¼Œé»˜è®¤ä¸ºâ€œè¯¦è§é”€è´§æ¸…å•â€ï¼‰
   s invobj.pushMode="1"	  ///	String	N	1	æ¨é€æ–¹å¼ï¼š-1,ä¸æ¨é€;0,é‚®ç®±;1,æ‰‹æœºï¼ˆé»˜è®¤2ï¼‰;2,é‚®ç®±ã€æ‰‹æœº
   s invobj.buyerPhone=ObjInvPrtInfo.PatBaseInfo.Mobphone	  ///	String	Y	15858585858	è´­æ–¹æ‰‹æœºï¼ˆpushModeä¸º1æˆ–2æ—¶ï¼Œæ­¤é¡¹ä¸º20å¿…å¡«ï¼‰
   s invobj.email=ObjInvPrtInfo.PatBaseInfo.PatEmail	  ///	String	Y	test@xx.comæ¨é€é‚®ç®±ï¼ˆpushModeä¸º0æˆ–2æ—¶ï¼Œæ­¤é¡¹ä¸º50å¿…å¡«ï¼‰
   s invobj.invoiceType="1"	  ///	String	Y	1	1	å¼€ç¥¨ç±»å‹ï¼š1:è“ç¥¨;2:çº¢ç¥¨
   if ObjInvUpDetail.OriInvUpDetail.IUDBillBatchNo'=""  d
   .s invobj.invoiceType="2"	
   s invobj.invoiceLine="p"	  ///	String	N	p	1	å‘ç¥¨ç§ç±»ï¼šp,æ™®é€šå‘ç¥¨(ç”µç¥¨)(é»˜è®¤);c,æ™®é€š
   s invobj.productOilFlag=""	  ///	String	N	0	1	æˆå“æ²¹æ ‡å¿—ï¼šéæˆå“æ²¹(é»˜è®¤):0;æˆå“æ²¹:1ä»£å¼€æ ‡å¿—ï¼š0éä»£å¼€;1ä»£å¼€ã€‚ä»£å¼€è“ç¥¨æ—¶å¤‡æ³¨è¦æ±‚å¡«å†™æ–‡æ¡ˆï¼šä»£å¼€ä¼ä¸šç¨å·:***,ä»£å¼€ä¼
   s invobj.proxyInvoiceFlag=""	  ///	String	N	0	1	ä¸šåç§°:***ï¼›ä»£å¼€çº¢ç¥¨æ—¶å¤‡æ³¨è¦æ±‚å¡«å†™æ–‡æ¡ˆï¼šå¯¹åº”æ­£æ•°å‘ç¥¨ä»£ç :***å·ç :***ä»£å¼€ä¼ä¸šç¨å·:***ä»£å¼€ä¼ä¸šåç§°:***
   s invobj.callBackUrl=""	  ////// http:127.0.0.1/invoicallBackUrl	String	N	å¼€ç¥¨å®Œæˆ ä¼ å‘ç¥¨ä¿¡æ¯åœ°å€ce/callback/	
   s invobj.extensionNumber=""	  ///	String	N		5	åˆ†æœºå·ï¼ˆåªèƒ½ä¸ºç©ºæˆ–è€…æ•°å­—ï¼‰
   s invobj.terminalNumber=""	  ///String	N		4	ç»ˆç«¯å·ï¼ˆå¼€ç¥¨ç»ˆç«¯å·ï¼Œåªèƒ½ ä¸ºç©ºæˆ–æ•°å­—ï¼‰
	
	//é¡¹ç›®æ¸…å•
	f i=1:1:ObjInvPrtInfo.InvItmDetInfo.Size  d
	.s InvoiceDetailsobj=##class(BILL.EINV.DTO.NNWB.EInvoiceDetails).%New()
    .s InvoiceDetailsobj.goodsCode=ObjInvPrtInfo.InvItmDetInfo.GetAt(i).TarCode	///String	N10905110ğŸ¡ª000001900000å•†å“ç¼–ç ï¼ˆå•†å“ç¨æ”¶åˆ†ç±»ç¼–ç å¼€å‘è€…è‡ªè¡Œå¡«å†™ï¼‰
    .s InvoiceDetailsobj.selfCode=""   ///	String	N1ğŸ¡ª000542600000000020	è‡ªè¡Œç¼–ç ï¼ˆå¯ä¸å¡«ï¼‰
    .s InvoiceDetailsobj.withTaxFlag="0"   ///	String	Y	1	1	å•ä»·å«ç¨æ ‡å¿—ï¼š0:ä¸å«ç¨,1:å«ç¨
    .s InvoiceDetailsobj.price=ObjInvPrtInfo.InvItmDetInfo.GetAt(i).Price   ///	String	N	1	16å•ä»·ï¼Œå½“å•ä»·(price)ä¸ºç©ºæ—¶ï¼Œæ•°é‡(num)ä¹Ÿå¿…é¡»ä¸ºç©ºï¼›(price)ä¸ºç©ºæ—¶ï¼Œå«ç¨é‡‘é¢(ta xIncludedAmount)ã€ä¸å«ç¨é‡‘é¢(taxEx cludedAmount)ã€ç¨é¢(tax)éƒ½ä¸èƒ½ä¸ºç©º
    .s InvoiceDetailsobj.num=ObjInvPrtInfo.InvItmDetInfo.GetAt(i).Qty  ///	String	N	1	16	æ•°é‡ï¼ˆå¼€å…·çº¢ç¥¨æ—¶æ•°é‡ä¸ºè´Ÿæ•°ï¼‰
    .s InvoiceDetailsobj.unit=ObjInvPrtInfo.InvItmDetInfo.GetAt(i).Unit   ///	String	N	å°	20	å•ä½
    .s InvoiceDetailsobj.specType=ObjInvPrtInfo.InvItmDetInfo.GetAt(i).Spec   ///	String	N	y460	40	è§„æ ¼å‹å·
    .s InvoiceDetailsobj.tax="0"   ///	String	N	0.12	ç¨é¢ï¼Œ[ä¸å«ç¨é‡‘é¢] * [ç¨ç‡] = [ç¨é¢]ï¼›ç¨é¢å…è®¸è¯¯å·®ä¸º 0.06ã€‚çº¢ç¥¨ä¸ºè´Ÿã€‚ä¸å«ç¨é‡‘16	é¢ã€ç¨é¢ã€å«ç¨é‡‘é¢ä»»ä½•ä¸€ä¸ªä¸ä¼ æ—¶ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„å•ä»·ï¼Œæ•°é‡è¿›è¡Œè®¡ç®—ï¼Œå¯èƒ½å’Œå®é™…æ•°å€¼å­˜åœ¨è¯¯å·®ï¼Œå»ºè®®éƒ½ä¼ å…¥
    .s InvoiceDetailsobj.taxRate="0"   ///	String	Y	0.1ğŸ¡ª	10	ç¨ç‡ï¼Œæ³¨ï¼šçº¸ç¥¨æ¸…å•çº¢ç¥¨å­˜åœ¨ä¸ºnullçš„æƒ…å†µ
    .s InvoiceDetailsobj.taxExcludedAmount="0"   ///	String	N	0.88 ä¸å«ç¨é‡‘é¢ã€‚çº¢ç¥¨ä¸ºè´Ÿã€‚ä¸å«ç¨é‡‘é¢ã€ç¨é¢ã€å«ç¨é‡‘é¢ä»»ä½•ä¸€ä¸ªä¸ä¼ æ—¶ï¼Œä¼šæ ¹æ®ä¼ 16å…¥çš„å•ä»·ï¼Œæ•°é‡è¿›è¡Œè®¡ç®—ï¼Œå¯èƒ½å’Œå®é™…æ•°å€¼å­˜åœ¨è¯¯å·®ï¼Œå»ºè®®éƒ½ä¼ å…¥
    .s InvoiceDetailsobj.taxIncludedAmount=ObjInvPrtInfo.InvItmDetInfo.GetAt(i).Amt   ///	String	N	1	16	å«ç¨é‡‘é¢ï¼Œ[ä¸å«ç¨é‡‘é¢] + [ç¨é¢] = [å«ç¨é‡‘é¢]ï¼Œçº¢ç¥¨ä¸ºè´Ÿã€‚ä¸å«ç¨é‡‘é¢ã€ç¨é¢ã€å«ç¨é‡‘é¢ä»»ä½•ä¸€ä¸ªä¸ä¼ æ—¶ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„å•ä»·ï¼Œæ•°é‡è¿›è¡Œè®¡ç®—ï¼Œå¯èƒ½å’Œå®é™…æ•°å€¼å­˜åœ¨è¯¯å·®ï¼Œå»ºè®®éƒ½ä¼ å…¥
    .s InvoiceDetailsobj.invoiceLineProperty="0"   ///	String	N	0	1	å‘ç¥¨è¡Œæ€§è´¨ï¼š0,æ­£å¸¸è¡Œ;1,æŠ˜æ‰£è¡Œ;2,è¢«æŠ˜æ‰£è¡Œ
    .s InvoiceDetailsobj.favouredPolicyFlag="0"   ///	String	N	0	1	ä¼˜æƒ æ”¿ç­–æ ‡è¯†ï¼š0,ä¸ä½¿ç”¨;1,ä½¿ç”¨å¢å€¼ç¨ç‰¹æ®Šç®¡ç†ï¼ˆä¼˜æƒ æ”¿ç­–åç§°ï¼‰,å½“favo
    .s InvoiceDetailsobj.favouredPolicyName=""   ///	String	N	0	50uredPolicyFlagä¸º1æ—¶ï¼Œæ­¤é¡¹å¿…å¡«æ‰£é™¤é¢ï¼Œå·®é¢å¾æ”¶æ—¶å¡«å†™ï¼Œç›®å‰åªæ”¯æŒå¡«å†™ä¸€é¡¹ã€‚  æ³¨æ„ï¼šå½“ä¼ 0ã€ç©ºæˆ–å­—æ®µä¸ä¼ æ—¶
    .s InvoiceDetailsobj.zeroRateFlag="1"   ///
    .d invobj.invoiceDetail.Insert(InvoiceDetailsobj)
    /// é›¶ç¨ç‡æ ‡è¯†ï¼šç©º,éé›¶ç¨ç‡;1,å…ç¨;2,ä¸å¾ç¨;ğŸ¡ª,æ™®é€šé›¶ç¨ç‡ï¼›1ã€å½“ç¨ç‡ä¸ºï¼š0%ï¼Œä¸”å¢å€¼ç¨ç‰¹æ®Šç®¡ç†ï¼šä¸ºâ€œå…ç¨â€ï¼Œ é›¶ç¨ç‡æ ‡è¯†	
   /// 0	1	ï¼šéœ€ä¼ â€œ1â€ 2ã€å½“ç¨ç‡ä¸ºï¼š0%ï¼Œä¸”å¢å€¼ç¨ç‰¹æ®Šç®¡ç†ï¼šä¸º"ä¸å¾ç¨" é›¶ç¨ç‡æ ‡è¯†ï¼šéœ€ä¼ â€œ2â€  ğŸ¡ªã€å½“ç¨ç‡ä¸ºï¼š0%ï¼Œä¸”å¢å€¼ç¨ç‰¹æ®Šç®¡ç†ï¼šä¸ºç©º é›¶ç¨ç‡æ ‡è¯†ï¼šéœ€ä¼ â€œğŸ¡ªâ€
	
	s InvoicevehicleInfoobj=##class(BILL.EINV.DTO.NNWB.EInvoicevehicleInfo).%New()
	s InvoicevehicleInfoobj.vehicleType=""   ///è½¦è¾†ç±»å‹");
    s InvoicevehicleInfoobj.brandModel=""   ///å‚ç‰Œå‹å·");
    s InvoicevehicleInfoobj.productOrigin=""   ///åŸäº§åœ°");
    s InvoicevehicleInfoobj.certificate=""   ///åˆæ ¼è¯å·");
    s InvoicevehicleInfoobj.importCerNum=""   ///è¿›å‡ºå£è¯æ˜ä¹¦å·");
    s InvoicevehicleInfoobj.insOddNum=""   ///å•†æ£€å•å·");
    s InvoicevehicleInfoobj.engineNum=""   ///å‘åŠ¨æœºå·ç ");
    s InvoicevehicleInfoobj.vehicleCode=""   ///è½¦è¾†è¯†åˆ«å·ç ");
    s InvoicevehicleInfoobj.intactCerNum=""   ///å®Œç¨è¯æ˜å·ç ");
    s InvoicevehicleInfoobj.tonnage=""   ///å¨ä½");
    s InvoicevehicleInfoobj.maxCapacity=""   ///é™ä¹˜äººæ•°");
    s InvoicevehicleInfoobj.idNumOrgCode=""   ///èº«ä»½è¯å·æˆ–è€…ç»„ç»‡æœºæ„ä»£ç ");
    s InvoicevehicleInfoobj.manufactureName=""   ///ç”Ÿäº§å‚å®¶");
    s invobj.vehicleInfo=InvoicevehicleInfoobj
	//è°ƒç”¨å›ºå®šæ–¹æ³•è¿›è¡Œå¯¹è±¡è½¬Json
	s Stream=##class(%GlobalCharacterStream).%New()
	d ##class(ext.util.JsonObject).ObjectToJSONStream(invobj,.Stream)
	s rtn=Stream.Read()
	q rtn
}

/// åŠŸèƒ½è¯´æ˜ï¼šè°ƒç”¨æœåŠ¡æ¥å£è·å–å¼€å…·æœåŠ¡ç»“æœ(è·å–å·²å¼€ç”µå­ç¥¨æ®çš„å®é™…çŠ¶æ€ä¿¡æ¯)
/// å…¥å‚è¯´æ˜: ObjInvUpDetail    --> äº¤æ˜“å¯¹è±¡
/// è¿” å› å€¼ï¼šè¿”å›æ¥å£æ–‡æ¡£å¯¹åº”çš„jsonæ ¼å¼      
/// ä¿®æ”¹å±¥å†ï¼šguoyunlong  2021-04-10
/// å…¶    ä»–ï¼šw ##class(BILL.EINV.ADP.FSA).GetInvStatusOfInvoice("","","") 
ClassMethod GetInvStatusOfInvoice(ObjInvUpDetail As BILL.EINV.DTO.COM.InvUpDetailInfo, ObjInvPrtInfo As BILL.EINV.DTO.COM.InvPrtInfo, InvociePam As BILL.EINV.DTO.COM.InvocieInputPam) As %String
{
	s RtnFlag="-1"	
	s InputJson="{""bizcode"":"_ObjInvUpDetail.IUDBusNo_",""bizcode"":"_ObjInvUpDetail.IUDBusNo_",""bizcode"":"_ObjInvUpDetail.IUDBusNo_",""bizcode"":"_ObjInvUpDetail.IUDBusNo_",""bizcode"":"_ObjInvUpDetail.IUDBusNo_"}"		;æµæ°´å· 
	s ServiceCode="queryEInvoiceRecord.do"                      ;æ¥å£æœåŠ¡åç§°
	s ReqJsonStr=InputJson										;ä¸šåŠ¡å…¥å‚
	
	s ResOutput=""    ;##class(BILL.EINV.DTO.FSA.EInvoiceRes).%New()    ;æ¥æ”¶è¿”å›
	//è°ƒç”¨è¯ºè¯ºç½‘æ¥å£
	s SRVRtnFlg=##class(BILL.EINV.BI.NNWB.HTTPRequest).InvoiceRequest(ServiceCode, ReqJsonStr, InvociePam, .ResOutput)
	//è·å–è¿”å›æ•°æ®æˆåŠŸåï¼Œæ ¹æ®stateå€¼æ¥åˆ¤æ–­å¼€ç¥¨æ˜¯å¦æˆåŠŸï¼Œå¼€ç¥¨æˆåŠŸåæ‰èƒ½å‘èµ·è·å–ç¥¨æ®æ–‡ä»¶çš„è¯·æ±‚ã€‚
	if (SRVRtnFlg>0){
		s state=ResOutput.data.state  ;å¼€ç¥¨çŠ¶æ€ 1æˆåŠŸï¼Œ0å¤±è´¥
		if (state="1") {
			s ObjInvUpDetail.IUDBillBatchCode=ResOutput.data.einvoicecode       ;ç”µå­ç¥¨æ®ä»£ç 
			s ObjInvUpDetail.IUDBillBatchNo=ResOutput.data.einvoicenumber       ;ç”µå­ç¥¨æ®å·ç 
			s ObjInvUpDetail.IUDCheckCode=ResOutput.data.randomnumber           ;æ ¡éªŒç 
			s ObjInvUpDetail.IUDBillBatchStatus=state                           ;å¼€ç¥¨çŠ¶æ€ 1æˆåŠŸï¼Œ0å¤±è´¥
			s ObjInvUpDetail.Xstr1=ResOutput.data.einvoiceid                    ;ç”µå­ç¥¨æ®ID
			s ObjInvUpDetail.Xstr2=ResOutput.data.einvoicefilename              ;ç”µå­ç¥¨æ®æ–‡ä»¶åç§°
			s ObjInvUpDetail.Xstr3=ResOutput.data.bizcode                       ;ä¸šåŠ¡æµæ°´å·(æœåŠ¡å•†è¿”å›çš„)
			
			s NowDateTimeStr=$h
			s iNowDate=$p(NowDateTimeStr, ",", 1)
			s iNowTime=$p(NowDateTimeStr, ",", 2)
			s ObjInvUpDetail.IUDCreatDate=iNowDate							   ;ç”µå­ç¥¨æ®ç”Ÿæˆæ—¥æœŸ(æœ‰è¿”å›æ—¥æœŸçš„æ—¶å€™ï¼Œä»¥è¿”å›æ—¥æœŸä¸ºå‡†)
			s ObjInvUpDetail.IUDCreatTime=iNowTime							   ;ç”µå­ç¥¨æ®ç”Ÿæˆæ—¶é—´(æœ‰è¿”å›æ—¶é—´çš„æ—¶å€™ï¼Œä»¥è¿”å›æ—¶é—´ä¸ºå‡†)
			s ObjInvUpDetail.IUDUplodeFlag="Y"                                 ;ä¸Šä¼ æ ‡å¿— Y:ä¸Šä¼ æˆåŠŸï¼ŒN:ä¸Šä¼ å¤±è´¥
			s ObjInvUpDetail.IUDResultMeg="ä¸Šä¼ æˆåŠŸ"   						   ;æŸ¥è¯¢çŠ¶æ€ ä¿¡æ¯æ˜¯å¦æˆåŠŸ
			s ObjInvUpDetail.EInvFlg="I"									   ;å‘ç¥¨çŠ¶æ€
			
			s RtnFlag="0"
		}else{
			s tmpErrMsg=ResOutput.msg
			s:tmpErrMsg="" tmpErrMsg="è·å–å¼€ç¥¨çŠ¶æ€ä¿¡æ¯ä¸ºå¤±è´¥çŠ¶æ€["_state_"]"
			s InvociePam.ErrMsgInfo=tmpErrMsg	
		}
	}else{
		s tmpErrMsg=ResOutput.msg
		s:tmpErrMsg="" tmpErrMsg="æŸ¥è¯¢å¼€ç¥¨ç»“æœå¤±è´¥"
		s InvociePam.ErrMsgInfo=tmpErrMsg
	}
	
	
	q RtnFlag
}

/// æŸ¥è¯¢æ¥å£å‚æ•°ç»„ç»‡è°ƒç”¨
///  guoyunlong
///  2022-08-11
ClassMethod InvoiceQuery(ObjInvUpDetail As BILL.EINV.DTO.COM.InvUpDetailInfo, ObjInvPrtInfo As BILL.EINV.DTO.COM.InvPrtInfo, InvociePam As BILL.EINV.DTO.COM.InvocieInputPam) As %String
{
	s RtnFlag=""
	s ReqJsonInput="{""serialNos"":"""_ObjInvUpDetail.Xstr1_""",""orderNos"":"""_ObjInvUpDetail.IUDBusNo_""",""isOfferInvoiceDetail"":"""_0_"""}"
    s ServiceCode="issueEInvoiceRecord.do"		;æœåŠ¡åç§°
	s ResOutput=""   
	// è°ƒç”¨"å¼€å…·åŒ»ç–—ç”µå­ç¥¨æ®è¯·æ±‚"æ¥å£ï¼Œæ ¹æ®è¿”å›çŠ¶æ€åˆ¤æ–­æ˜¯å¦ç»§ç»­æ“ä½œ
	s SRVRtnFlg=##class(BILL.EINV.BI.NNWB.HTTPRequest).InvoiceRequest(ServiceCode, ReqJsonInput, InvociePam, .ResOutput,.ObjInvUpDetail)	;è°ƒç”¨å¯Œæ·±httpæ¥å£
	s ObjJsonStream=##class(%GlobalBinaryStream).%New()
	s JsonStr={}.%FromJSON(ResOutput)
	s code=JsonStr.code
    if (code="E0000"){
	  s ObjInvUpDetail.Xstr1=JsonStr.result.invoiceSerialNum    ;è¯·æ±‚æµæ°´å·
	  ///s ObjInvUpDetail.IUDBusNo =JsonStr.result.invoiceSerialNum    ;è¯·æ±‚æµæ°´å·
	  s ObjInvUpDetail.IUDBillBatchCode=JsonStr.result.invoiceCode       ;ç”µå­ç¥¨æ®ä»£ç 
	  s ObjInvUpDetail.IUDBillBatchNo=JsonStr.result.invoiceNo       ;ç”µå­ç¥¨æ®å·ç 
	  s ObjInvUpDetail.IUDCheckCode=JsonStr.result.checkCode           ;æ ¡éªŒç 
	  s ObjInvUpDetail.IUDBillBatchStatus=JsonStr.result.status                           ;å¼€ç¥¨çŠ¶æ€ 1æˆåŠŸï¼Œ0å¤±è´¥
	  s ObjInvUpDetail.IUDPictureUrl= JsonStr.result.pictureUrl   //JsonStr.result.pdfUrl
	  s ObjInvUpDetail.Xstr1=JsonStr.result.serialNo                    ;ç”µå­ç¥¨æ®ID
	  s ObjInvUpDetail.Xstr2=JsonStr.result.orderNo             ;ç”µå­ç¥¨æ®æ–‡ä»¶åç§°
	  s ObjInvUpDetail.Xstr3=JsonStr.result.pdfUrl                       ;ä¸šåŠ¡æµæ°´å·(æœåŠ¡å•†è¿”å›çš„)	
	  s NowDateTimeStr=$zdt($zdth(JsonStr.result.invoiceTime,-2),3,1)  
	  s iNowDate=$p(NowDateTimeStr, ",", 1)
	  s iNowTime=$p(NowDateTimeStr, ",", 2)
	  s ObjInvUpDetail.IUDCreatDate=iNowDate							   ;ç”µå­ç¥¨æ®ç”Ÿæˆæ—¥æœŸ(æœ‰è¿”å›æ—¥æœŸçš„æ—¶å€™ï¼Œä»¥è¿”å›æ—¥æœŸä¸ºå‡†)
	  s ObjInvUpDetail.IUDCreatTime=iNowTime							   ;ç”µå­ç¥¨æ®ç”Ÿæˆæ—¶é—´(æœ‰è¿”å›æ—¶é—´çš„æ—¶å€™ï¼Œä»¥è¿”å›æ—¶é—´ä¸ºå‡†)
	  s ObjInvUpDetail.IUDUplodeFlag="Y"                                 ;ä¸Šä¼ æ ‡å¿— Y:ä¸Šä¼ æˆåŠŸï¼ŒN:ä¸Šä¼ å¤±è´¥
	  s ObjInvUpDetail.IUDResultMeg="ä¸Šä¼ æˆåŠŸ"   						   ;æŸ¥è¯¢çŠ¶æ€ ä¿¡æ¯æ˜¯å¦æˆåŠŸ
	  s ObjInvUpDetail.EInvFlg="I"									   ;å‘ç¥¨çŠ¶æ€
	  s RtnFlag="0"
	}else{ 
	   //;ä¸ºå¼€ç¥¨å¤±è´¥æˆ–å¼‚å¸¸ï¼Œä¸èƒ½è¿›è¡Œåç»­çš„å¼€ç¥¨çŠ¶æ€æŸ¥è¯¢ã€‚
	   s Errmsg="ç”µå­ç¥¨æ®æŸ¥è¯¢å¤±è´¥ï¼"
	   s RtnFlag="-1"
	}
	q RtnFlag
}

/// /w ##class(BILL.EINV.ADP.NNWB).Test()
ClassMethod Test()
{
	s Obj=##class(%DynamicObject).%New()
	s ObjArry1=##class(%DynamicArray).%New()
	d ObjArry1.%Push(1)
	s Obj.serialNos=ObjArry1
	s ObjArry2=##class(%DynamicArray).%New()
	d ObjArry2.%Push(3)
	s Obj.orderNos=ObjArry2
	s Obj.isOfferInvoiceDetail="0"
	q Obj.%ToJSON()
}

}
