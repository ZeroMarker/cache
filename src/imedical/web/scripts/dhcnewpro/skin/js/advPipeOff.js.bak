/// Description: 管路滑脱报告单
/// Creator: congyue
/// CreateDate: 2017-12-15
var eventtype=""
var RepDate=formatDate(0); //系统的当前日期
$(document).ready(function(){
	if ((recordId=="")){
		var frm = dhcadvdhcsys_getmenuform();
		if (frm) {
			var papmi = frm.PatientID.value;		
	        var adm = frm.EpisodeID.value;
	        if ((papmi=="")||(papmi=="undefined")){
		        papmi="" ;
		    }
	        $.ajax({
			   	   type: "POST",
			       url: url,
			       async: false, //同步
			       data: "action=getPatNo&patID="+papmi,
			       success: function(val){
				      	 papmi=val;
			       }
			    });	
		    EpisodeID=adm;
		    patientID=papmi;
	        InitPatInfo(papmi,adm);//获取病人信息
		}
	}
	$('#OccuLoc').combobox({ 
		//url:'dhcapp.broker.csp?ClassName=web.DHCADVCOMMONPART&MethodName=QueryLocDescCombo',
		mode:'remote'  //,  //必须设置这个属性
	});
	$("#SaveBut").on("click",function(){
		SavePipeReport(0);
	})
	$("#SubmitBut").on("click",function(){
		SavePipeReport(1);
	})
	CheckTimeornum();  //时间校验
	InitPipeReport(recordId);//加载页面信息
	
	
});
//加载报表信息
function InitPipeReport(recordId)
{
	if((recordId=="")||(recordId==undefined)){
		
		$('#OccuLoc').combobox('setValue',LgCtLocDesc);  //发生科室
		$('#RepHospType').val(LgHospDesc); //报告单位
		
		$('#RepUserName').val(LgUserName); //填报人姓名为登录人
		$('#ReportDate').datebox("setValue",RepDate);   //报告日期
		$('#HospPhone').val("64456715");//联系电话
	
	}else{
		//病人信息
		$('#DisMedThingPatName').attr("readonly","readonly"); //病人姓名 
		$('#PatSexinput').attr("readonly","readonly"); //性别
		$('#PatAge').attr("readonly","readonly"); //年龄
		$('#PatMedicalNo').attr("readonly","readonly");  //病案号
		$('#PatAdmDate').datebox({disabled:'true'});  //就诊日期
		$('#PatDiag').attr("readonly","readonly"); //诊断
    $("#from").form('validate')
		
	} 
}
//报告保存
function SavePipeReport(flag)
{
	///保存前,对页面必填项进行检查
	if(!(checkRequired()&&checkother())){
		return;
	}
	SaveReport(flag);
}
//加载报表病人信息
function InitPatInfo(patientID,EpisodeID)
{
	if((patientID=="")&&(EpisodeID=="")){return;}
	$.ajax({
		type: "POST",
		url: url,
		data: "action=getRepPatInfo&PatNo="+patientID+"&EpisodeID="+EpisodeID,
		success: function(val){
	    	var tmp=val.split("^");
			//病人信息
			$('#DisMedThingPatName').val(tmp[1]); //病人姓名
			$('#DisMedThingPatName').attr("readonly","readonly");
			$('#PatSexinput').val(tmp[3]);  //性别
			$('#PatSexinput').attr("readonly","readonly");
			$('#PatAge').val(tmp[4]);  //年龄
			$('#PatAge').attr("readonly","readonly");
			$('#PatMedicalNo').val(tmp[5]); //病案号
			$('#PatMedicalNo').attr("readonly","readonly");
			$('#PatAdmDate').datebox({disabled:'true'});
			$('#PatAdmDate').datebox("setValue",tmp[8]);  //就诊日期
      $('#PatDiag').val(tmp[10]);  //诊断
			$('#PatDiag').attr("readonly","readonly");
      $("#from").form('validate')
		}
	})
}
//检查界面勾选其他，是否填写输入框
function checkother(){
	//患者来源
	var PatOriginoth=0;
	$("input[type=radio][id^='PatOrigin-label']").each(function(){
		if($(this).is(':checked')){
			if ((this.value=="title")&&($("input[name$='.94109']").val()=="")){
				PatOriginoth=-1;
			}
		}
	})
	if(PatOriginoth==-1){
		$.messager.alert("提示:","【患者来源】勾选'其他'，请填写内容！");	
		return false;
	}
	//发现人
	var PipeDiscoverersoth=0;
	$("input[type=radio][id^='PipeDiscoverers']").each(function(){
		if($(this).is(':checked')){
			if ((this.value=="title")&&($("input[name$='.93813']").val()=="")){
				PipeDiscoverersoth=-1;
			}
		}
	})
	if(PipeDiscoverersoth==-1){
		$.messager.alert("提示:","【发现人】勾选'其他人员'，请填写内容！");	
		return false;
	}
	//导管类型 
	var PipeTypeoth=0;
	$("input[type=checkbox][id^='PipeType']").each(function(){
		if($(this).is(':checked')){
			if ((this.value=="title")&&($("input[name$='.93838'][class='lable-input']").val()=="")){
				PipeTypeoth=-1;
			}
		}
	})
	if(PipeTypeoth==-1){
		$.messager.alert("提示:","【导管类型】勾选'其他人员'，请填写内容！");	
		return false;
	}
	
	//患者身体状况  精神状态
	var PipePSoth=0;
	$("input[type=radio][id^='PipePS-94474']").each(function(){
		if ($(this).is(':checked')){
			if((this.value=="title")&&($("input[name$='.93504']").val()=="")){
				PipePSoth=-1;
			}
		}	
	})
	$("input[type=radio][id^='PipePS-94475']").each(function(){
		if ($(this).is(':checked')){
			if((this.value=="title")&&($("input[name$='.93510']").val()=="")){
				PipePSoth=-1;
			}
		}	
	})
	if(PipePSoth==-1){
		$.messager.alert("提示:","【患者身体状况】勾选'其他'，请填写内容！");	
		return false;
	}
	
	//脱管原因
	var PipeReasonoth=0;
	$("input[type=checkbox][id^='PipeReason']").each(function(){
		if ($(this).is(':checked')){
			if((this.value=="title")&&($("input[name$='.93845'][class='lable-input']").val()=="")){
				PipeReasonoth=-1;
			}
		}	
	})
	if(PipeReasonoth==-1){
		$.messager.alert("提示:","【脱管原因】勾选'其他'，请填写内容！");	
		return false;
	}
	//固定方法
	var PipeFixedMethodoth=0;
	$("input[type=checkbox][id^='PipeFixedMethod']").each(function(){
		if ($(this).is(':checked')){
			if((this.value=="title")&&($("input[name$='.93850'][class='lable-input']").val()=="")){
				PipeFixedMethodoth=-1;
			}
		}	
	})
	if(PipeFixedMethodoth==-1){
		$.messager.alert("提示:","【固定方法】勾选'其他'，请填写内容！");	
		return false;
	}
	//采取措施
	var PipeTakeStepsoth=0;
	$("input[type=checkbox][id^='PipeTakeSteps']").each(function(){
		if ($(this).is(':checked')){
			if((this.value=="title")&&($("input[name$='.93859'][class='lable-input']").val()=="")){
				PipeTakeStepsoth=-1;
			}
		}	
	})
	if(PipeTakeStepsoth==-1){
		$.messager.alert("提示:","【采取措施】勾选'其他'，请填写内容！");	
		return false;
	}
	
	//并发症 
	var PipeComploth=0,PipeCompl="",PipeList="";
	$("input[type=radio][id='PipeComplication-94540']").each(function(){
		if ($(this).is(':checked')){
			PipeCompl=this.value;
		}
	})
	if(PipeCompl=="有"){
		$("input[type=checkbox][id^='PipeComplication-94540']").each(function(){
			if (($(this).is(':checked'))&&(this.value!="")){
				PipeList=this.value
			}
		})
		if (PipeList==""){
			$.messager.alert("提示:","【并发症】勾选'有'，请勾选相应内容！");	
			return false;
		}
	}
	
	$("input[type=checkbox][id^='PipeComplication-94540-94541']").each(function(){
		if ($(this).is(':checked')){
			if((this.value=="title")&&($("input[name$='.93546'][class='lable-input']").val()=="")){
				PipeComploth=-1; //出血为空
			}
		}
	})
	
	if(PipeComploth==-1){
		$.messager.alert("提示:","【并发症】勾选'出血'，请填写内容！");	
		return false;
	}
	$("input[type=checkbox][id^='PipeComplication-94540-94548']").each(function(){
		if ($(this).is(':checked')){
			if((this.value=="title")&&($("input[name$='.93553'][class='lable-input']").val()=="")){
				PipeComploth=-2; //其他内容为空
			}
		}	
	})
	if(PipeComploth==-2){
		$.messager.alert("提示:","【并发症】勾选'其他'，请填写内容！");	
		return false;
	}
	
	return true;
}

//时间 数字校验
function CheckTimeornum(){
	//时间输入校验
	//脱管发现时间
	$('#PipeFindTime').live("keyup",function(){
		this.value=this.value.replace(/\D/g,'');
	})
	$('#PipeFindTime').live("blur",function(){
		this.value=CheckEmPcsTime(this.id);
	})
	$('#PipeFindTime').live("focus",function(){
		this.value=SetEmPcsTime(this.id);
	})
	
	//数字输入校验  
	//填报人工作年限(年)
	$('#RepUserWorkYears').live("keyup",function(){
		this.value=this.value.replace(/\D/g,'');
	})

}

