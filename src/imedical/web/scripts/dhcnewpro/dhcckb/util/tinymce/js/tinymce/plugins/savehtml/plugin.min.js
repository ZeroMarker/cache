function getQueryVariable(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}



tinymce.PluginManager.add('savehtml', function(editor, url) {
    var save = function () {
    var  param = [];
	var ID=getQueryVariable("ID")
    var dicParref=getQueryVariable("dicParref")
    var params = dicParref +"^"+ ID +"^"+ ""
    runClassMethod("web.DHCCKBEditProp","GetAttrListData",{"rows":"1000","page":"1","params":params,"drugType":"","MWToken":TOKEN},function(jsonString){
	    if(jsonString==""){ return;}
	    var jsonObj=jsonString;
	    for(var i=0;i<jsonObj.total;i++){
        var attrCode=jsonObj.rows[i].attrCode;
		var attrDesc=jsonObj.rows[i].attrDesc;
		var attrID=jsonObj.rows[i].attrID;
        var dataType =jsonObj.rows[i].dataType
        //debugger;
        if((attrDesc=="成分")||(attrDesc=="等效单位")||(attrDesc=="药学分类"))
        {
	    	continue;    
	    }
        //var valueHtml=cc.innerHTML
        //var valueText=cc.innerText
         var groupData="";
        if (dataType=="combobox"){
	        var cc=tinymce.activeEditor.dom.get(attrCode)
	        if(cc)
		        {
		        	var index=cc.selectedIndex; //序号，取当前选中选项的序号
					var datagridvalue = cc.options[index].value;   //comboval
		        	var datagridtext = cc.options[index].text;   //combotext
		        }
	        }
	    else  if(dataType=="datagrid"){
		    
		    var datagridList=serverCall("web.DHCCKBTinyOpen","getDatagridList",{"code":attrCode})
		    var datagridArray=datagridList.split("&&");
		    var ArrayLength = datagridArray.length;
		    if(ArrayLength==1){
			    var Code=datagridArray[0]
			    var datagridCode = Code+"det"
			    //没加标记之前先在这里区分正文和信息的内容
			    if((Code=="GenerNameFormProp")||(Code=="ProNameProp")||(Code=="EngName")||(Code=="SpecificationProp")||(Code=="FormProp")||(Code=="IngredientCode")||(Code=="IngredientMete")||(Code=="IngredientUnit"))
			    {
					datagridCode = Code	;
				}
			    
			    
			    var cc=tinymce.activeEditor.dom.get(datagridCode)
			    if(cc)
				    {
					    var index=cc.selectedIndex; //序号，取当前选中选项的序号
						var datagridvalue = cc.options[index].value;
						var datagridtext = cc.options[index].text;  
				    }
			    }
		    else{
			    var groupData="";
			    for (var m=0;m<datagridArray.length;m++){
			    	var cc=tinymce.activeEditor.dom.get(datagridArray[m])  
			    	var type =cc.getAttribute("data-type")
			    	if ((type=="combobox")||(type=="datagrid")){
				   		var index=cc.selectedIndex; //序号，取当前选中选项的序号
				   		var datagridvalue = cc.options[index].value;
				   		var datagridtext = cc.options[index].text;
				   		if(groupData!="")
					   		{
					   			groupData=groupData+"&&"+"^"+ID+"^"+attrID+"^"+datagridvalue+"^"+ datagridArray[m]+"^0^";  
					   		}else
					   		{
						   		groupData="0^"+ID+"^"+attrID+"^^"+"&&"+"^"+ID+"^"+attrID+"^"+datagridvalue+"^"+ datagridArray[m]+"^0^"; 	
						   	}
						}
			   		else{
				    	var valueHtml=cc.innerHTML
        				var valueText=cc.innerText
        				if(groupData!="")
					   		{
	        			    	groupData=groupData+"&&"+"^"+ID+"^"+attrID+"^"+valueText+"^"+ datagridArray[m]+"^0^";
					   		}else
					   		{
						   		groupData="0^"+ID+"^"+attrID+"^^"+"&&"+"^"+ID+"^"+attrID+"^"+valueText+"^"+ datagridArray[m]+"^0^";	
						   	} 
						} 
						
			   		}
			    }
		    
		    }
		 else{
			 
			  var cc=tinymce.activeEditor.dom.get(attrCode)

			 }
        
        if(cc==null){
	        var valueHtml="<p></p>"
        	var valueText=""
	        }else{
		    var valueHtml=cc.innerHTML
        	var valueText=cc.innerText
		        }
        //var Datalist = "" +"^"+ ID +"^"+ attrID +"^"+ "" +"^"+ valueText +"^"+ "" +"^"+ "" +"^"+ valueHtml;
        if(((dataType=="datagrid")||(dataType=="combobox"))&&(valueHtml.indexOf("<img")<0))
        {
	         valueText="";
	         valueHtml="";
        }else
        {
	    	datagridvalue="" 
	    	//valueHtml.replace(/\\"/g,"\'")   
			valueHtml = valueHtml.split("<p>")[1];
			valueHtml = valueHtml.split("</p>")[0];
			
	    }
	    
	    //debugger;
        param.push({"ID":ID,"attrID":attrID,"valueText":valueText,"valueHtml":valueHtml,"Type":dataType,"datagridvalue":datagridvalue,"groupData":groupData});
        }
        },'json',false);
        var json = JSON.stringify(param)
        
        
        var jsonString=$.cm({ 
			ClassName:"web.TinySave",
			MethodName:"TinyDeal",
			ListData:json,
			dataType:"text",
			LoginInfo:LoginInfo,
			ClientIPAddress:ClientIPAdd,
			MWToken:TOKEN
		}, false);
        
     	//runClassMethod("web.TinySave","TinyDeal",{"ListData":json,"":"text","LoginInfo":LoginInfo,"ClientIPAddress":ClientIPAdd},function(jsonString){
	        if (jsonString < 0){
			//$.messager.alert('提示','保存失败','error');	
			$.messager.popover({
				msg: '保存失败！',
				type: 'error',
				style: {
					top: 300,
					right:650
				}
			});	
				
		}else{
			//$.messager.alert('提示','保存成功','success');
			$.messager.popover({
				msg: '保存成功！',
				type: 'success',
				timeout: 2000, 		//0不自动关闭。3000s
				showType: 'slide',  //show,fade,slide
				style: {
					top: 350,
					right:650
				}
			});
			location.reload(); 
			}
	        //}); 
    };
    
    // 注册一个工具栏按钮名称
    editor.ui.registry.addButton('savehtml', {
      
      icon: 'save',
      onAction: function () {
        save();
      }
    });
  
    // 注册一个菜单项名称 menu/menubar
    editor.ui.registry.addMenuItem('savehtml', {
      
      icon: 'save',
      onAction: function() {
        save();
      }
    });
  
    
  });
  
  