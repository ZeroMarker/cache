(function(t){function a(a){t.map(a,function(a){t(a).droppable("enable")})}t.extend(t.fn.datagrid.defaults,{dropAccept:"tr.datagrid-row",dragSelection:!1,dragDelay:100,onBeforeDrag:function(t){},onStartDrag:function(t){},onStopDrag:function(t){},onDragEnter:function(t,a){},onDragOver:function(t,a){},onDragLeave:function(t,a){},onBeforeDrop:function(t,a,e){},onDrop:function(t,a,e){}}),t.extend(t.fn.datagrid.methods,{_appendRows:function(a,e){return a.each(function(){var a=t(this),r=t.isArray(e)?e:[e];t.map(r,function(t){a.datagrid("appendRow",t).datagrid("enableDnd",a.datagrid("getRows").length-1)})})},_insertRows:function(a,e){return a.each(function(){var a=t(this),r=e.index,n=e.row,d=t.isArray(n)?n:[n];t.map(d,function(t,e){a.datagrid("insertRow",{index:r+e,row:t}).datagrid("enableDnd",r+e)})})},_getRowIndexs:function(a,e){var r=a,n=t.isArray(e)?e:[e],d=t.map(n,function(t){return r.datagrid("getRowIndex",t)});return t.grep(d,function(t){if(t>=0)return!0})},_deleteRows:function(a,e){return a.each(function(){e.sort(function(t,a){return parseInt(t)>parseInt(a)?-1:1});for(var a=0;a<e.length;a++)t(this).datagrid("deleteRow",e[a])})},_setSelections:function(a){return a.each(function(){for(var a=t(this).datagrid("getRows"),e=0;e<a.length;e++)a[e]._selected&&(t(this).datagrid("selectRow",e),a[e]._selected=void 0)})},clearInsertingFlag:function(a){return a.each(function(){var a=t(this).datagrid("options");if(a.insertingIndex>=0){var e=a.finder.getTr(this,a.insertingIndex);e.removeClass("datagrid-row-top datagrid-row-bottom"),a.insertingIndex=-1}})}});var e=[];t.extend(t.fn.datagrid.methods,{resetDroppable:function(r){return r.each(function(){for(var r=t(this).datagrid("getPanel")[0],n=[],d=[],i=0;i<e.length;i++){var o=e[i],s=t(o).closest("div.datagrid-wrap");s.length&&s[0]==r?n.push(o):d.push(o)}e=d,a(n)})},enableDnd:function(r,n){return t("#datagrid-dnd-style").length||t('<style id="datagrid-dnd-style">.datagrid-row-top>td{border-top:1px solid red}.datagrid-row-bottom>td{border-bottom:1px solid red}</style>').appendTo("head"),r.each(function(){function r(a,e){var r=t(a).draggable("proxy").find("span.tree-dnd-icon");r.removeClass("tree-dnd-yes tree-dnd-no").addClass(e?"tree-dnd-yes":"tree-dnd-no")}function d(a){if(!t(a).hasClass("datagrid-row"))return null;var e=t(a).closest("div.datagrid-view").children("table")[0],r=t(e).datagrid("options");return r.finder.getRow(e,t(a))}function i(a){if(!t(a).hasClass("datagrid-row"))return null;for(var e=s(a),r=t(e).datagrid("options"),n=t(e).datagrid("getRows"),d=0;d<n.length;d++)n[d]._selected=void 0;if(r.dragSelection&&t(a).hasClass("datagrid-row-selected")){n=t(e).datagrid("getSelections");return t.map(n,function(t){t._selected=!0}),n}var i=r.finder.getRow(e,t(a));return i._selected=t(a).hasClass("datagrid-row-selected"),i}function o(t){g(t).droppable(b).droppable("enable")}function s(a){return t(a).closest("div.datagrid-view").children("table")[0]}function g(a){var e=t(a).data("datagrid").dc;return e.view}function l(a){var e=t(a).droppable("options");return!e.disabled&&"no-accept"!=e.accept}function f(a,e){var r=e?h.dropAccept:"no-accept";t.map(t.isArray(a)?a:[a],function(a){var e=t(p).datagrid("getRowIndex",a);h.finder.getTr(p,e).droppable({accept:r})})}var p=this,c=t.data(this,"datagrid"),u=t(this),h=c.options,v={disabled:!1,revert:!0,cursor:"pointer",proxy:function(a){var e=t('<div style="z-index:9999999999999"></div>').appendTo("body"),r=i(a),n=t.isArray(r)?r:[r];return t.map(n,function(a,r){var n=u.datagrid("getRowIndex",a),d=h.finder.getTr(p,n,"body",1),i=h.finder.getTr(p,n,"body",2);i.clone().removeAttr("id").removeClass("droppable").appendTo(e),d.clone().removeAttr("id").removeClass("droppable").find("td").insertBefore(e.find("tr:eq("+r+") td:first")),t('<td><span class="tree-dnd-icon tree-dnd-no" style="position:static">&nbsp;</span></td>').insertBefore(e.find("tr:eq("+r+") td:first"))}),e.find("td").css("vertical-align","middle"),e.hide(),e},deltaX:15,deltaY:15,delay:h.dragDelay,onBeforeDrag:function(a){var e=i(this);return 0!=h.onBeforeDrag.call(p,e)&&(!t(a.target).parent().hasClass("datagrid-cell-check")&&(1==a.which&&void 0))},onStartDrag:function(){t(this).draggable("proxy").css({left:-1e4,top:-1e4});var a=i(this);f(a,!1),c.draggingRow=a,h.onStartDrag.call(p,a)},onDrag:function(a){var e=a.pageX,r=a.pageY,n=a.data.startX,d=a.data.startY,i=Math.sqrt((e-n)*(e-n)+(r-d)*(r-d));if(i>3){t(this).draggable("proxy").show();var o=h.finder.getTr(p,parseInt(t(this).attr("datagrid-row-index")),"body");t.extend(a.data,{startX:o.offset().left,startY:o.offset().top,offsetWidth:0,offsetHeight:0})}this.pageY=a.pageY},onEndDrag:function(a){var e=t(this).data("draggable").droppables.filter(function(){var e=t(this);if(e.droppable("options").disabled)return!1;if(e.hasClass("datagrid-row")&&!e.hasClass("datagrid-row-over"))return!1;var r=e.offset();return a.pageX>r.left&&a.pageX<r.left+e.outerWidth()&&a.pageY>r.top&&a.pageY<r.top+e.outerHeight()}),r=e.filter(function(){return t(this).hasClass("datagrid-row")});r.length&&(e=r),t(this).data("draggable").droppables=e},onStopDrag:function(){a(e),e=[],f(c.draggingRow,!0),h.onStopDrag.call(p,c.draggingRow)}},b={disabled:!1,accept:h.dropAccept,onDragEnter:function(a,r){function n(){0==h.onDragEnter.call(p,c,f)&&(t(o).datagrid("clearInsertingFlag"),l.droppable("disable"),l.each(function(){e.push(this)}))}if(!t(this).droppable("options").disabled){var o=s(this),g=t(o).datagrid("options"),l=g.finder.getTr(o,null,"highlight"),f=i(r),c=d(this);l.length&&c&&n()}},onDragOver:function(a,n){function o(){0==h.onDragOver.call(p,v,u)&&(r(n,!1),t(g).datagrid("clearInsertingFlag"),c.droppable("disable"),c.each(function(){e.push(this)}))}if(!(t(this).droppable("options").disabled||t.inArray(this,e)>=0)){var g=s(this),f=t(g).datagrid("options"),c=f.finder.getTr(g,null,"highlight");if(!c.length||l(c)){r(n,!0);var u=i(n),v=d(this);if(c.length){var b=n.pageY,w=c.offset().top,D=c.offset().top+c.outerHeight();t(g).datagrid("clearInsertingFlag"),f.insertingIndex=c.attr("datagrid-row-index"),b>w+(D-w)/2?c.addClass("datagrid-row-bottom"):c.addClass("datagrid-row-top"),v&&o()}}else r(n,!1)}},onDragLeave:function(a,e){if(!t(this).droppable("options").disabled){r(e,!1);var n=s(this);t(n).datagrid("clearInsertingFlag");var o=i(e),g=d(this);g&&h.onDragLeave.call(p,g,o)}},onDrop:function(a,e){function r(){var a=parseInt(f.attr("datagrid-row-index"));if(c)if(o!=n){var e="top"==c?a:a+1;if(e>=0){i=t(n).datagrid("_getRowIndexs",u);t(o).datagrid("_insertRows",{index:e,row:u}),t(n).datagrid("_deleteRows",i),t(o).datagrid("_setSelections")}}else{var r=t(o);e="top"==c?a:a+1;if(e>=0){i=r.datagrid("_getRowIndexs",u),a=parseInt(f.attr("datagrid-row-index")),e="top"==c?a:a+1;if(e>=0){r.datagrid("_insertRows",{index:e,row:u});for(var d=0;d<i.length;d++)i[d]>e&&(i[d]+=i.length);r.datagrid("_deleteRows",i),r.datagrid("_setSelections")}}}else{var i=t(n).datagrid("_getRowIndexs",u);t(o).datagrid("_appendRows",u),t(n).datagrid("_deleteRows",i),t(o).datagrid("_setSelections")}}if(!t(this).droppable("options").disabled){var n=s(e),o=s(this),g=t(o).datagrid("options"),f=g.finder.getTr(o,null,"highlight"),c=null,u=i(e),v=null;if(f.length){if(!l(f))return;c=f.hasClass("datagrid-row-top")?"top":"bottom",v=d(f)}t(o).datagrid("clearInsertingFlag"),0!=h.onBeforeDrop.call(p,v,u,c)&&(r.call(this),h.onDrop.call(p,v,u,c))}}};if(null!=n)var w=h.finder.getTr(this,n);else w=h.finder.getTr(this,0,"allbody");w.draggable(v),w.droppable(b),o(p)})},disableDnd:function(a){return a.each(function(){var a=t.data(this,"datagrid"),e=(t(this),a.options),r=e.finder.getTr(this,0,"allbody");r.draggable("disable"),r.droppable("disable")})}})})(jQuery);