(function($){function isMultiLineHeaders(e){var t=$.data(e,"datagrid"),n=t.options;return!!(n.columns&&n.columns.length>1&&n.columns[0].length&&n.columns[1].length)||!!(n.frozenColumns&&n.frozenColumns.length>1&&n.frozenColumns[0].length&&n.frozenColumns[1].length)}function findRow(e,t,n,i,a){function o(e){return $.array.first(a,function(t){return t[i.idField]==e})}n=n&&n.length?n:$(e),i=i||$.data(e,"datagrid").options,a=a&&a.length?a:n.datagrid("getRows");var r=$.type(t);return"function"==r?$.array.first(a,function(n,i){return t.call(e,n,i,a)}):"object"==r?i.idField&&i.idField in t?o(t[i.idField]):$.array.first(a,function(e){return e==t}):o(t)}function findRows(e,t){var n=$(e),i=$.data(e,"datagrid"),a=i.options,o=n.datagrid("getRows");if($.isFunction(t))return $.array.filter(o,function(n,i){return t.call(e,n,i,o)});if($.array.likeArrayNotString(t)){var r=$.array.map(t,function(t){return findRow(e,t,n,a,o)});return $.array.filter(r,function(e){return null!=e&&null!=e})}return[findRow(e,t,n,a,o)]}function showRow(e,t){var n=$.data(e,"datagrid"),i=$(e),a=(n.options,i.datagrid("getRows"),findRow(e,t)),o=i.datagrid("getRowIndex",a);o>-1&&($.array.remove(n.hiddenRows,a),getRowDom(e,o).removeClass("datagrid-row-hidden"))}function hideRow(e,t){var n=$.data(e,"datagrid"),i=$(e),a=(n.options,i.datagrid("getRows"),findRow(e,t)),o=i.datagrid("getRowIndex",a);o>-1&&($.array.attach(n.hiddenRows,a),i.datagrid("unselectRow",o).datagrid("uncheckRow",o),getRowDom(e,o).addClass("datagrid-row-hidden"))}function hideRows(e,t){var n=$(e),i=$.data(e,"datagrid");i.options;if(1==t){var a=n.datagrid("getRows");$.array.clear(i.hiddenRows),$.array.copy(i.hiddenRows,a),$.each(a,function(t,i){var a=n.datagrid("getRowIndex",i);a>-1&&getRowDom(e,a).addClass("datagrid-row-hidden")})}else{var o=findRows(e,t);o.length&&$.each(o,function(t,n){hideRow(e,n)})}}function showRows(e,t){var n=$(e),i=$.data(e,"datagrid");i.options;if(1==t){var a=n.datagrid("getRows");$.array.clear(i.hiddenRows),$.each(a,function(t,i){var a=n.datagrid("getRowIndex",i);a>-1&&getRowDom(e,a).removeClass("datagrid-row-hidden")})}else{var o=findRows(e,t);o.length&&$.each(o,function(t,n){showRow(e,n)})}}function getHeaderMenuItems(e,t,n,i){var a=[],o=[],r=[e[0],i];return $.array.merge(o,o.length?"-":[],defaultMenus.sortMenus),$.array.merge(o,o.length?"-":[],defaultMenus.rowToggleMenus),$.array.merge(o,o.length?"-":[],defaultMenus.columnOperateMenus),$.array.likeArrayNotString(t.headerContextMenu)&&$.array.merge(a,a.length?"-":[],t.headerContextMenu),o.length&&$.array.merge(a,a.length?"-":[],o),$.easyui.parseMenuItems(a,r)}function initHeaderCellClickMenu(e,t,n){var i=$(n),a=i.find("div.datagrid-cell"),o=$("<span class='s-btn-downarrow datagrid-header-cell-arrow'>&nbsp;</span>").prependTo(a).click(function(n){$.easyui.hideAllMenu();var i=$(this),a=i.offset(),r=i.outerHeight(),d=i.closest("td[field]").attr("field"),l=getHeaderMenuItems(e,t,n,d),s=$.easyui.showMenu({items:l,left:a.left,top:a.top+r}),c=s.menu("options"),g=c.onHide;o.hidden=!1,c.onHide=function(){o.hidden=!0,o.removeClass("datagrid-header-cell-arrow-show"),g.apply(this,arguments)},n.stopPropagation()});i.unbind(".arrow-hover").bind({"mouseenter.arrow-hover":function(){o.addClass("datagrid-header-cell-arrow-show")},"mouseleave.arrow-hover":function(){(null==o.hidden||null==o.hidden||o.hidden)&&o.removeClass("datagrid-header-cell-arrow-show")}})}function getHeaderFields(e){var t=e.datagrid("getPanel").find("div.datagrid-view div.datagrid-header table.datagrid-htable tr.datagrid-header-row td[field]");return $.array.filter(t,function(t){var n=$(t),i=n.attr("colspan"),a=n.attr("field"),o=e.datagrid("getColumnOption",a);return!(i&&"1"!=i||n.is(".datagrid-cell-rownumber")||!o||o.checkbox)})}function getFieldTopMenus(e,t){return[{text:"保存",hideOnClick:!0,iconCls:function(){var e=cols.length,t=$.array.sum(cols,function(e){return e.hidden?0:1});return t>=e?"tree-checkbox1":0==t?"tree-checkbox0":"tree-checkbox2"},handler:function(){}}]}function getFieldToggleMenus(e,t){e[0];var n=$.array.filter(e.datagrid("getColumnOptions","all"),function(e){return!!e.field});return $.array.map(n,function(i){return{text:i.title||i.field,iconCls:i.hidden?"tree-checkbox0":"tree-checkbox1",hideOnClick:!1,disabled:!i.hidable,handler:function(){var a=$(this),o=a.parent(),r=o.find(".menu-item:gt(1)"),d=(r.find(".tree-checkbox1"),e.datagrid("getColumnOption",i.field));if(i.hidable){e.datagrid(d.hidden?"showColumn":"hideColumn",i.field),t.menu("setIcon",{target:this,iconCls:d.hidden?"tree-checkbox0":"tree-checkbox1"});var l=n.length,s=$.array.sum(n,function(e){return e.hidden?0:1});t.menu("setIcon",{target:a.parent().children("div.menu-item:first"),iconCls:s>=l?"tree-checkbox1":0==s?"tree-checkbox0":"tree-checkbox2"});var c=$.array.filter(r,function(){return!!$(".tree-checkbox1",this).length}),g=$.array.map($.array.filter(n,function(e){return!e.hidable}),function(t){return"<span>"+e.datagrid("getColumnOption",t.field).title+"</span>"});$.array.forEach(c,function(e){var n=t.menu("getItem",e);$.array.contains(g,n.text)||t.menu(c.length>1?"enableItem":"disableItem",e)})}}}})}function getRowTopMenus(e,t,n,i){var a=e[0],o=$.data(a,"datagrid");return[{text:"全部",hideOnClick:!1,iconCls:function(){return o.hiddenRows.length?o.hiddenRows.length>=n.length?"tree-checkbox0":"tree-checkbox2":"tree-checkbox1"},handler:function(){o.hiddenRows.length?showRows(a,!0):hideRows(a,!0),$(this).parent().children("div.menu-item[hideOnClick=false]").each(function(){t.menu("setIcon",{target:this,iconCls:o.hiddenRows.length?"tree-checkbox0":"tree-checkbox1"})})}}]}function getRowToggleMenus(e,t,n,i,a,o){var r=e[0],d=$.data(r,"datagrid"),l=d.options,s=a.length>l.headerFilterMenuLength,c=s?$.array.left(a,l.headerFilterMenuLength):a,g=$.array.map(c,function(e){var a=$.array.filter(i,function(n){return n[t]==e});return{text:e,hideOnClick:!1,iconCls:function(){var n=$.array.filter(d.hiddenRows,function(n){return n[t]==e});return n.length?n.length>=a.length?"tree-checkbox0":"tree-checkbox2":"tree-checkbox1"},handler:function(){var o=$.array.filter(d.hiddenRows,function(n){return n[t]==e});o.length?showRows(r,a):hideRows(r,a),n.menu("setIcon",{target:this,iconCls:o.length?"tree-checkbox1":"tree-checkbox0"}),$(this).parent().children("div.menu-item:first").each(function(){n.menu("setIcon",{target:this,iconCls:d.hiddenRows.length?d.hiddenRows.length>=i.length?"tree-checkbox0":"tree-checkbox2":"tree-checkbox1"})})}}});return s&&$.array.merge(g,g.length?"-":[],{text:"处理更多(共"+a.length+"项)...",iconCls:"icon-standard-application-view-detail",handler:function(){showFilterDialog(r,t,i,a)}}),g}function showFilterDialog(e,t,n,i){if(t){var a=$(e);n=n&&n.length?n:a.datagrid("getRows"),i=i&&i.length?i:getDistinctColumnData(e,t,!0);var o=$.data(e,"datagrid"),r=a.datagrid("getColumnOption",t),d=r.title||r.field,l=$("<div />").appendTo($("body")).dialog({title:"过滤/显示",iconCls:"icon-w-filter",height:300,width:280,modal:!0,resizable:!0,toolbar:[{text:"全部选择",iconCls:"icon-all-select",handler:function(){showRows(e,!0),l.dialog("body").find(":checkbox").each(function(){this.checked=!0})}},"-",{text:"全部不选",iconCls:"icon-all-unselect",handler:function(){hideRows(e,!0),l.dialog("body").find(":checkbox").each(function(){this.checked=!1})}}]}),s=l.dialog("body").find(".dialog-content"),c=$('<div><div class="datagrid-filters-dialog-layout-north" data-options="region: \'north\', split: false, border: false" style="padding:10px;"  >列：'+d+"，共"+i.length+'项</div><div class="datagrid-filters-dialog-layout-center" data-options="region: \'center\', border: false" style="padding:0 10px 10px 10px;" ></div></div>').appendTo(s).layout({fit:!0}),g=c.layout("panel","center"),p=$("<ul></ul>").appendTo(g);$.each(i,function(i,a){var r="item_ck_"+$.util.guid("N"),d=!$.array.some(o.hiddenRows,function(e){return e[t]==a}),l=$("<li></li>").appendTo(p),s=$("<input />").attr({type:"checkbox",id:r,checked:d}).appendTo(l);$("<labe style='padding-left:10px;'></label>").attr("for",r).text(a).appendTo(l);s.click(function(){var i=$.array.filter(n,function(e){return e[t]==a}),r=$.array.filter(o.hiddenRows,function(e){return e[t]==a});r.length?showRows(e,i):hideRows(e,i)})})}}function initExtendColumnOptions(e,t){var n=e[0],i=$.data(n,"datagrid"),a=e.datagrid("getColumnOptions","all");$.each(a,function(e,t){$.union(t,$.fn.datagrid.extensions.columnOptions)});var o=e.datagrid("getColumnOptions",!1);i.columnOptions=$.array.filter(o,function(e){return!!e.title}),i.originalColumnOptions=$.array.map(i.columnOptions,function(e){return $.extend({},e)}),i.multiLineHeaders=isMultiLineHeaders(n)}function initHeaderFiltersData(e,t){var n=e[0],i=$.data(n,"datagrid");i.hiddenRows=[]}function initDisposeEvent(e,t){e.datagrid("getPanel").panel("body").undelegate(".datagrid-extensions").delegate("tr.datagrid-header-row, tr.datagrid-row","click.datagrid-extensions",function(){$.easyui.hideAllMenu()})}function initHeaderContextMenu(e,t){e.datagrid("getPanel").panel("body").delegate("tr.datagrid-header-row>td[field]","contextmenu.datagrid-extensions",function(n){var i=$(this),a=i.attr("field");if(a&&t.enableHeaderContextMenu){n.preventDefault();var o=getHeaderMenuItems(e,t,n,a);$.easyui.showMenu({items:o,left:n.pageX,top:n.pageY,event:n})}})}function initHeaderClickMenu(e,t){t.enableHeaderClickMenu&&$.each(getHeaderFields(e),function(n,i){initHeaderCellClickMenu(e,t,i)})}function initializeExtensions(e){var t=$(e),n=$.data(e,"datagrid"),i=n.options;initExtendColumnOptions(t,i),initHeaderFiltersData(t,i),initDisposeEvent(t,i),initHeaderContextMenu(t,i),initHeaderClickMenu(t,i)}function setColumnsXYP(e){var t=$(e),n=t.datagrid("options"),i=t.datagrid("getColumnOptions",!0),a=t.datagrid("getColumnOptions","all").map(e=>Object.assign(e,{forzen:i.find(t=>t.field==e.field)?"Y":"N"})),o={total:a.length,rows:a},r=$("<div />").appendTo($("body")).dialog({title:"列设置(显示/隐藏/排序)",iconCls:"icon-w-config",height:600,width:860,modal:!0,resizable:!1}),d=r.dialog("body").find(".dialog-content"),l=$('<div><div class="datagrid-filters-dialog-layout-north" style="height:62px;padding:10px 10px 0 10px;"  data-options="region: \'north\', split: false, border: false" ></div><div class="datagrid-filters-dialog-layout-center" style=\'padding:0 10px 10px 10px;\' data-options="region: \'center\', border: false" ></div></div>').appendTo(d).layout({fit:!0}),s=l.layout("panel","north"),c=$("<div class='hisui-panel panel-body-gray' style='padding:10px;border-radius:4px 4px 0 0;'></div>").appendTo(s).panel();sv=$("<div><label style='padding-right:10px;vertical-align: middle;'>按</label></div>").appendTo(c),scl=$("<select class='pe-grid-save-sect hisui-combobox' style='width:200px;'></select>").appendTo(sv).combobox({valueField:"id",textField:"text",multiple:!0,rowStyle:"checkbox",selectOnNavigation:!1,panelHeight:"auto",editable:!1,data:[{id:"USER",text:"用户"},{id:"LOC",text:"科室"},{id:"GROUP",text:"安全组"}]}),scl.combobox("setValues",["USER","LOC","GROUP"]),$PE.initLoad(l);var g=$("<a href='#' class='green' style='margin-left:10px;'>保存</a>").appendTo(sv).linkbutton({}),p=$("<a href='#' style='margin-left:10px;' >确定</a>").appendTo(sv).linkbutton({});$("<label style='padding:0 10px 0 20px'>行样式</label>").appendTo(sv);var u=$("<input type='text' style='margin-right:10px;' style='width: 160px;'>").appendTo(sv).validatebox().val(n.rowStylerFunc?n.rowStylerFunc:""),f=$("<input  type='checkbox'>").appendTo(sv).checkbox({label:"自动换行"}).checkbox("setValue",!n.nowrap),h=$("<div style='float:right;margin-top:2px;'><label style='vertical-align: middle;padding-right:10px;'>模式</label></div>").appendTo(sv),m=$("<div></div>").appendTo(h).switchbox({animated:!0,onClass:"primary",offClass:"danger",size:"small",onText:"排序",offText:"显/隐",onSwitchChange:function(e,t){var n=t.value?"endEdit":"beginEdit";$PE.loadMask(!0),setTimeout(function(){for(var e=0;e<a.length;e++)if(v.datagrid(n,e),"beginEdit"==n){var t=v.datagrid("getRows")[e],i=v.datagrid("getEditor",{index:e,field:"hidden"});$(i.target).switchbox("setValue",void 0===t.hidden||!t.hidden)}$PE.loadMask(!1)},0)}}),x=l.layout("panel","center"),b=$("<div class='hisui-panel panel-body-gray' fit='true' style='border-top:0;border-radius:0 0 4px 4px;'></div>").appendTo(x).panel(),v=$("<table></table>").appendTo(b).datagrid({bodyCls:"panel-header-gray",fit:!0,fitColumns:!0,rownumbers:!0,singleSelect:!0,enableHeaderContextMenu:!1,pageSize:200,pageList:[200,500,1e3],pagination:!0,data:o,border:!1,columns:[[{field:"hidden",title:"显示/隐藏",width:120,align:"center",editor:{type:"switchbox",options:{onClass:"primary",offClass:"gray",size:"small",onText:"显示",offText:"隐藏"}},formatter:function(e,t){var n=void 0===t.hidden||!t.hidden;return n?"<label class='pe-circle-tag pe-primary-bg'>显</label>":"<label class='pe-circle-tag pe-gray-bg'>隐</label>"}},{field:"forzen",title:"冻结列",width:"120",align:"center",editor:{type:"combobox",options:{valueField:"id",textField:"text",data:[{id:"Y",text:"是"},{id:"N",text:"否"}]}}},{field:"width",title:"宽度",width:120,align:"center",editor:{type:"numberbox",options:{min:0}}},{field:"formatterFunc",title:"Formatter函数",width:"140",editor:{type:"validatebox"}},{field:"title",title:"列",width:200},{field:"field",title:"列代码",width:120}]],onLoadSuccess:function(){$(this).datagrid("enableDnd")},onBeforeDrag:function(e){return m.switchbox("getValue")}});g.on("click",function(){saveColumnsSetting(v,e,scl,m,u,f,r)}),p.on("click",function(){confirmColumnsSetting(v,e,m,u,f,r)})}function getSessionStr(e){var t=[];return t.push(e.find(e=>"USER"===e)?session["LOGON.USERID"]:""),t.push(e.find(e=>"LOC"===e)?session["LOGON.CTLOCID"]:""),t.push(e.find(e=>"GROUP"===e)?session["LOGON.GROUPID"]:""),t.join("^")}function saveColumnsSetting(e,t,n,i,a,o,r){if("undefined"==typeof pageCaption||""==pageCaption)return $.messager.alert("提示","未配置全局变量pageCaption","error"),!1;i.switchbox("getValue")||i.switchbox("toggle");var d=n.combobox("getValues");setTimeout(function(){$PE.ajax({ClassName:$PE.datagridSettingCls,MethodName:$PE.datagridSettingSaveMethod,dataType:"text",PageName:pageCaption,ElementID:t.id,ColsData:JSON.stringify(Object.assign(e.datagrid("getData"),{rowStylerFunc:a.val(),autoWrap:o.checkbox("getValue")?"Y":"N"})),SessionStr:getSessionStr(d),UserID:session["LOGON.USERID"]},function(e){if(0==e){$.messager.popover({msg:"保存成功",type:"success"});var n=$PE.cache.datagridSetting.find(e=>e.pageName==pageCaption&&e.elementId==t.id);n&&$PE.cache.datagridSetting.splice($PE.cache.datagridSetting.indexOf(n),1),$(t).datagrid($(t).datagrid("options")),r.dialog("close")}else $.messager.popover({msg:e.split("^")[1],type:"error"})},function(e,t,n){return $.messager.alert("提示","后台访问失败："+t,"error"),!1})},0)}function confirmColumnsSetting(e,t,n,i,a,o){if("undefined"==typeof pageCaption||""==pageCaption)return $.messager.alert("提示","未配置全局变量pageCaption","error"),!1;n.switchbox("getValue")||n.switchbox("toggle"),setTimeout(()=>{var n={pageName:pageCaption,elementId:t.id,rowStylerFunc:i.val(),autoWrap:a.checkbox("getValue")?"Y":"N",frozenColumns:[],columns:[]};e.datagrid("getData").rows.map(e=>{e.hidden=void 0!==e.hidden&&e.hidden?1:0,"Y"==e.forzen?n.frozenColumns.push(e):n.columns.push(e)});var r=$PE.cache.datagridSetting.find(e=>e.pageName==n.pageName&&e.elementId==n.elementId);r&&$PE.cache.datagridSetting.splice($PE.cache.datagridSetting.indexOf(r),1),$PE.cache.datagridSetting.push(n),$(t).datagrid($(t).datagrid("options")),o.dialog("close")},0)}function saveExportSetting(e,t,n,i,a,o){if("undefined"==typeof pageCaption||""==pageCaption)return $.messager.alert("提示","未配置全局变量pageCaption","error"),!1;i.switchbox("getValue")||i.switchbox("toggle");var r=n.combobox("getValues");setTimeout(function(){a.rows=e.datagrid("getData").rows,$PE.ajax({ClassName:$PE.datagridSettingCls,MethodName:$PE.datagridExportSettingSaveMethod,dataType:"text",PageName:pageCaption,ElementID:t.id,SettingData:JSON.stringify(a),SessionStr:getSessionStr(r),UserID:session["LOGON.USERID"]},function(e){0==e?$.messager.popover({msg:"保存成功",type:"success"}):$.messager.popover({msg:e.split("^")[1],type:"error"})},function(e,t,n){return $.messager.alert("提示","后台访问失败："+t,"error"),!1})},0)}function exportExcel(e){var t=appendExportInfo(e),n=t.fileNameEx&&""!=t.fileNameEx?t.fileNameEx:"未命名";download_excel(workbook2blob(getworkbook(e,t)),n+".xlsx")}function getworkbook(e,t){var n=groupData(e,t.sheetField),i=[],a={};return Object.keys(n).forEach(e=>{i.push(e),a[e]=getStyleSheet(n[e],t)}),{SheetNames:i,Sheets:a}}function getStyleSheet(rs,cfg){var st=[],o1={},o2={},e=[],f=[],dl=[],title=cfg.titleEx?cfg.titleEx:"",foot=cfg.inscribeEx?cfg.inscribeEx:"",cols=[];st["!cols"]=[],cfg.rows.map(e=>{"Y"==e.canExport&&cols.push(e)}),cols.forEach(function(t,n){f.push(t.field),st["!cols"].push({wpx:t.width}),o1[t.field]=0==n?title:"",e[t.field]=0==n?foot:"",o2[t.field]=t.exportName&&""!=t.exportName?t.exportName:t.title}),""!=title&&dl.push(o1),dl.push(o2),Array.prototype.push.apply(dl,rs.map(item=>(Object.keys(item).forEach(k=>{var cs=cols.find(e=>e.field==k);if(cs&&cs.formatterFunc&&""!=cs.formatterFunc)try{item[k]=eval(cs.formatterFunc)(item[k],item)}catch(e){console.error(e)}}),item))),""!=foot&&dl.push(e),dl.map((e,t)=>f.map((n,i)=>Object.assign({},{v:e[n],position:(i>25?getColumnExpression(i):String.fromCharCode(65+i))+(t+1)}))).reduce((e,t)=>e.concat(t)).forEach((e,t)=>{st[e.position]={v:e.v?e.v:""};var n=getCellIndex(e.position);""!=title&&1==n.r?st[e.position].s={alignment:{horizontal:"center"},fill:{bgColor:{indexed:64},fgColor:{rgb:"DCDCDC"}},font:{sz:parseInt(cfg.titleSize)>0?parseInt(cfg.titleSize):12,bold:!0}}:""!=foot&&n.r==dl.length?st[e.position].s={alignment:{horizontal:"right"}}:Object.assign(st[e.position],setCellStyle(cols[n.c-1],cfg.showLine)),"Y"==cfg.showLine&&(st[e.position].s.border={top:{style:"thin",color:{rgb:"000000"}},bottom:{style:"thin",color:{rgb:"000000"}},left:{style:"thin",color:{rgb:"000000"}},right:{style:"thin",color:{rgb:"000000"}}})});var cp=Object.keys(st);return st["!ref"]=cp[1]+":"+cp[cp.length-1],st["!merges"]=[],""!=title&&st["!merges"].push({s:{r:0,c:0},e:{r:0,c:f.length-1}}),""!=foot&&st["!merges"].push({s:{r:dl.length-1,c:0},e:{r:dl.length-1,c:f.length-1}}),st}function setCellStyle(e,t){return{s:{alignment:{horizontal:e.horizontalAlign.toLowerCase(),vertical:e.verticalAlign.toLowerCase(),wrapText:"Y"==e.autoWrap}},t:e.colStyle.toLowerCase()}}function groupData(e,t){var n={},i=$(e).datagrid("getAllData").rows;return""==t?{sheet1:i}:(i.forEach(e=>{var i=""!=e[t]?e[t]:"null";n[i]?n[i].push(e):n[i]=[e]}),n)}function getStyleSheetOld(e){var t=$(e),n=t.datagrid("getColumnOptions","all"),i=t.datagrid("getAllData").rows,a=[],o={},r={},d=[],l=[],s="测试";n.forEach(function(e,t){d.push(e.field),o[e.field]=0==t?s:"",r[e.field]=e.title}),""!=s&&l.push(o),l.push(r),Array.prototype.push.apply(l,i);var c={top:{style:"thick",color:{rgb:"FFFFAA00"}},bottom:{style:"thick",color:{rgb:"FFFFAA00"}},left:{style:"thick",color:{rgb:"FFFFAA00"}},right:{style:"thick",color:{rgb:"FFFFAA00"}}},g=l.map((e,t)=>d.map((n,i)=>Object.assign({},{v:e[n],position:(i>25?getColumnExpression(i):String.fromCharCode(65+i))+(t+1)})));g.reduce((e,t)=>e.concat(t)).forEach((e,t)=>{a[e.position]={v:e.v},Object.assign(a[e.position],{s:{border:c,alignment:{vertical:"top",horizontal:"right",wrapText:!0}}})});var p=Object.keys(a);return a["!ref"]=p[0]+":"+p[p.length-1],a["!merges"]=[{s:{r:0,c:0},e:{r:0,c:d.length}}],a["!cols"]=[{wpx:200},,{wpx:100},,,,{wpx:300}],a.A1.s={font:{sz:14,bold:!0},alignment:{horizontal:"center"},fill:{bgColor:{indexed:64},fgColor:{rgb:"DCDCDC"}},border:c},a}function getColumnExpression(e){let t="",n=0;for(;e>0;)n=e%26+1,t=String.fromCharCode(n+64)+t,e=(e-n)/26;return t}function getColumnIndex(e){for(var t=0,n=0;n<e.length;n++)t+=(e[n].toUpperCase().charCodeAt()-64)*Math.pow(26,e.length-n-1);return t}function getCellIndex(e){var t=e.replace(/[^\d]/g,"");return{c:getColumnIndex(e.replace(t,"")),r:t}}function appendExportInfo(e){var t=$(e).datagrid("getColumnOptions","all"),n=$(e).datagrid("getExportSetting");if(n&&n.rows){var i=n.rows.map(e=>(e.canExport=t.find(t=>t.field==e.field)?e.canExport:"N",e));return t.map(e=>{i.find(t=>t.field==e.field)||i.push({field:e.field,title:e.title,sort:9999,width:e.width,canExport:"N",exportName:"",colStyle:"S",verticalAlign:"BOTTOM",horizontalAlign:"LEFT",autoWrap:"N",formatterFunc:""})}),n.rows=i,n}return{fileName:"",title:"",titleSize:"",inscribe:"",sheetField:"",showLine:"Y",rows:t.map(e=>(e.canExport=void 0!==e.hidden&&e.hidden?"N":"Y",e.colStyle="S",e.verticalAlign="BOTTOM",e.horizontalAlign="LEFT",e.autoWrap="N",e))}}function export_setting(e){var t=appendExportInfo(e),n={total:t.rows.length,rows:t.rows},i=$("<div />").appendTo($("body")).dialog({title:"导出设置",iconCls:"icon-w-setting",height:620,width:1200,modal:!0,resizable:!1}),a=i.dialog("body").find(".dialog-content"),o=$('<div><div class="datagrid-filters-dialog-layout-north" style="height:62px;padding:10px 10px 0 10px;"  data-options="region: \'north\', split: false, border: false" ></div><div class="datagrid-filters-dialog-layout-center"  style=\'padding:0 0 10px 10px;\' data-options="region: \'center\', border: false" ></div><div class="datagrid-filters-dialog-layout-east" style="width:350px;padding:0 10px 10px 0;" data-options="region: \'east\', border: false" ></div></div>').appendTo(a).layout({fit:!0}),r=o.layout("panel","north"),d=$("<div class='hisui-panel panel-body-gray' style='padding:10px;border-radius:4px 4px 0 0;'></div>").appendTo(r).panel();sv=$("<div><label style='padding-right:10px;vertical-align: middle;'>按</label></div>").appendTo(d),scl=$("<select class='pe-grid-save-sect hisui-combobox' style='width:200px;'></select>").appendTo(sv).combobox({valueField:"id",textField:"text",multiple:!0,rowStyle:"checkbox",selectOnNavigation:!1,panelHeight:"auto",editable:!1,data:[{id:"USER",text:"用户"},{id:"LOC",text:"科室"},{id:"GROUP",text:"安全组"}]}),scl.combobox("setValues",["USER","LOC","GROUP"]),$PE.initLoad(o);var l=$("<a href='#' class='green' style='margin-left:10px;' >保存</a>").appendTo(sv).linkbutton({}),s=$("<a href='#' style='margin-left:10px;'>直接导出Excel</a>").appendTo(sv).linkbutton({}),c=$("<div style='float:right;margin-top:2px;'><label style='vertical-align: middle;padding-right:10px;'>模式</label></div>").appendTo(sv),g=$("<div></div>").appendTo(c).switchbox({animated:!0,onClass:"primary",offClass:"danger",size:"small",onText:"排序",offText:"编辑",onSwitchChange:function(e,n){var i=n.value?"endEdit":"beginEdit";$PE.loadMask(!0),setTimeout(function(){for(var e=0;e<t.rows.length;e++)f.datagrid(i,e);$PE.loadMask(!1)},0)}}),p=o.layout("panel","center"),u=$("<div class='hisui-panel panel-body-gray' fit='true' style='border-top:0;border-radius:0 0 0 4px;'></div>").appendTo(p).panel(),f=$("<table ></table>").appendTo(u).datagrid({bodyCls:"panel-header-gray",fit:!0,border:!1,rownumbers:!0,singleSelect:!0,enableHeaderContextMenu:!1,pageSize:200,pageList:[200,500,1e3],pagination:!0,data:n,columns:[[{field:"title",title:"列名",width:"140",align:"left"},{field:"canExport",title:"是否导出",width:"80",align:"center",editor:{type:"combobox",options:{valueField:"id",textField:"text",data:[{id:"Y",text:"是"},{id:"N",text:"否"}]}}},{field:"width",title:"列宽",width:"50",align:"center",editor:{type:"numberbox",options:{min:0}}},{field:"exportName",title:"导出列名",width:"140",align:"center",editor:{type:"validatebox"}},{field:"colStyle",title:"格式",width:"80",align:"center",hidden:!0,formatter:function(e,t){return"N"==e?"数值":"D"==e?"日期":"文本"}},{field:"verticalAlign",title:"垂直对齐",width:"80",align:"center",editor:{type:"combobox",options:{valueField:"id",textField:"text",data:[{id:"BOTTOM",text:"底部"},{id:"CENTER",text:"中间"},{id:"TOP",text:"顶部"}]}},formatter:function(e,t){return"CENTER"==e?"中间":"TOP"==e?"顶部":"底部"}},{field:"horizontalAlign",title:"水平对齐",width:"80",align:"center",editor:{type:"combobox",options:{valueField:"id",textField:"text",data:[{id:"LEFT",text:"左"},{id:"CENTER",text:"中"},{id:"RIGHT",text:"右"}]}},formatter:function(e,t){return"LEFT"==e?"左":"RIGHT"==e?"右":"中"}},{field:"autoWrap",title:"自动换行",width:"80",align:"center",editor:{type:"combobox",options:{valueField:"id",textField:"text",data:[{id:"Y",text:"是"},{id:"N",text:"否"}]}}},{field:"formatterFunc",title:"Formatter函数",width:"140",align:"center",editor:{type:"validatebox"}}]],onLoadSuccess:function(){$(this).datagrid("enableDnd")},onBeforeDrag:function(e){return g.switchbox("getValue")}}),h=o.layout("panel","east"),m=$("<div class='hisui-panel panel-body-gray' style='border-radius:0 0 4px 0;border-left:0;border-top:0;' fit='true'></div>").appendTo(h).panel(),x=$("<table cellspacing=10 ></table>").appendTo(m),b=$("<tr></tr>").appendTo(x),v=$("<tr></tr>").appendTo(x),y=$("<tr></tr>").appendTo(x),w=$("<tr></tr>").appendTo(x),C=$("<tr></tr>").appendTo(x),T=$("<tr></tr>").appendTo(x);$("<td style='text-align:right'>文件名</td>").appendTo(b);var O=$("<td></td>").appendTo(b),S=$("<input type='text' style='width: 230px;'>").appendTo(O).validatebox().val(t.fileName);$("<td style='text-align:right'>标题</td>").appendTo(v);var E=$("<td></td>").appendTo(v),k=$("<input type='text' style='width: 230px;'>").appendTo(E).validatebox().val(t.title);$("<td style='text-align:right'>标题字体</td>").appendTo(y);var F=$("<td></td>").appendTo(y),R=$("<input type='text' style='width: 80px;'>").appendTo(F).numberbox({min:1,max:60}).numberbox("setValue",t.titleSize);$("<label>&nbsp;&nbsp;px</label>").appendTo(F),$("<td style='text-align:right'>落款</td>").appendTo(w);var M=$("<td></td>").appendTo(w),N=$("<input type='text' style='width: 230px;'>").appendTo(M).validatebox().val(t.inscribe);$("<td style='text-align:right'>分页签</td>").appendTo(C);var D=$("<td></td>").appendTo(C),I=$("<select  style='width: 236px;'></select>").appendTo(D).combogrid({panelWidth:280,blurValidValue:!0,idField:"field",textField:"title",columns:[[{field:"field",title:"代码",width:80},{field:"title",title:"名称",width:150}]],fitColumns:!0,data:n}).combogrid("setValue",t.sheetField);$("<td style='text-align:right'>显示线条</td>").appendTo(T);var z=$("<td></td>").appendTo(T),A=$("<select style='width:236px;'><option value='Y'>是</option><option value='N'>否</option> </select>").appendTo(z).combobox({enterNullValueClear:!1,blurValidValue:!0}).combobox("setValue",t.showLine);tv=$("<div style='padding:0 10px 10px 10px;margin-top:10px;'></div>").appendTo(m).panel({border:!1}),tips="<label class='pe-red-tips'>提示：</label><hr>                    <label style='font-weight:600;'>【文件名】：</label>支持M语法，如<br>                    <label class='pe-code-snippet'>\"收费记录\"_%session.Get(\"LOGON.USERID\")</label><br>                    <label style='font-weight:600;'>【标题】：</label>支持M语法，如<br>                    <label class='pe-code-snippet'>\"收费记录\"_%session.Get(\"LOGON.USERID\")</label><br>                    <label style='font-weight:600;'>【落款】：</label>支持M语法，如<br>                    <label class='pe-code-snippet'>\"制表日期：\"_$ZD(+$H,3)</label><br>                    <label style='font-weight:600;'>【分页签】：</label>按照某一列的值分组，每一组为一个页签<br>                    <label style='font-weight:600;'>【显示线条】：</label>即Excel是否需要显示单元格框线                    ",tv.html(tips),l.on("click",function(){saveExportSetting(f,e,scl,g,{fileName:S.val(),title:k.val(),titleSize:R.numberbox("getValue"),inscribe:N.val(),sheetField:I.combogrid("getValue"),showLine:A.combobox("getValue")},i)}),s.on("click",function(){exportExcel(e)})}function extendColumnsOptions(target,opts){var setArr=[];if(o=$PE.cache.datagridSetting.find(e=>e.pageName==pageCaption&&e.elementId==target.id),o)opts.rowStylerFunc=o.rowStylerFunc,opts.nowrap="Y"!=o.autoWrap,setArr=[o.frozenColumns,o.columns];else{var cst=$(target).datagrid("getCustomSetting");if(!cst||$.isEmptyObject(cst))return;opts.rowStylerFunc=cst.rowStylerFunc,opts.nowrap="Y"!=cst.autoWrap,setArr=cst.rows}if(opts.rowStylerFunc&&""!=opts.rowStylerFunc)try{opts.rowStyler=eval(opts.rowStylerFunc)}catch(e){console.error(e)}if(0!=setArr.length){!(opts.frozenColumns&&opts.frozenColumns.length>0)&&(opts.frozenColumns=[[]]);var oArr=opts.frozenColumns[0].concat(opts.columns[0]),cArr=setArr[0].concat(setArr[1]).map(item=>{if(item.formatterFunc&&""!=item.formatterFunc)try{item.formatter=eval(item.formatterFunc)}catch(e){console.error(e)}var a=oArr.find(e=>e.field==item.field);return a?(a.width=item.width,a.hidden=1==item.hidden,Object.assign(item,a)):item.hidden=!0,item});return oArr.map(e=>{cArr.find(t=>t.field==e.field)||cArr.push({field:e.field,title:e.title,sort:9999,width:e.width?e.width.toString().split("px")[0]:"",hidden:!0,forzen:"N",formatterFunc:""})}),opts.frozenColumns[0]=[],opts.columns[0]=[],cArr.map(e=>"Y"==e.forzen?opts.frozenColumns[0].push(e):opts.columns[0].push(e)),opts}}$.util.namespace("$.fn.datagrid.extensions");var getColumnData=function(e,t,n){var i=$(e),a=i.datagrid("getRows");if(!1===n)return $.array.map(a,function(e){return e[t]});var o=i.datagrid("getColumnOptions","true"),r=$.array.first(o,function(e){return e.field==t});return r?$.isFunction(r.formatter)?$.array.map(a,function(n){return r.formatter.call(e,n[t],n,i.datagrid("getRowIndex",n))}):$.array.map(a,function(e){return e[t]}):[]},getDistinctColumnData=function(e,t,n){$(e);var i=getColumnData(e,t,n);return $.array.distinct(i)},getRowDom=function(e,t){if(!$.isNumeric(t)||t<0)return $();var n=$(e),i=n.datagrid("getPanel");return i.find("div.datagrid-view div.datagrid-body table tr.datagrid-row[datagrid-row-index="+t+"]")},defaultMenus={};defaultMenus.sortMenus=[{text:"升序",iconCls:"icon-up",disabled:function(e,t,n,i,a){var o=$(i),r=o.datagrid("getColumnOption",a);return!r.sortable||null!=r.colspan&&null!=r.colspan&&1!=r.colspan},handler:function(e,t,n,i,a){return $(i).datagrid("sort",{sortName:a,sortOrder:"asc"})}},{text:"降序",iconCls:"icon-down",disabled:function(e,t,n,i,a){var o=$(i),r=o.datagrid("getColumnOption",a);return!r.sortable||null!=r.colspan&&null!=r.colspan&&1!=r.colspan},handler:function(e,t,n,i,a){return $(i).datagrid("sort",{sortName:a,sortOrder:"desc"})}}],defaultMenus.fieldToggleMenus=[{text:"显示/隐藏列",iconCls:"icon-eye",disabled:!1,children:function(e,t,n,i,a){var o=$(i),r=$(n),d=[],l=[],s=getFieldToggleMenus(o,r);return l.length&&$.array.merge(d,d.length?"-":[],l),s.length&&$.array.merge(d,d.length?"-":[],s),d}}],defaultMenus.rowToggleMenus=[{text:"过滤/显示",iconCls:"icon-filter",disabled:function(e,t,n,i,a){var o=$(i),r=o.datagrid("getColumnOption",a);return!r.filterable||null!=r.colspan&&null!=r.colspan&&1!=r.colspan},children:function(e,t,n,i,a){var o=$(i),r=o.datagrid("getRows"),d=o.datagrid("getColumnOption",a);return fieldValues=getDistinctColumnData(i,a,!d.ignoreFormatterWhenFilter),mm=$(n),menuItems=[],topMenus=getRowTopMenus(o,mm,r,fieldValues),rowMenus=getRowToggleMenus(o,a,mm,r,fieldValues,e),topMenus.length&&$.array.merge(menuItems,menuItems.length?"-":[],topMenus),rowMenus.length&&$.array.merge(menuItems,menuItems.length?"-":[],rowMenus),menuItems}}],defaultMenus.columnOperateMenus=[{text:"列设置",iconCls:"icon-show-set",disabled:!1,hideOnClick:!0,handler:function(e,t,n,i,a){setColumnsXYP(i)}},{text:"导出",iconCls:"icon-export",disabled:!1,children:[{text:"配置",iconCls:"icon-batch-cfg",disabled:!1,handler:function(e,t,n,i,a){export_setting(i)}},{text:"导出Excel",iconCls:"icon-excel",disabled:!1,hideOnClick:!0,handler:function(e,t,n,i,a){exportExcel(i)}}]}];var _datagrid=$.fn.datagrid;$.fn.datagrid=function(e,t){return"string"==typeof e?_datagrid.apply(this,arguments):(e=e||{},this.each(function(){var n=$(this),i=!!$.data(this,"datagrid"),a=i?e:$.extend({},$.fn.datagrid.parseOptions(this),$.parser.parseOptions(this,[{headerFilterMenuLength:"number"},{enableHeaderContextMenu:"boolean",enableHeaderClickMenu:"boolean",autoHighlightColumn:"boolean"}]),e);$.extend(a,extendColumnsOptions(this,a)),_datagrid.call(n,a,t),i||initializeExtensions(this)}))},$.union($.fn.datagrid,_datagrid);var columnOptions={hidable:!0,filterable:!0,ignoreFormatterWhenFilter:!0}
;$.fn.datagrid.extensions.columnOptions?$.extend($.fn.datagrid.extensions.columnOptions,columnOptions):$.fn.datagrid.extensions.columnOptions=columnOptions;var defaults={enableHeaderContextMenu:!0,enableHeaderClickMenu:!1,headerContextMenu:null,headerFilterMenuLength:10},methods={};$.fn.datagrid.extensions.defaults?$.extend($.fn.datagrid.extensions.defaults,defaults):$.fn.datagrid.extensions.defaults=defaults,$.fn.datagrid.extensions.methods?$.extend($.fn.datagrid.extensions.methods,methods):$.fn.datagrid.extensions.methods=methods,$.extend($.fn.datagrid.defaults,defaults),$.extend($.fn.datagrid.methods,methods),$.extend($.fn.datagrid.defaults.editors,{switchbox:{init:function(e,t){return $("<div></div>").appendTo(e).switchbox(t)},destroy:function(e){$(e).remove()},getValue:function(e){return!$(e).switchbox("getValue")},setValue:function(e,t){$(e).switchbox("setValue",t)},resize:function(e,t){}}})})(jQuery);