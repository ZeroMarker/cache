(function(){	Ext.ns("dhcwl.mripday.MripdayRptCfg");})();///描述: 		报表配置页面///编写者：		WZ///编写日期: 		2014-11dhcwl.mripday.MripdayRptCfg=function(){	var rptDimSelector=null;	var serviceUrl="dhcwl/mripday/mripdayRptCfg.csp";	var outThis=this;	var rptItemWin=null;	var curStart=0;curLimit=0;	var quickMenu=new Ext.menu.Menu({		boxMinWidth:150,		ignoreParentClicks:true,    	items:[    		{    			text:'报表项配置',    			handler:function(){			 		var isSel=rptCfgGrid.getSelectionModel().getSelected();					if (!isSel) {						Ext.MessageBox.alert("提示","请先选择报表项！");						return;					}   							    	var RptDR=isSel.get('ID');					    	var RptDesc=isSel.get('RptDesc');		 			    	var RptCode=isSel.get('RptCode');   				    				//if (rptItemWin==null) {    					rptItemWin=new dhcwl.mripday.MripdayRptItemCfg();    				//}    				rptItemWin.setSubWinParam(RptDR,RptCode,RptDesc);    				rptItemWin.showWin(outThis);     			}    		}]	});	var columnModel = new Ext.grid.ColumnModel({        columns:[{header:'ID',dataIndex:'ID',sortable:true, width: 30, sortable: true,menuDisabled : true        },{header:'编码',dataIndex:'RptCode',sortable:true, width: 80, sortable: true,menuDisabled : true        },{header:'描述',dataIndex:'RptDesc', width: 160, sortable: true,menuDisabled : true        },{header:'类型',dataIndex:'RptType', width: 80, sortable: true,menuDisabled : true        },{header:'维度属性代码',dataIndex:'RptDimProCode', width: 80, sortable: true,menuDisabled : true        },{header:'模块报表代码',dataIndex:'RptMMgrCode', width: 160, sortable: true,menuDisabled : true//,renderer:formateDate        },{header:'统计项',dataIndex:'RptItemDescs', width: 300, sortable: true,menuDisabled : true//,renderer:formateDate        },{header:'明细报表',dataIndex:'DetailRptDesc', width: 160, sortable: true,menuDisabled : true, css:'color:#436EEE;'        }]	});    var store = new Ext.data.Store({        proxy: new Ext.data.HttpProxy({url:serviceUrl+'?action=search&start=0&limit=21&onePage=1'}),        reader: new Ext.data.JsonReader({            totalProperty: 'totalNum',            root: 'root',        	fields:[        		{name: 'ID'},            	{name: 'RptCode'},            	{name: 'RptDesc'},            	{name: 'RptType'},            	{name: 'RptDimProCode'},            	{name: 'RptMMgrCode'},            	{name: 'RptItemDescs'},            	            	{name: 'DetailRptDesc'}       		]    	})    });    var Record = Ext.data.Record.create([    	{name: 'ID',type:'integer'},    	{name: 'RptCode', type: 'string'},        {name: 'RptDesc', type: 'string'},        {name: 'RptType', type: 'string'},        {name: 'RptDimProCode', type: 'string'},        {name: 'RptMMgrCode', type: 'string'}    ]);    //var rptCfgGrid = new Ext.grid.GridPanel({    var rptCfgGrid = new Ext.grid.EditorGridPanel({    	resizeAble:true,    	clicksToEdit: true,        height:480,        store: store,        cm: columnModel,        sm: new Ext.grid.RowSelectionModel({        //sm: new Ext.grid.CellSelectionModel({        	singleSelect: true,            listeners: {            	rowselect: function(sm, row, rec) {            	//cellselect:function(sm, row, rec,colIndex){            		var id=rec.get("ID");            		var form=rptCfgForm.getForm();                	form.loadRecord(rec);                	//form.setValues({ID:id});                	                	if (id!="") {                 		form.findField("RptCode").disable();               		                	}else{                		form.findField("RptCode").enable();                             	}                	             	}            }        }),                listeners:{        	'contextmenu':function(event){        		event.preventDefault();        		quickMenu.showAt(event.getXY());        	},        	'celldblclick':function(grid,rowIndesc,columnIndex){        		var selectionModel = grid.getSelectionModel();             		var record = selectionModel.getSelected();				if (!record) {						Ext.MessageBox.alert("提示","请先选择报表项！");						return;				}   								var RptDR=record.get('ID');						var RptDesc=record.get('RptDesc');				if (columnIndex==7){					detailRptItemWin=new dhcwl.mripday.MripdayDetailRptItemCfg();		//新建弹出窗--明细报表配置界面    				detailRptItemWin.setSubWinParam(RptDR,"",RptDesc,"");    				detailRptItemWin.showWin();					}        	}        	        },        bbar:new Ext.PagingToolbar({            pageSize: 21,            store: store,            displayInfo: true,            displayMsg: '显示第 {0} 条到 {1} 条记录，一共 {2} 条',            emptyMsg: "没有记录",            listeners :{	        	'beforechange':function(pt,params){					curStart=params.start;					curLimit=params.limit;			        var RptCode=Ext.get('RptCode').getValue();			        var RptDesc=Ext.get('RptDesc').getValue();			        var RptType=Ext.get('RptType').getValue();			        var RptDimProCode=Ext.get('RptDimProCode').getValue();			       	paraValues='RptCode='+RptCode+'&RptDesc='+RptDesc+'&RptType='+RptType+'&RptDimProCodes='+RptDimProCode;			        //store.proxy.setUrl(encodeURI(serviceUrl+"?action=search&"+paraValues));									        	}	            }        })    });    /*    //add by chenyi.2015-09-14    //给grid增加双击监听事件    var onrowdoubleclick = function(grid, index, e){         var selectionModel = grid.getSelectionModel();             var record = selectionModel.getSelected();			if (!record) {						Ext.MessageBox.alert("提示","请先选择报表项！");						return;			}   							var RptDR=record.get('ID');					var RptDesc=record.get('RptDesc');		 			//var RptCode=isSel.get('RptCode');       	        detailRptItemWin=new dhcwl.mripday.MripdayDetailRptItemCfg();		//新建弹出窗--明细报表配置界面    	detailRptItemWin.setSubWinParam(RptDR,"",RptDesc,"");    	detailRptItemWin.showWin();				    }    rptCfgGrid.addListener('rowdblclick', onrowdoubleclick);				//给grid增加双击监听事件	*/    var rptCfgForm = new Ext.FormPanel({    	bodyStyle:'padding:5px',		labelAlign : 'right',    	frame:true,    	height: 145,		labelWidth : 65,		//bodyStyle : 'padding:5px',		style : {			"margin-right" : Ext.isIE6 ? (Ext.isStrict					? "-10px"					: "-13px") : "0"		},				layout : 'column',		items:[		{			columnWidth : .3,			layout : 'form',			defaultType : 'textfield',			items : [{							fieldLabel : 'ID',							xtype:'textfield',            				name: 'ID',            				disabled:true,            				anchor:'85%'																},{							fieldLabel : '编码',            				xtype:'textfield',            				name: 'RptCode',            				id: 'RptCode',            				anchor:'85%'								}]			},{			columnWidth : .3,			layout : 'form',			defaultType : 'textfield',			items : [{						fieldLabel : '类型',						xtype:'compositefield',						anchor:'85%',						items:[{								name: 'RptType',								id: 'RptType',								xtype:'textfield',								disabled:true	,								flex:7												},{								 flex:1,								 name: 'showRptType',								 id: 'showRptType',								 xtype:'button',								 //anchor:'85%' ,								 icon: '../images/uiimages/search.png',								 handler:OnShowRptType							}						]					},{						//disabled:true							fieldLabel : '描述',						name: 'RptDesc',						id: 'RptDesc',						xtype:'textfield',						anchor:'85%'					}]		},{			columnWidth : .3,			layout : 'form',			defaultType : 'textfield',			anchor:'85%',			items : [{						fieldLabel : '维度属性',				        xtype:'textfield',				        width:200,				        name: 'RptDimProCode',				        id: 'RptDimProCode',				        anchor:'85%'					}]		}		],	    	/*        frame: true,        height: 145,        labelAlign: 'right',        bodyStyle:'padding:5px',        style: {        	//"margin-left": "10px", // when you add custom margin in IE 6...            "margin-right": Ext.isIE6 ? (Ext.isStrict ? "-10px" : "-13px") : "0"         },        layout: 'columns',        defaultConfig:{width:140},        layoutConfig: {columns:12},        items:[{        	html: 'ID：'        },{            xtype:'textfield',            name: 'ID',            disabled:true,            anchor:'85%'        },{        	html: '编码：'        },{            xtype:'textfield',            name: 'RptCode',            id: 'RptCode',            anchor:'85%'        },{            html: '描述：'        },{            name: 'RptDesc',            id: 'RptDesc',            xtype:'textfield',            anchor:'85%'        },{            html:'类型：'        },{            name: 'RptType',            id: 'RptType',            xtype:'textfield',            anchor:'85%',            disabled:true        },{        	width:30,            name: 'showRptType',            id: 'showRptType',            xtype:'button',            anchor:'85%' ,            icon: '../images/uiimages/search.png',            handler:OnShowRptType        },{            html: '维度属性：'        },{        	xtype:'textfield',        	width:200,            name: 'RptDimProCode',            id: 'RptDimProCode'            //anchor:'85%',            //disabled:true        }],        */         tbar:new Ext.Toolbar([{            text: '<span style="line-Height:1">新增</span>',            icon: '../images/uiimages/edit_add.png',            handler: OnAddRpt        }, '-', {        	text: '<span style="line-Height:1">保存</span>',	        	icon: '../images/uiimages/filesave.png',            handler: OnSaveRpt        },'-',{        	text: '<span style="line-Height:1">删除</span>',        	icon: '../images/uiimages/edit_remove.png',            handler: OnDelRpt    	},'-',{    		text: '<span style="line-Height:1">查询</span>',    		icon: '../images/uiimages/search.png',            handler: OnSearch        },'-',{            text: '<span style="line-Height:1">清空</span>',	text: '<span style="line-Height:1">清空</span>',	            icon: '../images/uiimages/clearscreen.png',            handler: OnClear        }])    });    store.load({params:{start:0,limit:21}});    var rptCfgPanel =new Ext.Panel({    	title:'报表配置',    	layout:'border',        items: [{        	region: 'north',            height: 120,			layout:'fit',            //autoScroll:true,            items:rptCfgForm        },{        	region:'center',			layout:'fit',            //autoScroll:true,            items:rptCfgGrid    	}]/*,    	listeners:{    		"resize":function(win,width,height){    			rptCfgGrid.setHeight(height-150);    			rptCfgGrid.setWidth(width-15);    		}    	}		*/    });    //以下为对外的接口方法。    function OnAddRpt(){    	var cnt=store.getCount();    	if (cnt>0) {	    	firstRec=store.getAt(0);	    	var id=firstRec.get("ID");	    	if (id=="") return;    		    	}        var initValue = {ID:'',RptCode:'',RptDesc:'',RptType:'',RptDimProCode:'',RptMMgrCode:'',RptItemDescs:'',DetailRptDesc:''};        var p = new Record(initValue);        rptCfgGrid.stopEditing();        store.insert(0, p);        var sm = rptCfgGrid.getSelectionModel();        sm.selectFirstRow();    }        function OnDelRpt(){    	var sm = rptCfgGrid.getSelectionModel();        var record = sm.getSelected();        if(!sm||!record){       		alert("请选择要删除的类型！");       		return;       	}        Ext.Msg.confirm('信息', '确定要删除？', function(btn){            if (btn == 'yes') {                var rptDR=record.get("ID");				        		var url=serviceUrl+'?action=deleteRpt&rptDR='+rptDR				dhcwl.mkpi.Util.ajaxExc(url,null,function(jsonData){						if(jsonData.success==true && jsonData.tip=="ok"){                			store.remove(record);							var form=rptCfgForm.getForm();    						form.setValues({ID:'',RptCode:'',RptDesc:'',RptType:'',RptDimProCode:''});							//刷新grid  							//refresh();						}else{							Ext.Msg.alert("提示","操作失败！");							}													},this);	         		            }        });    }             function OnSaveRpt() {    	var form=rptCfgForm.getForm();        var values=form.getValues(false);        var sm = rptCfgGrid.getSelectionModel();        var record = sm.getSelected();        if(!sm||!record){       		Ext.Msg.alert("提示","请选择要保存的数据！");       		return;        }        var ID=record.get("ID");        var RptCode=Ext.get('RptCode').getValue();        var reg=/[\$\#\@\&\%\!\*\^\~||_]/;        var reg2=/^\d/;        if(reg.test(RptCode)||(reg2.test(RptCode))){        	alert("编码不能包括$,#,@,&,%,*,^,!,~,||,_等特殊字符，并且不能以数字开头！");        	Ext.get("RptCode").focus();        	return;        }                var RptDesc=Ext.get('RptDesc').getValue();        var RptType=Ext.get('RptType').getValue();        var RptDimProCode=Ext.get('RptDimProCode').getValue();                if(!RptType||!RptDimProCode){        	Ext.Msg.alert("要保存的数据不完整！");        	return;        }        paraValues='ID='+ID+'&RptCode='+RptCode+'&RptDesc='+RptDesc+'&RptType='+RptType+'&RptDimProCode='+RptDimProCode;                       var url=serviceUrl+'?action=addRpt&'+paraValues		dhcwl.mkpi.Util.ajaxExc(url,null,function(jsonData){				if(jsonData.success==true && jsonData.tip=="ok"){								    	var sm = rptCfgGrid.getSelectionModel();			        var record = sm.getSelected();			        if(!sm||!record){			       		return;			       	}										var ID=record.get("ID");					//刷新grid  					refresh();						if(ID==""){						RptDR=jsonData.ROWID;	    				//if (rptItemWin==null) {	    					rptItemWin=new dhcwl.mripday.MripdayRptItemCfg();	    				//}	    				rptItemWin.setSubWinParam(RptDR,RptCode,RptDesc);	    				rptItemWin.showWin();												}									}else{					Ext.Msg.alert("提示","操作失败！");					}									},this);	                   }             function OnClear() {    	outThis.clearForm();    	rptCfgGrid.getSelectionModel().clearSelections();    	return;    }      function OnSearch() {   	        var RptCode=Ext.get('RptCode').getValue();        var RptDesc=Ext.get('RptDesc').getValue();        var RptType=Ext.get('RptType').getValue();        var RptDimProCode=Ext.get('RptDimProCode').getValue();       	paraValues='RptCode='+RptCode+'&RptDesc='+RptDesc+'&RptType='+RptType+'&RptDimProCodes='+RptDimProCode;        store.proxy.setUrl(encodeURI(serviceUrl+"?action=search&"+paraValues+"&start=0&limit=21&onePage=1"));    	store.load();		rptCfgGrid.show();    }        function OnShowRptType(){    			if (rptDimSelector==null) {			rptDimSelector=new dhcwl.mripday.MripdayRptDimSelector();		}		rptDimSelector.showWin(outThis);    }        function refresh(){		rptCfgGrid.getStore().proxy.setUrl(encodeURI(serviceUrl+'?action=search&start=0&limit=21&onePage=1'));		rptCfgGrid.getStore().load();	    rptCfgGrid.show();      	    }    this.refresh=function(){    	refresh();    }        this.getRptCfgPanel=function(){    	return rptCfgPanel;    }       this.getStore=function(){    	return store;    }    this.getRptCfgGrid=function(){    	return rptCfgGrid;    }    this.clearForm=function(){    	var form=rptCfgForm.getForm();    	form.setValues({ID:'',RptCode:'',RptDesc:'',RptType:'',RptDimProCode:''});    }    this.getForm=function(){    	return rptCfgForm;    }}