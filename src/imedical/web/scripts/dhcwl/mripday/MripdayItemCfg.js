(function(){	Ext.ns("dhcwl.mripday.MripdayItemCfg");})();///描述: 		统计项配置页面///编写者：		WZ///编写日期: 		2014-11dhcwl.mripday.MripdayItemCfg=function(){	var serviceUrl="dhcwl/mripday/mripdayItemCfg.csp";	var outThis=this;	var itemKPIWin=null;	var itemCustomWin=null;	var itemCalWin=null;	var quickMenu=new Ext.menu.Menu({		boxMinWidth:150,		ignoreParentClicks:true,    	items:[    		{    			text:'扩展配置',    			handler:function(){			 					 		var isSel=itemCfgGrid.getSelectionModel().getSelected();					if (!isSel) {						Ext.MessageBox.alert("提示","请先选择统计项！");						return;					}   							    	var itemDR=isSel.get('ID');					    	var ItemDesc=isSel.get('ItemDesc');    							    	if (isSel.get('ItemType')=='KPIItem'){	    				if (itemKPIWin==null) {	    					itemKPIWin=new dhcwl.mripday.MripdayItemKPICfg();	    				}	    				itemKPIWin.setSubWinParam(itemDR,ItemDesc);	    				itemKPIWin.showWin();			    	}			    	if (isSel.get('ItemType')=='CustomItem'){	    				if (itemCustomWin==null) {	    					itemCustomWin=new dhcwl.mripday.MripdayItemCustomCfg();	    				}	    				itemCustomWin.setSubWinParam(itemDR,ItemDesc);	    				itemCustomWin.showWin();			    	}			    				    	if (isSel.get('ItemType')=='CalItem'){	    				if (itemCalWin==null) {	    					itemCalWin=new dhcwl.mripday.MripdayItemCalCfg();	    				}	    				itemCalWin.setSubWinParam(itemDR,ItemDesc);	    				itemCalWin.showWin();			    	}			    	     			}    		}]	});	var columnModel = new Ext.grid.ColumnModel([        {header:'ID',dataIndex:'ID',sortable:true, width: 30, sortable: true,menuDisabled : true        },{header:'编码',dataIndex:'ItemCode',sortable:true, width: 80, sortable: true,menuDisabled : true        },{header:'描述',dataIndex:'ItemDesc', width: 160, sortable: true,menuDisabled : true        },{header:'统计项类别',dataIndex:'ItemType', width: 80, sortable: true,menuDisabled : true}    ]);    var store = new Ext.data.Store({        proxy: new Ext.data.HttpProxy({url:serviceUrl+'?action=searchItem&start=0&limit=21&onePage=1'}),        reader: new Ext.data.JsonReader({            totalProperty: 'totalNum',            root: 'root',        	fields:[        		{name: 'ID'},            	{name: 'ItemCode'},            	{name: 'ItemDesc'},            	{name: 'ItemType'}       		]    	})    });    var Record = Ext.data.Record.create([    	{name: 'ID',type:'integer'},    	{name: 'ItemCode', type: 'string'},        {name: 'ItemDesc', type: 'string'},        {name: 'ItemType', type: 'string'}    ]);    var itemCfgGrid = new Ext.grid.GridPanel({        height:480,        store: store,        cm: columnModel,        sm: new Ext.grid.RowSelectionModel({        	singleSelect: true,            listeners: {            	rowselect: function(sm, row, rec) {            		var id=rec.get("ID");            		var form=itemCfgForm.getForm();                	form.loadRecord(rec);                	//form.setValues({ID:id});                	if (id!="") {                 		form.findField("ItemCode").disable();               		                 		itemTypeCbo.disable();                  	                	}else{                		form.findField("ItemCode").enable();             						itemTypeCbo.enable();                  	}             	}            }        }),        listeners:{        	'contextmenu':function(event){        		event.preventDefault();        		quickMenu.showAt(event.getXY());        	}        },        bbar:new Ext.PagingToolbar({            pageSize: 21,            store: store,            displayInfo: true,            displayMsg: '显示第 {0} 条到 {1} 条记录，一共 {2} 条',            emptyMsg: "没有记录"        })    });        	itemTypeCbo = new Ext.form.ComboBox({ 			labelAlign : 'right',			fieldLabel : '类型',			anchor:'85%',            xtype: 'combo',            width:358,            mode:           'local',            displayField:   'typeDesc',            triggerAction:  'all',            forceSelection: true,            editable:       false,            name:           'ItemType',            id:				'TtemType',            hiddenName:     'ItemType',            displayField:   'typeDesc',            valueField:     'typevalue',            store: new Ext.data.JsonStore({		        fields : ['typevalue','typeDesc' ],		        data   : [ 	    			{typevalue:'KPIItem', typeDesc:'指标类统计项'}, 	    		 	{typevalue:'CustomItem', typeDesc:'自定义统计项'}, 	    		 	{typevalue:'CalItem', typeDesc:'计算类统计项'}		            		        ]		    }),            emptyText : '请选择',             name: 'itemType'	});			    var itemCfgForm = new Ext.FormPanel({		        frame: true,        height: 145,        bodyStyle:'padding:5px',        style: {        	//"margin-left": "10px", // when you add custom margin in IE 6...            "margin-right": Ext.isIE6 ? (Ext.isStrict ? "-10px" : "-13px") : "0"         },        labelAlign : 'right',    	height: 140,		labelWidth : 65,		bodyStyle : 'padding:5px',		layout : 'column',				items:[		{			columnWidth : .45,			layout : 'form',			defaultType : 'textfield',			items : [{							fieldLabel : 'ID',				            xtype:'textfield',				            name: 'ID',				            disabled:true,				            anchor:'85%'																},{							fieldLabel : '编码',				            xtype:'textfield',				            name: 'ItemCode',				            id: 'ItemCode',				            anchor:'85%'								}]			},{			columnWidth : .45,			layout : 'form',			defaultType : 'textfield',			anchor:'85%',			items : [{							fieldLabel : '描述',				            id: 'ItemDesc',				            xtype:'textfield',				            anchor:'85%'									},itemTypeCbo/*{							fieldLabel : '类型',							xtype:'compositefield',							items:itemTypeCbo,							anchor:'85%'*/				            //disabled:true									]		}		],		        /*        layout: 'column',        defaultConfig:{width:140},        layoutConfig: {columns:9},        items:[{        	html: 'ID：'        },{            xtype:'textfield',            name: 'ID',            disabled:true,            anchor:'85%'        },{        	html: '编码：'        },{            xtype:'textfield',            name: 'ItemCode',            id: 'ItemCode',            anchor:'85%'        },{            html: '描述：'        },{            name: 'ItemDesc',            id: 'ItemDesc',            xtype:'textfield',            anchor:'85%'        },{            html:'类型：'        }, itemTypeCbo        ],*/         tbar:new Ext.Toolbar([{            text: '<span style="line-Height:1">新增</span>',	            icon: '../images/uiimages/edit_add.png',            handler: OnAddItem        }, '-', {        	text: '<span style="line-Height:1">保存</span>',	        	icon: '../images/uiimages/filesave.png',            handler: OnSaveItem        },'-',{        	text: '<span style="line-Height:1">删除</span>',        	icon: '../images/uiimages/edit_remove.png',            handler: OnDelItem    	},'-',{text: '<span style="line-Height:1">查询</span>',    		icon: '../images/uiimages/search.png',            handler: OnSearch        },'-',{            text: '<span style="line-Height:1">清空</span>',			            icon: '../images/uiimages/clearscreen.png',            handler: OnClear        }])    });    store.load({params:{start:0,limit:21}});       var itemCfgPanel =new Ext.Panel({    	title:'统计项配置',    	layout:'border',        items: [{        	region: 'north',            height: 120,			layout:'fit',            items:itemCfgForm        },{        	region:'center',        	//autoScroll:true,			layout:'fit',            items:itemCfgGrid    	}]/*,    	listeners:{    		"resize":function(win,width,height){    			itemCfgGrid.setHeight(height-150);    			itemCfgGrid.setWidth(width-15);    		}    	}		*/    });    function OnAddItem(){    	var cnt=store.getCount();    	if (cnt>0) {	    	firstRec=store.getAt(0);	    	var id=firstRec.get("ID");	    	if (id=="") return;    		    	}    	    	        var initValue = {ID:'',ItemCode:'',ItemDesc:'',ItemType:''};        var form=itemCfgForm.getForm();    	form.setValues({ID:'',ItemCode:'',ItemDesc:'',ItemType:''});        var p = new Record(initValue);        itemCfgGrid.stopEditing();        store.insert(0, p);        var sm = itemCfgGrid.getSelectionModel();        sm.selectFirstRow();    }        function OnDelItem(){    	var sm = itemCfgGrid.getSelectionModel();        var record = sm.getSelected();        if(!sm||!record){       		alert("请选择要删除的统计项！");       		return;       	}        Ext.Msg.confirm('信息', '确定要删除？', function(btn){            if (btn == 'yes') {                var ID=record.get("ID");            			        var url=serviceUrl+'?action=delItem&OPTLItemDR='+ID				dhcwl.mkpi.Util.ajaxExc(url,null,function(jsonData){						if(jsonData.success==true && jsonData.tip=="ok"){							if(jsonData.TipMSG){								Ext.MessageBox.alert("提示",jsonData.TipMSG);								return;							}							else{								//刷新grid								itemCfgGrid.getStore().proxy.setUrl(encodeURI(serviceUrl+'?action=searchItem&start=0&limit=21&onePage=1'));								itemCfgGrid.getStore().load();							    itemCfgGrid.show();  															    outThis.clearForm();							}																	}else{							Ext.Msg.alert("提示","操作失败！");							}													},this);	            	            }        });    }             function OnSaveItem() {    	var form=itemCfgForm.getForm();        var values=form.getValues(false);        var sm = itemCfgGrid.getSelectionModel();        var record = sm.getSelected();        if(!sm||!record){       		alert("请选择要保存的类型！");       		return;        }        var ID=record.get("ID");        var ItemCode=Ext.get('ItemCode').getValue();        var reg=/[\$\#\@\&\%\!\*\^\~||_]/;        var reg2=/^\d/;        if(reg.test(ItemCode)||(reg2.test(ItemCode))){        	alert("编码不能包括$,#,@,&,%,*,^,!,~,||,_等特殊字符，并且不能以数字开头！");        	Ext.get("ItemCode").focus();        	return;        }                var ItemDesc=Ext.get('ItemDesc').getValue();        var ItemType=Ext.get('ItemType').getValue();         if(!ItemCode||!ItemDesc||!ItemType){        	alert("编码或描述或类型不能为空！");        	return;        }        paraValues='ID='+ID+'&ItemCode='+ItemCode+'&ItemDesc='+ItemDesc+'&ItemType='+ItemType;        var url=serviceUrl+'?action=addItem&'+paraValues		dhcwl.mkpi.Util.ajaxExc(url,null,function(jsonData){				if(jsonData.success==true && jsonData.tip=="ok"){					if (ID=="") {						//record.set("RptCfg_RowID",jsonData.ROWID);					}					//刷新grid					itemCfgGrid.getStore().proxy.setUrl(encodeURI(serviceUrl+'?action=searchItem&start=0&limit=21&onePage=1'));					itemCfgGrid.getStore().load();				    itemCfgGrid.show();  										Ext.MessageBox.alert("提示","操作成功！");									}else{					Ext.Msg.alert("提示","操作失败！");					}									},this);	   }             function OnClear() {    	outThis.clearForm();    	return;   }      function OnSearch() {   	    var ItemCode=Ext.get('ItemCode').getValue();        var ItemDesc=Ext.get('ItemDesc').getValue();        var ItemType=Ext.get('ItemType').getValue();        paraValues='ItemCode='+ItemCode+'&ItemDesc='+ItemDesc+'&ItemType='+ItemType;        store.proxy.setUrl(encodeURI(serviceUrl+"?action=searchItem&"+paraValues+"&start=0&limit=21&onePage=1"));    	store.load();		itemCfgGrid.show();    }        function OnShowItemType(){    	    	Ext.MessageBox.alert("hello");    }    this.getItemCfgPanel=function(){    	return itemCfgPanel;    }       this.getStore=function(){    	return store;    }    this.getItemCfgGrid=function(){    	return itemCfgGrid;    }    this.clearForm=function(){    	var form=itemCfgForm.getForm();    	form.setValues({ID:'',ItemCode:'',ItemDesc:'',ItemType:''});    }}