(function(){	Ext.ns("dhcwl.mripday.MripdayDetailItemCfg");})();///描述: 		明细统计项配置页面///编写者：		WZ///编写日期: 		2014-11dhcwl.mripday.MripdayDetailItemCfg=function(){	//var parentWin=null;	var rptDimSelector=null;	var serviceUrl="dhcwl/mripday/mripdayItemDetailCfg.csp";	var outThis=this;	var dimProDR="";		var dimProCode="";	var detailColumnModel = new Ext.grid.ColumnModel([        {header:'ID',dataIndex:'OPTLDetailItemRowid',sortable:true, width: 30, sortable: true,menuDisabled : true        },{header:'编码',dataIndex:'OPTLDetailItemCode',sortable:true, width: 80, sortable: true,menuDisabled : true        },{header:'描述',dataIndex:'OPTLDetailItemDesc', width: 160, sortable: true,menuDisabled : true        },{header:'维度属性',dataIndex:'KPIDetailItemDimProCode', width: 80, sortable: true,menuDisabled : true        }    ]);    var detailStore = new Ext.data.Store({        proxy: new Ext.data.HttpProxy({url:serviceUrl+'?action=search&start=0&limit=21&onePage=1'}),        reader: new Ext.data.JsonReader({            totalProperty: 'totalNum',            root: 'root',        	fields:[        		{name: 'OPTLDetailItemRowid'},            	{name: 'OPTLDetailItemCode'},            	{name: 'OPTLDetailItemDesc'},            	{name: 'KPIDetailItemDimProCode'}       		]    	})    });    var detailRecord = Ext.data.Record.create([    	{name: 'OPTLDetailItemRowid',type:'integer'},    	{name: 'OPTLDetailItemCode', type: 'string'},        {name: 'OPTLDetailItemDesc', type: 'string'},        {name: 'KPIDetailItemDimProCode', type: 'string'}    ]);    var detailCfgGrid = new Ext.grid.GridPanel({        height:480,        store: detailStore,        cm: detailColumnModel,        sm: new Ext.grid.RowSelectionModel({        	singleSelect: true,            listeners: {            	rowselect: function(sm, row, rec) {            		var id=rec.get("OPTLDetailItemRowid");            		var form=detailCfgForm.getForm();                	form.loadRecord(rec);                	//form.setValues({ID:id});                	               	if (id!="") {                 		form.findField("OPTLDetailItemCode").disable();                     		Ext.getCmp("showDimProCode").disable();                 	}else{                		form.findField("OPTLDetailItemCode").enable();                   		Ext.getCmp("showDimProCode").enable();                 	}                         	             	}            }        }),        bbar:new Ext.PagingToolbar({            pageSize: 21,            store: detailStore,            displayInfo: true,            displayMsg: '显示第 {0} 条到 {1} 条记录，一共 {2} 条',            emptyMsg: "没有记录"        })    });    var detailCfgForm = new Ext.FormPanel({        frame: true,        height: 145,        labelAlign: 'left',        bodyStyle:'padding:5px',        style: {        	//"margin-left": "10px", // when you add custom margin in IE 6...            "margin-right": Ext.isIE6 ? (Ext.isStrict ? "-10px" : "-13px") : "0"         },         labelAlign : 'right',    	height: 140,		labelWidth : 65,		bodyStyle : 'padding:5px',		layout : 'column',				items:[		{			columnWidth : .45,			layout : 'form',			defaultType : 'textfield',			items : [{							fieldLabel : 'ID',				            xtype:'textfield',				            name: 'OPTLDetailItemRowid',				            disabled:true,				            anchor:'85%'																},{							fieldLabel : '编码',				            xtype:'textfield',				            id: 'OPTLDetailItemCode',				            anchor:'85%'								}]			},{				columnWidth : .45,				layout : 'form',				defaultType : 'textfield',				//anchor:'85%',				items : [{								fieldLabel : '描述',								id: 'OPTLDetailItemDesc',								xtype:'textfield',								anchor:'85%'										},{								fieldLabel : '维度属性',								xtype:'compositefield',								anchor:'85%',																items:[{									id: 'KPIDetailItemDimProCode',									name: 'KPIDetailItemDimProCode',									xtype:'textfield',									//width:331,									flex:9,									disabled:true								},{									id: 'showDimProCode',									xtype:'button',									//anchor:'85%' ,									flex:1,									icon: '../images/uiimages/search.png',									handler:OnShowDimProCode								}]								//disabled:true										}]			}		],        /*        layout: 'table',        defaultConfig:{width:140},        layoutConfig: {columns:12},        items:[{        	html: 'ID：'        },{            xtype:'textfield',            name: 'OPTLDetailItemRowid',            disabled:true,            anchor:'85%'        },{        	html: '编码：'        },{            xtype:'textfield',            id: 'OPTLDetailItemCode',            anchor:'85%'        },{            html: '描述：'        },{            id: 'OPTLDetailItemDesc',            xtype:'textfield',            anchor:'85%'        },{            html:'维度属性：'        },{        	id: 'KPIDetailItemDimProCode',        	name: 'KPIDetailItemDimProCode',            xtype:'textfield',            anchor:'85%',            disabled:true        },{        	width:30,            id: 'showDimProCode',            xtype:'button',            anchor:'85%' ,            icon: '../images/uiimages/search.png',            handler:OnShowDimProCode        }],        */         tbar:new Ext.Toolbar([{            text: '<span style="line-Height:1">新增</span>',            icon: '../images/uiimages/edit_add.png',            handler: OnAddItem        }, '-', {        	text: '<span style="line-Height:1">保存</span>',		        	icon: '../images/uiimages/filesave.png',            handler: OnSaveItem        },'-',{        	text: '<span style="line-Height:1">删除</span>',        	icon: '../images/uiimages/edit_remove.png',            handler: OnDelItem    	},'-',{text: '<span style="line-Height:1">查询</span>',    		icon: '../images/uiimages/search.png',            handler: OnSearch        },'-',{            text: '<span style="line-Height:1">清空</span>',		            icon: '../images/uiimages/clearscreen.png',            handler: OnClear        }]) //}]    });    detailStore.load({params:{start:0,limit:21}});       var detailCfgPanel =new Ext.Panel({    	title:'明细统计项配置',    	layout:'border',        items: [{        	region: 'north',            height: 120,			layout:'fit',            items:detailCfgForm        },{        	region:'center',			layout:'fit',            //autoScroll:true,            items:detailCfgGrid    	}]/*,    	listeners:{    		"resize":function(win,width,height){    			detailCfgGrid.setHeight(height-150);    			detailCfgGrid.setWidth(width-15);    		}    	}*/    });    //以下为对外的接口方法。    function OnAddItem(){    	    	var cnt=detailStore.getCount();    	if (cnt>0) {	    	firstRec=detailStore.getAt(0);	    	var id=firstRec.get("OPTLDetailItemRowid");	    	if (id=="") return;	    	}    	        var initValue = {OPTLDetailItemRowid:'',OPTLDetailItemCode:'',OPTLDetailItemDesc:'',KPIDetailItemDimProCode:''};        var p = new detailRecord(initValue);        detailCfgGrid.stopEditing();        detailStore.insert(0, p);        var sm = detailCfgGrid.getSelectionModel();        sm.selectFirstRow();    }            function OnDelItem(){    	var sm = detailCfgGrid.getSelectionModel();        var record = sm.getSelected();        if(!sm||!record){       		alert("请选择要删除的类型！");       		return;       	}        Ext.Msg.confirm('信息', '确定要删除？', function(btn){            if (btn == 'yes') {                var id=record.get("OPTLDetailItemRowid");                         		var url=serviceUrl+'?action=del&OPTLDetailItemRowid='+id;             		 		dhcwl.mkpi.Util.ajaxExc(url,null,function(jsonData){						if(jsonData.success==true && jsonData.tip=="ok"){							if(jsonData.TipMsg){									Ext.MessageBox.alert("提示",jsonData.TipMsg);									return;								}							else{									//刷新grid  									outThis.clearForm();									refresh();							}													}else{							Ext.Msg.alert("提示","操作失败！");							}													},this);	                              }        });    }             function OnSaveItem() {    	var form=detailCfgForm.getForm();        var values=form.getValues(false);        var sm = detailCfgGrid.getSelectionModel();        var record = sm.getSelected();        if(!sm||!record){       		Ext.Msg.alert("提示","请选择要保存的数据！");       		return;        }        var ID=record.get("OPTLDetailItemRowid");        var itemCode=Ext.get('OPTLDetailItemCode').getValue();        var reg=/[\$\#\@\&\%\!\*\^\~||_]/;        var reg2=/^\d/;        if(reg.test(itemCode)||(reg2.test(itemCode))){        	alert("编码不能包括$,#,@,&,%,*,^,!,~,||,_等特殊字符，并且不能以数字开头！");        	Ext.get("RptCode").focus();        	return;        }                var itemDesc=Ext.get('OPTLDetailItemDesc').getValue();        var dimProCode=Ext.get('KPIDetailItemDimProCode').getValue();        if(!itemCode||!itemDesc||!dimProCode){        	Ext.Msg.alert("提示","要保存的数据不完整！");        	return;        }        paraValues='ID='+ID+'&itemCode='+itemCode+'&itemDesc='+itemDesc+'&dimProCode='+dimProCode+'&dimProDR='+dimProDR;                       var url=serviceUrl+'?action=addOPTLDetailItem&'+paraValues		dhcwl.mkpi.Util.ajaxExc(url,null,function(jsonData){				if(jsonData.success==true && jsonData.tip=="ok"){					//刷新grid  					refresh();				}else{					Ext.Msg.alert("提示","操作失败！");					}				},this);	                   }             function OnClear() {    	outThis.clearForm();    	return;     }      function OnSearch() {        var DetailItemCode=Ext.get('OPTLDetailItemCode').getValue();        var DetailItemDesc=Ext.get('OPTLDetailItemDesc').getValue();        var KPIDetailItemDimProCode=Ext.get('KPIDetailItemDimProCode').getValue();        paraValues='DetailItemCode='+DetailItemCode+'&DetailItemDesc='+DetailItemDesc+'&KPIDetailItemDimProCode='+KPIDetailItemDimProCode;        detailStore.proxy.setUrl(encodeURI(serviceUrl+"?action=search&"+paraValues+"&start=0&limit=21&onePage=1"));    	detailStore.load();		detailCfgGrid.show();    }        function OnShowDimProCode(){    	selectDimProWin.show();		storeDimPro.load();		    }        function refresh(){		detailCfgGrid.getStore().proxy.setUrl(encodeURI(serviceUrl+'?action=search&start=0&limit=21&onePage=1'));		detailCfgGrid.getStore().load();	    detailCfgGrid.show();      	    }        this.getDetailItemPanel=function(){    	return detailCfgPanel;    }           this.clearForm=function(){    	var form=detailCfgForm.getForm();    	form.setValues({OPTLDetailItemRowid:'',OPTLDetailItemCode:'',OPTLDetailItemDesc:'',KPIDetailItemDimProCode:''});    }    		/*****************************************维度属性选取窗口***************************************************/	var columnModelDimPro = new Ext.grid.ColumnModel([		new Ext.grid.RowNumberer(),		{header:'ID',dataIndex:'ID', width: 30, sortable: true         },{header:'编码',dataIndex:'Code', width: 70, sortable: true         },{header:'名称',dataIndex:'Name', width: 80, sortable: true         },{header:'描述',dataIndex:'Desc',resizable:'true',width:88        }    ]);	//定义指标的存储模型    var storeDimPro = new Ext.data.Store({        proxy: new Ext.data.HttpProxy({url:serviceUrl+'?action=selectDimPro&start=0&limit=15'}),        reader: new Ext.data.JsonReader({            totalProperty: 'totalNum',            root: 'root',        	fields:[				{name: 'ID'},            	{name: 'Code'},            	{name: 'Name'},            	{name: 'Desc'}       		]    	})    });    	//定义指标的显示表格。	var gridPanelDimPro = new Ext.grid.GridPanel({		id:"gridPanelDimPro",        //width:500,        height:370,        resizeAble:true,        //autoHeight:true,        enableColumnResize :true,        store: storeDimPro,        cm: columnModelDimPro,		viewConfig:{			forceFit: true		},        //autoScroll: true,        bbar:new Ext.PagingToolbar({            pageSize: 15,            store: storeDimPro,            displayInfo: true,            displayMsg: '显示第 {0} 条到 {1} 条记录，一共 {2} 条',            emptyMsg: "没有记录"        }),        listeners :{        	'rowdblclick':function(ele,event){				var sm = gridPanelDimPro.getSelectionModel();				if(!sm) return;				var record = sm.getSelected();        		if(!record) return;				dimProDR = record.get("ID");				dimProCode = record.get("Code");				//	回填               	detailCfgForm.getForm().findField('KPIDetailItemDimProCode').setValue(dimProCode);				Ext.getCmp('selectDimProWin').hide();			}		}    });			//	定义指标选取窗口	var selectDimProWin = new Ext.Window({		id:'selectDimProWin',		title:'维度属性选取',        width:800,		height:400,		resizable:false,		closeAction:'hide',		layout:'border',		modal:true,		items:[{			region:'center',			items:gridPanelDimPro		}],		listeners:{			'close':function(){				this.hide();			}		}	});    }