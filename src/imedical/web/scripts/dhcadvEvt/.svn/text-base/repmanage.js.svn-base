/// Creator: CongYue
/// CreateDate: 2016-03-29
/// Description: 后台管理评价
var url="dhcadv.repaction.csp";
var armaID="",RepID="",RepType="",EpisodeID=""
$(function(){
	
    RepID=getParam("RepID");
    RepType=getParam("RepType");
    armaID=getParam("armaID");
 	//所发生不良事件类别
	$('#MainCat').combobox({
		panelHeight:"auto",  //设置容器高度自动增长
		url:url+'?action=SelMainCat',
		onSelect: function(rec){    
           var armaCatDr=rec.value;  
			Combobox(armaCatDr);        
			}
	}); 
	//处理办法
	$('#DealMethod').combobox({
		panelHeight:"auto",  //设置容器高度自动增长
		url:url+'?action=SelDealMethod'
	});
	//改进办法
	$('#ImpMethod').combobox({
		panelHeight:"auto",  //设置容器高度自动增长
		url:url+'?action=SelImpMethod'
	}); 
	//复选框按钮事件
	$("input[type=checkbox]").each(function(){
		$(this).click(function(){
			$(this).is(':checked');
			//setCheckBoxRelation(this.id);
		});
	});
	//复选框分组
	InitUIStatus();
	RepManageInfo(RepID);
})
///初始化界面复选框事件
function InitUIStatus()
{
	var tmpid="";
	$("input[type=checkbox]").click(function(){
		tmpid=this.id;
		if($('#'+tmpid).is(':checked')){
			$("input[type=checkbox][name="+this.name+"]").each(function(){
				if((this.id!=tmpid)&($('#'+this.id).is(':checked'))){
					$('#'+this.id).removeAttr("checked");
				}
			})
		}
	});
}
/// 保存管理评价信息
function saveRepManage()
{
	//1、不良事件等级
	var adrlevel="";
    $("input[type=checkbox][name=adrlevel]").each(function(){
		if($(this).is(':checked')){
			adrlevel=this.value;
		}
	})
	//2、所发生不良事件类别
	var MainCat=$('#MainCat').combobox('getValue');
	//3、二级类别
	var SubCat=$('#SubCat').combobox('getValue');
	if (SubCat==undefined){
		SubCat=""
		}
	//4、处理办法
	var DealMethod=$('#DealMethod').combobox('getValue');   
	
	//5、改进办法
	var ImpMethod=$('#ImpMethod').combobox('getValue');   
	
	//6、不良事件评价
	var adrAdvice=$('#adrAdvice').val();

	//7、持续改进措施
	var adrImprovie=$('#adrImprovie').val();
	if(SubCat!=""){
		MainCat=SubCat
		}
	var params=armaID+"^"+RepType+"^"+RepID+"^"+adrlevel+"^"+MainCat+"^"+DealMethod+"^"+ImpMethod+"^"+adrAdvice+"^"+adrImprovie;
	
	//alert(params);
	
	$.post(url+'?action=SaveRepManage',{"params":params},function(data){
		var armaArr=data.split("^");
		if (armaArr[1]>0) {
			
			$.messager.alert("提示","评估成功!");
	      	//window.parent.CloseWin();		
	    }else
	    {
		  	 $.messager.alert("提示:","评估失败!");
		}
	});
	
}
//加载后台管理信息
function RepManageInfo(RepID)
{
	if(RepID==""){return;}
		//获取报表信息
 	$.ajax({
   	   type: "POST",
       url: url,
       data: "action=GetRepManageInfo&adrRepID="+RepID,
       success: function(val){
	        var tmp=val.split("!");
	        armaID=tmp[1];
	        if (armaID!=undefined)
			{
			$('#adrleve'+tmp[2]).attr("checked",true);   //不良事件等级
			$('#MainCat').combobox('setValue',tmp[3]);    //一级类别
			Combobox(tmp[3]);
			$('#SubCat').combobox('setValue',tmp[4]);     //二级类别
			
			$('#DealMethod').combobox('setValue',tmp[5]);   //处理办法
			$('#ImpMethod').combobox('setValue',tmp[6]);   //改进办法
			$('#adrAdvice').val(tmp[7]); //不良事件评价
			$('#adrImprovie').val(tmp[8]); //持续改进措施
			} 
			else {
				armaID=""
			}
	   } ,
       error: function(){
	       alert('链接出错');
	       return;
	   }
 
	});
    
}

function Combobox(dr){
            //二级类别  
            $('#SubCat').combobox({
				panelHeight:"auto",  //设置容器高度自动增长
				url:url+'?action=SelSubCat&params='+dr
			});    
	
	}
