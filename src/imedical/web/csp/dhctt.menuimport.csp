<html>

<head>
	<DHCTT:HEAD/>
	<script language="JavaScript" type="text/javascript" src="/csp/broker/cspxmlhttp.js"></script>
	<script language="JavaScript" type="text/javascript" src="/csp/broker/cspbroker.js"></script>
	<SCRIPT language="CACHE" RUNAT=SERVER>
		s InputType = $g(%request.Data("InputType",1))
		s RemoteImport = $s(InputType="Local":0,1:1)
		s filename = $g(%request.Data("RemoteFileName",1))
		Set pypath = ##class(ext.util.String).GetPhysicalPath("","/temp/menuxml/")
		if 'RemoteImport,$d(%request.MimeData("LocalFileName",1)) {
			;s filename = $g(%request.Data("LocalFileName",1))
			Set fileStream = %request.MimeData("LocalFileName",1)		
			;提交fileStream是%CSP.BinaryStream对象 
			Set filename = fileStream.FileName
			//IE------filename=D:\xml\www.xml
			//Chrome--filename=www.xml
			Set filename = $p(filename,"\",$l(filename,"\"))
			Set filename = $p(filename,"/",$l(filename,"/"))
			do ##class(%File).CreateDirectoryChain(pypath)
			Set fileAllName = ##class(%File).NormalizeFilename(pypath_"/"_filename)
			;w fileAllName
			Set file = ##class(%FileBinaryStream).%New()
			Set file.Filename=fileAllName
			Do file.Rewind()
			do file.CopyFromAndSave(fileStream)
			Do file.%Save()
			do file.%Close()
			s file=""
			Set filename = fileAllName
			;w filename_","_fileStream
		}else{
			if ($d(%request.Data("preLocalFileName",1)) && (""'=$g(%request.Data("preLocalFileName",1)))){
				Set filename=%request.Data("preLocalFileName",1)
				Set filename = $p(filename,"\",$l(filename,"\"))
				Set filename = $p(filename,"/",$l(filename,"/"))
				Set filename = ##class(%File).NormalizeFilename(pypath_"/"_filename)
			}
		}
	</SCRIPT>
</head>	
<body>
	<form enctype="multipart/form-data" action="dhctt.menuimport.csp" method='post'>		
		<table>			
			<tr><td>导入菜单:</td></tr>
			<tr><td></td>
				<td>
					<input type='radio' name="InputType" value="Local" #($s(RemoteImport:"",1:"checked"))# onclick="locationchange(1);">本地				
					<input type='radio' name="InputType" value="Remote" #($s(RemoteImport:"checked",1:""))# onclick="locationchange(0);">服务器
				</td>
			</tr>
			<tr><td></td><td>
				<div id="id_remote" style='#($s(RemoteImport:"display:block",1:"display:none"))#' nowrap="">
				
					<input type="text" name="RemoteFileName" id="RemoteFileName" size="60" value="#($g(%request.Data("RemoteFileName",1)))#">
					<input type="button" name="RemoteBrowse" value="Browse..." onclick="return gotoBrowse('1','Wizard=Open&amp;Wild=*.xml');">
				</div>
				<div id="id_local" style='#($s('RemoteImport:"display:block",1:"display:none"))#' nowrap="">
					<input type="file" name="LocalFileName" id="LocalFileName" value="#($g(%request.Data("LocalFileName",1)))#">
				</div>
				<input name="preLocalFileName" value="#($g(filename))#" type="hidden">
			</td>
			<tr>
				<td></td><td></td><td><input id="Open" name='Open' value="Open" type='submit' ></td>
			</tr>
		</table>
		<SCRIPT language="CACHE" RUNAT=SERVER>
			IF ($g(%request.Data("Open",1))="Open"){
				s ExistsFlag=##Class(%File).Exists(filename)
				q:ExistsFlag'=1 "Error: "_filename_"  does not exist !"
				s reader = ##class(%XML.Reader).%New()
				s stream=##class(%FileCharacterStream).%New()
				s stream.Filename=filename
				s sc=reader.OpenStream(stream)
				d reader.Correlate("Menu","web.Util.Menu")
				w "请选择文件"_##class(%File).GetFilename(filename)_"内的菜单"				
				w "<table style='margin-left: 20px;' border='1' >"
				w "<tr style='background:wheat'>",!
				w "	<td colspan='3' align='left'>",!
				w "		<input type='button' name='SelectAll' value='Select All' onclick='toggleCheckboxes(true);'>",!
				w "		<input type=""button"" name=""UnselectAll"" value=""Unselect All"" onclick=""toggleCheckboxes(false);"">",!
				w "		<input type=""submit"" name=""OK"" id=""OK"" value=""Import"" onclick=""return validate();"">",!
				w "		<input type=""checkbox"" name=""overload"" id=""overload"" value=""1"">覆盖导入",!
				w "	</td>",!
				w "</tr>",!
				w "<tr style='background:wheat'><td>描述</td><td>菜单名</td><td>是否已存在</td></tr>"
				s count=0
				While reader.Next(.obj,.sc) 
				{
					s tmpId = ##class(websys.Menu).GetIdFromCodeOrDescription(obj.Name)
					s count=count+1
					w "<tr><td><input id='cbz"_count_"' name='cbz"_count_"' value='"_obj.Name_"' type='checkbox'>"_obj.Caption_"</td><td>"_obj.Name_"</td><td>"_$s(tmpId>0:"Yes",1:"No")_"</td></tr>"
				}
				w "</table>"
				w "<tr style='background:wheat'><td cols=""3"">菜单数: "_count_"<input type=""hidden"" name=""TotalRows"" id=""TotalRows"" value="_count_"></td></tr>",!
				d stream.%Close()
				s stream = ""
				d reader.%Close()
				s reader = ""				
			}
		</SCRIPT>
	</form>
	<SCRIPT language="CACHE" RUNAT=SERVER>
			IF ($g(%request.Data("OK",1))="Import"){
				d ##class(web.Util.MenuService).ImportProxy(filename,.SuccList)	
				s name="",count=0
				f  s name=$o(SuccList(name)) q:name=""  d
				.s count=count+1
				.w "导入 ."_SuccList(name)_"("_name_")","<br>"
				w " 成功导入 "_count_" 菜单"	
			}
		</SCRIPT>
	<script language = "javascript">		
		function update(v){
			document.getElementById("RemoteFileName").value = v;
	
		}
		function launchPopupWindow(page,features,pageName)
		{
			if (features == null) {
				features = "status,scrollbars,resizable";
			}
			var wid = self.screen.width;
			var hgt = self.screen.height;
			wid = wid * 0.8;
			hgt = hgt * 0.8;
			var top = self.screen.height * 0.1;
			var left = self.screen.width * 0.1;
		  	var id = '$ID1=';
		  	var questionmark = page.split("?");
		  	var url;
		  	if (questionmark.length > 1) {
			  	url = escape(questionmark[0]) + "?" + questionmark[1];
			  	url = url + "&" + id;
		  	} else {
			  	url = page + "?" + id;
		  	}
			if (pageName == null) {
				pageName = 'autopagePopup';
			}
			self.autopagePopupWindow = window.open(url,pageName,'left='+left+',top='+top+',width='+wid+',height='+hgt+(features==''?'':','+features));
			self.autopagePopupWindow.focus();
		}
		function gotoBrowse(number,param)
		{
			if (number == 1) var remotefile = document.getElementById("RemoteFileName").value;
			else var remotefile = document.getElementById("LocalFileName").value;
			var url = "/csp/sys/UtilFileSelect.csp?$NAMESPACE=DHC-APP&Dir=" + cspEncodeUTF8(remotefile) + "&" + param;
			return launchPopupWindow(url);
		}
		function legacyFormat(thisForm)
		{
			var legacy = document.getElementById("LegacyFormat");
			if (thisForm.ExportFormat.options[thisForm.ExportFormat.selectedIndex].value == "GO") {
				legacy.style.display = "block";	
			} else {
				legacy.style.display = "none";
			}
		}
		// make sure user has entered a file name
		function validate()
		{
			var cb,count=0;
			var TotalRows = document.getElementById("TotalRows").value;
			for (var i = 1; i <= TotalRows; i++) {
				cb = self.document.getElementById("cbz"+i);
				if(cb.checked){
					count += 1;
				}
			}
			if(count==0){
				alert("没有选中菜单!");
				return false;
			}
			return true;
		}
		// generic function called from /csp/sys/UtilFileSelect.csp
		function update(remotefile)
		{
			document.getElementById("RemoteFileName").value = remotefile;
		}
		function locationchange(islocal)
		{
			//var namespace = document.getElementById("$NAMESPACE").value;
			//var linkPageName = document.getElementById("linkPageName").value;
			//var ImportLocalPage = document.getElementById("ImportLocalPage").value;	
			if (islocal == 0) {
				document.getElementById("id_remote").style.display = "block";
				document.getElementById("id_local").style.display = "none";	
				//document.expform.target = "";	
				//document.expform.action = linkPageName+"NAMESPACE="+cspEncodeUTF8(namespace);	
				//document.getElementById("id_loadAll").style.display = "block";
			} else {
				document.getElementById("id_remote").style.display = "none";
				document.getElementById("id_local").style.display = "block";
				//document.expform.target = "new";		
				//document.expform.action = ImportLocalPage+"NAMESPACE="+cspEncodeUTF8(namespace);	
				//if (document.getElementById("id_loadAll")) {
				//	document.getElementById("id_loadAll").style.display = "none";
				//}
			}
		}
		function changeLoadAll(ischecked)
		{
			if (ischecked) {
				document.getElementById("idLoadAll").style.display = "block";
				document.getElementById("SHOWCONTENT").disabled = true;		
			} else {
				document.getElementById("idLoadAll").style.display = "none";
				document.getElementById("SHOWCONTENT").disabled = false;	
			}	
		}
		function confirmAll()
		{
			var ok = confirm('Are you sure you want to import all classes from the directory? Make sure you have entered a directory.');
			if (ok != true) document.getElementById("submitok").value = "false";
			else document.getElementById("submitok").value = "true";
		}
		function toggleCheckboxes(cbState){
			var cb;
			var TotalRows = document.getElementById("TotalRows").value;
			for (var i = 1; i <= TotalRows; i++) {
				cb = self.document.getElementById("cbz"+i);
				cb.checked = cbState;
			}
		}
	</script>	
</body>
</html>
