<!--csp:nur.hisui.taskoverview.config.csp-->
<csp:method name=OnPreHTTP
            arguments=""
            returntype=%Boolean>
    i ##Class(ext.websys.SessionEvents).SessionExpired() q 1 
    q 1
</csp:method>
<html lang="zh-CN">
<head>
	<meta http-equiv="Content-Type"
		  content="text/html; charset=utf-8">
	<title>
	<EXTHEALTH:TRANSLATE id=title>##(%session.Get("TITLE"))##</EXTHEALTH:TRANSLATE>
	</title>
	<EXTHEALTH:HEAD></EXTHEALTH:HEAD>
	<HISUI/>


	<style>
	body{opacity: 0; transition: opacity 0.2s}
    body.active{opacity: 1}
	body{
		background-color:#FFF;	
	}
	.search-table{
		border-collapse:separate;
		border-spacing:0 10px;
	}
	.r-label{
		padding-left: 10px;
	}
	.tdlabel{
		text-align:right;
		width:140px;	
		padding-right: 20px;
	}
	.ant-form-item-required:before {
	    display: inline-block;
	    margin-right: 4px;
	    color: #f5222d;
	    font-size: 14px;
	    font-family: SimSun,sans-serif;
	    line-height: 1;
	    content: "*";
	}
	#myWin tr{
		display:block;
		margin-top:5px;	
	}
	#form-save div.panel{
		margin-top:10px !important;
	}
	span.exeRule{
		border: 1px solid #40A2DE;
	    display: inline-block;
	    width: 60px;
	    text-align: center;
	    height: 30px;
	    line-height: 30px;
	    cursor: pointer;
		
	}
	.bgselect{
		background-color:#40A2DE;
		border: 1px solid #40A2DE !important;
		color:#fff;
	}
</style>
<script language="cache" runat="SERVER">

    s taskId = $G(%request.Data("taskId", 1))
	s hospId = $G(%request.Data("hospId", 1))
	
</script>
<script language="javascript">
     
	    var taskId = "#(taskId)#";
		var hospId = "#(hospId)#";
		
	</script>
</head>
<body>
	
	<div>
  	<form id="form-save" method="post" data-options="fit:true,border:false,plain:true">
			
		
 			<div class="hisui-panel" title="基本信息" style="width:560px;" data-options="headerCls:'panel-header-gray',iconCls:'icon-paper',closable:false,collapsible:false,minimizable:false,maximizable:false">
	 			<table id="addInfo" style="width:100%">
					 <tr>
					   <td class="tdlabel"><label class="ant-form-item-required">代码</label></td>
					   <td><input id="taskCode" name="taskCode" type="text" class="textbox hisui-validatebox" style="width:350px"></td>
					 </tr>
					 <tr>
					   <td class="tdlabel"><label class="ant-form-item-required">常规护理任务描述</label></td>
					   <td><input id="taskDesc" name="taskDesc" type="text" class="textbox hisui-validatebox" style="width:350px"></td>
					 </tr>
					 <tr>
					   <td class="tdlabel"><label class="ant-form-item-required">任务属性</label></td>
					   <td><input  id="taskAttr" name="taskAttr" type="text" class="textbox hisui-validatebox" style="width:200px"></td>
					 </tr>	
					 <tr>
					   <td class="tdlabel"><label class="ant-form-item-required">任务项</label></td>
					   <td><input  id="taskItem" name="taskItem" type="text" class="textbox hisui-validatebox" style="width:350px;"></td>
					 </tr>	 	 								
				</table >
 			</div>
 			<div id="condion-panel-one" >
				<div class="hisui-panel" title="关联条件" style="width:560px;" data-options="headerCls:'panel-header-gray',iconCls:'icon-paper',closable:false,collapsible:false,minimizable:false,maximizable:false">
		 			<table id="addtable" style="width:100%">
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">类型</label></td>
						   <td><input  type="text" id="type" name="type" class="textbox hisui-validatebox" style="width:200px">
						   		<a href="#" style="display:none;" id="vsReminder_sb" name="vsReminder_sb" class="hisui-linkbutton" data-options="iconCls:'icon-tip',plain:true"></a>

						   
						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">关联体征项</label></td>
						   <td><input  type="text" id="relationSign" name="relationSign" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">关联事件项</label></td>
						   <td><input  type="text" id="relationEvents" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">根据频次展示</label></td>
						   <td>
						   <input class="hisui-radio" id="showByFreq" type="radio" label="" name="highestDegree" value="doctor" data-options="radioClass:'hischeckbox_square-blue',required:true">
						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">关联医嘱项</label></td>
						   <td><input  type="text" id="relationDocAdvices" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 
						 
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">关联评估项</label></td>
						   <td><input  type="text" id="relationAssess" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">关联评估日期</label></td>
						   <td><input  type="text" id="careDate" name="careDate" readonly class="textbox hisui-validatebox" style="width:200px;background:#ddd">
						   <a href="#" id="vsReminder_tip" class="hisui-linkbutton" data-options="iconCls:'icon-tip',plain:true"></a>
						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">关联评估时间</label></td>
						   <td><input  type="text" id="careTime" name="careTime" readonly class="textbox hisui-validatebox" style="width:200px;background:#ddd"></td>
						 </tr>											
					</table >
	 			</div>
 			</div>

 			<div id="condion-panel-two">
	 			<div class="hisui-panel" title="关联条件生效后执行规则" style="width:560px;" data-options="headerCls:'panel-header-gray',iconCls:'icon-paper',closable:false,collapsible:false,minimizable:false,maximizable:false">
		 			<table id="addCondion" style="width:100%">
		 				<tr>
						   <td class="tdlabel"><label class="ant-form-item-required">生效公式</label></td>
						   <td><input  type="text" placeholder="多个公式以符号@拼接，关系为且" id="relationFormula" name="relationFormula" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">执行类型</label></td>
						   <td><input  type="text" id="rationIntervalType" name="rationIntervalType" class="textbox hisui-validatebox" style="width:200px"></td>
						 </tr>
						<tr>
						   <td class="tdlabel"><label class="ant-form-item-required">需执行班次</label></td>
						   <td><input  type="text" id="relationExeShift" name="relationExeShift" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">执行模式</label></td>
						   <td><input  type="text" id="relationExeMode" name="relationExeMode" class="textbox hisui-validatebox" style="width:200px"></td>
						 </tr>
						<tr>
						   <td class="tdlabel"><label class="ant-form-item-required">当日需执行规则</label></td>
						 
						   <td>
						   		<input  type="text" id="relationTodayExeRule" name="relationTodayExeRule" value="3" class="textbox hisui-validatebox">
						   		<!--<div>
						    			<span showId="relationTodayExeTime" class="exeRule bgselect" value="3">时间</span><span class="exeRule" showId="relationUDNum" value="4" style="border-left: 1px solid #fff;">自定义</span>
					
						   		</div>
						   -->
						   </td>
						 </tr>
						<tr>
						   <td class="tdlabel"><label>当日需执行时间</label></td>
						   <td>
						   		<input  type="text" id="relationUDOperator" name="relationUDOperator" class="textbox hisui-validatebox" style="width:120px">
						   		<input  type="text" id="relationUDNum" name="relationUDNum" class="textbox hisui-numberbox" style="width:80px">
						   		<input  type="text" id="relationUDUnit" name="relationUDUnit" class="textbox hisui-validatebox" style="width:80px">
						   </td>
						 </tr>
						
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">当日需执行班次</label></td>
						   <td>
						   <input  type="text" id="relationTodayExeShift" name="relationTodayExeShift" class="textbox hisui-validatebox" style="width:350px">
						   
						   </td>
						 </tr>
						
						 <tr>
						   <td class="tdlabel"><label>当日需执行时间</label></td>
						   <td><input  type="text" id="relationTodayExeTime" name="relationTodayExeTime" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label>非当日需执行规则</label></td>
						   <td>
						   <input  type="text" id="relationNotTodayExeRule" name="relationNotTodayExeRule" class="textbox hisui-validatebox">
						   		
						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">固定天</label></td>
						   <td><input  type="text" id="rationFixedCycle" name="rationFixedCycle" class="textbox hisui-validatebox" style="width:350px">
						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label>非当日需执行班次</label></td>
						   <td>
						   <input  type="text" id="relationNotTodayExeShift" name="relationNotTodayExeShift" class="textbox hisui-validatebox" style="width:350px">
						   
						   </td>
						 </tr>
						 
						 <tr>
						   <td class="tdlabel"><label>非当日需执行时间</label></td>
						   <td><input  type="text"  id="relationNotTodayExeTime" name="relationNotTodayExeTime" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 
						 

						 <tr>
						   <td class="tdlabel"><label>间隔周期</label></td>
						   <td><input  type="text" id="relationIntervalPeriod" name="relationIntervalPeriod" class="textbox hisui-numberbox" data-options="isKeyupChange:true" style="width:100px">
						   	
						   	<input type="text" id="relationIntervalPeriodUnit" name="relationIntervalPeriodUnit"  class="textbox hisui-validatebox" style="width:80px">
						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label>持续周期</label></td>
						   <td><input  type="text" id="relationPeriod" name="relationPeriod" class="textbox hisui-numberbox" data-options="isKeyupChange:true" style="width:100px">
						   	<input  type="text" id="relationPeriodUnit" name="relationPeriodUnit" class="textbox hisui-validatebox" style="width:80px">
						   	<a href="#" id="vsReminder_cx" name="vsReminder_cx" class="hisui-linkbutton" data-options="iconCls:'icon-tip',plain:true"></a>

						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">执行方法</label></td>
						   <td><input  type="text" id="relationExeMethod" name="relationExeMethod" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>	 								
					</table >
	 			</div>
 			</div>
 			<div id="condion-panel-three" >
	 			<div class="hisui-panel" title="正常后执行规则" style="width:560px;" data-options="headerCls:'panel-header-gray',iconCls:'icon-paper',closable:false,collapsible:false,minimizable:false,maximizable:false">
		 			<table id="addCondion" style="width:100%">
		 				 <tr>
						   <td class="tdlabel"><label>正常值生效公式</label></td>
						   <td><input  type="text" id="normalFormula" name="normalFormula" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label>正常值持续周期</label></td>
						   <td><input  type="text" id="normalSustain" name="normalSustain" class="textbox hisui-numberbox" data-options="isKeyupChange:true" style="width:100px">
						   	<input  type="text"  id="normalSustainUnit" name="normalSustainUnit" class="textbox hisui-validatebox" style="width:80px">
						   </td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label>正常后需执行时间</label></td>
						   <td><input  type="text" id="normalExeTime" name="normalExeTime" class="textbox hisui-validatebox" style="width:350px"></td>
						 </tr>
						 <tr>
						   <td class="tdlabel"><label class="ant-form-item-required">正常后需执行规则</label></td>
						   <td><input  type="hidden" id="normalExeRule" name="normalExeRule" class="textbox hisui-validatebox">
						   <div><span class="exeRule">班次</span><span class="exeRule" style="border-left: 1px solid #fff;">时间</span></div>
						   
						   </td>
						 </tr>	
						 
						 <tr>
						   <td class="tdlabel"><label>正常后间隔周期</label></td>
						   <td><input  type="text" id="normalIntervalPeriod" name="normalIntervalPeriod" class="textbox hisui-numberbox" data-options="isKeyupChange:true" style="width:100px">
						   	<input  type="text"  id="normalIntervalPeriodUnit" name="normalIntervalPeriodUnit" class="textbox hisui-validatebox" style="width:80px">
						   </td>
						 </tr>	
						 <tr>
						   <td class="tdlabel"><label>正常后持续周期</label></td>
						   <td><input  type="text" id="normalPeriod" name="normalPeriod" class="textbox hisui-numberbox" data-options="isKeyupChange:true" style="width:100px">
						   	<input  type="text"  id="normalPeriodUnit" name="normalPeriodUnit" class="textbox hisui-validatebox" style="width:80px">
						   </td>
						 </tr>	
					</table>
				</div>
			</div>
			<div class="hisui-panel" title="其他配置" style="width:560px;" data-options="headerCls:'panel-header-gray',iconCls:'icon-paper',closable:false,collapsible:false,minimizable:false,maximizable:false">
	 			<table id="addOhter" style="width:100%">
	 				<tr>
					   <td class="tdlabel"><label class="ant-form-item-required">执行有效时间设定</label></td>
					   <td><input  type="text" id="exePeriod" name="exePeriod" class="textbox hisui-validatebox" style="width:200px"></td>
					 </tr>
					 <tr>
					   <td class="tdlabel"><label>适用患者</label></td>
					   <td><input  type="text" id="applyPatient" name="applyPatient" class="textbox hisui-validatebox" style="width:200px">
					   </td>
					 </tr>
					 <tr>
					   <td class="tdlabel"><label>排除条件生效方法</label></td>
					   <td><input  type="text" id="exclusions" name="exclusions" class="textbox hisui-validatebox" style="width:350px"></td>
					 </tr>
					 <tr>
					   <td class="tdlabel"><label>生效科室</label></td>
					   <td><input  type="text" id="validLocs" name="validLocs" class="textbox hisui-validatebox" style="width:350px"></td>
					 </tr>	
					 <tr>
					   <td class="tdlabel"><label>无效科室</label></td>
					   <td><input  type="text" id="invalidLocs" name="invalidLocs" class="textbox hisui-validatebox" style="width:350px">
					   </td>
					 </tr>
					 
					 
				</table>
			</div>
		</form>
  
  </div>
<div style="margin-bottom: 5px;display:none; " id="comboxSearch">
	<table>
		<tr>
			<td>
				<input class="textbox" class="startDayReport" style="width:170px;" placeholder="请输入任务描述"/>
			</td>

			<td>
				<a class="hisui-linkbutton btnTaskSearch"  data-options="iconCls:'icon-w-find'">查询</a>  
			</td>
		</tr>
	</table>
</div>
<script type="text/javascript">

$(function(){
	GetTaskOverNormOptions()
	GetTaskoverNormById();
	InitTip()
	$('body').addClass('active')
	$("body").on("click",".btnTaskSearch",function(){
		var id = $(this).parents("div.searchBtn").attr("id")
		var value = $(this).parents("div.searchBtn").find("input.startDayReport").val();
		var tid = id.split("-")[0]
		var type = id.split("-")[1]
		//var parmas = contorls[tid].parmas()
		//parmas.desc=value
		//var hospID = $HUI.combogrid('#_HospList').getValue();
		//parmas.hospID = hospID
		//console.log(id)
		var taskVal = $("#taskAttr").combobox("getValue");
		var parmas=""
		if(taskVal==1){
			parmas = contorls.relationSign.parmas()
		}else if(taskVal==2){
			parmas = contorls.relationAssess.parmas()
		}else if(taskVal==3){
			parmas = contorls.relationDocAdvices.parmas()
		}
		if(parmas !=""){ 
			parmas.desc=value
			$('#'+tid).combogrid("grid").datagrid("reload", parmas);
		}	
	})
	$("span.exeRule").on("click",function(){
		$(this).addClass("bgselect").siblings("span").removeClass("bgselect");	
		var value = $(this).attr("value")
		var showId = $(this).attr("showId")
		$(this).siblings("span").each(function(){
			var hideId = $(this).attr("showId");
			$("#"+hideId).parents("tr").hide()	
		})
		$("#"+showId).parents("tr").show();	
		$(this).parents("tr").find("input").val(value)
		
		
	})
	
	$("#relationIntervalPeriodUnit").val("DAY")
	
})

function InitTip(){
	var _content="<p>请在'病历表单分值字段配置'中设置</p>";
	
	$("#vsReminder_tip").popover({
		trigger:'hover',
		content:_content,
		style:'inverse'
	});
	$("#vsReminder_sb").popover({
		trigger:'hover',
		content:"根据频次展示",
		style:'inverse'
	});
	$("#vsReminder_cx").popover({
		trigger:'hover',
		content:"为空时，默认持续至当天",
		style:'inverse'
	});
}

var rsData={}
function GetTaskOverNormOptions(){
	runClassMethod("CF.NUR.NIS.TaskOverview","GetTaskOverNormOptions",{},function(data){
		rsData = data;
			var times=[]
			for(var i in rsData.timePoint){
				var text = rsData.timePoint[i]	
				var js ={
					"text":text,
					"value":text	
				}
				times.push(js)
			}
			rsData.times = times
			setContorlsData(rsData)
			//create(contorls)
	},'json',false);
}


function GetTaskoverNormById(){
		
	if(taskId !=""){
		runClassMethod("Nur.NIS.Service.TaskOverview.Setting","GetTaskoverNormById",{id:taskId},function(data){
				
			setContorlsValue(data);
		},'json',false);	
	}
	create(contorls)
}
/**编辑和查阅时，将值显示在控件中**/
function setContorlsValue(data){
	contorls.id = data.id
	for(var key in data){
		if(typeof(contorls[key])!='undefined'){
			contorls[key].values = data[key]
			var names = data[key+"Name"]
			if(typeof(names) !='undefined'){
				contorls[key].names = names
			}
		}
	}
	var value = contorls.taskAttr.values
	contorls.type.data=setTypeData(value)
	
	
	
	
	
	if(typeof(data.relationNotTodayExeRule)!='undefined'){
		$("#relationNotTodayExeRule").parents("tr").find("span[value='"+data.relationNotTodayExeRule+"']").trigger("click")
	}

	if(typeof(data.relationTodayExeRule)!='undefined'){	

		$("#relationTodayExeRule").parents("tr").find("span[value='"+data.relationTodayExeRule+"']").trigger("click")
	}
	
}
//动态设置类型的值
function setTypeData(value){
	
	var typeArrs = rsData.type;
	var typeObj  = {}
	for(var key in typeArrs){
		var val = typeArrs[key].value
		var txt = typeArrs[key].text
		typeObj[val] = txt
	}
	
	var keyArrs=[]
	var list = tempVals["taskAttr-"+value].type
	
	for(var key in list){
		var txt = typeObj[key]
		if(typeof(txt) !="undefined"){
			keyArrs.push({"value":key,"text":txt})
		}
	}
	
	return keyArrs
	
}
function create(contorls){
		$("#condion-panel-one,#condion-panel-two,#condion-panel-three").hide().find("tr").hide()
		$('#form-save').form('clear');
		$("#taskItem").parents("tr").hide()
		
		for(var cid in contorls){
			var obj = contorls[cid]
			if("combox"==obj.type){
				
				var queryName = obj.changeQuery
				var values = obj.values
				var defaultValue = obj.defaultValue
				if(typeof(queryName)!="undefined"){
					MethodCreate.combox(cid).combobox({"data":obj.data,"onChange":queryName})
				}else{
					MethodCreate.combox(cid).combobox({"data":obj.data})
				}
				if(typeof(values)!="undefined"){
					
					$("#"+cid).combobox("setValue",values)
				}else{
					
					if(typeof(defaultValue) !="undefined"){
						
						$("#"+cid).combobox("setValue",defaultValue)
					}
				}
			}else if("comboxIsMultiple"==obj.type){
				var values = obj.values
				MethodCreate.combox(cid).combobox({"data":obj.data,"multiple":true,'rowStyle':'checkbox'})
				if(typeof(values)!="undefined"){
					$("#"+cid).combobox("setValues",values)
				}
			}else if("combogrid"==obj.type){
				if(obj.classMethod !=""){
					
					MethodCreate.combogrid(cid,obj)	
				}
				var values = obj.values
				var names = obj.names
				if(typeof(values)!="undefined"){
					for(var k in values){
						insertComboValues(cid,values[k],names[k])
					}
				}
			}else if("input"==obj.type){
				var values = obj.values
				$("#"+cid).attr("autocomplete","off")
				if(typeof(values)!="undefined"){
					var isnumberbox = $("#"+cid).hasClass("numberbox")
					if(isnumberbox){
						
						$("#"+cid).numberbox("setValue",values)
					}else{
						$("#"+cid).val(values)
					}
				}
			}	
		}	
	}


/**动态创建下拉框和下拉多选框**/
var MethodCreate ={
	combox:function(id){
		$HUI.combo("#"+id,{
			valueField:"value",
			textField:"text",
			multiple:false,
			selectOnNavigation:false,
			panelHeight:"auto",
			width:257,
			editable:false
		});
		return $("#"+id)
	},
	combogrid:function(selector,obj) {
		
		var clsname = obj.classMethod;
		var quyname= obj.queryName;
		var columns = obj.columns();
		var parmas = obj.parmas()
		
		var seachText = obj.seachText;
		var searchhtml = $("#comboxSearch").html()
		var len = $('#'+selector+"-search").length
		var id = selector+"-search"
		if(len==0){
			//$(".startDayReport").attr("placeholder",seachText)
			var html = '<div style="margin-bottom: 5px; " class="searchBtn" id="'+id+'">'+searchhtml+'</div>'
			$("#comboxSearch").after(html)
		}
		$("#"+id).find(".startDayReport").attr("placeholder",seachText)
		var find = false;
		$("#"+selector).combogrid({
			panelWidth: 350,
			panelHeight: 350,
			editable: false,
			idField: 'id',
			textField: 'desc',
			columns: columns,
			pagination : true,
			url:$URL+"?ClassName="+clsname+"&QueryName="+quyname,
			fitColumns: true,
			toolbar: '#'+selector+"-search",
			pageSize:50,
			multiple: true,
			striped: true,
			mode:"remote",
			queryParams:parmas,
			loadFilter: function(obj) {
			  var arrs = []
			  $.each(obj.rows, function(index, value) {
	                if (isExitValue(selector,value.id)) {
	                    
	                    
	                    if("invalidLocs"==selector || "validLocs"==selector){
							value.desc=value.warddesc
							value.id = value.wardid
						}
	                    arrs.push(value)
	                }
	            });
			  obj.rows = arrs

			  return obj;
			},
			onBeforeLoad: function(data) {
				insertComboDiv(selector,obj)
				$("#"+selector).combogrid('grid').datagrid('clearSelections');
			},
			onClickRow:function(rowIndex, rowData){
				
				/*if("invalidLocs"==selector || "validLocs"==selector){
					rowData.desc=rowData.warddesc
					rowData.id = rowData.
					
				}*/
				var desc = rowData.desc
				var id = rowData.id	
				insertComboValues(selector,id,desc)
				$('#'+selector).combogrid("grid").datagrid("load");
				
				if("relationAssess"!=selector){
					return false;
					
				}
				
				runClassMethod("Nur.NIS.Service.VitalSign.TaskRule","GetAssessCareDate",{itemId:rowData.id},function(data){
					$("#careDate").val(data.careDate)
					$("#careTime").val(data.careTime)	
				},'json',false);
				

				return false
			}
		});
	}
}


function setContorlsData(rsData){
	console.log(rsData)
	contorls.applyPatient.data					=		rsData.patientType
	contorls.exePeriod.data						=		rsData.exeTime
	contorls.taskAttr.data						=		rsData.taskAttr
	contorls.type.data							=		rsData.type
	contorls.rationIntervalType.data			=		rsData.intervalType
	contorls.relationExeMode.data				=		rsData.exeMode
	contorls.relationIntervalPeriodUnit.data	=		rsData.periodUnit
	contorls.relationPeriodUnit.data			=		rsData.periodUnit
	//contorls.normalSustainUnit.data				=		rsData.periodUnit
	contorls.normalPeriodUnit.data				=		rsData.periodUnit
	contorls.normalIntervalPeriodUnit.data		=		rsData.periodUnit
	contorls.careDate.data						=		rsData.sqlFieldList
	contorls.careTime.data						=		rsData.sqlFieldList
	contorls.relationTodayExeTime.data			=		rsData.times
	contorls.relationNotTodayExeTime.data		=		rsData.times
	contorls.normalExeTime.data					=		rsData.times
	contorls.rationFixedCycle.data				=		rsData.fixedCycle
	
}

/**多选下拉框、自带检索功能***/
function insertComboDiv(selector,obj){
	var $input = $("#"+selector).siblings("span.combo").find("input.combo-text")
	var w = $input.width()
	var h = $input.height()
	$input.hide()
	$("#"+selector).siblings("span.combo").find("span.combo-arrow").hide()
	$("#"+selector).siblings("span.combo").css({"white-space":"normal","height":"auto"})
	$("#"+selector).find(".startDayReport").attr("placeholder",obj.seachText)
	var len = $("#"+selector).siblings("span.combo").find(".div-combo-text").length;
	if(len==0){
		$input.after('<div class="div-combo-text" style="display: inline-block;padding-bottom:5px;border:0px solid;width:100%;min-height:'+h+'px;"></div>')
		$("#"+selector).siblings("span.combo").find(".div-combo-text").on("click",function(event){
			event.stopPropagation()
			$input.trigger("click")
		})
	}
}
function isExitValue(selector,id){
	var $div = $("#"+selector).siblings("span.combo").find("div.div-combo-text")
	var len = $div.find('span[id="'+id+'"]').length
	if(len>0){
		return false	
	}
	return true
}
function insertComboValues(selector,id,desc){
	var $div = $("#"+selector).siblings("span.combo").find("div.div-combo-text")
	var len = $div.find('span[id="'+id+'"]').length
	if(len>0){
		//$div.find('span[id="'+id+'"]').remove()
	}else{
		if("relationAssess"==selector){
			$div.html('<span style="background-color: #fafafa;border-radius: 2px;padding-left: 3px;padding-right: 20px;border: 1px solid #e8e8e8;display: inline-block;margin: 5px 0px 0px 5px;position: relative;" id="'+id+'">'+desc+'<a style="width: 16px;height: 16px;display: inline-block;vertical-align: top;position: absolute;right:1px;bottom:1px" class="panel-tool-close" href="javascript:void(0)"></a></span>')
	
		}else{
			$div.append('<span style="background-color: #fafafa;border-radius: 2px;padding-left: 3px;padding-right: 20px;border: 1px solid #e8e8e8;display: inline-block;margin: 5px 0px 0px 5px;position: relative;" id="'+id+'">'+desc+'<a style="width: 16px;height: 16px;display: inline-block;vertical-align: top;position: absolute;right:1px;bottom:1px" class="panel-tool-close" href="javascript:void(0)"></a></span>')
		}
		$div.find("span a.panel-tool-close").on("click",function(event){
			event.stopPropagation()
			$(this).parent().remove()
			$('#'+selector).combogrid("grid").datagrid("load");	
			
		})
	}
}
function findShow(){
	$("#condion-panel-one,#condion-panel-two,#condion-panel-three").hide()
	$("#condion-panel-one").find("tr").each(function(){
		var display =$(this).css('display');
		if(display !="none"){
			$("#condion-panel-one").show()
		}
	})
	$("#condion-panel-two").find("tr").each(function(){
		var display =$(this).css('display');
		if(display !="none"){
			$("#condion-panel-two").show()
		}
	})
	$("#condion-panel-three").find("tr").each(function(){
		var display =$(this).css('display');
		
		if(display !="none"){
			$("#condion-panel-three").show()
		}
	})
	
	
}

function saveFunLib(flag){
	
	
	
	//var exeRuleValue = $("span.exeRule.bgselect").attr("value");	
	//$("#relationTodayExeRule").val(exeRuleValue)
	
	
	
	
	var parmas = {}
	var isNullValue=[]
	for(var cid in contorls){
		var obj=contorls[cid]
		var isDisplay = $('#'+cid).parents("tr").is(':hidden');
	 	if(isDisplay=='true' || isDisplay){
		 	continue;
		}
		var len = $("#"+cid).length
		if(len ==0){
			 continue;
		}
		var type = obj.type
		var value= ""
		if(type=="input"){
			value= $("#"+cid).val()
		}
		if(type=="combox"){
			value= $("#"+cid).combo("getValue")
		}
		if(type=="comboxIsMultiple"){
			value = $("#"+cid).combo("getValues")
		}
		if(type=="combogrid"){
			value=[]
			var $div = $("#"+cid).siblings("span.combo").find("div.div-combo-text")
			$div.find('span').each(function(){
				var val = $(this).attr("id")
				value.push(val)
			})	
		}
		
		var required = obj.required
		if(required=="true"){
			if(value.length==0){
				isNullValue.push(obj.name)
			}
		}
		parmas[cid]=value
	}
	
	if(isNullValue.length>0){
		$.messager.alert('提示',isNullValue[0]+'存在必填项未填写，请检查！' , "info");
		return false;	
	}
	
	parmas.id = flag==1?contorls.id:""
	parmas.hospID=hospId
	parmas.locId = session['LOGON.CTLOCID'];
	parmas.userId=session['LOGON.USERID']
	console.log(parmas)
	var rsflag = true;
	runClassMethod("CF.NUR.NIS.TaskOverview","AddOrUpdateTaskOverNorm",{data:JSON.stringify(parmas)},function(rtn){
		if(rtn == 0) {
			$.messager.popover({msg:'保存成功！',type:'success'});
		
		} else {
			parent.$.messager.alert('提示','保存失败！code已存在，不能重复。' , "info");
			
			rsflag = false
		}
		
	},'json',false);
	
	
	return rsflag
}

var contorls = {
			applyPatient:{
					type:"combox",
					name:"适用患者"
				},
			exePeriod:{
					type:"combox",
					name:"执行有效时间设定",
					required:"true",
					defaultValue:"0"
				},
			
			taskAttr:{
					name:"任务属性",
					type:"combox",
					required:"true",
					changeQuery:function(value,oldValue){
						$("#condion-panel-one,#condion-panel-two,#condion-panel-three").hide().find("tr").hide()
						$("#taskItem").parents("tr").show()
						$("#vsReminder_sb").hide();
						var classMethod=""
						var queryName=""
						var columns=""
						var parmas=""
						var obj=""
						if(value==1){
							classMethod=contorls.relationSign.classMethod	
							queryName=contorls.relationSign.queryName
							columns = contorls.relationSign.columns()	
							parmas = contorls.relationSign.parmas()	
							
							obj=contorls.relationSign
							
							$("#type").parents("tr").show();	
						}else if(value==2){
							classMethod=contorls.relationAssess.classMethod	
							queryName=contorls.relationAssess.queryName	
							columns = contorls.relationAssess.columns()	
							parmas = contorls.relationAssess.parmas()
							obj=contorls.relationAssess	
							$("#type").parents("tr").show();
						}else if(value==3){
							classMethod=contorls.relationDocAdvices.classMethod	
							queryName=contorls.relationDocAdvices.queryName
							columns = contorls.relationDocAdvices.columns()	
							parmas = contorls.relationDocAdvices.parmas()	
							obj = contorls.relationDocAdvices
							$("#relationDocAdvices,#type").parents("tr").show();
							$("#vsReminder_sb").show();
						}
						/*var typeArrs = contorls.type.data;
						var typeObj  = {}
						for(var key in typeArrs){
							var val = typeArrs[key].value
							var txt = typeArrs[key].text
							typeObj[val] = txt
						}
						var keyArrs = []
						var list = tempVals["taskAttr-"+value].type
						for(var key in list){
							var txt = typeObj[key]
							if(typeof(txt) !="undefined"){
								keyArrs.push({"value":key,"text":txt})
							}
						}
						console.log("张三")
						console.log(keyArrs)*/
						
						$("#type").combobox({'data':setTypeData(value)});
						//contorls.type.data=keyArrs
						MethodCreate.combogrid("taskItem",obj)
						$("div.div-combo-text").html('')
						findShow()
					}
				},
				
			type:{
					name:"类型",
					type:"combox",
					required:"true",
					changeQuery:function(value,oldValue){
					
						$("#condion-panel-two,#condion-panel-three").hide().find("tr").hide();	
						$("#rationIntervalType").parents("tr").siblings("tr").hide()
						var v = $("#taskAttr").combobox("getValue");
						var key = "taskAttr-"+v+"-type-"+value
						var showIds = tempVals["taskAttr-"+v]["type"][value]
						if(typeof(showIds) !="undefined"){
							$("#condion-panel-two").show();
							$("#type").parents("tr").siblings("tr").hide()
							$(showIds).parents("tr").show();
						}
						findShow()
					}
				},
			rationIntervalType:{
					name:"执行类型",
					type:"combox",
					changeQuery:function(value,oldValue){
						
						$("#rationIntervalType").parents("tr").siblings("tr").hide()
						var v = $("#taskAttr").combobox("getValue");
						var showIds = tempVals["taskAttr-"+v]["rationIntervalType"][value]
						$(showIds).parents("tr").show();
					}
				},
			relationExeMode:{
					name:"执行模式",
					type:"combox",
					changeQuery:function(value,oldValue){
						$("#relationExeMode").parents("tr").siblings("tr").hide()
						var v = $("#taskAttr").combobox("getValue");
						var showIds = tempVals["taskAttr-"+v]["relationExeMode"][value]
						$(showIds).parents("tr").show();
					}
				},
			relationIntervalPeriodUnit:{
					type:"combox",
					name:"间隔周期(单位)",
					defaultValue:"DAY"
				},
			relationPeriodUnit:{
					type:"combox",
					name:"持续周期(单位)",
					defaultValue:"DAY"
				},
			normalSustainUnit:{
					type:"combox",
					name:"回归正常持续周期(单位)",
					data:[{"text":"次","value":"TIME"},
					{"text":"天","value":"DAY"}],
					defaultValue:"DAY"
				},
			normalPeriodUnit:{
					type:"combox",
					name:"正常后持续周期(单位)",
					defaultValue:"DAY"
				},
			normalIntervalPeriodUnit:{
					type:"combox",
					name:"正常后间隔周期(单位)",
					defaultValue:"DAY"
				},
			relationUDUnit:{
					type:"combox",
					name:"自定义单位",
					data:[{"text":"小时","value":"HOUR"}]	//,{"text":"分钟","value":"MINUTE"}
				},
			relationUDOperator:{
					type:"combox",
					name:"自定义操作符",
					data:[{"text":"之前","value":"2"},
					{"text":"之后","value":"3"},
					{"text":"(12h)每间隔","value":"4"},
					{"text":"(24h)每间隔","value":"5"},
					/*{"text":"遵医嘱","value":"6"},*/
					]	
				},
				
			relationExeShift:{
					type:"comboxIsMultiple",
					name:"需执行班次"
				},
			relationNotTodayExeShift:{
					type:"comboxIsMultiple",
					name:"非当日需执行班次"
				},
			relationTodayExeShift:{
					type:"comboxIsMultiple",
					name:"当日需执行班次"
				},
			relationTodayExeTime:{
					type:"comboxIsMultiple",
					name:"当日需执行时间"
				},
			relationNotTodayExeTime:{
					type:"comboxIsMultiple",
					name:"非当日需执行时间"
				},
			normalExeTime:{
					type:"comboxIsMultiple",
					name:"正常后需执行时间"
				},
			rationFixedCycle:{
					type:"comboxIsMultiple",
					name:"固定周期"
				},
			invalidLocs:{
				type:"combogrid",
				name:"无效科室",
				classMethod:"Nur.NIS.Service.Base.Ward",
				queryName:"GetallWardNew",
				seachText:"请输入无效科室名称",
				parmas:function(){ 
					return {
						desc: $("#startDayReport").val(),
						hospid:hospId,
						bizTable:"Nur_IP_TaskOverviewNormal" 
					}
				},
				columns: function(){
					return [[{field:'warddesc',title:'名称',width:350}]]		
				}
			},
			validLocs:{
				type:"combogrid",
				name:"生效科室",
				classMethod:"Nur.NIS.Service.Base.Ward",
				queryName:"GetallWardNew",
				seachText:"请输入生效科室名称",
				parmas:function(){ 
					return {
						desc: $("#startDayReport").val(),
						hospid:hospId,
						bizTable:"Nur_IP_TaskOverviewNormal" 
					}
				},
				columns: function(){
					return [[{field:'warddesc',title:'名称',width:350}]]		
				}
			},
			taskItem:{
				type:"combogrid",
				name:"任务项",
				required:"true",
				classMethod:"",
				queryName:"",
				seachText:"请输入任务描述",
				parmas:function(){ 
					return {
						desc: $("#startDayReport").val(),
						hospID:hospId
					}
				},
				columns: function(){
					return [[{field:'desc',title:'名称',width:350}]]		
				}
			},
			relationSign:{
				type:"combogrid",
				name:"关联体征项",
				required:"true",
				classMethod:"Nur.NIS.Service.TaskOverview.Setting",
				queryName:"GetSignsItem",
				seachText:"请输入体征项",
				parmas:function(){ 
					return {
						desc: $("#startDayReport").val(),
						hospID:hospId
					}
				},
				columns: function(){
					return [[{field:'desc',title:'名称',width:350}]]		
				}
			},
			relationEvents:{
				type:"combogrid",
				name:"关联事件项",
				required:"true",
				classMethod:"Nur.NIS.Service.TaskOverview.Setting",
				queryName:"GetEventType",
				seachText:"请输入事件内容",
				parmas:function(){ 
					return {
						desc: $("#startDayReport").val(),
						hospID:hospId
					}
				},
				columns: function(){
					return [[{field:'desc',title:'名称',width:350}]]			
				}
			},
			relationDocAdvices:{
				type:"combogrid",
				name:"关联医嘱项",
				required:"true",
				classMethod:"Nur.NIS.Service.TaskOverview.Setting",
				seachText:"请输入医嘱内容",
				queryName:"GetDocAdvice",
				parmas:function(){ 
					return {
						desc: $("#startDayReport").val(),
						hospDR:hospId
					}
				},
				columns: function(){
					return [[{field:'desc',title:'名称',width:350}]]		
				}
			},
			relationAssess:{
				type:"combogrid",
				name:"关联评估项",
				required:"true",
				classMethod:"Nur.NIS.Service.TaskOverview.Setting",
				queryName:"GetAssessItems",
				seachText:"请输入评估表名称",
				parmas:function(){ 
					return {
						desc: $("#startDayReport").val(),
						hospID:hospId
					}
				},
				columns: function(){
					return [[{field:'desc',title:'名称',width:350}]]		
				}
			},
			exclusions:{
				type:"input",
				name:"排除条件生效方法"
				},

			normalPeriod:{
				type:"input",
				name:"正常后持续周期"
			},
			normalIntervalPeriod:{
				type:"input",
				name:"正常后间隔周期",
				defaultValue:"DAY"
				},
			normalExeRule:{
				type:"input",
				name:"正常后需执行规则"
				},
			taskDesc:{
				type:"input",
				name:"常规护理任务描述"
				},
			taskCode:{
				type:"input",
				required:"true",
				name:"代码"
				},
			relationFormula:{
				type:"input",
				required:"true",
				name:"生效公式"
				},
			relationTodayExeRule:{
				type:"combox",
				data:[{"text":"时间点","value":"3"},
					  {"text":"自定义","value":"4"}
					  
					  ],
				//defaultValue:"3",
				changeQuery:function(value,oldValue){
					//$("#relationTodayExeRule").parents("tr").siblings("tr").hide()
						//var v = $("#taskAttr").combobox("getValue");
						//var showIds = tempVals["taskAttr-"+v]["relationTodayExeRule"][value]
						//$(showIds).parents("tr").show();
						if(value==3){
							$("#relationTodayExeTime").parents("tr").show()
							$("#relationUDNum").parents("tr").hide()
						}else if(value==4){
							$("#relationTodayExeTime").parents("tr").hide()
							$("#relationUDNum").parents("tr").show()
						}
						
						
					},
				required:"true",
				name:"当日需执行规则"
				},
			relationNotTodayExeRule:{
				type:"combox",
				data:[{"text":"时间点","value":"3"},
					  {"text":"固定天","value":"4"},
					   
					  ],
				changeQuery:function(value,oldValue){
				
						
						
						
						if(value==3){
							$("#rationFixedCycle").parents("tr").hide()	
							
						}else{
							$("#rationFixedCycle").parents("tr").show()	
						}
						
						
						
						
					},
				name:"非当日需执行规则"
				},
			relationIntervalPeriod:{
				type:"input",
				name:"间隔周期"
				
				},
			relationPeriod:{
				type:"input",
				name:"持续周期"
				},
			relationExeMethod:{
				type:"input",
				name:"执行方法"
				},
			normalFormula:{
				type:"input",
				name:"正常值生效公式"
				},
			normalSustain:{
				type:"input",
				name:"回归正常持续周期"
				},
			relationUDNum:{
				type:"input",
				name:"自定义值"
			},
			careDate:{
				type:"input",
				required:"true",
				name:"关联评估日期"
			},
			careTime:{
				type:"input",
				required:"true",
				name:"关联评估时间"
			},
	}




var tempVals={
	"taskAttr-1":{
		"type":{
			"NORMAL":"#type,#rationIntervalType",
			"SIGNS":"#relationTodayExeRule,#relationIntervalPeriod,#relationSign,#relationFormula,#relationTodayExeTime,#relationNotTodayExeRule,#relationNotTodayExeTime,#relationPeriod,#normalSustain,#normalExeTime,#normalPeriod,#normalFormula",
			"ORDER":"#relationDocAdvices,#relationExeMode",
			"SIGNORDER":"#relationSign,#relationDocAdvices,#relationFormula,#relationTodayExeTime,#relationNotTodayExeRule,#relationNotTodayExeTime,#relationPeriod,#normalSustain,#normalExeTime,#normalPeriod,#NormalFormula",
			"EVENT":"#relationEvents,#relationTodayExeRule,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationIntervalPeriod,#relationPeriod",//#relationTodayExeRule,#relationNotTodayExeRule,
			"MUTIPLY":"#relationEvents,#relationTodayExeRule,#relationDocAdvices,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationPeriod",
			"SPECIAL":"#relationExeMethod"
		},
		"rationIntervalType":{
			"1":"#rationFixedCycle,#relationTodayExeTime",
			"2":"#relationTodayExeTime,#relationPeriod,#relationIntervalPeriod"
		},
		"relationExeMode":{
			"2":"#relationTodayExeRule,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationIntervalPeriod,#relationPeriod",
			"3":"#rationFixedCycle,#relationTodayExeTime"
		},
		
	},
	"taskAttr-2":{
		"type":{
			"NORMAL":"#rationIntervalType",
			"ORDER":"#relationDocAdvices,#relationExeMode",
			"EVENT":"#relationEvents,#relationTodayExeRule,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationIntervalPeriod,#relationPeriod",//#relationNotTodayExeRule,#relationTodayExeRule,
			"SPECIAL":"#relationExeMethod",
			"ASSESS":"#normalSustain,#relationTodayExeRule,#careDate,#careTime,#relationAssess,#relationFormula,#relationPeriod,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationIntervalPeriod,#normalFormula,#normalExeTime,#normalIntervalPeriod,#normalPeriod",//#relationTodayExeRule,#relationNotTodayExeRule,
			"ORDERASSESS":"#normalSustain,#relationTodayExeRule,#careDate,#careTime,#relationAssess,#relationDocAdvices,#relationFormula,#relationPeriod,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationIntervalPeriod,#normalFormula,#normalExeTime,#normalIntervalPeriod,#normalPeriod",//#relationTodayExeRule,#relationNotTodayExeRule,
			"MUTIPLY":"#relationEvents,#relationTodayExeRule,#relationDocAdvices,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationPeriod",
			"SIGNORDER":"#relationTodayExeRule,#relationSign,#relationDocAdvices,#relationFormula,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationPeriod,#normalSustain,#normalExeTime,#normalPeriod,#NormalFormula",
		},
		"rationIntervalType":{
			"1":"#rationFixedCycle,#relationTodayExeTime",
			"2":"#relationTodayExeTime,#relationIntervalPeriod,#relationPeriod"
		},
		"relationExeMode":{
			"2":"#relationTodayExeRule,#relationTodayExeTime,#relationNotTodayExeTime,#relationNotTodayExeRule,#relationIntervalPeriod,#relationPeriod",
			"3":"#rationFixedCycle,#relationTodayExeTime"
		},
		
		
	},
	"taskAttr-3":{
		"type":{
			"ORDER":"#type,#relationDocAdvices,#vsReminder_sb",
		
		}
		
		}
	/*"taskAttr-3":{
		"type":{
			"ORDER":"#type,#relationDocAdvices,#relationExeMode",
			//"MUTIPLY":"#relationEvents,#relationTodayExeRule,#relationDocAdvices,#relationTodayExeTime,#relationNotTodayExeTime,#relationPeriod,#relationIntervalPeriod",
		
		},
		"relationExeMode":{
			"2":"#relationTodayExeRule,#relationTodayExeTime,#relationNotTodayExeTime,#relationIntervalPeriod,#relationPeriod",
			"3":"#rationFixedCycle,#relationTodayExeTime"
		}
	}*/
}
		
</script>
	
</body>
</html>

