<csp:content charset="UTF-8">
<SERVER>
s Action=$Get(%request.Data("actiontype",1))
s Start=$Get(%request.Data("start",1))
s Limit=$Get(%request.Data("limit",1))
s Sort=$Get(%request.Data("sort",1))
s Dir=$Get(%request.Data("dir",1))
;
i Action = "Save" d
	.S Ingr=$Get(%request.Data("Ingr",1))
	.S MainInfo=$Get(%request.Data("MainInfo",1))
	.S ListDetail=$Get(%request.Data("ListDetail",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).Save(Ingr,MainInfo,ListDetail)
	.i +ret<=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
i Action = "Select" d
	.S IngrRowid=$Get(%request.Data("IngrRowid",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).Select(IngrRowid)	
	.w "{success:'true',info:'"_ret_"'}"
i Action = "QueryDetail" d
	.S Parref=$Get(%request.Data("Parref",1))
	.d ##class(web.DHCSTM.DHCINGdRecItm).Query(Start,Limit,Sort,Dir,Parref)
	.
i Action = "Delete" d
	.S Parref=$Get(%request.Data("IngrRowid",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).Delete(Parref)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "DeleteDetail" d
	.S Ingri=$Get(%request.Data("Rowid",1))
	.s ret=##class(web.DHCSTM.DHCINGdRecItm).Delete(Ingri)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "GetItmInfo" d
	.S IncId=$Get(%request.Data("IncId",1))
	.S Params=$Get(%request.Data("Params",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).GetItmInfo(IncId,Params)
	.s ret=##class(web.DHCSTM.Common.UtilCommon).hJsonChar(ret)
	.w "{success:'true',info:'"_ret_"'}"
	.
i Action = "Query" d
	.s ListParam=$Get(%request.Data("ParamStr",1))
	.d ##class(web.DHCSTM.DHCINGdRec).Query(Start,Limit,Sort,Dir,ListParam)

i Action = "MakeComplete" d
	.s Ingr=$Get(%request.Data("Rowid",1))
	.s UserId=$Get(%request.Data("User",1))
	.s GroupId=$Get(%request.Data("GroupId",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).MakeComplete(Ingr,UserId,GroupId)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "CancleComplete" d
	.s Ingr=$Get(%request.Data("Rowid",1))
	.s UserId=$Get(%request.Data("User",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).CancleComplete(Ingr,UserId)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "Audit" d
	.s Ingr=$Get(%request.Data("Rowid",1))
	.s UserId=$Get(%request.Data("User",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).Audit(Ingr,UserId)
	.i ret=0  d
	..w "{success:'true',info:'"_ret_"'}"
	.e  d
	..w "{success:'false',info:'"_ret_"'}"
	.
i Action = "SaveCheckInfo" d
	.S IngrId=$Get(%request.Data("IngrId",1))
	.S UserId=$Get(%request.Data("UserId",1))
	.S ListDetail=$Get(%request.Data("ListDetail",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).SaveAcceptInfo(IngrId,UserId,ListDetail)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "QueryPoDetailForRec" d
	.s Parref=$Get(%request.Data("Parref",1))
	.d ##class(web.DHCSTM.DHCINGdRecItm).QueryPoItmForRec(Parref)
	.
i Action = "GetParamProp" d
	.s GroupId=$g(%request.Data("GroupId",1))
	.s LocId=$g(%request.Data("LocId",1))
	.s UserId=$g(%request.Data("UserId",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).GetParamProp(GroupId,LocId,UserId)
	.w "{success:'true',info:'"_ret_"'}"
	.
i Action = "CheckInvnoExist" d
	.S IngriId=$Get(%request.Data("Ingr",1))
	.S InvNo=$Get(%request.Data("InvNo",1))
	.s ret=##class(web.DHCSTM.DHCINGdRecItm).CheckInvnoExist(IngriId,InvNo)	
	.w "{success:'true',info:'"_ret_"'}"
	.
i Action = "jsQueryRecDetail" d
	.S LocId=$Get(%request.Data("LocId",1))
	.s StartDate=$Get(%request.Data("StartDate",1))
	.s EndDate=$Get(%request.Data("EndDate",1))
	.s Others=$Get(%request.Data("Others",1))
	.d ##class(web.DHCSTM.DHCINGdRecStat).jsQueryRecDetail(Start,Limit,Sort,Dir,StartDate,EndDate,LocId,Others)
	.
i Action = "UpdateRecInfo" d
	.S ListDetail=$Get(%request.Data("ListDetail",1))
	.s ret=##class(web.DHCSTM.DHCINGdRecMod).UpdateRecInfo(ListDetail)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "UpdateVendor" d
	.S Ingr=$Get(%request.Data("Ingr",1))
	.s VendorId=$g(%request.Data("Vendor",1))
	.s ret=##class(web.DHCSTM.DHCINGdRecMod).GrUpdateVen(Ingr,VendorId)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "CancelAudit" d
	.S Ingr=$Get(%request.Data("Ingr",1))
	.s ret=##class(web.DHCSTM.DHCINGdRecMod).GrCancelAudit(Ingr)
	.i +ret'=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
	.
i Action = "GetMtSp" d
	.S IncId=$Get(%request.Data("IncId",1))
	.S UomId=$Get(%request.Data("IncId",1))
	.S Rp=$Get(%request.Data("Rp",1))
	.s ret=##class(web.DHCSTM.Common.PriceCommon).GetMtSp(IncId,UomId,Rp)
	.w "{success:'true',info:'"_ret_"'}"
	.
i Action = "GetSpec" d
  .S IncId=$Get(%request.Data("IncId",1))
  .d ##class(web.DHCSTM.INCALIAS).Selectspec(InciId)
  .
///查询入库单
i Action = "QueryIngrStr" d
	.s IngrStr=$Get(%request.Data("IngrStr",1))
	.s ^Lh("sdsfs")=IngrStr
	.d ##class(web.DHCSTM.DHCINGdRec).QueryIngrStr(IngrStr)
///保存子表
i Action = "InsertDetail" d
	.S Ingr=$Get(%request.Data("Ingr",1))
	.S MainInfo=$Get(%request.Data("MainInfo",1))
	.S ListDetail=$Get(%request.Data("ListDetail",1))
	.s ret=##class(web.DHCSTM.DHCINGdRecItm).Save(Ingr,ListDetail,MainInfo) //高值入参MainInfo
	.i +ret<0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"
i Action ="GetPrice" d
	.S InciId=$Get(%request.Data("InciId",1))
	.S UomId=$Get(%request.Data("UomId",1))
	.S StrParam=$Get(%request.Data("StrParam",1))
	.w ##class(web.DHCSTM.DHCINGdRec).GetPrice(InciId,UomId,StrParam)
i Action ="CheckNamePrice" d
	.s inci=$Get(%request.Data("inci",1))
	.s rp=$Get(%request.Data("rp",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).CheckNamePrice(inci,rp)
	.w "{success:'true',info:'"_ret_"'}"
	
i Action = "PrintFlag" d
	.S IngrRowid=$Get(%request.Data("IngrRowid",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).PrintFlag(IngrRowid)	
	.w "{success:'true',info:'"_ret_"'}"

i Action = "PrintMBPL" d
	.S IngrRowid=$Get(%request.Data("IngrRowid",1))
	.s HospId=$Get(%request.Data("HospId",1))
	.S User=$Get(%request.Data("user",1))
	.s ret=##class(web.DHCSTM.DHCINGdRec).InserMBPL(IngrRowid,HospId,User)	
	.w "{success:'true',info:'"_ret_"'}"
i Action="GetChargeFlag" d
    .S InciId=$Get(%request.Data("IncId",1))
    .s ret=##class(web.DHCSTM.Common.DrugInfoCommon).GetChargeFlag(InciId)
    .w "{success:'true',info:'"_ret_"'}"
///批量审批    
i Action = "AuditStr" d
    .s IngrStr=$Get(%request.Data("RowidStr",1))
    .s UserId=$Get(%request.Data("User",1))
    .s ret=##class(web.DHCSTM.DHCINGdRec).AuditStr(IngrStr,UserId)
    .i ret=0  d
	..w "{success:'true',info:'"_ret_"'}"
	.e  d
	..w "{success:'false',info:'"_ret_"'}"
</SERVER>
