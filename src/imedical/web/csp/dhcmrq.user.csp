<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(DHCMRQ.Base.Util.Verification).SessionVerifi() q 1
	q 1
</csp:method>
<!DOCTYPE html>
<html>
	<head>
		<script>
		if (top == self) {
    		top.location = 'dhcmrq.index.csp';
		}
	   </script>
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-validator/css/bootstrapValidator.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/datatable-1.10.12/datatables.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/css/main.css">
		<!--[if lte IE 6]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap-ie6.css">
	  <![endif]-->
	  <!--[if lte IE 8]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/ie.css">
			<style media="screen">
				.col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9{
					padding-left: 0;
					padding-right: 0;
				}
			</style>
	  <![endif]-->
		<style media="screen">
			label.col-sm-3{
				padding-right: 0;
			}
			.table>tbody>tr.selected{
				background-color: #16c79e;
				color: #fff;
				transition: all .2s;
			}
			#roleDiv .col-sm-5{
				border: 1px solid #16c79e;
				min-height: 200px;
			}
			.panel-footer{
				text-align: right;
			}
			.table th, .table td{
				text-align: left;
			}
			
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="boxcq" id="two">
					<div class="ti">

					</div>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-8">
									<table id="userTable" class="table table-striped" width="100%">
										<thead>
											<tr><th>用户账号</th><th>用户名称</th><th>电话号码</th><th>备注</th><th>状态</th><th>操作</th></tr>
										</thead>
										<tbody>

										</tbody>
									</table>
								</div>
								<div class="col-sm-4">
									<div class="panel panel-info">
									  <div class="panel-heading">基本信息</div>
									  <div class="panel-body">
									  		<input type="hidden" id="userId">
											<form id="userForm" class="form-horizontal" role="form">
											<div class="form-group">
											    <label for="userCode" class="col-sm-3 control-label">用户账号</label>
											    <div class="col-sm-9">
											      <input type="text" class="form-control" id="userCode" name="Params">
											    </div>
											  </div>
											  <div class="form-group">
											    <label for="userName" class="col-sm-3 control-label">用户名称</label>
											    <div class="col-sm-9">
											      <input type="text" class="form-control" id="userName" name="userName">
											    </div>
											  </div>
											  <div class="form-group">
											    <label for="userStatus" class="col-sm-3 control-label">状态</label>
											    <div class="col-sm-9">
											      <select class="form-control" id="userStatus" name="userStatus">
											      	<option value="1" selected="selected">可用</option>
											      	<option value="0">不可用</option>
											      </select>
											    </div>
											  </div>
											  <input type="hidden" class="form-control" name="userPassword">
											  <!--
											  <div class="form-group">
											    <label for="confirmPassword" class="col-sm-3 control-label">确认密码</label>
											    <div class="col-sm-9">
											      <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
											    </div>
											  </div>
											  -->
											  <div class="form-group">
											    <label for="userTelephone" class="col-sm-3 control-label">电话号码</label>
											    <div class="col-sm-9">
											      <input type="text" class="form-control" id="userTelephone" name="userTelephone">
											    </div>
											  </div>
												<div class="form-group">
											    <label for="userResume" class="col-sm-3 control-label">备注</label>
											    <div class="col-sm-9">
											      <input type="text" class="form-control" id="userResume" name="userResume">
											    </div>
											  </div>
												<div class="form-group">
											    <label for="deptCode" class="col-sm-3 control-label">所属科室</label>
											    <div class="col-sm-9">
											      <select class="form-control" id="deptCode" name="deptCode"></select>
											    </div>
											  </div>
											  <div class="form-group">
											    <label for="roleCode" class="col-sm-3 control-label">角色</label>
											    <div class="col-sm-9">
											      <select class="form-control" id="roleCode" name="roleCode"></select>
											    </div>
											  </div>
											</form>
									  </div>
										<div class="panel-footer">
											<button type="button" onclick="saveUser()" class="btn btn-info">保存</button>
										</div>
									</div>
									<!--
									<div class="panel panel-info">
									  <div class="panel-heading">角色授权</div>
									  <div class="panel-body">
											<div class="row" id="roleDiv">
												<div class="col-sm-5">
													<h4>未授权角色</h4>
													<div id="allRole">
														<div class="role">
															<input type="checkbox" name="allRole" value="boss">
															<label for="">院长</label>
														</div>
														<div class="role">
															<input type="checkbox" name="allRole" value="master">
															<label for="">科主任</label>
														</div>
													</div>

												</div>
												<div class="col-sm-2">
													<button type="button" class="btn btn-success btn-sm" name="button" title="授权"><i class="fa fa-chevron-circle-left"></i></button>
													<button type="button" class="btn btn-warning btn-sm" name="button" title="撤销"><i class="fa fa-chevron-circle-right"></i></button>
												</div>
												<div class="col-sm-5">
													<h4>已授权角色</h4>
													<div id="grantRole">
														<div class="role">
															<input type="checkbox" name="grantRole" value="boss">
															<label for="">院长</label>
														</div>
													</div>
												</div>
											</div>
									  </div>
										<div class="panel-footer">
											<button type="button" onclick="saveUserRole()" class="btn btn-info">保存</button>
										</div>
									</div>
									-->
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<DHCMRQ:HEAD></DHCMRQ:HEAD>
		<script type="text/javascript">
			var dt;
			var allRole;
			$(function(){
				loadTable();
				getAllDep();
				getAllRole();
				
				//code值改变时，认为要新增记录，所以启动验证
				$('#userCode').on('input',function(){
					$('#userForm').bootstrapValidator('enableFieldValidators', 'Params', true);
				})
				
$('#userForm').bootstrapValidator({
        message: 'This value is not valid',
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            userName: {
                validators: {
                    notEmpty: {
                        message: '用户名不能为空'
                    }
                }
            },
            Params: {
                message: 'The username is not valid',
                validators: {
                    notEmpty: {
                        message: '用户账号不能为空'
                    },
                    stringLength: {
                        min: 4 ,
                        max: 30,
                        message: '用户账号要大于4位小于30位字符'
                    },
                    regexp: {
                        regexp: /^[a-zA-Z0-9_]+$/,
                        message: '用户账号只能包含字母数字和下划线'
                    },
                    remote: {
                        url: 'dhcmrq.service.csp?ClassName=DHCMRQ.Base.MRQUser&MethodName=CheckUserCode',
                        message: '用户账号已存在'
                    }
                }
            },
            userTelephone: {
                validators: {
                    regexp: {
                        regexp: /(^(0[1-9][0-9]{1,2}[-\s]?)?[0-9]{6,8}$)|(^1[3-8][0-9]{9}$)/,//^[0-9\-]{6,13}$/,
                        message: '请输入正确的电话号码'
                    }
                }
            }
        }
    });
			})

			function loadTable(){
				$.ajax({
						type: 'post',
						url: 'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQUser',
									 MethodName:'GetAllUser',
									 Params:''
						},
						dataType:'json',
						success: function (res) {
							//console.log(res);
							dt = $('#userTable').DataTable( {
									data: res,//JSON.parse(res),
									lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "全部"] ],
									columns: [
												{ "data": "userCode" },
												{ "data": "userName" },
												{ "data": "userTelephone" },
												{ "data": "userResume" },
												{ "data": "userStatus" ,
													"render": function ( data, type, full, meta ) {
														if(full.userStatus==1){
															return '可用';
														} else if(full.userStatus==0){
															return '不可用';
														}
															
													}
												},
												{ "data": "oper" ,
													"render": function ( data, type, full, meta ) {
														return '<a class="link" href="#" onclick="deleteUser(\''+full.userId+'\')">删除</a>&nbsp;&nbsp;'
															  +'<a class="link" href="#" onclick="passwordReset(\''+full.userId+'\')">重置密码</a>'
															
													}
												}
										]
							});

							$('#userTable tbody').on( 'click', 'tr', function () {
									dt.$('tr.selected').removeClass('selected');
									$(this).addClass('selected');
									var rowData = dt.rows('.selected').data()[0];
									for (var key in rowData) {
										$('#'+key).val(rowData[key]);
									}
									//$('#userCode').attr('readonly','readonly');
									get(rowData.userId);
									$('#userForm').bootstrapValidator('enableFieldValidators', 'Params', false);

							});
		        }
		    });
			}
			
			function get(uid){
				
				$.ajax({
		        	type: 'post',
		        	url: 'dhcmrq.service.csp',
		        	data: {ClassName:'DHCMRQ.Base.MRQUserRole',
						   MethodName:'GetDeptAndRole',
						   Params:uid
					  },
		        	success: function (res) {
				  		//console.log(res);
		          		
		        	}
		    	});
		    	
		    	$.ajax({
		        	type: 'post',
		        	url: 'dhcmrq.service.csp',
		        	data: {ClassName:'DHCMRQ.Base.MRQUserRole',
						   MethodName:'GetDefaultInfo',
						   Params:uid
					  },
		        	success: function (res) {
				  		
				  		var userInfoArray = res.replace(/[\n\r]/g,'').split('^');
		          		//console.log(userInfoArray);
		          		$('#deptCode').val(userInfoArray[0]);
		          		$('#roleCode').val(userInfoArray[3]);
		        	}
		    	});
			}

			function getAllRole(){
				$.ajax({
		        	type: 'post',
		        	url: 'dhcmrq.service.csp',
		        	data: {ClassName:'DHCMRQ.Base.MRQRole',
									 MethodName:'GetAllRole',
									 Params:''
					  },
		        	success: function (res) {
				  		//console.log(res);
		          		allRole = JSON.parse(res);
		          		var roleSelector = $('#roleCode');
		          		$.each(allRole,function(i,n){
			          		roleSelector.append('<option value="'+n.roleId+'">'+n.roleDesc+'</option>')
			      		})
		        	}
		    	});
		    	
		    	
			}
			
			function getAllDep(){
				$.ajax({
		        	type: 'post',
		        	url: 'dhcmrq.service.csp',
		        	data: {ClassName:'DHCMRQ.Base.MRQDepartment',
									 MethodName:'GetAllDept',
									 Params:''
					  },
		        	success: function (res) {
				  		//console.log(res);
		          		var deptSelector = $('#deptCode');
		          		$.each(JSON.parse(res),function(i,n){
			          		deptSelector.append('<option value="'+n.deptId+'">'+n.deptDesc+'</option>')
			      		})
		        	}
		    	});
			}

			function saveUser(update){
				var flag = 1;
				/*
				if(update=='update'){
					if($('#userId').val()=='' || $('#userCode').val()=='') {
						msg('warning','请选择用户',2000);
						return;
					}
					$('#userForm').bootstrapValidator('enableFieldValidators', 'Params', false);
					
				} else {
					$('#userForm').bootstrapValidator('enableFieldValidators', 'Params', true);
				}
				*/
				//验证表单
				$('#userForm').bootstrapValidator('validate');
				//$('#userForm').data('bootstrapValidator').updateStatus('userName', 'NOT_VALIDATED').validate();
				//$('#userForm').data('bootstrapValidator').updateStatus('Params', 'NOT_VALIDATED').validate();
				//console.log($('#userForm').data('bootstrapValidator').isValid())
				if(!$('#userForm').data('bootstrapValidator').isValid()) return;
				
				$.ajax({
		        	type: 'post',
		        	url: 'dhcmrq.service.csp',
		        	data: {ClassName:'DHCMRQ.Base.MRQUser',
							 	   MethodName:'Update',
							 	   Params:decodeURIComponent($('#userForm').serialize().replace(/&.*?=/g,'^').replace(/^.*?=/g,'')+'^'+flag)
					  },
		        	success: function (uId) {
			        	//console.log(decodeURIComponent($('#userForm').serialize().replace(/&.*?=/g,'^').replace(/^.*?=/g,'')+'^'+flag))
						//console.log(res);
						saveUserRole();
		          		loadTable()
		          		msg('success','更新成功!',2000);
		        	}
		    	});
			}
			
			function saveUserRole(){
				console.log($('#userId').val()+','+$('#deptCode').val()+','+$('#roleCode').val()+','+flag)
				var flag=1;
				$.ajax({
		        	type: 'post',
		        	url: 'dhcmrq.service.csp',
		        	data: {ClassName:'DHCMRQ.Base.MRQUserRole',
						   MethodName:'Update',
						   Params:$('#userId').val()+','+$('#deptCode').val()+','+$('#roleCode').val()+','+flag
					  },
		        	success: function (res) {
			        	console.log(res);
		        	}
		    	});
			}

			function deleteUser(userId){
				if(confirm('确定删除吗？')){
					$.ajax({
						type: 'post',
						url: 'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQUser',
									 MethodName:'DeleteById',
									 Params:userId
						},
						success: function (res) {
							//loadTable();
							location.reload();
							msg('success','删除用户成功！',2000);
						}
					});
				}
			}
			
			function passwordReset(userId){
				if(confirm('确定重置密码吗？')){
					$.ajax({
						type: 'post',
						url: 'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQUser',
									 MethodName:'ResetPassword',
									 Params:userId
						},
						success: function (res) {
							msg('info',res,2000);
						}
					});
				}
			}
			function resetForm(){
				$('#userCode').removeAttr('readonly');
				$('#userForm').data('bootstrapValidator').resetForm(true);
				
			}
		</script>
	</body>
</html>
