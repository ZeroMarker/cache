<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. --> 
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
 i ##Class(websys.SessionEvents).SessionExpired()
 //i ##Class(ext.websys.SessionEvents).SessionExpired() q 1
 quit 1
</csp:method>
<HTML XMLNS=TRAK>
<meta charset="utf-8" /> 
<HEAD>
<TITLE><TRAK:TRANSLATE id=title>##(%session.Get("TITLE"))##</TRAK:TRANSLATE></TITLE>
<!-- <TRAK:HEAD></TRAK:HEAD> -->
<EXTHEALTH:HEAD></EXTHEALTH:HEAD>
</HEAD>

<SERVER>
 /*
 session['LOGON.SITECODE']='DHCHEALTH';
session['LOGON.REGION']='';
session['LOGON.USERID']='489';
session['LOGON.USERCODE']='301';
session['LOGON.USERNAME']='李磊';
session['LOGON.GROUPID']='29';
session['LOGON.GROUPDESC']='住院医师';
session['LOGON.LANGID']='20';
session['LOGON.CTLOCID']='6';
session['XMONTHSSHORT']='一月,二月,三月,四月,五月,六月,七月,八月,九月,十月,十一月,十二月';
session['CONTEXT']='';
session['LOGON.WARDID']='';
session['LOGON.HOSPID']='2';
session['ContainerName']='';

 s %session.Data("UserInfo")=1
 s %session.Data("Password")=""
 s %session.Data("UserDR")=114
 s %session.Data("UserCode")="LIS01"
 s %session.Data("UserName")="检验01"
 s %session.Data("WorkGroupDR")=10
 s %session.Data("WorkGroupName")="检验科-门诊检验组"
 s %session.Data("LocationDR")=0
 s %session.Data("LocationName")=""
 s %session.Data("ReagentGroupDR")=0
 s %session.Data("ReagentGroupName")=""
 s %session.Data("SysDR")=4
 s %session.Data("GroupDR")=12
 s %session.Data("HospitalDR")=1
 s %session.Data("SysCode")="lis"
 s %session.Data("CurrentSysCode")="all"
 s %session.Data("SysName")="技师工作站"
 s %session.Data("LoginDate")=20150810
 s %session.Data("LoginTime")=49817
 s %session.Data("IpAddress")="127.0.0.1"
 s %session.Data("Method")=""

 s UserDR=$G(%session.Data("UserDR"))
 s HospitalDR=$G(%session.Data("HospitalDR"))
 */
 
 s USERID=$G(%session.Data("LOGON.USERID"))
 s USERCODE = $G(%session.Data("LOGON.USERCODE"))
 s USERNAME = $G(%session.Data("LOGON.USERNAME"))
 s PatientID=%request.Get("PatientID")
 s HOSPID=$G(%session.Data("LOGON.HOSPID"))
 s CTLOCID=$G(%session.Data("LOGON.CTLOCID"))
 
 s (HospCode,LocCode,LocName,HospName)=""
 i $l(HOSPID) s HospCode=$p($g(^CT("HOSP",HOSPID)),"^",1)
 i $l(HOSPID) s HospName=$p($g(^CT("HOSP",HOSPID)),"^",2)
 i $l(CTLOCID) s LocCode=$p($g(^CTLOC(CTLOCID)),"^",1)
 i $l(CTLOCID) s LocName=$p($g(^CTLOC(CTLOCID)),"^",2) 
 
 /** TODO 与his对接的参数：用户代码，科室代码，就诊号(AdmNo)，登记号(RegNo)，病案号(RecordNo)  **/
 //s UserCode="00668"
 s LocationCode="1"
 s HospitalCode=HospCode
 
 //处理医院信息 
 s HospitalDR=""
 //i $l(HospitalCode) s HospitalDR=##Class(DHCLIS.DHCCommon).GetHospitalDR(HospCode,HospName)
 s LocCode=##Class(DHCLIS.DHCCommon).UPPER(LocCode)
 //i $l(LocCode) s LocationDR=##Class(DHCLIS.DHCCommon).GetLocationDR(CTLOCID,LocCode,LocName,HospitalDR)

 //i $l(USERCODE) s CollectUserDR=##Class(DHCLIS.DHCCommon).GetUserDR(USERCODE,USERNAME,HospitalDR)
 
 //i $l(USERCODE) s DoctorDR=##Class(DHCLIS.DHCCommon).GetDoctorDR(USERCODE,USERNAME,HospCode)
 
 //职称信息处理
 s PositionTitleRowID=""
 s (PositionTitleCode,PositionTitleName)=""
 s USERCODE = $ZCVT(USERCODE,"U")
 s HisDocID = $O(^CTPCP(0,"Code",USERCODE,0))
 i $l(HisDocID) d
 .s TypeID = $p($g(^CTPCP(HisDocID,3)),"^",29)
 .i $l(TypeID) d
 ..s TypeData = $g(^CT("TTL",TypeID))
 ..s PositionTitleCode = $p(TypeData,"^",1)
 ..s PositionTitleName = $p(TypeData,"^",2)


 
 s AdmNo=%request.Get("EpisodeID")
 s PatientID=%request.Get("PatientID")
 s Page=%request.Get("Page")
 s ReqFormDR=%request.Get("ReqFormDR")
 s RegNo=""
 s RecordNo=""
  
  
  s DischargeStatus=##class(web.DHCDischargeHistory).GetCurrentDischargeStatus(AdmNo)
//获取输血知情同意书电子病历模板id
  s DocID=""
  s DocID=##Class(EMRservice.HISInterface.Event.BloodTransfusion).GetInformedConsentDocID()	
#;	i ret="E" s retVal="-1^医生办理出院"
#;	i ret="F" s retVal="-1^护士办理出院"
#;	//i ret="R" s retVal="-1^护士召回病人"
#;	i ret="T" s retVal="-1^结束费用调整"
 //s webIP=##Class(DHCLIS.DHCOrderList).getDllWebIP()
 //s dllstr=webIP_"/lablis/DHCLabtrakReportPrint.dll#DHCLabtrakReportPrint.DHCLabtrakReportPrint"

 
</SERVER>

<script Language="JavaScript">
	var DischargeStatus = "#((DischargeStatus))#" ;
	if (DischargeStatus.length > 0) {
		var DischargeStatusret="";
		if (DischargeStatus=="E")
		{
			DischargeStatusret = "医生办理出院";
			alert(DischargeStatusret+",无法申请用血！");
			window.close();
		}
		if (DischargeStatus=="F") 
		{
			DischargeStatusret = "护士办理出院";
			alert(DischargeStatusret+",无法申请用血！");
			window.close();
		}
		if (DischargeStatus=="T")
		{
			DischargeStatusret = "结束费用调整";
			alert(DischargeStatusret+",无法申请用血！");
			window.close();
		}
	}
	function isIE11() {
		var re = /rv:11.0/g
		return re.test(navigator.userAgent.toLowerCase());
	}
	var host = window.location.host;
	
	var url ='http://'+ host +'/imedicallis/cts/form/Login.aspx?SysCode=CTS';
	url += '&UserId='+"#((USERID))#"+'&UserName='+"#((USERNAME))#"+'&UserCode='+"#((USERCODE))#";
	url += '&LocationId='+"#((CTLOCID))#"+'&LocationCode='+"#((LocCode))#"+'&LocationName='+"#((LocName))#";
	url += '&HospitalCode='+"#((HospitalCode))#"+'&HospitalName='+"#((HospName))#";
	url += '&PositionTitleCode='+"#((PositionTitleCode))#"+'&PositionTitleName='+"#((PositionTitleName))#";
	url += '&AdmNo='+"#((AdmNo))#"+'&RegNo='+"#((RegNo))#"+'&RecordNo='+"#((RecordNo))#";
	url += '&Page='+"#((Page))#"+'&ReqFormDR='+"#((ReqFormDR))#"+'&DocID='+"#((DocID))#";
	//document.write('C:\\TRAK\\chrome.lnk -start-maximized --app='+encodeURI(url));
	if (window.screen) {//判断浏览器是否支持window.screen判断浏览器是否支持screen     
	      var myw = screen.availWidth;   //定义一个myw，接受到当前全屏的宽     
	      var myh = screen.availHeight;  //定义一个myw，接受到当前全屏的高     
	      window.moveTo(0, 0);           //把window放在左上脚     
	      window.resizeTo(myw, myh);     //把当前窗体的长宽跳转为myw和myh     
	    } 
		location.href=encodeURI(url);
//	if (isIE11()) {
//		if (window.screen) {//判断浏览器是否支持window.screen判断浏览器是否支持screen     
//	      var myw = screen.availWidth;   //定义一个myw，接受到当前全屏的宽     
//	      var myh = screen.availHeight;  //定义一个myw，接受到当前全屏的高     
//	      window.moveTo(0, 0);           //把window放在左上脚     
//	      window.resizeTo(myw, myh);     //把当前窗体的长宽跳转为myw和myh     
//	    } 
//		location.href=encodeURI(url);
//	} else {
//		var wsh = new ActiveXObject('WScript.Shell');
//    	if ((wsh)) {
//	     	wsh.Run('C:\\TRAK\\chrome.lnk -start-maximized --app='+encodeURI(url));
//    	}
//    	//window.close();
//	}
//    //document.write('C:\\TRAK\\chrome.lnk -start-maximized --app='+encodeURI(url));
//	window.close();
    
//	var host = window.location.host;
//	var url = 'http://' + host + '/iMedicalLIS/cts/form/Login.aspx?SysCode=CTS';
//	url += '&UserCode='+"#((USERCODE))#"+'&LocationCode='+"#((LocCode))#"+'&HospitalCode='+"#((HospCode))#";
//	url += '&AdmNo='+"#((AdmNo))#"+'&RegNo='+"#((RegNo))#"+'&RecordNo='+"#((RecordNo))#";
//	//alert("#((HospitalCode))#");
//	//alert(url);
//
//	var x =screen.width;
// 	var y =screen.height;
// 	var win=window.open (url, 'newwindow', 'height='+y-1+', width='+x+',left=0,top=0, toolbar=no , menubar=no, scrollbars=no, resizable=yes, location=no, status=yes') 
//	
 	//win.document.write(objstr)

	//window.open(url,"_self");
	

</script>

</HTML>