<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
 	s EpisodeID=$g(%request.Data("EpisodeID",1))
 	s PatientID=$p($g(^PAADM(+EpisodeID)),"^",1)
 	s MRAdm=$p($g(^PAADM(+EpisodeID)),"^",61)
 	s UserID=%session.Get("LOGON.USERID")
	s LogUserID=UserID
 	s UserInitial=$p($g(^SSU("SSUSR",+UserID)),"^",1)
 	s UserPassword=$p($g(^SSU("SSUSR",+UserID)),"^",3)
 	s LocID=$g(%request.Data("LocID",1))
 	s LocDesc=$p($g(^CTLOC(+LocID)),"^",2)
	s CPWID=$g(%request.Data("CpwVerID",1))
	s BackPage=+$g(%request.Data("BackPage",1))
	
	s PathWayID=""
	if ($l(CPWID,$c(2))=1)&&((+CPWID)>0) {
		s InputStr=EpisodeID_"^"_(+CPWID)_"^"_LogUserID
		s PathWayID=##Class(web.DHCCPW.MR.Interface).InPathWay(InputStr)
	}
	
	s CurrPathWayInfo=##class(web.DHCCPW.MR.ClinicalPathWays).GetActiveCPWByMradm(EpisodeID)
	s:CurrPathWayInfo'="" PathWayID=$p(CurrPathWayInfo,"^",1)
	
	if (PathWayID="")||(BackPage=1) {
		s url=$c(0)_"EpisodeID"_$c(1)_EpisodeID
		s url=url_$c(0)_"PatientID"_$c(1)_PatientID
		s url=url_$c(0)_"MRAdm"_$c(1)_MRAdm
		s url=url_$c(0)_"BackPage"_$c(1)_BackPage
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"%","%25")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"+","%2B")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url," ","%20")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"/","%2F")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"?","%3F")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"#","%23")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"&","%26")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"=","%3D")
	 	s url=$tr(url,$c(0),"&")
	 	s url=$tr(url,$c(1),"=")
	 	s url="dhccpw.mr.inpathway.csp?a=a"_url_"&b=b"
	} else {
		s url=$c(0)_"EpisodeID"_$c(1)_EpisodeID
		s url=url_$c(0)_"PatientID"_$c(1)_PatientID
	 	s url=url_$c(0)_"mradm"_$c(1)_MRAdm
		s url=url_$c(0)_"PathWayID"_$c(1)_PathWayID
	 	s url=url_$c(0)_"ConsultFlag"_$c(1)_1
	 	s url=url_$c(0)_"NurseFlag"_$c(1)_1
	 	s url=url_$c(0)_"OEOutOrderFlag"_$c(1)_1
	 	s url=url_$c(0)_"NEOutOrderFlag"_$c(1)_1
	 	s url=url_$c(0)_"VarianceFlag"_$c(1)_1
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"%","%25")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"+","%2B")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url," ","%20")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"/","%2F")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"?","%3F")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"#","%23")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"&","%26")
	 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"=","%3D")
	 	s url=$tr(url,$c(0),"&")
	 	s url=$tr(url,$c(1),"=")
	 	s url="dhccpw.mr.formshow.csp?a=a"_url_"&b=b"
	}
	
 	s %response.Redirect=url
 	if $d(%session.Data("LOGON.USERID"))&&($g(%session.Data("LOGON.USERID"))'="") {
 		s %response.Redirect=url
 	}else{
		//通过Portal登录
		s %request.Data("USERNAME",1)=UserInitial
	 	s %request.Data("PASSWORD",1)=UserPassword
		s %request.Data("DEPARTMENT",1)=LocDesc
		s myrtnflag=##Class(web.portal.SessionLogon).Logon()
		if +myrtnflag=0 {
			s %response.Redirect=url    //登录成功,跳转到临床路径表单界面
		}else{
			//s %response.ServerSideRedirect="logon.csp"    //转向登录页面
		}
 	}
 	
	q 1
</csp:method>