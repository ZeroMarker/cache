<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(websys.SessionEvents).SessionExpired() q 1
	q 1
</csp:method>
<csp:content charset="UTF-8">

<script language="cache" runat="server">

 s Action=$Get(%request.Data("actiontype",1))
 s Start=$Get(%request.Data("start",1))
 s Limit=$Get(%request.Data("limit",1))
 s Sort=$Get(%request.Data("sort",1))
 s Dir=$Get(%request.Data("dir",1))
 
 //保存发票号
 i Action = "SaveInvNo" d
 .s ListDetail=$G(%request.Data("ListDetail",1))
 .s ret=##class(web.DHCSTM.DHCVendorInv).SaveInvNo(ListDetail)
 .i +ret'=0  d
 ..w "{success:'false',info:'"_ret_"'}"  
 .e  d
 ..w "{success:'true',info:'"_ret_"'}"     

 //完成发票组合单
 i Action = "SetComp" d
 .s invid=$Get(%request.Data("invid",1))
 .s result = ##class(web.DHCSTM.DHCVendorInv).SetCompleted(invid)
 .i result = 0  d
 ..w "{success:'true',info:'"_result_"'}"  //成功
 .e  d
 ..w "{success:'false',info:'"_result_"'}"  //失败  

 //取消完成发票组合单
 i Action = "CnlComp" d
 .s invid=$Get(%request.Data("invid",1))
 .s result = ##class(web.DHCSTM.DHCVendorInv).CnlCompleted(invid)
 .i result = 0 d
 ..w "{success:'true',info:'"_result_"'}"
 .e  d
 ..w "{success:'false',info:'"_result_"'}"
 
 //删除发票组合单明细
 i Action = "DelinvItm" d
 .s invi=$G(%request.Data("RowId",1))
 .s ret=##class(web.DHCSTM.DHCVendorInv).Delete(invi)
 .i ret=0 d
 ..w "{success:'true',info:'"_ret_"'}"  
 .e  d
 ..w "{success:'false',info:'"_ret_"'}"     

 //删除发票组合单
 i Action = "Delete" d
 .s invRowId=$G(%request.Data("invRowId",1))
 .s ret=##class(web.DHCSTM.DHCVendorInv).DeleteAll(invRowId)
 .i ret=0 d
 ..w "{success:'true',info:'"_ret_"'}"  
 .e  d
 ..w "{success:'false',info:'"_ret_"'}"    
 
 //根据主表Rowid查询供应商发票组合主表信息
 i Action = "invMainInfo" d
 .s invid=$Get(%request.Data("invid",1))
 .s result = ##class(web.DHCSTM.DHCVendorInv).invMainInfo(invid)
 .i result = "" d
 ..w "{results:0,rows:[]}"
 .e  d
 ..w result

 //查询供应商发票组合单列表
 i Action = "query" d
 .s StrParam=$Get(%request.Data("StrParam",1))
 .s result = ##class(web.DHCSTM.DHCVendorInv).jsDHCVendorInv(Start,Limit,Sort,Dir,StrParam)
 .i result = "" d
 ..w "{results:0,rows:[]}"
 .e  d
 ..w result
 
 //查询供应商发票组合单明细
 i Action = "queryItem" d
 .s parref=$g(%request.Data("parref",1))
 .s result = ##class(web.DHCSTM.DHCVendorInv).jsDHCVendorInvItm(Start,Limit,parref)
 .i result = "" d
 ..w "{results:0,rows:[]}"
 .e  d
 ..w result

 //插入或更新入库单发票组合主表记录
 i Action="Save" d
 .s inv=$g(%request.Data("inv",1))
 .s LocRowId=$g(%request.Data("LocRowId",1))
 .s stkGrpId=$g(%request.Data("stkGrpId",1))
 .s vendor=$g(%request.Data("vendor",1))
 .s user=$g(%request.Data("userId",1))
 .s RpAmt=$g(%request.Data("RpAmt",1))
 .s SpAmt=$g(%request.Data("SpAmt",1))
 .s detailData=$g(%request.Data("detailData",1))
 .s inv=##class(web.DHCSTM.DHCVendorInv).Save(inv,LocRowId,stkGrpId,vendor,user,RpAmt,SpAmt,detailData)
 .i inv>0 d
 ..w "{success:'true',info:'"_inv_"'}"
 .e  d
 ..w "{success:'false',info:'"_inv_"'}"
 
 //查询入库单和退货单主表信息
 i Action = "QueryIngd" d
 .s ListParam=$Get(%request.Data("ParamStr",1))
 .d ##class(web.DHCSTM.DHCVendorInv).QueryIngd(Start,Limit,Sort,Dir,ListParam)
 
 //查询入库单和退货单明细信息
 i Action = "QueryIngdDetail" d
 .s Parref=$Get(%request.Data("Parref",1))
 .s Type=$Get(%request.Data("Type",1))
 .i Type="入库" d
 ..d ##class(web.DHCSTM.DHCVendorInv).QueryIngdDetail(Start,Limit,Sort,Dir,Parref)
 .e  d
 ..d ##class(web.DHCSTM.DHCVendorInv).QueryIngdRetDetail(Start,Limit,Sort,Dir,Parref)
 
 //查询发票组合主表信息
 i Action = "Select" d
 .S inv=$Get(%request.Data("inv",1))
 .s ret=##class(web.DHCSTM.DHCVendorInv).Select(inv)	
 .w "{success:'true',info:'"_ret_"'}"
 
  //根据主表插入或更新发票组合主表记录
 i Action="SaveMast" d
 .s inv=$g(%request.Data("inv",1))
 .s LocRowId=$g(%request.Data("LocRowId",1))
 .s stkGrpId=$g(%request.Data("stkGrpId",1))
 .s vendor=$g(%request.Data("vendor",1))
 .s user=$g(%request.Data("userId",1))
 .s RpAmt=$g(%request.Data("RpAmt",1))
 .s SpAmt=$g(%request.Data("SpAmt",1))
 .s detailData=$g(%request.Data("detailData",1))
 .s inv=##class(web.DHCSTM.DHCVendorInv).SaveMast(inv,LocRowId,stkGrpId,vendor,user,RpAmt,SpAmt,detailData)
 .i inv>0 d
 ..w "{success:'true',info:'"_inv_"'}"
 .e  d
 ..w "{success:'false',info:'"_inv_"'}"

</script>