<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
    i ##Class(websys.SessionEvents).SessionExpired() q 1
    q 1
</csp:method>
<csp:content charset="UTF-8">

<script language="cache" runat="server">

    s Action=$Get(%request.Data("actiontype",1))
    s Start=$Get(%request.Data("start",1))
    s Limit=$Get(%request.Data("limit",1))
    s Sort=$Get(%request.Data("sort",1))
    s Dir=$Get(%request.Data("dir",1))

    s StrPar=$Get(%request.Data("strPar",1))
    s Req=$Get(%request.Data("req",1))
    s Reqi=$Get(%request.Data("reqi",1))
    s ReqInfo=$Get(%request.Data("reqInfo",1))
    s ListData=$Get(%request.Data("data",1))
    s LocId=$Get(%request.Data("locId",1))
    s UserId=$Get(%request.Data("userId",1))
    s ListReqId=$Get(%request.Data("listReqId",1))
    s StkGrpId=$Get(%request.Data("stkGrpId",1))
    s User=$G(%session.Data("LOGON.USERID"))
    s HOSPID=$G(%session.Data("LOGON.HOSPID"))
    s ReqItm=$Get(%request.Data("reqItm",1))

    //查询请求单
    i Action = "query" d
    .d ##class(web.DHCSTM.INRequest).jsINReqM(Start,Limit,Sort,Dir,StrPar)

    //查询请求单明细
    i Action = "queryDetail" d
    .s showFlag=$g(%request.Data("TransferedFlag",1))
    .s refuseflag=$g(%request.Data("refuseflag",1))
    .s handletype=$g(%request.Data("handletype",1))
    .s canceled=$g(%request.Data("canceled",1))
    .s ListParam=$g(%request.Data("ListParam",1))
    .s Reqdetailidstr=$g(%request.Data("Reqdetailidstr",1))
    .d ##class(web.DHCSTM.INReqItm).jsINReqD(Start,Limit,Sort,Dir,Req,refuseflag,handletype,canceled,showFlag,HOSPID,ListParam,Reqdetailidstr)

    //根据请求单Id查询相关信息
    i Action = "select" d
    .s ReqId=$Get(%request.Data("ReqId",1))
    .s m=##class(web.DHCSTM.INRequest).Select(ReqId)
    .s m=##class(web.DHCSTM.Common.UtilCommon).hJsonChar(m)
    .w "{success:'true',info:'"_m_"'}"
    .
    //保存请求出库的主表信息和明细信息
    i Action = "save" d
    .;s ^zx("fdacccf")=Req_","_ReqInfo_","_ListData
    .s result = ##class(web.DHCSTM.INRequest).Save(Req,ReqInfo,ListData)
    .i result > 0 d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

    //删除请求出库的明细信息
    i Action = "del" d
    .s result = ##class(web.DHCSTM.INReqItm).Delete(ReqItm)
    .i result = 0 d
    ..w "{success:'true',info:''}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    //删除请求单
    i Action = "Delete" d
    .s result = ##class(web.DHCSTM.INRequest).Delete(Req)
    .i result = 0 d
    ..w "{success:'true',info:''}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    
    //设置完成请求单
    i Action = "SetComp" d
    .s result = ##class(web.DHCSTM.INRequest).SetComp(Req)
    .i result = 0 d
    ..w "{success:'true',info:''}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

	//取消完成请求单
	i Action = "CancelComp" d
	.s flag=$g(%request.Data("flag",1))
	.s result = ##class(web.DHCSTM.INRequest).CancelComp(Req,flag)
	.i result = 0 d
	..w "{success:'true',info:''}"
	.e  d
	..w "{success:'false',info:'"_result_"'}"
	
	  //不再显示
    i Action = "refuse" d
    .s result = ##class(web.DHCSTM.INReqItm).SetItmStatus(Reqi)
    .i result =0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    //查询辅助请求单<消耗及补货标准>
    i Action = "queryFZ" d
    .d ##class(web.DHCSTM.INRequestAuxByConsume).jsLocItmForReq(Start,Limit,StrPar,User)
    .
    //查询辅助请求单<转移入库>
    i Action = "queryFZByTrans" d
    .s result = ##class(web.DHCSTM.INRequestAuxByTrans).jsLocItmForReq(StrPar,User)
    .i result = "" d
    ..w "{results:0,rows:[]}"
    .e  d
    ..w result

    //查询辅助请求单<库存上下限>
    i Action = "queryFZByLimit" d
    .s result = ##class(web.DHCSTM.INRequestAuxByLim).jsLocItmForReq(Start,Limit,Sort,Dir,StrPar,User)
    .i result = "" d
    ..w "{results:0,rows:[]}"
    .e  d
    ..w result
    //根据库存上下限生成请求单:保存
    i Action = "SaveForAuxByLim" d
    .s pid=$g(%request.Data("Pid",1))
    .s data=$g(%request.Data("ListData",1))
    .s result = ##class(web.DHCSTM.INRequestAuxByLim).Save(pid,data)
    .i result = 0 d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    .
    //根据库存上下限生成请求单
    i Action = "CreateReqByLim" d
    .s pid=$g(%request.Data("Pid",1))
    .s reqinfo=$g(%request.Data("ReqInfo",1))
    .s result = ##class(web.DHCSTM.INRequestAuxByLim).CreateReq(pid,reqinfo)
    .;i result'="" d
    .i +result'=0 d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    .
    //删除临时global
    i Action = "KillTmpGlobal" d
    .s pid=$g(%request.Data("Pid",1))
    .s result = ##class(web.DHCSTM.INRequestAuxByLim).KillTmpGlobal(pid)
    .w "{success:'true',info:'"_result_"'}"
    .
    
    //请求方审核库存转移请求单
    i Action="ReqSideAudit" d
    .s ret=##class(web.DHCSTM.INRequest).ReqSideAudit(Req,User)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
  
    //请求方拒绝库存转移请求单
    i Action="ReqSideDeny" d
    .s ret=##class(web.DHCSTM.INRequest).ReqSideDeny(Req,User)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
  
  
    //供应方审核库存转移请求单
    i Action="ProvSideAudit" d
    .s ret=##class(web.DHCSTM.INRequest).ProvSideAudit(Req,User)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
    
    //供应方拒绝库存转移请求单
    i Action="ProvSideDeny" d
    .s ret=##class(web.DHCSTM.INRequest).ProvSideDeny(Req,User)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
  
    //获取模板
    i Action="GetTemplate" d
    .s reqType=$g(%request.Data("reqType",1))
    .s HVflag=$g(%request.Data("HVflag",1))
    . w ##class(web.DHCSTM.INRequestTemplate).jsReqTem(LocId,reqType,HVflag)
    .
    
    i Action="ModifyQtyApproved" d
    .s inrqi=$g(%request.Data("inrqi",1))
    .s qtyApproved=$g(%request.Data("qtyApproved",1))
    .s ret=##class(web.DHCSTM.INReqItm).ModifyQtyApproved(inrqi,qtyApproved)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
   
	i Action="GetItmInfo" d
    .s IncId=$Get(%request.Data("IncId",1))
    .s Params=$Get(%request.Data("Params",1))
    .s result=##class(web.DHCSTM.INRequest).GetItmInfo(IncId, Params)
    .s result=##class(web.DHCSTM.Common.UtilCommon).hJsonChar(result)
    .w "{success:'true',info:'"_result_"'}"
	
	i Action = "GetParamProp" d
	.s GroupId=$g(%request.Data("GroupId",1))
	.s LocId=$g(%request.Data("LocId",1))
	.s UserId=$g(%request.Data("UserId",1))
	.s ret=##class(web.DHCSTM.INRequest).GetParamProp(GroupId,LocId,UserId)
	.w "{success:'true',info:'"_ret_"'}"
	.
	//供应方科室拒绝库存转移请求单
    i Action="ProvLocDeny" d
    .s Reqs=$Get(%request.Data("reqs",1))
    .s ret=##class(web.DHCSTM.INRequest).ProvLocDeny(Reqs)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
    
    ////待拆分请求单明细查询
    i Action="QuerySplitDetail" d
    .s StrPar=$Get(%request.Data("strPar",1))
    .d ##class(web.DHCSTM.INRequestSplit).jsQuerySplitDetail(Start,Limit,StrPar)
    ///拆分请求单
     i Action="SplitDetail" d
    .s Cstr=$Get(%request.Data("Cstr",1))
    .s Ostr=$Get(%request.Data("Ostr",1))
    .s StrParam=$Get(%request.Data("StrParam",1))
    .s ret=##class(web.DHCSTM.INRequestSplit).SplitDetail(Cstr,Ostr,StrParam)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
     ////查询拆分后的申购计划单
    i Action="QueryRelate" d
    .d ##class(web.DHCSTM.INRequest).QueryRelate(Start,Limit,Req)	
    
     //撤销请求单
    i Action="Cancel" d
    .
    .s ret=##class(web.DHCSTM.INReqItm).Cancel(Reqi,UserId)
    .i ret=0 d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"	
    
    //手工拆分计划单
	i Action = "SplitPlan" d
	.s flag=$g(%request.Data("flag",1))
	.s result = ##class(web.DHCSTM.INRequestTemplate).CreateReqByPlan(Req)
	.i result = 0 d
	..w "{success:'true',info:''}"
	.e  d
	..w "{success:'false',info:'"_result_"'}"
	
	i Action = "PrintMBPL" d
	.S ReqRowid=$Get(%request.Data("ReqId",1))
	.s HospId=$Get(%request.Data("HospId",1))
	.s UserId=$Get(%request.Data("user",1))
	.s ret=##class(web.DHCSTM.INRequest).InserMBPL(ReqRowid,HospId,UserId)	
	.w "{success:'true',info:'"_ret_"'}"
	
	i Action = "ChecklimitReqDetail" d
    .s ListDetail=$g(%request.Data("ListDetail",1))
    .s LocId=$g(%request.Data("LocId",1))
    .;s ^TMPHOUSC("fdaf")=LocId_","_ListDetail
    .s result = ##class(web.DHCSTM.DHCLVConfig).CheckAllReqDetailQty(LocId,ListDetail)
    .;w result
    .w "{success:'true',info:'"_result_"'}"
	
</script>