<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
 	s EpisodeID=$g(%request.Data("EpisodeID",1))
 	s PatientID=$p($g(^PAADM(+EpisodeID)),"^",1)
 	s MRAdm=$p($g(^PAADM(+EpisodeID)),"^",61)
 	s UserID=$g(%request.Data("UserID",1))
 	s UserInitial=$p($g(^SSU("SSUSR",+UserID)),"^",1)
 	s UserPassword=$p($g(^SSU("SSUSR",+UserID)),"^",3)
 	s LocID=$g(%request.Data("LocID",1))
 	s LocDesc=$p($g(^CTLOC(+LocID)),"^",2)
 	s PathWayID=$g(%request.Data("PathWayID",1))
 	s ConsultFlag=$g(%request.Data("ConsultFlag",1))
 	s NurseFlag=$g(%request.Data("NurseFlag",1))
 	s OEOutOrderFlag=$g(%request.Data("OEOutOrderFlag",1))
 	s NEOutOrderFlag=$g(%request.Data("NEOutOrderFlag",1))
 	s VarianceFlag=$g(%request.Data("VarianceFlag",1))
 	s OEOrderFlag=$g(%request.Data("OEOrderFlag",1))
 	s NEOrderFlag=$g(%request.Data("NEOrderFlag",1))
 	s NewPage=$g(%request.Data("NewPage",1))
 	
	s url=$c(0)_"EpisodeID"_$c(1)_EpisodeID
	s url=url_$c(0)_"PatientID"_$c(1)_PatientID
 	s url=url_$c(0)_"mradm"_$c(1)_MRAdm
	s url=url_$c(0)_"PathWayID"_$c(1)_PathWayID
 	s url=url_$c(0)_"ConsultFlag"_$c(1)_ConsultFlag
 	s url=url_$c(0)_"NurseFlag"_$c(1)_NurseFlag
 	s url=url_$c(0)_"OEOutOrderFlag"_$c(1)_OEOutOrderFlag
 	s url=url_$c(0)_"NEOutOrderFlag"_$c(1)_NEOutOrderFlag
 	s url=url_$c(0)_"VarianceFlag"_$c(1)_VarianceFlag
 	s url=url_$c(0)_"OEOrderFlag"_$c(1)_OEOrderFlag
 	s url=url_$c(0)_"NEOrderFlag"_$c(1)_NEOrderFlag
 	s url=url_$c(0)_"NewPage"_$c(1)_NewPage
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"%","%25")
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"+","%2B")
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url," ","%20")
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"/","%2F")
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"?","%3F")
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"#","%23")
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"&","%26")
 	s url=##Class(web.DHCCPW.MR.SysBaseSrv).Translate(url,"=","%3D")
 	s url=$tr(url,$c(0),"&")
 	s url=$tr(url,$c(1),"=")
 	s url="dhccpw.mr.formshow.csp?1=1&PortalFlg=1"_url_"&2=2"

 	s %response.ServerSideRedirect=url
 	if $d(%session.Data("LOGON.USERID"))&&($g(%session.Data("LOGON.USERID"))'="") {
 		s %response.ServerSideRedirect=url
 	}else{
		//通过Portal登录
		s %request.Data("USERNAME",1)=UserInitial
	 	s %request.Data("PASSWORD",1)=UserPassword
		s %request.Data("DEPARTMENT",1)=LocDesc
		s myrtnflag=##Class(web.portal.SessionLogon).Logon()
		if +myrtnflag=0 {
			s %response.ServerSideRedirect=url    //登录成功,跳转到临床路径表单界面
		}else{
			//s %response.ServerSideRedirect="logon.csp"    //转向登录页面
		}
 	}
 	
	q 1
</csp:method>