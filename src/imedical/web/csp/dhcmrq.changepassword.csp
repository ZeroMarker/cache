<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(DHCMRQ.Base.Util.Verification).SessionVerifi() q 1
	q 1
</csp:method>
<!DOCTYPE html>
<html>
	<head>
		<script>
		if (top == self) {
    		top.location = 'dhcmrq.index.csp';
		}
	   </script>
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-validator/css/bootstrapValidator.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/datatable-1.10.12/datatables.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/css/main.css">
		<!--[if lte IE 6]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap-ie6.css">
	  <![endif]-->
	  <!--[if lte IE 8]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/ie.css">
			<style media="screen">
				.col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9{
					padding-left: 0;
					padding-right: 0;
				}
			</style>
	  <![endif]-->
		<style media="screen">
			label.col-sm-3{
				padding-right: 0;
			}
			.table>tbody>tr.selected{
				background-color: #16c79e;
				color: #fff;
				transition: all .2s;
			}
			#roleDiv .col-sm-5{
				border: 1px solid #16c79e;
				min-height: 200px;
			}
			.panel-footer{
				text-align: right;
			}
			.table th, .table td{
				text-align: left;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="boxcq" id="two">
					<div class="ti">

					</div>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-4 col-sm-offset-4">
									
									<div class="panel panel-info">
									  <div class="panel-heading"><i class="fa fa-lock fa-lg"></i>&nbsp;&nbsp;修改密码</div>
									  <div class="panel-body">
											<form id="passwordForm" class="form-horizontal" role="form">
											<div class="form-group">
											    <label for="oldPassword" class="col-sm-3 control-label">原密码</label>
											    <div class="col-sm-9">
											      <input type="password" class="form-control" id="oldPassword" name="oldPassword">
											    </div>
											  </div>
											  <div class="form-group">
											    <label for="newPassword" class="col-sm-3 control-label">新密码</label>
											    <div class="col-sm-9">
											      <input type="password" class="form-control" id="newPassword" name="newPassword">
											    </div>
											  </div>
											  <div class="form-group">
											    <label for="confirmPassword" class="col-sm-3 control-label">确认密码</label>
											    <div class="col-sm-9">
											      <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
											    </div>
											  </div>
											</form>
									  </div>
										<div class="panel-footer">
											<button type="button" onclick="changePassword()" class="btn btn-info">确定</button>
										</div>
									</div>
									
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<DHCMRQ:HEAD></DHCMRQ:HEAD>
		<script type="text/javascript">
			$(function(){
				
	$('#passwordForm').bootstrapValidator({
		//live: 'disabled',
        message: 'This value is not valid',
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            oldPassword: {
                validators: {
                    notEmpty: {
                        message: '原密码不能为空'
                    }
                }
            },
            newPassword: {
                message: 'The Code is not valid',
                validators: {
                    notEmpty: {
                        message: '密码不能为空'
                    },
                    stringLength: {
                        min: 6 ,
                        max: 30,
                        message: '密码要大于6位小于30位字符'
                    },
                    regexp: {
                        regexp: /^[a-zA-Z0-9_]+$/,
                        message: '密码只能包含字母数字和下划线'
                    },
                    different: {
                        field: 'oldPassword',
                        message: '新密码和旧密码相同'
                    }
                }
            },
            confirmPassword: {
                validators: {
                    notEmpty: {
                        message: '请确认密码'
                    },
                    identical: {
                        field: 'newPassword',
                        message: '确认密码和密码不一致'
                    }
                }
            }
        }
    });
			})

			
			
			function changePassword(){
				//验证表单
				$('#passwordForm').bootstrapValidator('validate');
				if(!$('#passwordForm').data('bootstrapValidator').isValid()) return;
				console.log(session['LOGON.USERID']+'^'+$('#oldPassword').val()+'^'+$('#newPassword').val())
				$.ajax({
		        	type: 'post',
		        	url: 'dhcmrq.service.csp',
		        	data: {ClassName:'DHCMRQ.Base.MRQUser',
							 	   MethodName:'ChangePassword',
							 	   Params:session['LOGON.USERID']+','+$('#oldPassword').val()+','+$('#newPassword').val()
					  },
		        	success: function (res) {
			        	//console.log($('#passwordForm').serialize().replace(/&.*?=/g,'^').replace(/^.*?=/g,''))
						//console.log(res);
						if(res>0) {
							msg('success','密码修改成功!',5000);
						} else {
							msg('danger','密码修改失败!',5000);
						}
		          		
		        	}
		    	});
			}
		</script>
	</body>
</html>
