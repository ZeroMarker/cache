<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(DHCMRQ.Base.Util.Verification).SessionVerifi() q 1
	q 1
</csp:method>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>病案首页数据质量督导系统</title>
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/datatable-1.10.12/datatables.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/css/main.css">
		<!--[if lte IE 6]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap-ie6.css">
	  <![endif]-->
	  <!--[if lte IE 8]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/ie.css">
			<style media="screen">
				.col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9{
					padding-left: 0;
					padding-right: 0;
				}
			</style>
	  <![endif]-->
	  <style>
	 	.row .value{
			font-size: 30px;
			color: #ee66aa;
			text-align:center;
		}
		.row .value:hover{
			color: #e8308c;
		}
		.row .col-sm-2:hover .title{
			color: #16c79e;
		}
		.row .col-sm-4 .fa{
			color: #16c79e;
			font-size:35px;
			margin:5px 0 5px 0;
		}
		.row .col-sm-4{
			font-size:18px;
		}
		.row .title{
			color: #415064;
			font-size:15px;
			text-align:center;
			margin-bottom:10px;
		}
		.row .title .fa{
			color: #16c79e;
			font-size:20px;
			text-align:center;
		}
		.row .title i{
			margin-right:5px;
		}
		.row>div{
			text-align:center;
			
		}
		#mainTab .my-row{
			padding:10px 0;
			border-bottom:1px solid #ddd;
			min-height:63px;
			cursor:pointer;
		}
		.popover{
				max-width:400px;
			}
			.tooltip-inner{
				padding: 10px;
				text-align: left;
				max-width: none;
				line-height: 20px;
			}
	 
	 </style>
	</head>
	<body>
		<div class="navbar navbar-static-top" style="background-color:#fff;">
			<div class="container-fluid">
				<div class="navbar-header">
					<button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a href="#" class="navbar-brand">病案首页数据质量督导系统</a>
				</div>
				<nav id="bs-navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
						<!--
						<li class="active">
							<a href="../getting-started/">Getting started</a>
						</li>
						 -->
					</ul>
					<ul class="nav navbar-nav navbar-right">
						<li id="searchLi">
							<!-- 查询条件 -->
							<a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">
								<i class="glyphicon glyphicon-search"></i>
								查询条件<span class="caret"></span>&nbsp;&nbsp;
								<span class="time_id"></span>
							</a>
              <div class="dropdown-menu" id="searchBox">
								<table>
									<tr>
										<td>
											<i class="fa fa-calendar"></i>&nbsp;&nbsp;监测时间：
										</td>
										<td>
											<input id="startDate" class="form-control input-sm" readonly>
											~
											<input id="endDate" class="form-control input-sm" readonly>
										</td>
									</tr>
									<tr>
										<td colspan="2">
											<button class="btn btn-success btn-block" onclick="searchByCondition()"><i class="glyphicon glyphicon-search"></i>查询</button>
										</td>
									</tr>
								</table>
              </div>
							<!-- 查询条件 end -->
						</li>
					</ul>

				</nav>
			</div>
		</div>
		<div class="container-fluid">

			<!-- 中部表格图表 -->
			<div class="row">
				<div class="boxcq">
					<div class="ti">
						<i class="fa fa-hospital-o fa-lg"></i>&nbsp;&nbsp;全院总体情况
					</div>
					<ul class="nav nav-tabs boxnavcq" role="tablist">
						<li></li>
					</ul>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active" id="mainTab">
							<div class="row" style="padding:10px 0;font-size:20px;">
								<div class="col-sm-4">
								</div>
								<div class="col-sm-2 clinic">
									<div class="title"><i class="fa fa-user-md"></i>临床版</div>
								</div>
								<div class="col-sm-2 coding">
									<div class="title"><i class="fa fa-medkit"></i>编目版</div>
								</div>
								<div class="col-sm-2 hqms">
									<div class="title"><i class="fa fa-h-square"></i>HQMS</div>
								</div>
								<div class="col-sm-2 wt4">
									<div class="title"><i class="fa fa-university"></i>卫统版</div>
								</div>
							</div>
							
						</div>
						
					</div>
				</div>
			</div>
		</div>
		<!--
		<footer id="footer">
			<div class="container">
        <p class="text-muted">copyright <i class="fa fa-heartbeat fa-lg"></i> DHCC</p>
      </div>
		</footer>
		 -->
		 
		 <div id="loading">
		 	<img src="../scripts/dhcmrq/images/loading.gif"/>
		 	<h3 class="info">正在加载<br>...</h3>
		 </div>
		 
		<DHCMRQ:HEAD></DHCMRQ:HEAD>
<script type="text/javascript">
//console.log(parent.session)
init();//初始化

	var quotas =[
				{quotaCode:'fpCnt',quotaName:'病例数',quotaIcon:'fa-users',quotaUnit:'人'},
				{quotaCode:'fpCplRatio',quotaName:'病案首页填报完整率',quotaIcon:'fa-calendar-check-o',quotaUnit:'%'},
				{quotaCode:'fpRqItmCplRatio',quotaName:'病案首页项目填报完整率',quotaIcon:'fa-wpforms',quotaUnit:'%'},
				{quotaCode:'mRqItmAvg',quotaName:'每份不完整病历的平均缺失数',quotaIcon:'fa-braille',quotaUnit:'个'},
				{quotaCode:'hospAvgScore',quotaName:'首页质量平均得分',quotaIcon:'fa-star-half-o',quotaUnit:'分'},
				{quotaCode:'fpErrACnt',quotaName:'A类错误病例数',quotaIcon:'fa-times-circle-o',quotaUnit:'人'},
				{quotaCode:'errorARatio',quotaName:'A类扣分项目占比',quotaIcon:'fa-pie-chart',quotaUnit:''}
				];
	var template = '';
	var errorDetail = '';
	for(var i=0;i<quotas.length;i++){
		var quota = quotas[i];
		if(quota['quotaCode']=='errorARatio') errorDetail = '<a class="link errorADetail" role="button" title="扣分项信息" style="position:absolute;bottom:0px;right:10px;"><i class="fa fa-info-circle fa-2x"></i></a>';
		template += '<div class="row my-row">'
				 +'		<div class="col-sm-4">'
				 +'			<i class="fa '+quota['quotaIcon']+' fa-lg"></i><br>'+quota['quotaName']
				 +'		</div>'
				 +'		<div class="col-sm-2 clinic">'
				 +'			<span class="value '+quota['quotaCode']+'"></span>'+quota['quotaUnit']
				 +'			'+errorDetail
				 +'		</div>'
				 +'		<div class="col-sm-2 coding">'
				 +'			<span class="value '+quota['quotaCode']+'"></span>'+quota['quotaUnit']
				 +'			'+errorDetail
				 +'		</div>'
				 +'		<div class="col-sm-2 hqms">'
				 +'			<span class="value '+quota['quotaCode']+'"></span>'+quota['quotaUnit']
				 +'			'+errorDetail
				 +'		</div>'
				 +'		<div class="col-sm-2 wt4">'
				 +'			<span class="value '+quota['quotaCode']+'"></span>'+quota['quotaUnit']
				 +'			'+errorDetail
				 +'		</div>'
				 +'	</div>';
	}
	
	$('#mainTab').append(template);
	
searchByCondition();
	
function loadData(){
	$.post('dhcmrq.service.csp',
			{ClassName:'DHCMRQ.Compute.Hospital',
			 MethodName:'GetHospInfo',
			 Params:startDate+','+endDate+',CLINIC'
			},
			function(data){
				try{
					loadHospData(JSON.parse(data)[0],'clinic');
				}catch(err){
					console.error(err);
					console.log(data);
					data = '[{"fpCnt":"-","fpCplRatio":"-","fpCplRR":"-/-","fpRqItmCplRatio":"-","fpRqItmCplRR":"-/-","mRqItmAvg":"-","hospAvgScore":"-","fpErrACnt":"-","errorARatio":"-/-","errADtl":[]}]';
					loadHospData(JSON.parse(data)[0],'clinic');
				}
	});
	
	$.post('dhcmrq.service.csp',
			{ClassName:'DHCMRQ.Compute.Hospital',
			 MethodName:'GetHospInfo',
			 Params:startDate+','+endDate+',CODING'
			},
			function(data){
				try{
					loadHospData(JSON.parse(data)[0],'coding');
				}catch(err){
					console.error(err);
					console.log(data);
					data = '[{"fpCnt":"-","fpCplRatio":"-","fpCplRR":"-/-","fpRqItmCplRatio":"-","fpRqItmCplRR":"-/-","mRqItmAvg":"-","hospAvgScore":"-","fpErrACnt":"-","errorARatio":"-/-","errADtl":[]}]';
					loadHospData(JSON.parse(data)[0],'coding');
				}
			}
	);
	
	$.post('dhcmrq.service.csp',
			{ClassName:'DHCMRQ.Compute.Hospital',
			 MethodName:'GetHospInfo',
			 Params:startDate+','+endDate+',HQMS'
			},
			function(data){
				try{
					loadHospData(JSON.parse(data)[0],'hqms');
				}catch(err){
					console.error(err);
					console.log(data);
					data = '[{"fpCnt":"-","fpCplRatio":"-","fpCplRR":"-/-","fpRqItmCplRatio":"-","fpRqItmCplRR":"-/-","mRqItmAvg":"-","hospAvgScore":"-","fpErrACnt":"-","errorARatio":"-/-","errADtl":[]}]';
					loadHospData(JSON.parse(data)[0],'hqms');
				}
	});
	
	$.post('dhcmrq.service.csp',
			{ClassName:'DHCMRQ.Compute.Hospital',
			 MethodName:'GetHospInfo',
			 Params:startDate+','+endDate+',WT4'
			},
			function(data){
				try{
					loadHospData(JSON.parse(data)[0],'wt4');
				}catch(err){
					console.error(err);
					console.log(data);
					data = '[{"fpCnt":"-","fpCplRatio":"-","fpCplRR":"-/-","fpRqItmCplRatio":"-","fpRqItmCplRR":"-/-","mRqItmAvg":"-","hospAvgScore":"-","fpErrACnt":"-","errorARatio":"-/-","errADtl":[]}]';
					loadHospData(JSON.parse(data)[0],'wt4');
				}
	});
	
	
	
	/*
	//全院必填项信息 clinic
	var hospRqItemInfo=tkMakeServerCall("DHCMRQ.Compute.HospData","GetHospRqItemInfo",startDate,endDate,'CLINIC');
	loadHospBaseData(JSON.parse(hospRqItemInfo)[0],'clinic');
	*/
}

$('.clinic').click(function(){
	var param = 'startDate='+$("#startDate").val()
	  			   +'&endDate='+$("#endDate").val()
	  			   +'&mrVersionCode=CLINIC';
	addTab('病案质控','dhcmrq.main.csp?'+param,'mainPage');
})
$('.coding').click(function(){
	var param = 'startDate='+$("#startDate").val()
	  			   +'&endDate='+$("#endDate").val()
	  			   +'&mrVersionCode=CODING';
	addTab('病案质控','dhcmrq.main.csp?'+param,'mainPage');
	//addTab('责任科室病案质控','dhcmrq.home.dutydep.csp?'+param,'dutyMainPage');
})
$('.hqms').click(function(){
	var param = 'startDate='+$("#startDate").val()
	  			   +'&endDate='+$("#endDate").val()
	  			   +'&mrVersionCode=HQMS';
	addTab('病案质控','dhcmrq.main.csp?'+param,'mainPage');
})
$('.wt4').click(function(){
	var param = 'startDate='+$("#startDate").val()
	  			   +'&endDate='+$("#endDate").val()
	  			   +'&mrVersionCode=WT4';
	addTab('病案质控','dhcmrq.main.csp?'+param,'mainPage');
})

function loadHospData(data,version){
	if(!isNaN(data['mRqItmAvg'])){
		data['mRqItmAvg'] = Number(data['mRqItmAvg']).toFixed(2);
	}				
	
	$('.'+version+' .fpCplRatio').html((data['fpCplRatio']+' ').replace(/(\.00)|%/g,''));
	$('.'+version+' .fpRqItmCplRatio').html((data['fpRqItmCplRatio']+' ').replace(/(\.00)|%/g,''));
	$('.'+version+' .mRqItmAvg').html(data['mRqItmAvg'].replace(/(\.00)|%/g,''));
	$('.'+version+' .fpCnt').html((data['fpCnt']+' ').replace(/(\.00)|%/g,''));
	
	var popContent = '<table>';
	var errorADtl = data['errADtl'];
if(errorADtl && errorADtl.length>0){
	for(var i=0;i<errorADtl.length;i++){
		popContent += '<tr><td>'+errorADtl[i]['name']+'</td><td>:&nbsp;'+errorADtl[i]['triggerCnt']+'</td></tr>';
		
	}
	popContent += '</table>';
	$('.'+version+' .errorADetail').attr('data-content',popContent);
	$('.'+version+' .errorADetail').popover({
								trigger:'hover',
								placement:'auto left',
								html:true,
								title:'扣分项信息'
								});
}else {
	$('.'+version+' .errorADetail').remove();
}
	$('.'+version+' .hospAvgScore').html((data['hospAvgScore']+' ').replace(/(\.00)|%/g,''));
	$('.'+version+' .fpErrACnt').html((data['fpErrACnt']+' ').replace(/(\.00)|%/g,''));
	$('.'+version+' .errorARatio').html((data['errorARatio']+' ').replace(/(\.00)|%/g,''));

}
</script>
	</body>
</html>
