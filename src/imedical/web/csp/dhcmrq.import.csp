<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(DHCMRQ.Base.Util.Verification).SessionVerifi() q 1
	q 1
</csp:method>
<html>
	<head>
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title></title>
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/datatable-1.10.12/datatables.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/css/main.css">
		<style>
		#file{
			/*兼容火狐，相当于padding-left、padding-top*/
			padding-inline-start: 0;
			padding-block-start: 0;
			
		}
		
		/*兼容IE11*/
		_:-ms-fullscreen, :root #file { padding:0;  }
		form label{
			color: #000;

		}
		
		#loading p{
			position: absolute;
    		top: 50%;
    		width: 100%;
    		margin: 120px 0 0 0;
    		text-align: center;
    		color: #596c76;
		}
		</style>
		<!--[if lte IE 6]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap-ie6.css">
	  <![endif]-->
	  <!--[if lte IE 8]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/ie.css">
			<style media="screen">
				.col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9{
					padding-left: 0;
					padding-right: 0;
				}
			</style>
	  <![endif]-->
<script>
		if (top == self) {
    		top.location = 'dhcmrq.index.csp';
		}
	   </script>
	</head>
	<body>
		<div class="navbar navbar-static-top" style="background-color:#fff;">
			<div class="container-fluid">
				<div class="navbar-header">
					<button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a href="#" class="navbar-brand"></a>
				</div>
				<nav id="bs-navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
					</ul>
					<ul class="nav navbar-nav navbar-right">
					</ul>

				</nav>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row">
				<div class="boxcq">
					<div class="ti">
						<i class="fa fa-upload fa-lg"></i>病案首页上传
					</div>
					<ul class="nav nav-tabs boxnavcq" role="tablist">
						<li><a class="licenseWarning" style="color:red;"></a></li>
					</ul>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-12" id="formDiv">
									<form id="form1" style="text-align:center;" enctype="multipart/form-data" class="form-inline" role="form">
										<label for="verCode" class="control-label">首页版本:</label>
										<select class="form-control" name="verCode" id="verCode">
											<option value="V2012.BJ">V2012.BJ</option>
										</select>&nbsp;&nbsp;
										<label for="appCode" class="control-label">应用版本:</label>
										<select class="form-control" name="appCode" id="appCode">
											<option value="BJ.XH.Clinic">临床</option>
											<option value="BJ.XH.Coding">编目</option>
											<option value="BJ.XH.HQMS">HQMS</option>
											<option value="BJ.XH.WT4">卫统4</option>
										</select>
										<input id="file" type="file" class="form-control" style="width:300px;" name="file"/>
										<a class="btn btn-success" href="javascript:upload()" id="uploadBtn" style="width:100px;">上传</a>
									</form>
								</div>
							</div>
						</div>
						<div class="progress">
  							<div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" style="width: 0%;transition:width 2000s;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
<!-- Modal -->
<div class="modal fade" id="importDialog" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel"><i class="ace-icon fa fa-question-circle green"></i>&nbsp;首页上传确认</h4>
      </div>
      <div class="modal-body">
        
      </div>
      <div class="modal-footer">
        <input type="checkbox" id="runRule" checked="checked">
        <label for="runRule" class="control-label">执行质控规则</label>
        <input type="checkbox" id="DRGsGroup" checked="checked">
        <label for="DRGsGroup" class="control-label">执行DRGs分组</label>
        <button type="button" class="btn btn-success" onclick="importData()" data-dismiss="modal">确认导入</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

		 <div id="loading">
		 	<img src="../scripts/dhcmrq/images/loading.gif"/>
		 	<h3 class="info">正在保存<br>...</h3>
		 	<p>可能需要几分钟...</p>
		 </div>
		 <input type="text" id="url" style="display:none;"/>
		<DHCMRQ:HEAD></DHCMRQ:HEAD>
<script type="text/javascript">
if(session['LOGON.VALIDLIC']=='0') {
	$('.licenseWarning').html('License已过期，将不能导入数据，请更新License！');
}
$('#url').val(getConf('mrUploadURL'));

var progressUrl = $('#url').val().replace(/(.*\/).*/,'$1')+'getProgress.dhc';

//console.log('conf:'+getConf('mrUploadURL'));
//console.log('val:'+$('#url').val());
console.log(getConf('hospCode').trim())

//上传导临时表
function upload(){
	if($('#uploadBtn').attr('disabled')) return;
	if(session['LOGON.VALIDLIC']=='0') {
		msg('warning','License已过期，请更新License！');
		return;
	} else if ($('#url').val()==''){
		msg('warning','首页上传地址未配置，请先配置上传地址！');
		return;
	} else if(!getConf('hospCode') || getConf('hospCode').trim()==''){
		msg('warning','医院代码未配置，请先配置医院代码：hospCode！');
		return;
	} else if($('#file').val()==''){
		msg('warning','请选择文件',5000);
		$('#file').focus().click();
		return;
	}
	
	$('#uploadBtn').html('<i class="fa fa-spinner fa-spin fa-fw"></i>&nbsp;正在上传').attr('disabled','disabled');
	
	var formData = new FormData($('#form1')[0]);
	formData.append('hospCode', getConf('hospCode'));
	
	$('.progress-bar').css('transition','width 0s').css('width','0%');
	$('.progress-bar').css('transition','width 5s linear').addClass('active');
	var timer = setInterval(getProgress,5000);
	$.ajax({
	    url: $('#url').val(),
	    type: 'POST',
	    cache: false,
	    data: formData,
	    processData: false,
	    contentType: false
	}).done(function(result) {
		
		if(result.success){
			//msg('success',result.msg);
			clearInterval(timer);
			$('.progress-bar').css('transition','width 1s').css('width','100%').removeClass('active');
			$('#importDialog').modal('show').find('.modal-body').html(result.msg);
			
		} else if(result){
			msg('danger',result.msg);
			clearInterval(timer);
			$('.progress-bar').css('transition','width 1s').css('width','0%');
			console.log(result.msg)
			console.log(result.data)
		}
		
		$('#uploadBtn').html('上传').removeAttr('disabled');
		
	}).fail(function(res) {
		clearInterval(timer);
		$('.progress-bar').css('transition','width 1s').css('width','0%');
		console.error(res)
		msg('danger','请检查解析服务是否正常');
		console.log(res)
		$('#uploadBtn').html('上传').removeAttr('disabled');
	});
}

function getProgress(){
	$.post(progressUrl,function(res){
		//console.log(res)
		$('.progress-bar').css('width',(res.data.successNum*100/res.data.totalNum)+'%');
	})
}

//保存到正式表
function importData(){
	var stime=new Date().getTime();
	if(getConf('hospCode') && getConf('hospCode').trim()!=''){
		var verCode = $('#verCode').val();
		var appCode = $('#appCode').val();
		var hospCode = getConf('hospCode').trim();
		//console.log($('#runRule').is(':checked'))
		var logInfo = $('#file').val()+'^'+($('#runRule').is(':checked')?1:0)+'^'+($('#DRGsGroup').is(':checked')?1:0)+'^'+session['LOGON.USERNAME'];
		
		console.log(verCode+','+appCode+','+hospCode+','+logInfo)
		$('#loading').fadeIn();
		$.ajax({
	    	type: 'POST',
        	url: 'dhcmrq.service.csp', 
        	data: {ClassName:'DHCMRQ.MRService.SetDataByFile',
			   MethodName:'SaveFrontPage',
			   Params:verCode+','+appCode+','+hospCode+','+logInfo
			}
		}).done(function(res) {
			msg('success',res);
			console.log('成功了')
			console.log(res)
			console.log('time:'+(new Date().getTime()-stime));
			$('#loading').fadeOut();
		}).fail(function(res) {
			msg('error',res);
			console.log('失败了')
			console.log(res)
			console.log('time:'+(new Date().getTime()-stime));
			$('#loading').fadeOut();
		});
	} else {
		msg('warning','请配置医院代码：hospCode');
	}
}

</script>
	</body>
</html>
