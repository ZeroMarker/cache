<csp:content charset="utf-8">
<script runat="server" language="cache">
	s act = $g(%request.Data("act",1))
	if (act="getTalbeNameList"){
		set packageName = $g(%request.Data("packageName",1))
		set className = $g(%request.Data("tableName",1))
		//set className = "DHCPatBillDetailsOl"
		;set ns = $namespace
		;zn "dhc-app"	
		set rs=##class(%ResultSet).%New("web.Util.DHCJFClassGlobal:SelectClass")
		set sc=rs.Execute(packageName,className)  If $$$ISERR(sc) Do DisplayError^%apiOBJ(sc) Quit
		w "{"
		if rs.Next() w """"_rs.GetData(1)_""": """_rs.GetData(1)_""""
		while rs.%Next() { 		
			w ","""_rs.GetData(1) _""": """_ rs.GetData(1)_""""				
		}
		w "}"
		;zn ns
		q
	} elseif(act="getTableListByPre"){
		set packageName =  $g(%request.Data("P1",1))
		set preTableName = $g(%request.Data("P2",1))		
		set info=##class(web.Util.DHCJFClassGlobal).GetTableListByPre(packageName,preTableName)
		w info
		q
	}elseif(act="getFieldListByPre"){
		set packageName =  $g(%request.Data("P1",1))
		set preTableName = $g(%request.Data("P2",1))
		set preFieldName = $g(%request.Data("P3",1))		
		set info=##class(web.Util.DHCJFClassGlobal).getFieldListByPre(packageName,preTableName,preFieldName)
		w info
		q
	}elseif(act="getPropertyPiece"){
		set tableName = $g(%request.Data("P1",1))
		set propertyName = $g(%request.Data("P2",1))
		set info=##class(web.Util.DHCJFClassGlobal).GetPropertyPiece(tableName,propertyName)
		w info
		q
	}elseif(act="getComponentNameList") {
		set componentName = $g(%request.Data("componentName",1))
		;set ns = $namespace
		;zn "dhc-app"	
		set rs=##class(%ResultSet).%New("web.Util.DHCJFClassGlobal:SelectComponent")
		set sc=rs.Execute(componentName)  If $$$ISERR(sc) Do DisplayError^%apiOBJ(sc) Quit
		set count = 1
		w "{"
		if rs.Next() w """"_rs.GetData(1)_""": """_rs.GetData(1)_""""
		while rs.%Next(),count<13 { 		
			w ","""_rs.GetData(1) _""": """_ rs.GetData(1)_""""				
			s count=count+1
		}
		w "}"
		;zn ns
		q
	} elseif (act="download"){
		s filename = $g(%request.Data("filename",1))
		s dirname = $g(%request.Data("dirname",1))
		if (##class(%File).Exists(dirname_filename)){
			s stream=##class(%FileCharacterStream).%New()
			s stream.Filename=dirname_filename
			;d %response.Reset()
			s %response.ContentType = "text/xml" ;"application/x-download" ;"application/octet-stream"
			d %response.SetHeader("Pragma", "No-cache")
			d %response.SetHeader("Cache-Control", "No-cache")
			s %response.Expires=0 ;setDateHeader("Expires", 0)
			d %response.SetHeader("Content-Disposition", "attachment; filename="_filename)
			d %response.SetHeader("Content-Length",stream.Size)
			d %response.SetHeader("Content-Type","text/xml; charset=utf-8")
			s %response.CharSet = "UTF-8" 
			d stream.Rewind()
			while('stream.AtEnd){
				w $zcvt(stream.ReadLine(),"O","HTML")
			}
			d stream.Clear()
			s stream=""
			d %response.Flush()	
		}else{
			d %response.Abort()
			w "404 没找到文件"	
		}
	}
	q 1
</script>