<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
 i ##Class(websys.SessionEvents).SessionExpired()
 //i ##Class(ext.websys.SessionEvents).SessionExpired() q 1
 quit 1
</csp:method>
<HTML XMLNS=TRAK>
<meta charset="utf-8" /> 
<HEAD>
<TITLE><TRAK:TRANSLATE id=title>##(%session.Get("TITLE"))##</TRAK:TRANSLATE></TITLE>
<!-- <TRAK:HEAD></TRAK:HEAD> -->
<EXTHEALTH:HEAD></EXTHEALTH:HEAD>

<SERVER>
 s USERID=$G(%session.Data("LOGON.USERID"))
 s USERCODE = $G(%session.Data("LOGON.USERCODE"))
 s USERNAME = $G(%session.Data("LOGON.USERNAME"))
 s HOSPID=$G(%session.Data("LOGON.HOSPID"))
 s (HospCode,LocCode,LocName,HospName)=""
 i $l(HOSPID) s HospCode=$p($g(^CT("HOSP",HOSPID)),"^",1)
 i $l(HOSPID) s HospName=$p($g(^CT("HOSP",HOSPID)),"^",2)
 
 //处理医院信息 
 s HospitalDR=""
 i $l(HospCode) s HospitalDR=##Class(DHCLIS.DHCCommon).GetHospitalDR(HospCode,HospName)
 //处理用户信息
 i $l(USERCODE) s CollectUserDR=##Class(DHCLIS.DHCCommon).GetUserDR(USERCODE,USERNAME,HospitalDR)
</SERVER>
<!-- Put your page Title here -->
<title>审批大量用血</title>
	<script type="text/javascript" src="../scripts_lib/hisui-0.1.0/hisuisource.js" ></script>
	<link   type="text/css" href="../scripts_lib/plug/font-awesome-4.3.0/css/font-awesome.min.css" rel="stylesheet" />
	<script src="../scripts/websys.jquery.js" type="text/javascript"></script>
	<script type="text/javascript" src="../scripts_lib/jquery-easyui-1.3.2/locale/easyui-lang-zh_CN.js" charset="utf-8"></script>
    <style>
    .PatientInfo {
        border: 0px;
        display: none;
        border-bottom: 1px double #061fe9;
        padding: 5px 5px 7px 15px
    }

        .PatientInfo span {
            font-weight: bold;
            border-bottom: 1px solid #000000;
        }

    .ReqFormListInfo table {
        width: 100%;
        border: 0px;
        border-bottom: 2px dotted #00ff90;
        line-height: 20px
    }

    .Operate {
        height: 70px;
        width: 100%;
        position: absolute;
        bottom: 0px;
        border-top: 1px double #061fe9;
    }
    </style>
</head>
<body>
    <div class="hisui-layout" data-options="fit:true">
        <div data-options="region:'west',title:'审核单列表',split:true,collapsible:false,headerCls:'panel-header-gray',iconCls:'icon-paper'" style="width: 370px;">
            <table id="dg_ApprovalList"></table>
        </div>
        <div data-options="region:'center',title:'申请信息',headerCls:'panel-header-gray',iconCls:'icon-paper'" style="padding: 5px;">
            <div class="PatientInfo">
                <table style="width: 100%">
                    <tr>
                        <td rowspan="2">
                            <span id="sp_PatName" style="padding-right: 10px; font-size: 25px; font-weight: bold; font-family: KaiTi"></span>
                            <span id="sp_Sex" style="padding-right: 10px; font-size: 19px; font-family: KaiTi"></span>
                        </td>
                        <td>年龄：<span id="sp_Age"></span>
                        </td>
                        <td>登记号：<span id="sp_RegNo"></span>
                        </td>
                        <td>病案号：<span id="sp_MedicalRecordNo"></span>
                        </td>
                        <td>科室：<span id="sp_Location"></span>
                        </td>
                        <td>病区：<span id="sp_Ward"></span>
                        </td>
                        <td>床号：<span id="sp_BedNo"></span>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">身份证号：<span id="sp_IDNumber"></span>
                        </td>
                        <td colspan="4">诊断：<span id="sp_Diagnosis"></span>
                        </td>
                    </tr>
                    <tr>
                    </tr>
                </table>
            </div>
            <div class="ReqFormListInfo">
            </div>
            <div class="Operate">
                <table style="width: 100%">
                    <tr>
                        <td>审批意见：<input id="text_ApprovOpinion" type="text" style="width: 85%" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding-top: 10px; text-align: center">
                            <a id="" href="#" class="hisui-linkbutton" data-options="iconCls:'icon-save'" onclick="ApprovalReqForm();">通过</a>
                            &nbsp&nbsp&nbsp&nbsp
                            <a id="" href="#" class="hisui-linkbutton" data-options="iconCls:'icon-cancel'" onclick="RefuseApprovalReqForm();">拒审</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <table id="tb_ApprovalList">
        <tr>
            <td>申请日期：<input id="db_SttDate" type="text" class="easyui-datebox" required="required" style="width: 120px" />--
                <input id="db_EndDate" type="text" class="easyui-datebox" required="required" style="width: 120px" />
            </td>
        </tr>
        <tr>
            <td>审批状态：
                 <label>
                     <input name="ApproveType" type="radio" value="10" onclick="LoadApprovalList()" checked="checked" />申请</label>
                <label>
                    <input name="ApproveType" type="radio" value="20" onclick="LoadApprovalList()" />通过</label>
                <label>
                    <input name="ApproveType" type="radio" value="30" onclick="LoadApprovalList()" />拒绝</label>
                <label>
                    <input name="ApproveType" type="radio" value="40" onclick="LoadApprovalList()" />作废</label>
                <label>
                    <input name="ApproveType" type="radio" value="" onclick="LoadApprovalList()" />全部</label>
            </td>
        </tr>
    </table>
    <script type="text/javascript">
    var me = {
        ApprovalListDR: "",
    }
    $(function () {
        //全局ajax开始
        $(document).ajaxStart(function () {
            $("<div class=\"datagrid-mask\"></div>").css({ display: "block", width: "100%", height: document.body.scrollHeight }).appendTo("body");
            $("<div class=\"datagrid-mask-msg\"></div>").html("正在处理，请稍候。。。").appendTo("body").css({ display: "block", left: ($(document.body).outerWidth(true) - 190) / 2, top: ($(window).height() - 45) / 2 });
        });
        //全局ajax结束
        $(document).ajaxStop(function (evt, request, settings) {
            $(".datagrid-mask").remove();
            $(".datagrid-mask-msg").remove();
        });

        var TodayDate = GetCurentDate();
        var ThreeDataAgo = getNextDays(TodayDate, -3);
        $("#db_SttDate").datebox({
            onSelect: function (date) {
                LoadApprovalList();
            }
        });
        $("#db_EndDate").datebox({
            onSelect: function (date) {
                LoadApprovalList();
            }
        });
        $("#db_SttDate").datebox("setValue", ThreeDataAgo);
        $("#db_EndDate").datebox("setValue", TodayDate);
        $("#dg_ApprovalList").datagrid({
            fit: true,
            border: false,
            toolbar: '#tb_ApprovalList',
            columns: [[
                { field: 'ApprovalNo', title: '审批单号', width: 100, align: 'center' },
                {
                    field: 'ApproveType', title: '状态', width: 50, align: 'center',
                    formatter: function (value, row, index) {
                        var retStr = "";
                        switch (value) {
                            case "10":
                                retStr = "申请";
                                break;
                            case "20":
                                retStr = "通过";
                                break;
                            case "30":
                                retStr = "拒审";
                                break;
                            case "40":
                                retStr = "作废";
                                break;
                            default:
                                retStr = "未知";
                                break;
                        }
                        return retStr;
                    }
                },
                { field: 'AddDate', title: '申请日期', width: 100, align: 'center' },
                { field: 'AddUserName', title: '申请人', width: 100, align: 'right' }
            ]],
            singleSelect: true,
            onSelect: function (rowIndex, rowData) {
                LoadApprovalInfo(rowData["ApprovalListDR"]);
            },
            onLoadSuccess: function (data) {
                $(".ReqFormListInfo").html("");
                me.ApprovalListDR = "";
                $(".PatientInfo").css("display", "none");
            }
        });
        LoadApprovalList();
    });

    //载入审核单列表
    function LoadApprovalList() {		
        var SttDate = $("#db_SttDate").datebox("getValue");
        var EndDate = $("#db_EndDate").datebox("getValue");
        var ApproveType = $('input:radio[name="ApproveType"]:checked').val();
        $("#dg_ApprovalList").datagrid({
	        url:'jquery.easyui.dhclabclassjson.csp?ClassName=DHCLIS.BLD.DHCBDApprovalReqForm&QueryName=QryApprovalReqFormList&FunModul=JSON&P0='+SttDate+'&P1='+EndDate+'&P2=REF&P3='+ApproveType,
	        method: 'get',
//			queryParams: { 
//				ClassName:"DHCLIS.BLD.DHCBDApprovalReqForm",
//				QueryName:"QryApprovalReqFormList",
//				FunModul:"JSON",
//				P0:SttDate, 
//				P1:EndDate, 
//				P2:ApproveType, 
//				P3:"",  //ToDate:"", 
//				P4:"",  //LocCode:"", 
//				P5:"",  //AuthFlag:"", 
//				P6:"",  //AllTS:"", 
//				P7:"",  //AdmDateFlag:""
//				P8:"",
//				P9:"",   //ReadFlag
//				P10:"",	 //RegNo
//				P11:"",  //LocationDR
//				P12:"",  //WardDR
//				P13:""  //PrintFlag
//			},		
        });
    }

    //加载审核单关联信息
    function LoadApprovalInfo(ApprovalDR) {
        me.ApprovalListDR = ApprovalDR;
        $(".ReqFormListInfo").html("");
        if (ApprovalDR.length == 0) {
            $(".PatientInfo").css("display", "none");
        }
        $(".PatientInfo").css("display", "block");
        $.ajax({
	        url:'jquery.easyui.dhclabclassjson.csp',
	        data: { 
				 ClassName:"BLD.WS.BLL.DHCBDApprovalList",
				 QueryName:"QryReqFormListByApr",
				 FunModul:"JSON",
				 P0:ApprovalDR
			 },
            success: function (data) {
	            data = jQuery.parseJSON(data)["rows"];
                if (data.length > 0) {
                    for (var index = 0; index < data.length; index++) {
                        //展示病人信息
                        if (index == 0) {
                            for (var i = 0; i < $(".PatientInfo span").length; i++) {
                                var NodeName = $(".PatientInfo span")[i]["id"];
                                NodeName = NodeName.replace("sp_", "");
                                $(".PatientInfo span").eq(i).html(data[0][NodeName]);
                            }
                        }
                        console.log(data[index]);
                        var ReqFormInfo = data[index];
                        //展示申请单信息
                        var HtmlStr = "<table><tr><td>";
                        HtmlStr += "申请单号：" + ReqFormInfo["ReqFormNo"] + "</td>";
                        HtmlStr += "<td>申请类型：" + ReqFormInfo["ReqTypeName"] + "</td>";
                        HtmlStr += "<td>预定日期：" + ReqFormInfo["BookDate"] + "</td>";
                        HtmlStr += "<td>审核时间：" + ReqFormInfo["CheckDate"] + "&nbsp&nbsp" + ReqFormInfo["CheckTime"] + "</td>";
                        HtmlStr += "<td>审核人：" + ReqFormInfo["CheckUserName"] + "</td>";
                        HtmlStr += "</tr>"
                        var ProductListObj = JSON.parse(ReqFormInfo["ProductList"]);
                        for (var j = 0; j < ProductListObj.length; j++) {
                            HtmlStr += "<tr>";
                            HtmlStr += "<td>申请血型：" + ProductListObj[j]["ReqBloodGroup"] + "</td>";
                            HtmlStr += "<td>血产品：<b>" + ProductListObj[j]["ReqProduct"] + "</b></td>";
                            HtmlStr += "<td>申请量：<b>" + ProductListObj[j]["Volumn"] + "&nbsp&nbsp" + ProductListObj[j]["Unit"] + "</b></td>";
                            HtmlStr += "<td colspan=\"2\">输血目的：" + ProductListObj[j]["Purpose"] + "</td>";
                            HtmlStr += "</tr>";
                        }
                        HtmlStr += "</table>";
                        $(".ReqFormListInfo").append(HtmlStr);
                    }
                    //展示审批信息
                    $(".Operate").css("display", "block");
                    var SelectedRow = $("#dg_ApprovalList").datagrid("getSelected");
                    var ApproveType = SelectedRow["ApproveType"];
                    if (SelectedRow["ApprovalReason"].length > 0) {
                        var HtmlStr = "<table style='padding-top:12px'>";
                        HtmlStr += "<tr>";
                        HtmlStr += "<td colspan='3'>申请原因：" + SelectedRow["ApprovalReason"] + "</td>";
                        HtmlStr += "</tr>";
                        HtmlStr += "</table>";
                        $(".ReqFormListInfo").append(HtmlStr);
                    }
                    if (ApproveType != "10") {
                        $(".Operate").css("display", "none");
                        var HtmlStr = "<table style='padding-top:20px'>";
                        HtmlStr += "<tr style='border-bottom: 1px double #061fe9;'><td style='font-size:19px;text-align:center;font-weight:bold;border-bottom: 1px double #061fe9;' colspan='3'>审批信息</td></tr>"
                        var ApproveTypeStr = "";
                        switch (ApproveType) {
                            case "10":
                                ApproveTypeStr = "申请";
                                break;
                            case "20":
                                ApproveTypeStr = "通过";
                                break;
                            case "30":
                                ApproveTypeStr = "拒审";
                                break;
                            case "40":
                                ApproveTypeStr = "作废";
                                break;
                            default:
                                ApproveTypeStr = "未知";
                                break;
                        }
                        HtmlStr += "<tr><td>审批状态：" + ApproveTypeStr + "</td>";
                        HtmlStr += "<td>审批时间：" + SelectedRow["ApproveDate"] + "&nbsp&nbsp" + SelectedRow["ApproveTime"] + "</td>";
                        HtmlStr += "<td>审批人：" + SelectedRow["ApproveUserName"] + "</td>";
                        HtmlStr += "</tr>";
                        if (SelectedRow["ApprovOpinion"].length > 0) {
                            HtmlStr += "<tr>";
                            HtmlStr += "<td colspan='3'>审批意见：" + SelectedRow["ApprovOpinion"] + "</td>";
                            HtmlStr += "</tr>";
                        }
                        HtmlStr += "</table>";
                        console.log(HtmlStr)
                        $(".ReqFormListInfo").append(HtmlStr);
                    }
                }
            }
        });
    }
    //审批
    function ApprovalReqForm() {
        var ApprovOpinion = $("#text_ApprovOpinion").val();
        $.messager.confirm('确认', '您确认想要<span style="font-weight:bold;color:red">审批通过</span>吗？此操作不可取消！', function (r) {
            if (r) {
	            $.ajaxRunServerMethod({ClassName:"DHCLIS.BLD.DHCBDApprovalReqForm",MethodName:"ApprovalReqForm",UserID:"#((USERID))#",ApprovalListDR:me.ApprovalListDR,ApprovOpinion:ApprovOpinion},
		           function(rtn){
					   if (rtn == "0") {
						   LoadApprovalList();
						   $.messager.show({
								title:'提示消息',
								msg:'审批成功!',
								timeout:5000,
								showType:'slide'
							});
					   } else {
						    $.messager.alert("错误提示",rtn);
					   }
		           }
		       );
               
            }
        });
    }
    //拒绝审批
    function RefuseApprovalReqForm() {
        var ApprovOpinion = $("#text_ApprovOpinion").val();
        $.messager.confirm('确认', '您确认想要<span style="font-weight:bold;color:red">拒绝审批</span>吗？此操作不可取消！', function (r) {
            if (r) {
                $.ajaxRunServerMethod({ClassName:"DHCLIS.BLD.DHCBDApprovalReqForm",MethodName:"RefuseApprovalReqForm",UserID:"#((USERID))#",ApprovalListDR:me.ApprovalListDR,ApprovOpinion:ApprovOpinion},
		           function(rtn){
					   if (rtn == "0") {
						   LoadApprovalList();
						   $.messager.show({
								title:'提示消息',
								msg:'审批成功!',
								timeout:5000,
								showType:'slide'
							});
					   } else {
						    $.messager.alert("错误提示",rtn);
					   }
		           }
		           );
            }
        });
    }
    //获取当前日期
function GetCurentDate() {
    var now = new Date();

    var year = now.getFullYear();       //年
    var month = now.getMonth() + 1;     //月
    var day = now.getDate();            //日

    var hh = now.getHours();            //时
    var mm = now.getMinutes();          //分

    var clock = year + "-";

    if (month < 10)
        clock += "0";

    clock += month + "-";

    if (day < 10)
        clock += "0";

    clock += day;

    return (clock);
}

//获取日期的下偏移几天
function getNextDays(date,days) {
    date = new Date(date);
    date = +date + 1000 * 60 * 60 * 24 * days;
    date = new Date(date);
    var month = date.getMonth() + 1;
    var day = date.getDate();
    if (month < 10) {
        month = "0" + month;
    }
    if (date.getDate() < 10) {
        day = "0" + day;
    }
    //格式化
    return date.getFullYear() + "-" + month + "-" + day;

}
    </script>
</body>

</html>

