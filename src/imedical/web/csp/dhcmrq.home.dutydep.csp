<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(DHCMRQ.Base.Util.Verification).SessionVerifi() q 1
	q 1
</csp:method>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>病案首页数据质量督导系统</title>
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/datatable-1.10.12/datatables.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/css/main.css">
		<!--[if lte IE 6]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap-ie6.css">
	  <![endif]-->
	  <!--[if lte IE 8]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/ie.css">
			<style media="screen">
				.col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9{
					padding-left: 0;
					padding-right: 0;
				}
			</style>
	  <![endif]-->
	</head>
	<body>
		<div class="navbar navbar-static-top" style="background-color:#fff;">
			<div class="container-fluid">
				<div class="navbar-header">
					<button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a href="#" class="navbar-brand">病案首页数据质量督导系统</a>
				</div>
				<nav id="bs-navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
						<!--
						<li class="active">
							<a href="../getting-started/">Getting started</a>
						</li>
						 -->
					</ul>
					<ul class="nav navbar-nav navbar-right">
						<li id="searchLi">
							<!-- 查询条件 -->
							<a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">
								<i class="glyphicon glyphicon-search"></i>
								查询条件<span class="caret"></span>&nbsp;&nbsp;
								<span class="time_id"></span>
							</a>
              <div class="dropdown-menu" id="searchBox">
								<table>
									<tr>
										<td>
											<i class="fa fa-users"></i>&nbsp;&nbsp;病案版本：
										</td>
										<td>
											<select class="form-control input-sm" id="mrVersionSelect">
                      							
												<option value="CODING">编目版</option>
												<!--
												<option value="CLINIC">临床版</option>
												<option value="DRGS">DRGs版</option>
												<option value="HQMS">HQMS版</option>
												<option value="WT4">卫统4版</option>
												-->
                      						</select>
										</td>
									</tr>
									<tr>
										<td>
											<i class="fa fa-calendar"></i>&nbsp;&nbsp;监测时间：
										</td>
										<td>
											<input id="startDate" class="form-control input-sm" readonly>
											~
											<input id="endDate" class="form-control input-sm" readonly>
										</td>
									</tr>
									<tr>
										<td colspan="2">
											<button class="btn btn-success btn-block" onclick="searchByCondition()"><i class="glyphicon glyphicon-search"></i>查询</button>
										</td>
									</tr>
								</table>
              </div>
							<!-- 查询条件 end -->
						</li>
						<li>
							<a href="#"><span class="mrVersion"></span>出院病案首页</a>
						</li>
					</ul>

				</nav>
			</div>
		</div>
		<div class="container-fluid">
			<!-- 顶部概览卡片 -->
			<div class="boxcq" style="margin:5px 0 -8px 0;">
				<div class="ti">
					<i class="fa fa-hospital-o fa-lg"></i><span class="depName"></span>总体情况
				</div>
				<ul class="nav nav-tabs boxnavcq" role="tablist">
					<li><a class="fpCnt"></a></li>
					<li class="pull-right"><a href="#" onclick="showTrend()" title="指标趋势图"><i class="fa fa-line-chart fa-lg"></i></a></li>
				</ul>
			</div>
			<div class="row top-card">
				<div class="col-sm-4">
					<div class="pull-left">
						<i class="fa fa-calendar-check-o"></i>
					</div>
					<a class="pull-right">
						<span class="value fpCplRatio"></span>%<br><span class="fpCplRR"></span>
						<div class="title">首页完整率</div>
					</a>
				</div>
				<div class="col-sm-4">
					<div class="pull-left">
						<i class="fa fa-calendar-times-o"></i>
					</div>
					<a class="pull-right">
						<span class="value fpRqItmCplRatio"></span>%<br><span class="fpRqItmCplRR"></span>
						<div class="title">首页必填项完整率</div>
					</a>
				</div>
				<div class="col-sm-4">
					<div class="pull-left">
						<i class="fa fa-braille"></i>
					</div>
					<a class="pull-right">
						<span class="value mRqItmAvg"></span>个
						<div class="title">每份不完整病历的平均缺失数</div>
					</a>
				</div>
			</div>

			<div class="row top-card">
				<div class="col-sm-4">
					<div class="pull-left">
						<i class="fa fa-star-half-o"></i>
					</div>
					<a class="pull-right">
						<span class="value deptAvgScore"></span>分
						<div class="title">首页质量平均得分</div>
					</a>
					<!--
					<a role="button" id="depScoreLink" class="link" title="查看科室得分详情" style="position:absolute;bottom:0px;right:10px;"><i class="fa fa-list-ol fa-2x"></i></a>
					-->
				</div>
				<div class="col-sm-4">
					<div class="pull-left">
						<i class="fa fa-times-circle-o"></i>
					</div>
					<a class="pull-right">
						<span class="value fpErrACnt"></span>份
						<div class="title">A类错误病例数</div>
					</a>
				</div>
				<div class="col-sm-4">
					<div class="pull-left">
						<i class="fa fa-pie-chart"></i>
					</div>
					<a class="pull-right">
						<span class="value errorARatio"></span>&nbsp;
						<div class="title">A类扣分项目占比</div>
					</a>
					<a class="link" id="errorADetail" role="button" title="扣分项信息" style="position:absolute;bottom:0px;right:10px;">
					   <i class="fa fa-info-circle fa-2x"></i>
					</a>
				</div>
			</div>

			<!-- 中部表格图表 -->
			
			<div class="row">
				<div class="boxcq" id="one">
					<div class="ti">
						<i class="fa fa-user-md fa-lg"></i>临床科室列表
					</div>
					<ul class="nav nav-tabs boxnavcq" role="tablist">
						<li></li>
					</ul>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-12">
									<table id="itemClassTable" class="table table-striped table-bordered" width="100%">
										<thead>
											<tr><th rowspan="2">科室名</th><th colspan="3">首页完整率</th><th colspan="3">项目完整率</th><th colspan="3">得分</th></tr>
											<tr><th>总例数</th><th>完整例数</th><th>完整率</th><th>必填项数</th><th>已填项数</th><th>完整率</th><th>总分</th><th>实际得分</th><th>百分制得分</th></tr>
										</thead>
										<tbody></tbody>
									</table>
								</div>
							</div>
						</div>
						
					</div>
				</div>
			</div>
			
			<div class="row">
				<div class="boxcq" id="one">
					<div class="ti">
						<i class="fa fa-wpforms fa-lg"></i><span class="docName"></span>病历缺失项列表
					</div>
					<ul class="nav nav-tabs boxnavcq" role="tablist">
						<li></li>
					</ul>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-5">
									<div id="missItemChart" style="width:100%;height:350px;">

									</div>
								</div>
								<div class="col-sm-7">
									<table id="missItemTable" class="table table-striped" width="100%">
										<thead><tr><th>名称</th><th>类别</th><th>缺失项数</th></tr></thead>
										<tbody></tbody>
									</table>
								</div>
							</div>
						</div>
						
					</div>
				</div>
			</div>
			
			
		</div>
		<!--
		<footer id="footer">
			<div class="container">
        <p class="text-muted">copyright <i class="fa fa-heartbeat fa-lg"></i> DHCC</p>
      </div>
		</footer>
		 -->
		 
		 <div class="modal fade" tabindex="-1" role="dialog" id="trendModal">
  			<div class="modal-dialog modal-lg">
    			<div class="modal-content">
					<div class="modal-header">
        				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        				<h4 class="modal-title">科室指标趋势图</h4>
      				</div>
      				<div class="modal-body">
      					<div id="trendChart" style="width:100%;height:400px;"></div>
      				</div>
    			</div>
  			</div>
		 </div> 
		 <div id="loading">
		 	<img src="../scripts/dhcmrq/images/loading.gif"/>
		 	<h3 class="info">正在加载<br>...</h3>
		 </div>
		 
		<DHCMRQ:HEAD></DHCMRQ:HEAD>
		<script type="text/javascript">
	   		var dutyDepCode = parent.session['LOGON.ROLECODE'];
		   	var dutyDepName = parent.session['LOGON.ROLEDESC'];
		   	$('.depName').html(dutyDepName);
    		
    		// 基于准备好的dom，初始化echarts实例
			var missItemChart = echarts.init(document.getElementById('missItemChart'));
			//趋势图
			var trendChart = echarts.init(document.getElementById('trendChart'));
			window.onresize = function(){
				missItemChart.resize();
				trendChart.resize();
			}
    	
    		init();//初始化
	
			searchByCondition();
    	
    		function loadData(){
	    		
	    		$.post('dhcmrq.service.csp',
					{ClassName:'DHCMRQ.Compute.FuncDept',
			 		MethodName:'GetFuncDeptInfo',
			 		Params:startDate+','+endDate+','+mrVersionCode+','+dutyDepCode
					},
					function(depInfo){
						try{
							//console.log(depInfo)
							//console.log(JSON.parse(depInfo));
							loadDepData(JSON.parse(depInfo)[0]);
						}catch(err){
							console.log(err);
						}
				});
		
				$.post('dhcmrq.service.csp',
					{ClassName:'DHCMRQ.Compute.FuncDept',
			 		MethodName:'GetFuncByClin',
			 		Params:startDate+','+endDate+','+mrVersionCode+','+dutyDepCode
					},
					function(docInfo){
						try{
							//console.log(docInfo)
							loadTable(JSON.parse(docInfo),startDate,endDate,mrVersionCode)
						}catch(err){
							console.log(err);
						}
				});
				
				/*
	    		//总体情况
	    		var depInfo=tkMakeServerCall("DHCMRQ.Compute.FuncDept","GetFuncDeptInfo",startDate,endDate,mrVersionCode,dutyDepCode);
	    		//临床科室情况
	    		var clinicDepInfo=tkMakeServerCall("DHCMRQ.Compute.FuncDept","GetFuncByClin",startDate,endDate,mrVersionCode,dutyDepCode);
				try{
					//console.log(depInfo)
					//console.log(JSON.parse(depInfo));
					loadDepData(JSON.parse(depInfo)[0]);
					
					//console.log(JSON.parse(clinicDepInfo))
					loadTable(JSON.parse(clinicDepInfo),startDate,endDate,mrVersionCode)
				}catch(err){
					depInfo = [];
					console.log(err);
				}
				*/
	    	}
	    	
//加载总体情况
function loadDepData(data){
	var popContent = '<table>';
	var errorADtl = data['errADtl'];
	for(var i=0;i<errorADtl.length;i++){
		popContent += '<tr><td>'+errorADtl[i]['name']+'</td><td>:&nbsp;'+errorADtl[i]['triggerCnt']+'</td></tr>';
		
	}
	popContent += '</table>';
	$('#errorADetail').attr('data-content',popContent).popover({
								trigger:'hover',
								placement:'left',
								html:true,
								title:'扣分项信息'
								});
	
	$('.fpCnt').html('总病例数：'+data['fpCnt']);
	showNum(Number((data['fpCplRatio']+' ').replace(/%/g,'')).toFixed(2).replace(/(\.00)/g,''),$('.fpCplRatio'));
	$('.fpCplRR').html((data['fpCplRR']+' ').replace(/(%|\.00)/g,''));
	showNum(Number((data['fpRqItmCplRatio']+' ').replace(/%/g,'')).toFixed(2).replace(/(\.00)/g,''),$('.fpRqItmCplRatio'));
	$('.fpRqItmCplRR').html((data['fpRqItmCplRR']+' ').replace(/(%|\.00)/g,''));
	showNum(Number((data['mRqItmAvg']+' ').replace(/%/g,'')).toFixed(2).replace(/(\.00)/g,''),$('.mRqItmAvg'));
	showNum(Number((data['deptAvgScore']+' ').replace(/%/g,'')).toFixed(2).replace(/(\.00)/g,''),$('.deptAvgScore'));
	showNum(Number((data['fpErrACnt']+' ').replace(/%/g,'')).toFixed(2).replace(/(\.00)/g,''),$('.fpErrACnt'));
	showNum((data['errorARatio']+' ').replace(/(\.00)|%/g,''),$('.errorARatio'));
	
}

//加载问题列表
function loadMissDetail(depCode,depName){
	if(depCode=='合计') depCode = '';
	$('.docName').html(depName);
	$.post('dhcmrq.service.csp',
			{ClassName:'DHCMRQ.Compute.FuncDept',
			MethodName:'GetFuncMissRqItem',
			Params:startDate+','+endDate+','+mrVersionCode+','+depCode+','+dutyDepCode
			},
			function(missItemInfo){
				try{
					//console.log(JSON.parse(missItemInfo))
					missItemInfo = JSON.parse(missItemInfo)
				}catch(err){
					missItemInfo = [];
					console.log(err);
				}
	
				$('#missItemTable').DataTable( {
      				data: missItemInfo,
					columns: [
            			{ "data": "desc" },
            			{ "data": "weight" },
						{ "data": "count" ,
						  "render": function ( data, type, full, meta ) {
				      		return '<a title="查看病例详情" role="button" onclick="addTab(\''+full.desc+'缺失病例列表\',\'dhcmrq.caseList.csp?itemId='+full.ItemID+'&startDate='+startDate+'&endDate='+endDate+'&mrVersionCode='+mrVersionCode+'&depCode='+depCode+'\',\'mrList'+full.ItemID+'\')">'+full.count+'</a>';
					    	}
						}
        			],
					order: [[2, 'desc']],
					drawCallback: function( settings ) {
	        			var thisPageData = this.api().rows( {page:'current'} ).data();
						var data = [];
						var category = [];
						for (var i = 0; i < thisPageData.length; i++) {
							data.push({name:thisPageData[i]['desc'],value:thisPageData[i]['count']});
							category.push(thisPageData[i]['desc']);
						}
						$('#missItemChart').height($('#missItemTable').height()+120);
						pieChart(missItemChart,data,'缺失项');
	    		}
  			});
	});
	
}

function loadTable(data,startDate,endDate,mrVersionCode){
	
	var itemClassTable = $('#itemClassTable').DataTable( {
			//dom: 'Bfrtip',
      		data: data,
			columns: [
            	{ "data": "desc" ,
						  "render": function ( data, type, full, meta ) {
				      		return '<a title="查看问题详情" role="button" onclick="loadMissDetail(\''+full.code+'\',\''+full.desc+'\')">'+full.desc+'</a>';
					    }
				},
            	{ "data": "fpCnt" },
            	{ "data": "fpCplCnt" },
				{ "data": "fpCplRatio" },
				{ "data": "totalRqItmCnt" },
				{ "data": "cplRqItmCnt" },
				{ "data": "cplRqItmRatio" },
				{ "data": "rqItmScore" },
				{ "data": "avgScore" },
				{ "data": "transScore" }
        	],
			order: [[1, 'desc']]
  	});
  	
  	//默认先查询第一行问题
	loadMissDetail(itemClassTable.row(0).data().code,itemClassTable.row(0).data().desc);
  	
  	
}

//全院指标趋势图
function showTrend(){
	console.log(startDate+','+endDate+','+mrVersionCode+','+dutyDepCode)
	$.post('dhcmrq.service.csp',
			{ClassName:'DHCMRQ.Compute.FuncDept',
			 MethodName:'GetFuncDepTrend',
			 Params:startDate+','+endDate+','+mrVersionCode+','+dutyDepCode
			},
			function(data){
				
				try{
					data = JSON.parse(data);
				}catch(err){
					console.log(data)
					data = {"fpCplRatio":[],"fpItemCplRatio":[],"avgScore":[],"date":[]};
				}
				
				var fpCplRatio = data['fpCplRatio'];
				var fpItemCplRatio = data['fpItemCplRatio'];
				var avgScore = data['avgScore'];
				var dateArray = data['date'];
				
			var lineOption = {
    			//title: {
        		//	text: depName,
        		//	subtext: '2016-01'
    			//},
    			grid: {
	    			top:40,
	    			bottom:60,
	    			left:60,
	    			right:60
	    		},
    			tooltip: {
        			trigger: 'axis'
    			},
    			legend: {
	    			left:0,
        			data:['首页完整率(%)','项目完整率(%)','平均得分']
    			},
    			toolbox: {
        			feature: {
            			saveAsImage: {}
        			}
    			},
    			xAxis: {
        			type: 'category',
        			boundaryGap: false,
        			data: dateArray
    			},
    			yAxis: {
        			type: 'value',
        			name: '完整率',
        			nameGap: 45,
        			nameLocation:'middle'
    			},
    			dataZoom: [
        			{
            			type: 'slider',
            			xAxisIndex: [0]//,
            			//startValue: '2016-01',
            			//endValue: '2016-06'
        			}
    			],
    			series: [
        			{
            		name:'首页完整率(%)',
            		type:'line',
            		smooth: true,
            		data:fpCplRatio
        			},
        			{
            		name:'项目完整率(%)',
            		type:'line',
            		smooth: true,
            		data:fpItemCplRatio
        			},
        			{
            		name:'平均得分',
            		type:'line',
            		smooth: true,
            		data:avgScore
        			}
    			]
			};
			
				setTimeout(function(){
					trendChart.setOption(lineOption);
					trendChart.resize();
				},200);
			})
	
			$('#trendModal').modal('show');
}
	   </script>
	</body>
</html>
