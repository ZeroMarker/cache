<csp:content charset="UTF-8">
<SERVER>
s Action=$Get(%request.Data("actiontype",1))
s Start=$Get(%request.Data("start",1))
s Limit=$Get(%request.Data("limit",1))
s Sort=$Get(%request.Data("sort",1))
s Dir=$Get(%request.Data("dir",1))
s sHospID=$G(%session.Data("LOGON.HOSPID"))
i Action = "GetItm" d
    .S InciDesc=$Get(%request.Data("InciDesc",1))
    .S InciCode=$Get(%request.Data("InciCode",1))
    .S Alias=$Get(%request.Data("Alias",1))
    .S StkCatId=$Get(%request.Data("StkCatId",1))
    .S AllFlag=$Get(%request.Data("AllFlag",1))
    .S Others=$Get(%request.Data("Others",1))
    .s User=$get(%session.Data("LOGON.USERID"))
    .s HighPrice=$Get(%request.Data("HighPrice",1))
    .s Charge=$Get(%request.Data("Charge",1))
    .s Implantation=$Get(%request.Data("Implantation",1))
    .s sLoc=$G(%session.Data("LOGON.CTLOCID"))  //xuchao 2014-10-29 add
    .s Vendor=$Get(%request.Data("Vendor",1))
    .d ##class(web.DHCSTM.DrugInfoMaintain).GetItm(Start,Limit,Sort,Dir, InciDesc, InciCode, Alias, StkCatId, AllFlag, Others,User,HighPrice,Charge,Implantation,sLoc,sHospID,Vendor)

i Action = "SaveData" d
    .S ListArc=$Get(%request.Data("ListArc",1))
    .S ListInc=$Get(%request.Data("ListInc",1))
    .S drugRowid=$Get(%request.Data("drugRowid",1))
    .S result = ##class(web.DHCSTM.DrugInfoMaintain).SaveData(drugRowid,ListArc,ListInc)
    .S Len = $Length(result,"^")
    .i Len = 2 d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    
i Action="DeleteData" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .s result=##class(web.DHCSTM.DrugInfoMaintain).Delete(InciId)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

i Action="GetIncAlias" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .d ##class(web.DHCSTM.INCALIAS).Select(InciId)
    
i Action="GetIncSpec" d
   .s InciId=$Get(%request.Data("InciRowid",1))
   .d ##class(web.DHCSTM.INCALIAS).Selectspec(InciId)

i Action="SaveIncAlias" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .s ListData=$Get(%request.Data("ListData",1))
    .s result=##class(web.DHCSTM.INCALIAS).Save(InciId,ListData)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

 i Action="SaveIncSpec" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .s ListData=$Get(%request.Data("ListData",1))
    .s result=##class(web.DHCSTM.INCALIAS).SaveSpec(InciId,ListData)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

i Action="DeleteIncAlias" d
    .S IncaRowid=$Get(%request.Data("IncaRowid",1))
    .s result=##class(web.DHCSTM.INCALIAS).Delete(IncaRowid)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

 i Action="DeleteIncSpec" d
    .S SpecRowid=$Get(%request.Data("SpecRowid",1))
    .s result=##class(web.DHCSTM.INCALIAS).Deletespec(SpecRowid)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

i Action="GetDetail" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .s ret=##class(web.DHCSTM.DrugInfoMaintain).GetDetail(InciId,sHospID)
    .s ret=$tr(ret,$c(13,10))
    .s ret=##class(web.DHCSTM.Common.UtilCommon).Replace(ret,"\","\\")
    .s ret=##class(web.DHCSTM.Common.UtilCommon).Replace(ret,"'","\'")
    .i $f(ret,"ERROR-")  d
    ..W "{success:'false',info:'"_"请查看错误日志!"_"'}"
    .e  d
    ..W "{success:'true',info:'"_ret_"'}"

i Action="GetDoseEquiv" d
    .s InciId=$Get(%request.Data("InciRowid",1))
    .d ##class(web.DHCSTM.PHCDRGMAST).QueryFormDoseEquiv(InciId)

i Action="SaveDoseEquiv" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .s ListData=$Get(%request.Data("ListData",1))
    .s result=##class(web.DHCSTM.PHCDRGMAST).SaveFormDoseEquiv(InciId,ListData)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

i Action="DeleteDoseEquiv" d
    .S EqRowid=$Get(%request.Data("EqRowid",1))
    .s result=##class(web.DHCSTM.PHCDRGMAST).DeleteFormDoseEquiv(EqRowid)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

i Action="GetArcAlias" d
    .S ArcId=$Get(%request.Data("ArcRowid",1))
    .d ##class(web.DHCSTM.ARCALIAS).Select(ArcId)

i Action="SaveArcAlias" d
    .S ArcId=$Get(%request.Data("ArcRowid",1))
    .s ListData=$Get(%request.Data("ListData",1))
    .s result=##class(web.DHCSTM.ARCALIAS).Save(ArcId,ListData)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

i Action="DeleteArcAlias" d
    .S AliasRowid=$Get(%request.Data("AliasRowid",1))
    .s result=##class(web.DHCSTM.ARCALIAS).Delete(AliasRowid)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

;保存存储条件
i Action="saveStoreCon" d
    .S storeStr=$Get(%request.Data("storeStr",1))
    .S rowid=$Get(%request.Data("rowid",1))
    .s IncRowid=$Get(%request.Data("IncRowid",1))
    .s result=##class(web.DHCSTM.ITMSTORECON).Save(rowid,storeStr,IncRowid)
    .i +result>0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

i Action="GetStoreCon" d
    .S IncRowid=$Get(%request.Data("IncRowid",1))
    .s result=##class(web.DHCSTM.ITMSTORECON).Select(IncRowid)
    .w "{success:'true',info:'"_result_"'}"

i Action ="CheckItmUsed" d
    .S IncRowid=$Get(%request.Data("IncRowid",1))
    .S result = ##class(web.DHCSTM.INCITM).CheckUsed(IncRowid)
    .w "{success:'true',info:'"_result_"'}"

i Action="GetParamProp" d
	.s Param=$Get(%request.Data("Param",1))
    .s result=##class(web.DHCSTM.DrugInfoMaintain).GetParamProp(Param)
    .w "{success:'true',info:'"_result_"'}"

i Action="GetMaxCodeByCat" d
    .s Cat=$Get(%request.Data("Cat",1))
    .s result=##class(web.DHCSTM.INCITM).GetMaxCodeByCat(Cat)
    .w "{success:'true',info:'"_result_"'}"

i Action="GetProductImage" d
 	.s inci=$Get(%request.Data("IncRowid",1))
 	.s type=$Get(%request.Data("type",1))
 	.s result = ##class(web.DHCSTM.DrugInfoMaintain).GetProductImageInfo(inci,type)
 	.i result = "" d
 	..w "{results:0,rows:[]}"
 	.e  d
 	..w result 

i Action = "DeleteProductImage" d
 	.s RowId=$G(%request.Data("rowid",1))
 	.s PicSrc=$Get(%request.Data("picsrc",1))
 	.s GroupId=$G(%session.Data("LOGON.GROUPID"))
 	.s LocId=$G(%session.Data("LOGON.CTLOCID"))
 	.s UserId=$G(%session.Data("LOGON.USERID"))
 	.s Param=GroupId_"^"_LocId_"^"_UserId
 	.s result = ##class(web.DHCSTM.DrugInfoMaintain).DelProductImageInfo(RowId,PicSrc,Param)
 	.i result = 0 d
 	..w "{success:'true',info:''}"
 	.e  d
 	..w "{success:'false',info:'"_result_"'}"

i Action="UploadImage" d
 	.s inci=$Get(%request.Data("IncRowid",1))
 	.s type=$Get(%request.Data("type",1))
 	.s GroupId=$G(%session.Data("LOGON.GROUPID"))
 	.s LocId=$G(%session.Data("LOGON.CTLOCID"))
 	.s UserId=$G(%session.Data("LOGON.USERID"))
 	.s Param=GroupId_"^"_LocId_"^"_UserId
	.s File=$Get(%request.MimeData("files",1))
 	.s result = ##class(web.DHCSTM.DrugInfoMaintain).SaveProductImage(File,Param,inci,type)
 	.i result=0 d
 	..w "{success:'true',message:'上传成功'}"
 	.e  d
 	..w "{success:'false',message:'上传失败'}" 

i Action="setProductMaster" d
 	.s RowId=$G(%request.Data("rowid",1))
 	.s result=##class(web.DHCSTM.DrugInfoMaintain).SetProductMaster(RowId)
 	.i result=0 d
 	..w "{success:'true',message:'设置成功'}"
 	.e  d
 	..w "{success:'false',message:'设置失败'}" 
 
i Action="InsItmPic" d   //zhwh 2015-04-02
 	.s code=$G(%request.Data("code",1))
 	.s fileName=$G(%request.Data("fileName",1))
 	.s type=$G(%request.Data("type",1))
 	.&sql(select inci_rowid into :inci from inc_itm where inci_code=:code)
 	.s result=##class(web.DHCSTM.DrugInfoMaintain).InsItmPic(inci,fileName,type)
 	.i result = 0 d
 	..w "{success:'true',info:''}"
 	.e  d
 	..w "{success:'false',info:'"_result_"'}"

 ///取参数
i Action="GetParamPropNew"  d
 	.s AppName=##class(web.DHCSTM.DrugInfoMaintain).%GetParameter("AppName")
 	.s UserId=$Get(%request.Data("UserId",1))
 	.s LocId=$Get(%request.Data("LocId",1))
 	.s GroupId=$Get(%request.Data("GroupId",1))
 	.;安全组RowId^科室RowId^用户RowId^医院RowId
 	.s p=GroupId_"^"_LocId_"^"_UserId_"^"_$G(sHospID)
 	.s result= ##class(web.DHCSTM.Common.AppCommon).GetAppParamStr(AppName,p)
 	.w "{success:'true',info:"_result_"}"

 //检索一个药学项目数据
 i Action="GetPhcDrgFrm"  d
 .s PhcdfId=$Get(%request.Data("PhcdfId",1))
 .s result=##class(web.DHCSTM.PHCDRGMAST).Select(PhcdfId)
 .i result = "" d
 ..w "{success:'false',info:''}"
 .e  d
 ..w "{success:'true',info:'"_result_"'}"

 //保存一个药学项 
 i Action="SavePhcDrgFrm"  d
 .s PhcdfId=$Get(%request.Data("PhcdfId",1))
 .s Data=$Get(%request.Data("Data",1))
 .s inci=$Get(%request.Data("inci",1))
 .s result=##class(web.DHCSTM.PHCDRGMAST).Save(PhcdfId,Data,inci)
 .
 .i result <0  d
 ..w "{success:'false',info:'"_result_"'}"
 .e  d
 ..w "{success:'true',info:'"_result_"'}"

 i Action="GetInciCertList"  d
 .s inci=$Get(%request.Data("InciRowid",1))
 .s manf=$Get(%request.Data("Manf",1))
 .d ##class(web.DHCSTM.INCITM).GetRegCertRecords(inci,manf)
 .
 
 //zhwh 20170817
 i Action="GetManfCertList"  d
 .s manf=$Get(%request.Data("Manf",1))
 .d ##class(web.DHCSTM.INCITM).GetRegCertsOfManf(manf)
 .

  //根据库存项Rowid获取院区零库存标志
 i Action="GetINCZero" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .d ##class(web.DHCSTM.DHCIncHosp).Select(InciId)
 
 //保存库存项零库存标志
 i Action="SaveINCZero" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .s ListData=$Get(%request.Data("ListData",1))
    .s result=##class(web.DHCSTM.DHCIncHosp).Save(InciId,ListData)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    
  //保存库存项零库存标志
 i Action="SaveMarkType" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .s ListData=$Get(%request.Data("ListData",1))
    .s result=##class(web.DHCSTM.DHCIncLoc).Save(InciId,ListData)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}" 
    
  //根据库存项Rowid获取院区零库存标志
 i Action="QueryMarkType" d
    .S InciId=$Get(%request.Data("InciRowid",1))
    .d ##class(web.DHCSTM.DHCIncLoc).QueryMarkType(InciId)
 i Action="DeleteMarkType" d
    .S Rowid=$Get(%request.Data("Rowid",1))
    .s result=##class(web.DHCSTM.DHCIncLoc).DeleteMarkType(Rowid)
    .i result=0  d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
 //获取库存分类管理医嘱收费  
 i Action="GetChargeItem" d
    .s StkCat=$Get(%request.Data("StkCat",1))
    .s result=##class(web.DHCSTM.DrugInfoMaintain).GetChargeItem(StkCat)
    .w "{success:'true',info:'"_result_"'}"
 //发送物资信息到平台
	i Action = "SendInci" d
	.s InciRowid=$Get(%request.Data("InciRowid",1))
	.s result=##class(web.DHCSTM.INCITM).SendInciStr(InciRowid)
	.i result="" d
	..w "{success:'true',info:''}"
	.e  d
	..w "{success:'false',info:'"_result_"'}"
//批量修改
i Action = "BatchSaveData" d
    .s InciIdStr=$Get(%request.Data("InciIdStr",1))
    .s DataStr=$Get(%request.Data("DataStr",1))
    .s result = ##class(web.DHCSTM.DrugInfoMaintain).BatchSaveData(InciIdStr,DataStr)
    .i result=0 d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"
    
    //保存注册证信息
i Action = "saveRegInfo" d
    .s data=$Get(%request.Data("data",1))
    .s result = ##class(web.DHCSTM.DHCMatRegCert).save(data)
    .i +result>0 d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"

     //
i Action = "getByRegNo" d
    .s No=$Get(%request.Data("No",1))
    .s result = ##class(web.DHCSTM.DHCMatRegCert).getByRegNo(No)
    .i result'=0 d
    ..w "{success:'true',info:'"_result_"'}"
    .e  d
    ..w "{success:'false',info:'"_result_"'}"   
</SERVER>