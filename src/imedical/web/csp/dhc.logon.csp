<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title><EXTHEALTH:TITLE></EXTHEALTH:TITLE></title>
<script type="text/javascript" src="/csp/broker/cspbroker.js"></script>
<script type="text/javascript" src="/csp/broker/cspxmlhttp.js"></script>
<SCRIPT SRC="../scripts/websys.js"></SCRIPT>
<BOOTSTRAP303/>
<ADDINS require="CMgr,CmdShell,PrjSetTime"/>
<link type="text/css" rel="stylesheet" href="../scripts_lib/font-awesome/font-awesome.min.css" />
<link type="text/css" rel="stylesheet" href="../skin/default/css/logon.css" />
<link rel="stylesheet" type="text/css" href="../scripts_lib/hisui-0.1.0/dist/css/hisui.min.css" />
<script type="text/javascript" src="../scripts_lib/hisui-0.1.0/dist/js/jquery.hisui.min.js" charset="utf-8"></script>
<script type="text/javascript" src="../scripts_lib/hisui-0.1.0/dist/js/locale/hisui-lang-zh_CN.js" charset="utf-8"></script>
<script type="text/javascript" src="../scripts/websys.jquery.js" charset="utf-8"></script>
<script type="text/javascript" src="../scripts_lib/bootstrap-3.0.3/dist/js/jquery.backgroundcover.js"></script>
<server>
 //Set EnableLocalWeb = ##class(websys.StandardTypeItem).GetIdFromCodeOrDescription("websys","EnableLocalWeb")
 Set IEVersion = ##class(ext.util.String).GetIEVersion()
 if IEVersion="IE6" {
 	 Set IEVersion = "IE6"
 }ELSE{
 	Set IEVersion = "IE11"
 }
 Set IsIE = (%request.GetCgiEnv("HTTP_USER_AGENT")["Trident")
</server>
<style>
body{
	overflow:hidden;
	color:#000000;
}
body *{
	font-size:12px;
}
.ext-strict .x-small-editor .x-form-text{
	height: 19px !important;
}
.modal-body{
	position:relative;
	padding:10px;
	padding-top:20px;
	padding-bottom:0px;
}
.modal-header {
    min-height: 16.428571429px;
    padding: 15px;
    border-bottom: 0px solid #e5e5e5;
}
.loginbox_cq .alert-danger {
    margin: -29px 0 0 0;
    height: 26px;
    padding: 0px 10px 0;
}
.x-grid3-row td,.x-grid3-summary-row td {
    line-height: 12px;
    padding-bottom: 1px;
    padding-top: 1px;
    font: normal 12px "Microsoft Yahei", arial, helvetica, sans-serif;
}
.ipInfo{
    position: absolute;
    /*top: 475px;
    left: 875px;*/
    color: #fff;
    background-color: #000;
    opacity: 0.1;
    /*height: 32px;*/
    width: 324px;
    text-align: left;
    padding: 8px 5px 5px 5px;
    border-radius: 4px;
}
.ipInfo .arrow{
    border-width:8px 7px 8px 7px;
    border-style: solid;
    border-color: transparent transparent #000 transparent;
    margin-top: -22px;
    margin-left: 162px;
    width: 14px;
    /* height: 16px; */
}
#DEPARTMENT{
	cursor:pointer!important;
	padding-left:12px!important;
}
</style>
<csp:if condition=IEVersion="IE6">
	<style>
	.loginboxP_cq .input-group .form-control{
		width:250px;
	}
	.loginboxP_cq .input-group .addonimg{
		float:left;
		width:32px;
		height:39px;
	}
	.loginboxP_cq INPUT{
		height:23px;
	}
	</style>
</csp:If>
<script language=cache runat=server>
	Set LogonPageTitle="东华标准版数字化医院信息管理系统"
	if ##class(%Dictionary.CompiledProperty).%ExistsId("websys.Configuration||LogonPageTitle"){
		Set LogonPageTitle = ##class(websys.Configuration).GetFieldValue("LogonPageTitle")
		if (LogonPageTitle[".jpg")||(LogonPageTitle[".png"){
			Set LogonPageTitle = "<img style=""height:110px;margin-top:-35px;"" src="""_LogonPageTitle_"""></img>"
		}
		if LogonPageTitle="" Set LogonPageTitle="东华标准版数字化医院信息管理系统"
	}
	s myCode($i(myCode))="<script type='text/javascript'>"
	s myCode($i(myCode))="var session=new Array();"
	s myCode($i(myCode))="session['LOGON.TIMEOUT']='"_$g(%session.Data("LOGON.TIMEOUT"))_"';"
	s myCode($i(myCode))="session['LOGON.SITECODE']='"_$g(%session.Data("LOGON.SITECODE"))_"';"
	s myCode($i(myCode))="session['LOGON.REGION']='"_$g(%session.Data("LOGON.REGION"))_"';"
	s myCode($i(myCode))="session['LOGON.USERID']='"_$g(%session.Data("LOGON.USERID"))_"';"
	s myCode($i(myCode))="session['LOGON.USERCODE']='"_$g(%session.Data("LOGON.USERCODE"))_"';"
	s myCode($i(myCode))="session['LOGON.USERNAME']='"_$g(%session.Data("LOGON.USERNAME"))_"';"
	s myCode($i(myCode))="session['LOGON.GROUPID']='"_$g(%session.Data("LOGON.GROUPID"))_"';"
	s myCode($i(myCode))="session['LOGON.GROUPDESC']='"_$g(%session.Data("LOGON.GROUPDESC"))_"';"
	s myCode($i(myCode))="session['LOGON.LANGID']='"_$g(%session.Data("LOGON.LANGID"))_"';"
	s myCode($i(myCode))="session['LOGON.CTLOCID']='"_$g(%session.Data("LOGON.CTLOCID"))_"';"
	s myCode($i(myCode))="session['XMONTHSSHORT']='"_$g(%session.Data("XMONTHSSHORT"))_"';"
	s myCode($i(myCode))="session['CONTEXT']='"_$g(%request.Data("CONTEXT",1))_"';"			;;;%session.Data("CONTEXT",1)
	s myCode($i(myCode))="session['LOGON.WARDID']='"_$g(%session.Data("LOGON.WARDID"))_"';"
	s myCode($i(myCode))="session['LOGON.HOSPID']='"_$g(%session.Data("LOGON.HOSPID"))_"';"
	
	s myStatusTip = "用户名称:  "_ $g(%session.Data("LOGON.USERNAME"))_"  组:  "_$g(%session.Data("LOGON.GROUPDESC"))
	s myStatusTip = myStatusTip_"  科室: "_$g(%session.Data("LOGON.CTLOCDESC"))
	
	s myCode($i(myCode))="window.status='"_myStatusTip_"';"
	s event=##class(%CSP.Page).Encrypt($lb("websys.Configuration.CSPServerConnect"))
	
	s myCode($i(myCode))="function tkMakeServerCall(tkclass,tkmethod) {"
	s myCode($i(myCode))="	if ((tkclass=='')||(tkmethod=='')) return '';"
	s myCode($i(myCode))="	var args=new Array('"_event_"',tkclass,tkmethod);"
	s myCode($i(myCode))="	for (var i=2; i<tkMakeServerCall.arguments.length; i++) {"
	s myCode($i(myCode))="	args[i+1]=tkMakeServerCall.arguments[i];"
	s myCode($i(myCode))="	}"
	s myCode($i(myCode))="	var retval=cspHttpServerMethod.apply(this,args);"
	s myCode($i(myCode))="	return retval;"
	s myCode($i(myCode))="}"
	s myCode($i(myCode))="<"_"/script>"
	f myIdx=1:1:myCode {
		w myCode(myIdx),!
	}

 	//function tkMakeServerCall(tkclass,tkmethod) {  if ((tkclass=='')||(tkmethod=='')) return '';var args=new Array('#(##class(%CSP.Page).Encrypt($lb("websys.Configuration.CSPServerConnect")))#',tkclass,tkmethod);  for (var i=2; i<tkMakeServerCall.arguments.length; i++) {  args[i+1]=tkMakeServerCall.arguments[i];  }  var retval=cspHttpServerMethod.apply(this,args);  return retval; }
 </script>
 <csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
 if %request.GetCgiEnv("HTTP_X_FORWARDED_FOR")'="" s %request.CgiEnvs("REMOTE_ADDR")=%request.GetCgiEnv("HTTP_X_FORWARDED_FOR")
 //登录后才同步时间,相差超一分钟
 Set ClientDate = $g(%request.Data("ClientDate",1))
 Set ClientTime = $g(%request.Data("ClientTime",1))
 Set ServerDate = +$h
 Set ServerTime = $p($h,",",2)
 Set ModifyTimeFlag = 0
 ;&& ($g(%session.Data("LOGON.USERCODE"))'="")
 If (ClientDate'="")&&(ClientTime'="") {
	Set ClientDate = $zdh(ClientDate,3)
	Set ClientTime = $zth(ClientTime)
	If (ClientDate'=ServerDate) || (60<(ClientTime-ServerTime)) ||(-60>(ClientTime-ServerTime)) {
		Set ModifyTimeFlag=1
	}
 }
 if ##class(websys.Conversions).IsValidClassName("websys.Filter") d ##class(websys.Filter).InjectionFilter()
 ;s preSessionId=##Class(websys.SessionLogon).LogonBefore()
 ;s preSessionId=0
 ;if (preSessionId=0) {
	 //判断是否CAS单点登录
	Set caslogin = $g(%request.Data("caslogin",1))
	Set PEiMediclVer = $p($tr($p($g(^CF("SM",1)),"^",5),"R",""),".",1,2)
	//Set NewSession = (('caslogin) && %session.NewSession && ($G(%request.Data("token",1))="") && ($G(%request.Data("TPSID",1))=""))
	// 2020-06-01 在IE下%session.NewSession在F5后，有时得到1，有时为0，判断前后%session.SessionId是否一样
	// 桌面进入登录NewSession=0,^Temp(sid)为空
	// F5 NewSession=1 ,^Temp(sid)有值
	// F5 NewSession=0 ,^Temp(sid)有值  '$d(^Temp(%session.SessionId))表示F5刷新
	Set fromCloseSes = $d(^Temp(%session.SessionId))
	Set MyNewSession=0
	if %session.NewSession,'fromCloseSes Set MyNewSession=1
	Set NewSession = (('caslogin) && MyNewSession && ($G(%request.Data("token",1))="") && ($G(%request.Data("TPSID",1))=""))
	Set IsOutInLine = ($d(%session) && $d(^Temp(%session.SessionId)) && ($G(^Temp(%session.SessionId))="outline"))
	if (NewSession || IsOutInLine) {
		 // 超时后按F5, 本机测试sessionId有时会变化
		 Set %request.Data("PASSWORD",1)=""
		 Set %request.Data("USERNAME",1)=""
		 Set %request.Data("SSUSERGROUPDESC",1)=""
		 Set %request.Data("DEPARTMENT",1)=""
	 }
	 k ^Temp(%session.SessionId)
	 // F5刷新时报科室无效问题 20200601 by wanghc CachePs的Input不能删除，删除会导致请求乱码
	 d ..AdjustCharSet()
	 // 支持传科室Code,科室Id作为入参,以便解决乱码问题 20200317 by wanghc 
	 Set InCharSet = $G(%request.Data("InCharSet",1))
	 Set DepId="" , DepCode=$g(%request.Data("DEPARTMENTCODE",1))
	 if (DepCode'="") Set DepId = ##class(web.CTLoc).GetIdFromCodeOrDescription(DepCode)
 	 If $d(%request.Data("DEPARTMENTID")) Set DepId = $g(%request.Data("DEPARTMENTID",1))
	 if ((DepId'="") && (DepId>0)) Set %request.Data("DEPARTMENT",1) = $p(^CTLOC(DepId),"^",2)
	 if ('caslogin){
	 	s returnval=##Class(websys.SessionLogon).Logon()
	 }else{
		s returnval = ##Class(websys.cas.SessionLogon).CASLogon()
	 }
	 ; ab 18.04.07 63052 - override timeout to 60 secs to free license
	 ;w "<br>"_$g(lic)_"<br>",!
	 s %session.AppTimeout=60*5
	 s sc=%session.Login("_system","SYS",1)
	 s:$System.Status.IsError(sc) ^TempLogon($h)=$system.Status.GetErrorText(sc)
	 s ^Temp("ClientName")=$J_" "_$ZUTIL(67,12,$j)_" "_$zu(67,15,$j)
	 q returnval
 ;}else{
	 q 1
 ;}
</csp:method>
 <csp:method name=OnPostHTTP arguments="">
	k STATUS,username,password,department,ValidUser,welcometitle,copyright,traktooltip1
	;w !,%session.NewSession_"  新的",!
</csp:method>
<csp:method name=GetDepId arguments="">
	n (%request)
	Set DepId=0
	If $d(%request.Data("DEPARTMENT",1),mydep),(mydep'=""){
		if $g(%request.Data("DEPARTMENTAlias",1))'="" Set mydep=%request.Data("DEPARTMENTAlias",1)_"-"_mydep
	 	Set DepId = ##class(web.CTLoc).GetIdFromCodeOrDescription(mydep)
	}
	Quit DepId
</csp:method>
<csp:method name=AdjustCharSet arguments="">
	n (%request)
	Set DepId=..GetDepId()
	Set Count=0
	While(DepId'>0){ // 测试发现第二次就不能转回正确的汉字
		if $d(%request.Data("DEPARTMENT",1),mydep),(mydep'=""){
			Set %request.Data("DEPARTMENT",1)=$zcvt($zcvt(%request.Data("DEPARTMENT",1),"O","GB18030"),"I","UTF8")
			Set %request.Data("SSUSERGROUPDESC",1)=$zcvt($zcvt(%request.Data("SSUSERGROUPDESC",1),"O","GB18030"),"I","UTF8")
			Set %request.Data("Hospital",1)=$zcvt($zcvt(%request.Data("Hospital",1),"O","GB18030"),"I","UTF8")
			Set DepId=..GetDepId()
		 	Set Count = Count+1
		 	Quit:Count>5
		}else{
			Quit
		}
	}
	Quit 0
</csp:method>
<SCRIPT language='javascript'>
function isRunProcess(exeName){
	var t;
	var locator = new ActiveXObject ("WbemScripting.SWbemLocator");
	var service = locator.ConnectServer(".");
	var properties = service.ExecQuery("SELECT * FROM Win32_Process");
	var np = new Enumerator (properties);
	var num = 0;
	for (;!np.atEnd();np.moveNext())
	{
	    t=t + np.item().Name + "\n"; //ProcessId
	   if (np.item().Name.indexOf(exeName)>-1) num++;
	}
	return num;
}
function singleSession(){
	var preSessionId = "#($g(preSessionId))#";
	var username = "#($g(username))#"; 
	if(0!=preSessionId){
		//四川一个用户只能在线一份会话
		if(confirm(username+" 已经在 #($g(LOGADDRIP))# 登录了系统!会话ID:#($g(LOGADDRSessionId))#,你确定替换登录?")){
			#server(websys.SessionLogon.ForceLogoutByUser(username))#
		}else{
			window.location.href="websys.closesession.csp?relogon=1";
		}
	}
	if(false && isRunProcess("iexplore.exe")>2){
		alert("请关闭所有IE再登录系统");
		window.close(); 
		return ;
		//协和一台电脑只能登录一个用户
		//if(confirm("#($g(username))# 已经登录了系统,你确定重新登录?")==true){
		//	#server(websys.SessionLogon.ForceLogoutPreSession())#
		//	window.location.href="dhc.logon.csp";
		//}else{
		//	window.close();
		//}
	}
}
singleSession();
function setPageTitle(){
	var ipobj = document.getElementById("localipdiv");
	if (ipobj && ipobj.innerText){
		var pageTitle = #server(websys.Configuration.GetLogonPageTitle(ipobj.innerText))#;
		//var pageTitle =#server(websys.DHCClientLoginIPLocRule.GetHospInfoByIP(ipobj.innerText))#;
		if (pageTitle.indexOf("^")>-1){pageTitle = pageTitle.split("^")[1];}
		if (pageTitle!=""){
			$(".hospital").html(pageTitle);
		}
	}
	
}
var showModal = function(target, url, opt){
	var width = 400, height=400 , title = "对话框!" ,showbefore = null,showafter=null,content="无内容";
	if (arguments.length>2){
		if (opt.width){ width = parseInt(opt.width); }
		if (opt.height){ height = parseInt(opt.height);}
		if (opt.title){title = opt.title;}
		if (opt.showbefore){
			showbefore = opt.showbefore;
			if(showbefore) showbefore.call(this);
		}
		if (opt.showafter){
			showafter = opt.showafter;
		}
		if(opt.content) content = opt.content;
	}
	var urlHtml = "";
	if(url){
		urlHtml = '<iframe src="'+url+'" width="100%" height="100%" scrolling="auto" marginwidth=0 marginheight=0 frameborder="no" framespacing=0></iframe>';
	}else{
		urlHtml = content;
	}
	var modalJObj = $(target);
	modalJObj.find(".modal-title").html(title);
	modalJObj.find(".modal-content").css({width:width});		
	modalJObj.find(".modal-body").css({width:width,height:height}).html(urlHtml); //
	modalJObj.modal('show').css({width: 'auto'});
	if(showafter) showafter.call(this);
}
function ChangePassword(obj) {
	//var doc="websys.default.csp?WEBSYS.TCOMPONENT=SSUser.EditPassword&ID="+session['LOGON.USERID']; 
	//window.open(doc,'new','scrollbars=no,toolbar=no,width=350,height=250,top=200,left=500');
	websys_showModal({url:'websys.user.settings.csp?changepassword=1',title:'修改密码',width:480,height:280});
}
function ChangePinPassword(obj) {
	var doc="websys.default.csp?WEBSYS.TCOMPONENT=SSUser.EditPINPassword&ID="+session['LOGON.USERID']; 
	window.open(doc,'new','scrollbars=no,toolbar=no,width=350,height=250,top=200,left=500');
	
}
function ChangeDefultDept(obj)
{
	var doc="websys.default.csp?WEBSYS.TCOMPONENT=SSUser.UpdateDefaultDept&ID="+session['LOGON.USERID']+"&UserName="+document.getElementById("USERNAME").value; 
	window.open(doc,'new','scrollbars=no,toolbar=no,width=350,height=220,top=200,left=500');
}
function resetSize()  {
  var posX=screen.availWidth;
  var posY=screen.availHeight;
  websys_move(0,0,posX,posY);
}
function unlockonunload() {
	websys_onunload();
	if (window.event) {
		if ((!islogon) && (window.event.clientY < 0)) {
		   	window.location.href="websys.closesession.csp";
		}
	}
	return true;
}
window.onunload=unlockonunload;
var islogon = 0;
</SCRIPT>

</head>
<body>
<CSP:IF condition="$g(lic)=1">
	<SCRIPT language="Cache" RUNAT="SERVER">
	 set LICENSE="iMedical License to ",IsDirty=1,TWKFL="",TWKFLI=""
	</SCRIPT>
	  <div class="index">
	    <!--LOGO-->
	    <div class="login_header">
	      <div class="hospital">#(LogonPageTitle)#</div>
	    </div>
	    <!--LOGO-->
	    <server>
	          Set hldImg = ##class(websys.Holiday).GetImg()
	          if (hldImg="") Set hldImg = "1.jpg"
	   </server>
	    <!--背景图-->
	    <div class="login_carousel">
	      <div id="carousel-example-generic" class="carousel_200 carousel slide login_carousel_picture" data-ride="carousel">
	        <div class="carousel-inner" role="listbox">
		  		  <div class="item active"> <div class="in_img" style="background-image:url('../skin/default/images/logon/#(hldImg)#')"></div> </div>
	        </div>  
	      </div>
	    </div>
	    <!--背景图-->
	  <form ACTION="dhc.logon.csp" method="post" name="fSSUserLogon" id="fSSUserLogon">
	    <!--登录框 SCQ-->
	    <INPUT TYPE="HIDDEN" NAME="TFORM" VALUE="SSUserLogon">
		<INPUT TYPE="HIDDEN" NAME="TPAGID" VALUE='#($i(^websys.Counters("tpagid")))#'>
		<INPUT TYPE="HIDDEN" NAME="TEVENT" VALUE="">
		<INPUT TYPE="HIDDEN" NAME="TOVERRIDE" VALUE="">
		<INPUT TYPE="HIDDEN" NAME="TDIRTY" VALUE='#($g(IsDirty))#'>
		<INPUT TYPE="HIDDEN" NAME="TWKFL" VALUE='#($g(TWKFL))#'>
		<INPUT TYPE="HIDDEN" NAME="TWKFLI" VALUE='#($g(TWKFLI))#'>
		<INPUT TYPE="HIDDEN" NAME="TWKFLL" VALUE='#(%request.Get("TWKFLL"))#'>
		<INPUT TYPE="HIDDEN" NAME="TWKFLJ" VALUE='#(%request.Get("TWKFLJ"))#'>
		<INPUT TYPE="HIDDEN" NAME="TREPORT" VALUE='#(%request.Get("TREPORT"))#'>
		<INPUT TYPE="HIDDEN" NAME="TRELOADID" VALUE='#($g(TRELOADNEW))#'>
		<INPUT TYPE="HIDDEN" NAME="TFRAME" VALUE="">
		<INPUT TYPE="HIDDEN" NAME="TCONTEXT" VALUE='#($g(%request.Data("TCONTEXT",1)))#'>
		<!--协和2019-05-12增加, 人脸登录,UKey登录,扫码登录-->
		<input name="ContainerName" id="ContainerName" type="hidden" value='#($g(%request.Data("ContainerName",1)))#'>
		<input name="CALogonType" id="CALogonType" type="hidden" value='#($g(%request.Data("CALogonType",1)))#'>
		<input name="CAUserCertCode" id="CAUserCertCode" type="hidden" value='#($g(%request.Data("CAUserCertCode",1)))#'>
		<input name="CACertNo" id="CACertNo" type="hidden" value='#($g(%request.Data("CACertNo",1)))#'>
		<input name="CAToken" id="CAToken" type="hidden" value='#($g(%request.Data("CAToken",1)))#'>
		<input name="ContainerPin" id="ContainerPin" type="hidden" value='#($g(%request.Data("ContainerPin",1)))#'>		
		<INPUT type="hidden" name="CacheNoRedirect" value="1">
		<INPUT type="hidden" name="CacheUserName" value="dhsyslogin">
		<INPUT type="hidden" name="CachePassword" value="1q2w3e4r%T6y7u8i9o0p">
		<INPUT TYPE="HIDDEN" NAME="TCONTEXT" VALUE='#($g(%request.Data("TCONTEXT",1)))#'>
		<!--<INPUT TYPE="HIDDEN" ID="SelectedDefaultDepBordker" VALUE='#(##class(%CSP.Page).Encrypt($lb("web.SSUserOtherLogonLoc.SelectedDefaultDepBordker")))#' />-->
		<INPUT TYPE="HIDDEN" id="IPAddress" NAME="IPAddress" VALUE=""/>
		<INPUT TYPE="HIDDEN" id="DNSHostName" NAME="DNSHostName" VALUE=""/>
		<INPUT TYPE="HIDDEN" id="MACAddr" NAME="MACAddr" VALUE=""/>
		<INPUT TYPE="HIDDEN" id="ClientDate" NAME="ClientDate" VALUE=""/>
		<INPUT TYPE="HIDDEN" id="ClientTime" NAME="ClientTime" VALUE=""/>
		<INPUT TYPE="HIDDEN" id="LogonOtherLoc" NAME="LogonOtherLoc" VALUE=""/>
		<input id="RELOGON" name="RELOGON" type="hidden" value='#($g(%request.Data("RELOGON",1)))#'>
		<input id="LocationListFlag" name="LocationListFlag" type="hidden" value='#(##Class(web.SSUserOtherLogonLoc).CheckUserOtherLocation(%request.Get("USERNAME")))#'>
		<input id="SSUSERGROUPDESC" name="SSUSERGROUPDESC" type="hidden" value='#($g(%request.Data("SSUSERGROUPDESC",1)))#'>
		<input id="changeinlogonhosp" name="changeinlogonhosp" type="hidden" value='#($g(%request.Data("changeinlogonhosp",1)))#'>
		<input id="Hospital" name="Hospital" type="hidden" value="#($g(%request.Data("Hospital",1)))#">
		<input id="ADErrMessage" name="ADErrMessage" type="hidden" value="#($g(%request.Data("ADErrMessage",1)))#">
		<input name="isADEmployee" id="isADEmployee" type="hidden" value="1"/>
		<csp:if condition='ModifyTimeFlag=1'><object ID='CLSSETTIME' CLASSID='CLSID:6F4558E4-72DA-4CCD-963C-9EED2ECD14A9' CODEBASE='../addins/client/SetTime.CAB#version=1,0,0,0' height="0" width="0"></object></csp:if>
		<!--CA单点登录用-->
		<input name="caslogin" id="caslogin" type="hidden" value='#($g(%request.Data("caslogin",1)))#'>
		<input name="ticket" id="ticket" type="hidden" value='#($g(%request.Data("ticket",1)))#'>
		<input name="directpage" id="directpage" type="hidden" value='#($g(%request.Data("directpage",1)))#'>
		<input name="DEPARTMENTAlias" id="DEPARTMENTAlias" type="hidden" value='#($g(%request.Data("DEPARTMENTAlias",1)))#'>
		<input name="PwdComplexity" id="PwdComplexity" type="hidden" value='#($g(%request.Data("PwdComplexity",1)))#'><!--密码复杂度是否符合要求-->
	    <div class="loginboxP_cq loginbox_cq">
	      <div class="tcq">
	      	
	      		<div style='font-size:16px;'>
	      			欢迎登录 #(PEiMediclVer)#
	      			<csp:if condition=(($g(LicVerSummary)'="")&&("合同临时试用"[$g(LicVerSummary)))>
		      			<!--<div style="font-size:13px;color:red;"><a class="dhccpopover" href="#" onclick="GetLic();" role="button" tabindex="0" style="margin-top:4px;">获得许可证</a></div>-->	      			
			      		<a class="dhccpopover" role="button" tabindex="0" style="margin-top:4px;display:inline;font-size:15px;" 
			      			data-toggle="popover" data-placement="top" data-trigger="click" 
			      			title="#(LicVerSummary)#版说明" data-html="true" 
		      			data-content='<div style="font-size:13px;">有效期至#(LicExpDate)#, 还剩 #(LicAvailableDays)# 天. <a href="#" onclick="GetLic();" style="display:inline-block;font-size:10px;">更新新许可</a></div>'>
			      			#(LicVerSummary)#版&nbsp;#($g(LicUseType))#
			      		</a>
		      		</csp:if>
	      		</div>
	      	
	      </div>
	      <!-- fa-minus-circle-->
	      <server>
 	 		if (STATUS=""){
	 	 		If $g(LicTip)'="" {
	 	 			Set getLiclinkHtml = "<div style='display:inherit;'><u><a style='color:#a94442;' href='#' onclick='GetLic();' role='button' tabindex='0' style='margin-top:4px;'>获得许可证</a></u></div>"
	 	 			Set STATUS = $g(LicTip)_getLiclinkHtml
     	 		}
 	 		}
 	 	</server>
	      <csp:if condition=$g(STATUS)'="">
	     	 <div class="alert alert-danger" role="alert">
	     	 	<i class="fa" style="font-family:'microsoft yahei'">#(STATUS)#</i>
	     	 </div>
	      </csp:if>
	      <div class="form-group">
	        <div class="input-group">
	        	<csp:if condition=IEVersion="IE11">
	          		<div class="input-group-addon"><i class="fa fa-user"></i></div>
	          	<csp:else>	
	          		<div class="addonimg" style="background-image:url('../skin/default/images/logon/username.png');"></div>
	          	</csp:if>
	          <input name="USERNAME" id="USERNAME" tabIndex="1" value='#(%request.Get("USERNAME"))#' type="text" autocomplete="off" class="form-control" style="ime-mode:disabled;" placeholder="请输入用户名..." title="请输入用户名...">
	          <div class="usernameinfo logon-center-right">#($G(%session.Data("LOGON.USERNAME")))#</div>
	        </div>
	      </div>
	      <div class="form-group">
	        <div class="input-group">
	          <csp:if condition=IEVersion="IE11">
	          	<div class="input-group-addon"><i class="fa fa-lock"></i></div>
	          <csp:else>
	          	<div class="addonimg" style="background-image:url('../skin/default/images/logon/password.png');"></div>
	          </csp:if>
	          <input name="PASSWORD" id="PASSWORD" tabIndex="2" value='#(%request.Get("PASSWORD"))#' type="password" autocomplete="off" class="form-control" style="ime-mode:disabled;" placeholder="请输入密码..." title="请输入密码...">
	        </div>
	      </div>
	      <div class="form-group">
	        <div class="input-group">
	        	<csp:if condition=IEVersion="IE11">
	          		<div class="input-group-addon"><i class="fa fa-group"></i></div>
	          	<csp:else>
		          	<div class="addonimg" style="background-image:url('../skin/default/images/logon/loc.png');"></div>
	          	</csp:if>
	          	<input class="form-control" name="DEPARTMENT" tabIndex="3" autocomplete="off" id="DEPARTMENT" title="请选择登录科室" value='#(%request.Get("DEPARTMENT"))#' placeholder="请选择科室...">
	        </div>
	      </div>
	      <button href="#" id="Logon" name="Logon" tabIndex="4" href="javascript:void(0);" type="button" class="btn btn-primary btn-lg btn-block">登录</button>
	      <server>
	      if 0,$g(ValidUser){
	      	w "<a id=""CHANGEPASSWORD"" name=""CHANGEPASSWORD"" href=""#"" class=""edit_pw"">修改密码</a>"
	      	W "<a id=""ChangePINPassword"" name=""ChangePINPassword"" href=""#"" class=""edit_pw"">修改PIN密码</a>"
	      	w "<a id=""ChangDefaultDept"" name=""ChangDefaultDept"" href=""#"" class=""edit_loc"">修改默认科室</a>"
	      }
	      </server>
	    </div>
    <!--登录框 ECQ-->
    </form>
    
    <!--显示IP信息-->
    <div class="ipInfo">
    	<div class="arrow"></div>
    	<div style="margin-top:5px;">
    		服务器IP:#(##class(ext.util.String).ServerIP())# 本机IP:<span id="localipdiv">#(%request.CgiEnvs("REMOTE_ADDR"))#</span>
    	</div>
    	<div>
    		本机MAC:<span id="localmacdiv"></span>
    	</div>
    </div>
    <!--详细信息-->
    <div class="login_row">
      <div class="row login_row_4">
        <ul>
          <li>
            <i class="fa fa-gears login_icon_1"></i><span></span><strong>整合</strong>
            <div class="login_br">统一用户管理
              <div>单点登陆</div>
              <div>工作流引擎</div>
            </div>
          </li>
          <li>
            <i class="fa fa-laptop login_icon_2"></i><span></span><strong>一站式平台</strong>
            <div class="login_br">聚集应用
              <div>梳理业务流程</div>
              <div>信息驱动工作</div>
            </div>
          </li>
          <li>
            <i class="fa fa-suitcase login_icon_3"></i><span></span><strong>B2E个人热点</strong>
            <div class="login_br">我的资质档案
              <div>工资条、绩效指标</div>
              <div>企业即时信息</div>
            </div>
          </li>
          <li>
            <i class="fa fa-user-md login_icon_4"></i><span></span><strong>医生工作站</strong>
            <div class="login_br">医生秘书
              <div>临床指南+临床路径</div>
              <div>电子病历</div>
            </div>
          </li>
        </ul>
        <div class="login_QRcode"><img src="../skin/default/images/logon/QRcode.png" />
          <div class="login_br">扫一扫关注</div>
        </div>
      </div>
    </div>
    <!--详细信息-->
    <!--页脚-->
    <div class="login_footer">
      <div class="log_f">
      	<!--
        <div class="login_logo"><img src="../skin/default/images/logon/logo1.png" /><i class="fa fa-registered"></i></div>
        <div class="login_logo"><img src="../skin/default/images/logon/logo2.png" /></div>
        -->
		<div class="login_logo"><img src="../skin/default/images/logon/logo3.png" /></div>
        <span>#(+$zd(+$h,3))#</span>
        <span>东华医为科技有限公司版权所有</span>
	<!--<span>|</span>
        <span>联系我们</span><span>|</span>
        <span>加入我们</span><span>|</span>
        <span>页面改进意见</span>
        <a href="#" class="red"><i class="fa fa-thumbs-o-up login_up_color"></i>点赞（19）</a>
        <a href="#" class="green"><i class="fa fa-thumbs-o-down login_down_color"></i>不喜欢（1）</a>
	//-->
      </div>
    </div>
    <!--页脚-->

	<div class="modal fade" id="modalWin" tabindex='-1' role="dialog" aria-hidden="true">
		 <div class="modal-dialog">
         	<div class="modal-content">
            	<!--<div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            	</div>-->
            	<div class="modal-body">
            	</div>
        	</div><!-- /.modal-content -->
    	</div><!-- /.modal -->
	</div>
  </div>
  <script type="text/javascript">
	var EnableCALogon="#($G(EnableCALogon))#";
	var forcePasswordChange=#(forcePasswordChange)#;
	var readonly = '#(readonly)#';
	var locIsDisabled = #(locIsDisabled)#;
	var ValidUser = #($g(ValidUser))#;
	var logonround = #(logonround)#;
	var ModifyTimeFlag = #(ModifyTimeFlag)#;
	//密码复杂度相关
	var tipPasswordChange='#($g(tipPasswordChange))#';
	var PwdContainWordAndNum='#(##class(websys.Configuration).GetFieldValue("PwdContainWordAndNum"))#';
	var PwdMinLength='#(##class(web.CFSM).GetPasswordMinLength())#';
	var PwdLastPwd='#(%request.Get("PASSWORD"))#';
	
	
</script>
<script type='text/javascript' src='../scripts/framework/dhcc.icare.lu.js'></script>
<script type='text/javascript' src='../scripts/websys.encrypt.js'></script>
<SCRIPT Language="JavaScript">
function GetLic(){
	var html = '<h3 style="color:#000000;">许可证申请</h3><form style="color:#000000;"><div class="form-group">'
	    +'<label for="cmpCode" class="control-label">服务机器码:</label>'
	    +	'<input type="text" class="form-control" id="cmpCode" style="width:100%;" value="#(CurrServerCmpCode)#" readonly>'
	  +'</div>'
	  +'<div class="form-group">'
	  +'<label for="lickey" class="control-label ">许可证内容:</label>'
	  +'<div>'
	  +  	'<textarea id="EncLicTA" class="form-control" rows="5" id="lickey" placeholder="先复制【机器码】在协同-合同管理-安装许可证，再将许可证内容粘贴到此处验证"></textarea>'
	  +	'</div>'
	  +'</div>'
	  +'<div class="form-group">'
	  +  '<div class="col-sm-9" id="validLicErr" style="padding:5px"></div>'
	  +  '<div class="col-sm-3">'
	  +  '<button class="btn btn-primary" id="ValidEncLicBtn" onclick="ValidEncLic();return false;">验证</button>'
	  +	'</div>'
	  +'</div></form>'
	 showModal("#modalWin","",{content:html,height:'400',width:'500'}); 
	 $(".dhccpopover").popover('hide');
	 return ;
}
function ValidEncLic(){
	var encLicObj = $("#EncLicTA");
	if (encLicObj){
		var encLicStr = encLicObj.val();
		var licStr = #server(websys.License.DecryptLicAndSave(encLicStr))#
		var licArr = licStr.split("^");
		if (licArr.length>0){
			if (licArr.length>4) {
				$("#validLicErr").html("有效许可,有效日期至:"+licArr[0]).addClass("alert alert-danger").attr("role","alert");
			}else{
				$("#validLicErr").html(licArr[0]).addClass("alert alert-danger").attr("role","alert");
			}
		}
	}
}
function disableDep(){
	$("#DEPARTMENT").removeClass("logininput-dep").addClass("disabledField").attr("readOnly",true).attr("disabled",false); 
	//.attr("disabled",true); -- disabled后,submit不会提交DEPARTMENT
}
function enableDep(){
	$("#DEPARTMENT").removeClass("disabledField").addClass("logininput-dep").attr("readOnly",false).attr("disabled",false);
	$("#ChangDefaultDept").show();
	$("#CHANGEPASSWORD").show();
	$("#ChangePINPassword").show();
}
if (forcePasswordChange) ChangePassword();

var frm=document.forms['fSSUserLogon'];
frm.action="dhc.logon.csp";
var objUser=document.getElementById('USERNAME'); //frm.elements['USERNAME'];
var objPswd=document.getElementById('PASSWORD'); //frm.elements['PASSWORD'];
var objDept=document.getElementById('DEPARTMENT'); //frm.elements['DEPARTMENT'];
var objRound=document.getElementById('ROUND'); //frm.elements['ROUND'];
var objListFlag=document.getElementById('LocationListFlag'); //frm.elements['LocationListFlag'];
var btnLogon=document.getElementById('Logon');
var objDefaultDept=document.getElementById("ChangDefaultDept");
var objCHANGEPASSWORD=document.getElementById("CHANGEPASSWORD");
var objChangePINPassword = document.getElementById("ChangePINPassword")
if (readonly=='READONLY') {
	if (objUser) {
		$(objUser).addClass('disabledField').attr("readOnly",true);
	}
	if (objPswd) {
		$(objPswd).addClass("disabledField").attr("readOnly",true);
	}
}
var listflag=0;
if(objListFlag) listflag=objListFlag.value;
if(objListFlag && listflag!=1){
	$("#DEPARTMENT").removeClass("logininput-dep");
} else {
	enableDep();
}
if (locIsDisabled) {
	disableDep();
} else {
	$("#DEPARTMENT").removeClass("disabledField");
}
if (!ValidUser) {
	$("#DEPARTMENT").val("");
	disableDep();
	$("#ChangDefaultDept").hide();
	$("#CHANGEPASSWORD").hide();
	$("#ChangePINPassword").hide();
}
if (!logonround) {
	if (objRound) {
		objRound.readOnly=true;
		objRound.className='disabledField';
		var roundobj=document.getElementById('ld1473iROUND');
		if (roundobj) { roundobj.style.visibility='hidden' }
	}
}
</SCRIPT>
  </CSP:IF>
<script type="text/javascript">
	$(function(){
		$(window).resize(function(){
			/* 轮播图片高度 DY */
			$(".carousel_200 .carousel-inner .item div").css("height",$("#carousel-example-generic").height()+'px');
			/* LOGO字体竖直居中 CQ */
			$(".hospital").css("padding-top",(($(".login_header").height())/2-23)+'px');
		});
		$(window).resize();
		/* IE8下图片自适应兼容 CQ */
		$(".in_img").backgroundcover();
		$(".dhccpopover").popover({width:'160'});
		(function(){
			if (ModifyTimeFlag) {
				var serverDate = "#($zd(+$h,3))#";
				var serverTime = "#($zt($p($h,",",2)))#";
				var dateArr = serverDate.split("-");
				var timeArr = serverTime.split(":");
				var SetSysTime = "";
				if ("undefined"!=typeof EnableLocalWeb || 1==EnableLocalWeb ){
					SetSysTime = PrjSetTime;
				}else{
					try{
						SetSysTime = new ActiveXObject("PrjSetTime.CLSSETTIME")
					}catch(e){
						
					}
				}
				if(SetSysTime){
					SetSysTime.VYear = dateArr[0];
					SetSysTime.VMonth = dateArr[1]; 
					SetSysTime.VDay = dateArr[2];
					SetSysTime.VHour = timeArr[0]-8;
					SetSysTime.VMinute = timeArr[1];
					SetSysTime.VSecond = timeArr[2];
					SetSysTime.SetTime();
				}
			}
		})();
	});
</script>
<SCRIPT SRC="../scripts/dhc.logon.js"></SCRIPT>

<CSP:IF Condition=IsIE>
<!--**获取本地IP地址,只适用于IE  2013.12.02-->
<SCRIPT language=JScript event=OnObjectReady(objObject,objAsyncContext) for=foo>
   if(objObject.IPEnabled != null && objObject.IPEnabled != "undefined" && objObject.IPEnabled == true)
   {
    if(objObject.MACAddress != null && objObject.MACAddress != "undefined")
    if(IPAddr==""){
	    MACAddr = objObject.MACAddress;
	}
    if(objObject.IPEnabled && objObject.IPAddress(0) != null && objObject.IPAddress(0) != "undefined"){
    	if (IPAddr==""){
	    	//如果是内外网OnObjectReady会进入二次, 第一次是本地连接,第二次是无线连接
	    	//一般是拿本地连接(内网)
	    	IPAddr = objObject.IPAddress(0);
	    	$("localipdiv").html(IPAddr);
	    	// IPV6Addr = objObject.IPAddress(1);
    	}
    }
    if(objObject.DNSHostName != null && objObject.DNSHostName != "undefined")
    sDNSName = objObject.DNSHostName;
    }
</SCRIPT>
<SCRIPT language=JScript event="OnCompleted(hResult,pErrorObject, pAsyncContext)" for=foo>
 	document.getElementById("IPAddress").value=unescape(IPAddr);
 	$("#localipdiv").html(unescape(IPAddr));
 	document.getElementById("DNSHostName").value=unescape(sDNSName);
	if (document.getElementById("DNSHostName").value=="")  {
		document.getElementById("DNSHostName").value = dhcsys_getComputerName();
	}
 	document.getElementById("MACAddr").value=unescape(MACAddr);
 	$("#localmacdiv").html(unescape(MACAddr));

</SCRIPT>
<OBJECT id=locator classid=CLSID:76A64158-CB41-11D1-8B02-00600806D9B6 VIEWASTEXT  style="display:none;"></OBJECT>
<OBJECT id=foo classid=CLSID:75718C9A-F029-11d1-A1AC-00C04FB6C223  style="display:none;"></OBJECT>
<SCRIPT language=JScript>
   var service = locator.ConnectServer();
   var MACAddr ="" ;
   var IPAddr ="";
   var DomainAddr="";
   var sDNSName="";
   service.Security_.ImpersonationLevel=3;
   service.InstancesOfAsync(foo, 'Win32_NetworkAdapterConfiguration');
</SCRIPT>
</CSP:IF>
</body>
</html>
