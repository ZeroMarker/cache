<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	set start = $g(%request.Data("start",1))
	set pageSize = $g(%request.Data("limit",1))
	set action=$g(%request.Data("action",1))
	set isArrayType=$g(%request.Data("isArrayType",1))
	set className=$g(%request.Data("className",1))
	set condSql=""
	;s start=1,pageSize=9999999
	s:start>1 start=start+1
	s end=start+pageSize
	s deli="&"
	if action="addinterface" {
		s dim("InterCode")=$g(%request.Data("InterCode",1))
		s dim("InterDesc")=$g(%request.Data("InterDesc",1))
		s dim("InterCreateUse")=$g(%request.Data("InterCreateUse",1))
		s tip=##class(DHCWL.CodeCfgData.SaveData).AddCodeInterface(.dim)
		w "{success:true,tip:'"_tip_"'}"
	}elseif action="updateInterface" {
		s dim("ID")=$g(%request.Data("ID",1))
		s dim("InterCode")=$g(%request.Data("InterCode",1))
		s dim("InterDesc")=$g(%request.Data("InterDesc",1))
		s dim("InterCreateUse")=$g(%request.Data("InterCreateUse",1))
		s tip=##class(DHCWL.CodeCfgData.SaveData).UpdateCodeInterface(.dim)
		w "{success:true,tip:'"_tip_"'}"
	}elseif action="deleteInterface" {
		s id=$g(%request.Data("ID",1))
		s tip=##class(DHCWL.CodeCfgData.SaveData).DeleteCodeInterface(id)
		w "{success:true,tip:'"_tip_"'}"
	}elseif action="getinterfaceCombo" {
		s sql="select ID,Inter_Desc from DHCWL_CodeCfg.DHCWLCodeCfgInterface"   //Type_Code
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s deli=",",str="['',''],"
		While(rs.Next()){
			s str=str_"['"_rs.Data("ID")_"'"_deli_"'"_rs.Data("Inter_Desc")_"'],"
		}
		d rs.Close()
		w "["_$e(str,1,$l(str)-1)_"]"
	}elseif action="gethisCombo" {
		s ^yxtest("aaaa")=action
		s typeId=$g(%request.Data("choiceTypeId",1))
		s ^yxtest("aaatypeId")=typeId
		i typeId="" {
			w "{success:false,info:'请选择要查看的分类'}"
			q
		}
		s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.CodeCfgData.CodeTypeItemQuery:CodeTypeItemQuery","",typeId)
		i json="" {
			w "{result:0,totalNum:0,root:[]}"
			q
		}
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif action="addInterfaceContrast" {
		s dim("choiceTypeId")=$g(%request.Data("choiceTypeId",1))
		s dim("choiceInterfaceId")=$g(%request.Data("choiceInterfaceId",1))
		s dim("choiceHisId")=$g(%request.Data("choiceHisId",1))
		s dim("InterItem")=$g(%request.Data("InterItem",1))
		s tip=##class(DHCWL.CodeCfgData.SaveData).AddInterfaceContrast(.dim)
		w "{success:true,tip:'"_tip_"'}"
	}elseif action="deleteInterfaceContrast" {
		s id=$g(%request.Data("ID",1))
		s tip=##class(DHCWL.CodeCfgData.SaveData).DeleteInterfaceContrast(id)
		w "{success:true,tip:'"_tip_"'}"
	}elseif action="updateInterfaceContrast" {
		s ^yxtest("updateInterfaceContrast")=action
		s dim("ID")=$g(%request.Data("ID",1))
		//s dim("choiceTypeId")=$g(%request.Data("choiceTypeId",1))
		//s dim("choiceInterfaceId")=$g(%request.Data("choiceInterfaceId",1))
		s dim("choiceHisId")=$g(%request.Data("choiceHisId",1))
		s dim("InterItem")=$g(%request.Data("InterItem",1))
		S ^yxtest("choiceTypeId")=$g(%request.Data("choiceTypeId",1))
		S ^yxtest("choiceInterfaceId")=$g(%request.Data("choiceInterfaceId",1))
		S ^yxtest("choiceHisId")=$g(%request.Data("choiceHisId",1))
		S ^yxtest("InterItem")=$g(%request.Data("InterItem",1))
		S ^yxtest("ID")=$g(%request.Data("ID",1))
		s tip=##class(DHCWL.CodeCfgData.SaveData).UpdateInterfaceContrast(.dim)
		w "{success:true,tip:'"_tip_"'}"
	}elseif action="mulSearchContrast" {
		s id=$Get(%request.Data("ID",1))     //$g(%session.Data("kpiId"))
		s TypeId=$g(%request.Data("choiceTypeId",1))
		s InterfaceId=$g(%request.Data("choiceInterfaceId",1))
		s HisId=$g(%request.Data("choiceHisId",1))
		s InterItem=$g(%request.Data("InterItem",1))
		i InterItem'="" d
		.if condSql="" s condSql=condSql_" where"
		.e  s condSql=condSql_" and "
		.s condSql=condSql_" Contr_InterItem_Dr like '%"_InterItem_"%'"
		i TypeId'="" d
		.if condSql="" s condSql=condSql_" where"
		.e  s condSql=condSql_" and "
		.s condSql=condSql_" Contr_Type_Dr="_TypeId
		i InterfaceId'="" d
		.if condSql="" s condSql=condSql_" where"
		.e  s condSql=condSql_" and "
		.s condSql=condSql_" Contr_Interface_Dr="_InterfaceId
		i HisId'="" d
		.if condSql="" s condSql=condSql_" where"
		.e  s condSql=condSql_" and "
		.s condSql=condSql_" Contr_HisItem_Dr"_HisId
		s ^yxtest("condSql")=condSql
		s jsonPros="ID,ContrInterfaceDr,ContrTypeDr,ContrHisItemDr,ContrInterItemDr"
		s sqlFields=##class(DHCWL.util.GetSetService).MapFildFromClassProByStr("DHCWL.CodeCfg.Contrast",jsonPros)
		s tableName=##class(DHCWL.util.GetSetService).GetTableName("DHCWL.CodeCfg.Contrast")
		s sql="select "_sqlFields_" from "_tableName_condSql_" order by ID"
		s rs=##class(%Library.ResultSet).%New()
	    d rs.Prepare(sql)
	    d rs.Execute()
	    s json=##class(DHCWL.util.Json).Json("ID"_deli_"InterfaceDr"_deli_"TypeDr"_deli_"HisItemDr"_deli_"InterItemDr","result","root",deli)
	    s num=0
		While(rs.Next()){
			s num=num+1
			s typedr=rs.Data("Contr_Type_Dr")
			i typedr="" s typedesc=""
		    e  s typedesc=$list(^DHCWL.CodeCfg.TypeD(typedr),6)
		    s InterfaceDr=rs.Data("Contr_Interface_Dr")
			i InterfaceDr="" s Interfacedesc=""
		    e  s Interfacedesc=$list(^DHCWL.CodeCfg.InterfaceD(InterfaceDr),6)
		    s hisDr=rs.Data("Contr_HisItem_Dr")
			i hisDr="" s hisdesc=""
		    e  s hisdesc=##class(DHCWL.CodeCfg.Type).GetValueDeseById(typedr,hisDr)
			d json.Insert(rs.Data("ID")_""_deli_"'"_Interfacedesc_"'"_deli_"'"_typedesc_"'"_deli_"'"_hisdesc_"'"_deli_"'"_rs.Data("Contr_InterItem_Dr")_"'")
		}
		d rs.Close()
		d json.SetTotalNum(num)
		i (+isArrayType=1) {
			w "["
			d {
				s obj=json.GetNextJsonArray()
				i obj'="" w obj,","
			}while(obj'="")
			w "]"
			q
		}
	
		s jsonHead=json.GetHead()
		//w json.GetJson()有一些代替此方法（因为数据量大时string会溢出）
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	    
	}
	
	
	
	
</script>