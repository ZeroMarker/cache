<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
i ##Class(websys.SessionEvents).SessionExpired() q 1
q 1
</csp:method>
<csp:content charset="gb2312">
<csp:content charset="utf-8">
<script language="cache" runat="server">
s start=$g(%request.Data("start",1))
s pageSize=$g(%request.Data("limit",1))
s isArrayType=$g(%request.Data("isArrayType",1))
s className=$g(%request.Data("className",1))
s action=$g(%request.Data("action",1))
s condSql=""
s:start>1 start=start+1
s end=start+pageSize
s deli="&"
i action="mulSerchRel"{
	s setId=$g(%request.Data("setId",1))
	s relkpiId=$g(%request.Data("relkpiId",1))
	s relkpiDesc=$g(%request.Data("relkpiDesc",1))
	i setId'="" d
	.i condSql="" s condSql=condSql_" where"
	.e  s condSql=condSql_" and"
	.s condSql=condSql_" SetKpiRe_Set_Dr ='"_setId_"'"
	i relkpiId'=""  d
	.if condSql="" s condSql=condSql_" where"
	.e  s condSql=condSql_" and "
	.s condSql=condSql_" SetKpiRe_Kpi_Dr ='"_relkpiId_"'"
	s jsonPros="ID,SetKpiReSetDr,SetKpiReKpiDr,SetKpiReUpdateDate,SetKpiReUpdateUser"
	s sqlFields=##class(DHCWL.util.GetSetService).MapFildFromClassProByStr("DHCWL.CheckFun.SetKpiRe",jsonPros)
	s tableName=##class(DHCWL.util.GetSetService).GetTableName("DHCWL.CheckFun.SetKpiRe")
	s sql="select "_sqlFields_" from "_tableName_condSql_" order by ID"
	s json=##class(DHCWL.util.Json).Json("ID"_deli_"relkpiId"_deli_"relkpiDesc"_deli_"uDate"_deli_"uUser","result","root",deli)
	s rs=##class(%Library.ResultSet).%New()
	d rs.Prepare(sql)
	d rs.Execute()
	s num=0
	while (rs.Next()){
			s num=num+1
			i (num<start) continue
			i (num>end) continue
			s updateDate=rs.Data("SetKpiRe_UpdateDate")
		    i updateDate'="" s updateDate=##class(websys.Conversions).DateLogicalToHtml(updateDate)
		    s relKpi=rs.Data("SetKpiRe_Kpi_Dr")
		    s relKpiDesc=$list(^DHCWL.CheckFun.CheckKPID(relKpi),3)
		    d json.Insert(rs.Data("ID")_""_deli_"'"_rs.Data("SetKpiRe_Kpi_Dr")_"'"_deli_"'"_relKpiDesc_"'"_deli_"'"_updateDate_"'"_deli_"'"_rs.Data("SetKpiRe_UpdateUser")_"'")
		}
		d rs.Close()
		d json.SetTotalNum(num)
		i (+isArrayType=1) {
			w "["
			d {
				s obj=json.GetNextJsonArray()
				i obj'="" w obj,","
			}while(obj'="")
			w "]"
			q
		}
		s jsonHead=json.GetHead()
		//w json.GetJson()有一些代替此方法（因为数据量大时string会溢出）
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
}elseif action="addCheckFunRel"{
		s dim("setId")=$g(%request.Data("setId",1))
		s dim("relkpiId")=$g(%request.Data("relkpiId",1))
		s dim("relUpdateUser")=$g(%session.Data("LOGON.USERNAME"))
		s tip=##class(DHCWL.CheckFunData.SaveData).AddCheckFunRel(.dim)
		w "{success:true,tip:'"_tip_"'}"
}elseif action="deleteCheckFunRel"{
		s dim("ID")=$g(%request.Data("ID",1))
		s tip=##class(DHCWL.CheckFunData.SaveData).DeleteCheckFunRel(.dim)
		w "{success:true,tip:'"_tip_"'}"
}

</script>