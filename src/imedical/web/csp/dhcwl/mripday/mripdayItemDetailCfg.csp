<csp:content charset="gb2312">
<csp:content charset="UTF-8">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s action=$g(%request.Data("action",1))

	if "selectDimPro"=action {		//得到出入转明细指标的维度属性

		set start = $g(%request.Data("start",1))
		set pageSize = $g(%request.Data("limit",1)) 
		s end=$g(start)+$g(pageSize)
		s:+start>1 start=start+1
		//1、得到出入转明细指标的维度属性的ID,编码，描述
		set sql="SELECT ID,DimPro_Code,DimPro_Name,DimPro_Desc FROM DHCWL_MKPI.DHCWLDimProperty WHERE DimPro_DimDr IN (SELECT ID FROM DHCWL_MKPI.DHCWLMKPIDimType WHERE KDT_CODE='MRIPDetail') ORDER BY ID"

		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()

		//2、组装拼接返回数据
		s deli=","
        s json=##class(DHCWL.util.Json).Json("ID"_deli_"Code"_deli_"Name"_deli_"Desc","result","root",deli)
		s recCnt=0				;记录条数计数
		While(rs.Next()){
			s recCnt=recCnt+1
			;w "start:"_start_"  end:"_end
			i (recCnt<start) continue
			i (recCnt>end) continue

			s ID=rs.Data("ID")
			s code=rs.Data("DimPro_Code")
			s name=rs.Data("DimPro_Name")
			s desc=rs.Data("DimPro_Desc")
			d json.Insert(""_ID_""_deli_"'"_code_"'"_deli_"'"_name_"'"_deli_"'"_desc_"'")
		}
	
		d rs.Close()
		//3、向前台页面返回数据
		d json.SetTotalNum(recCnt)
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"			

	}elseif "addOPTLDetailItem"=action {	//保存可选明细统计项定义
		s ID=$g(%request.Data("ID",1))
		s itemCode=$g(%request.Data("itemCode",1))
		s itemDesc=$g(%request.Data("itemDesc",1))
		s dimProCode=$g(%request.Data("dimProCode",1))
		s dimProDR=$g(%request.Data("dimProDR",1))
		s dimType=$g(%request.Data("dimType",1))
		if dimType="" s dimType="KPIDetailItem"
		if ID="" {		//1、如果ID为空，那么添加记录
			tstart
			//1.1新增可选明细统计项
			&sql(insert into DHCWL_MRIPDay.OPTLDetailItem (OPTLDetailItem_Code,OPTLDetailItem_Desc,OPTLDetailItem_Type) 
			values (:itemCode,:itemDesc,:dimType))
			i +$g(SQLCODE)=0 {
				//1.2新增指标类可选明细统计项
				&sql(insert into DHCWL_MRIPDay.KPIDetailItem (KPIDetailItem_OPTLDetailItemDR,KPIDetailItem_DimProDR,KPIDetailItem_DimProCode) 
				values (:%ROWID,:dimProDR,:dimProCode))
				i +$g(SQLCODE)=0 {
					tcommit
					w "{success:true,tip:'ok',ROWID:"_%ROWID_"}"
				}else {
					trollback
				  w "{success:true,tip:'操作失败！',SQLCODE:"_SQLCODE_"}"	
				}	
			}
			else {
				trollback
				w "{success:true,tip:'操作失败！',SQLCODE:"_SQLCODE_"}"	
			
			}
		}else {	//2、如果ID不为空，那么更新记录
			//更新明细统计项
			&sql(update DHCWL_MRIPDay.OPTLDetailItem set OPTLDetailItem_Desc=:itemDesc where OPTLDetailItem_RowID=:ID)
			i +$g(SQLCODE)=0 {
				w "{success:true,tip:'ok',ROWID:''}"
			}else {
			  w "{success:true,tip:'操作失败！',SQLCODE:"_SQLCODE_"}"	
			}	
		}




	}elseif "search"=action {		//查询可选明细统计项
		set DetailItemCode = $g(%request.Data("DetailItemCode",1))
		set DetailItemDesc = $g(%request.Data("DetailItemDesc",1))
		set KPIDetailItemDimProCode = $g(%request.Data("KPIDetailItemDimProCode",1))
		set start = $g(%request.Data("start",1))
		set pageSize = $g(%request.Data("limit",1)) 
		s end=$g(start)+$g(pageSize)
		s:+start>1 start=start+1
		
		//1、组合查询条件
		set sql="SELECT t1.OPTLDetailItem_RowID,t1.OPTLDetailItem_Code,t1.OPTLDetailItem_Desc,t2.KPIDetailItem_DimProCode FROM DHCWL_MRIPDay.OPTLDetailItem t1,DHCWL_MRIPDay.KPIDetailItem t2 WHERE t1.OPTLDetailItem_RowID=t2.KPIDetailItem_OPTLDetailItemDR"
		s sqlCon=""
		if DetailItemCode'=""	{
			if sqlCon="" s sqlCon=" t1.OPTLDetailItem_Code='"_DetailItemCode_"'"
			e  s sqlCon=sqlCon_" and t1.OPTLDetailItem_Code='"_DetailItemCode_"'"
		}
		if DetailItemDesc'="" {
			if sqlCon="" s sqlCon=" t1.OPTLDetailItem_Desc like '%"_DetailItemDesc_"%'"	
			e  s sqlCon=sqlCon_" and t1.OPTLDetailItem_Desc like '%"_DetailItemDesc_"%'"	
		}
		if KPIDetailItemDimProCode'="" {
			if sqlCon="" s sqlCon=" t2.KPIDetailItem_DimProCode='"_KPIDetailItemDimProCode_"'"
			e  s sqlCon=sqlCon_" and t2.KPIDetailItem_DimProCode='"_KPIDetailItemDimProCode_"'"
		}		
		
		if sqlCon'="" s sql=sql_" and "_sqlCon


		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()


		//2、组装拼接返回数据
		s deli=","
            	
        s json=##class(DHCWL.util.Json).Json("OPTLDetailItemRowid"_deli_"OPTLDetailItemCode"_deli_"OPTLDetailItemDesc"_deli_"KPIDetailItemDimProCode","result","root",deli)
		s recCnt=0				;记录条数计数
		While(rs.Next()){
			s recCnt=recCnt+1
			i (recCnt<start) continue
			i (recCnt>end) continue

			s rowID=rs.Data("OPTLDetailItem_RowID")
			s code=rs.Data("OPTLDetailItem_Code")
			s desc=rs.Data("OPTLDetailItem_Desc")
			s dimProCode=rs.Data("KPIDetailItem_DimProCode")
			//3、组装拼接返回数据
			d json.Insert(""_rowID_""_deli_"'"_code_"'"_deli_"'"_desc_"'"_deli_"'"_dimProCode_"'")
		}
	
		d rs.Close()
		
		//4、向前台页面返回数据
		d json.SetTotalNum(recCnt)
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		
	
	
	}elseif "del"=action {		//删除明细统计项定义
		b
		s OPTLDetailItemRowid=$g(%request.Data("OPTLDetailItemRowid",1))
		//1、查看是否有报表使用到这个统计项
		s ret=##class(DHCWL.MRIPDay.MripDayService).FindDetailRptDescByDtlID(OPTLDetailItemRowid)
		if ret'="" {
			s TipMsg="要删除的明细统计项被下面报表使用："_ret_" 。请先从这些报表中移除该明细统计项。"
			w "{success:true,tip:'ok',TipMsg:'"_TipMsg_"'}"	
		}else{
			tstart
			//2、删除统计项
			s ret=##class(DHCWL.MRIPDay.MripDayService).DelDtlRpt(OPTLDetailItemRowid)
			if ret=0 {
				tcommit
				w "{success:true,tip:'ok'}"	
			}else{
				trollback
				w "{success:true,tip:'操作失败！'}"
			}
		}
		
	}
</script>
