<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
 ;dhccpm.rqreport.csp
 //d ##class(web.DHCBL.BDP.BDPExecutables).BuildAutAry("DHCWL_CodeCfg.DHCWLCodeCfgType")  //调用数据平台接口
 i ##Class(websys.SessionEvents).SessionExpired() q 1
 q 1
</csp:method>
<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s deli = "&"
	set start = $g(%request.Data("start",1))
	set limit = $g(%request.Data("limit",1))
	set action=$g(%request.Data("action",1))
	set pageSize = $g(%request.Data("limit",1))
	set isArrayType=$g(%request.Data("isArrayType",1))
	set className=$g(%request.Data("className",1))
	set condSql=""
	s:start>1 start=start+1
	s end=start+pageSize
	i action="singleSearche" {
		s choiceSearcheCond = $Get(%request.Data("choiceSearcheCond",1))
		s searcheValue = $Get(%request.Data("searcheValue",1))
		s className = "DHCWL.DocQuery.DocKpiDef"
		s jsonPros = "ID,MDocKPIDefCode,MDocKPIDefDesc,MDocKPIUpdateDate,MDocKPIDefClass,MDocKPIDefCategory,MDocKPIDefType"
		s sqlFields=##class(DHCWL.util.GetSetService).MapFildFromClassProByStr(className,jsonPros)
        s tableName=##class(DHCWL.util.GetSetService).GetTableName(className)  
        s change = ##class(DHCWL.util.GetSetService).MapFildFromClassProByStr(className,choiceSearcheCond)
        s sql = "SELECT "_sqlFields_" FROM "_tableName_" where "_change_" like '%"_searcheValue_"%'"
        s hql = "SELECT count(*) as cnt FROM "_tableName_" where "_change_" like '%"_searcheValue_"%'"
        d ##class(DHCWL.DocQueryData.DocQueryFactory).GetConditionID(sql)
        s json=##class(DHCWL.util.Json).Json("ID"_deli_"MDocKPIDefCode"_deli_"MDocKPIDefDesc"_deli_"MDocKPIUpdateDate"_deli_"MDocKPIDefClass"_deli_"MDocKPIDefCategory"_deli_"MDocKPIDefType","result","root",deli)
 		k page
		s total = (end-start-1)
		s tNum = 0
		i start=0  d
	    .s tempId = 0  f  s tempId=$o(^TEMPDHCWLDUH("condition",tempId)) q:tempId=""  d
	    ..q:(tNum>total)
        ..s page(tempId)=""   //把start到end 的id拿到
        ..s tNum = $g(tNum)+1
        e  d
        .s tempId = 0  f  s tempId=$o(^TEMPDHCWLDUH("condition",tempId)) q:tempId=""  d
        ..s tNum = $g(tNum)+1
	    ..q:(tNum<start)
        ..s page(tempId)=""   //把start到end 的id拿到
	    s ids = "" s tId = 0 f  s tId = $o(page(tId))  q:tId=""  d
	    .s ids = ids_tId_","  // 1,2,3,4
	    s ids=$e(ids,1,$l(ids)-1)
		k page
 	    s sql = "SELECT "_sqlFields_" FROM "_tableName_" where ID in ("_ids_") Order by ID "
 		s rs = ##class(%Library.ResultSet).%New()
 		s sc = rs.Prepare(sql)
 		s sc = rs.Execute()
 		While(rs.Next()){
 			s docId=rs.Data("ID")
 			s docCode = rs.Data("MDocKPIDef_Code")
 			s docDesc = rs.Data("MDocKPIDef_Desc")
 			s docDate = rs.Data("MDocKPI_UpdateDate")
 			s docClass = rs.Data("MDocKPIDef_Class")
 			s docCategory = rs.Data("MDocKPIDef_Category")
 			s docType = rs.Data("MDocKPIDef_Type")
 			i docDate'=""  s docDate = $zd(docDate,3)
 			d json.Insert(docId_""_deli_"'"_docCode_"'"_deli_"'"_docDesc_"'"_deli_"'"_docDate_"'"_deli_"'"_docClass_"'"_deli_"'"_docCategory_"'"_deli_"'"_docType_"'")
 		}
		d rs.Close()
		s cNum = ##class(DHCWL.DocQueryData.DocQueryFactory).GetConditionCount(hql)
		d json.SetTotalNum(cNum)
		i (+isArrayType=1) {
			w "["
			d {
				s obj=json.GetNextJsonArray()
				i obj'="" w obj,","
			}while(obj'="")
			w "]"
			q
		}
	
		s jsonHead=json.GetHead()
		//w json.GetJson()有一些代替此方法（因为数据量大时string会溢出）
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}
	
	
</script>
