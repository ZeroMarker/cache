<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">

	s action=$g(%request.Data("action",1))
	i "addGrpAndSubgrp"=action {
		s isSuccess=0
		s dimTypeID=""

		f {
			s dimTypeID=$o(^DHCWL.MKPI.MKPIDimTypeD(dimTypeID))
			q:dimTypeID=""
			
			if $d(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID)) {
				if '$d(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMGRP")) {
					&sql(insert into DHCWL_MKPI.DHCWLDimProperty 
					(DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DimDr,DimPro_DefaultFlag) 
					values ('ItemGrp','统计大组','统计大组','GetMripdayGrpDescAndSort^DHCWLBuildDimDataGetSubGrp',:dimTypeID,'N') )
					if SQLCODE'=0 {
						S isSuccess=SQLCODE
						q
					}
				}else{
					s dimProID=$o(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMGRP",""))
					s dimPrObj=##class(DHCWL.MKPI.DimProperty).%OpenId(dimProID)
					s exeCode=dimPrObj.ExcuteCode
					if ((exeCode="")||(exeCode=$c(0))){
						s dimPrObj.ExcuteCode="GetMripdayGrpDescAndSort^DHCWLBuildDimDataGetSubGrp"
						s result=dimPrObj.%Save()
						if (result'=1){
							s isSuccess=result
							q
						}
					}
				}
                if '$d(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMBSGRPORDER")){
	                &sql(insert into DHCWL_MKPI.DHCWLDimProperty
					(DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DimDr,DimPro_DefaultFlag) 
					values ('ItemBsGrpOrder','统计大组顺序','统计大组顺序','GetBSGrpOrder^DHCWLBuildDimDataGetSubGrp',:dimTypeID,'N') )
					if SQLCODE'=0 {
						S isSuccess=SQLCODE
						q
					}
                }
				if '$d(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMSUBGRP")) {
					&sql(insert into DHCWL_MKPI.DHCWLDimProperty
					(DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DimDr,DimPro_DefaultFlag) 
					values ('ItemSubGrp','统计子组','统计子组','GetSubGrpByItemDr^DHCWLBuildDimDataGetSubGrp',:dimTypeID,'N') )
					if SQLCODE'=0 {
						S isSuccess=SQLCODE
						q
					}
				}else{
					s dimProID=$o(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMSUBGRP",""))
					s dimPrObj=##class(DHCWL.MKPI.DimProperty).%OpenId(dimProID)
					s exeCode=dimPrObj.ExcuteCode
					if ((exeCode="")||(exeCode=$c(0))){
						s dimPrObj.ExcuteCode="GetSubGrpByItemDr^DHCWLBuildDimDataGetSubGrp"
						s result=dimPrObj.%Save()
						if (result'=1){
							s isSuccess=result
							q
						}
					}
				}
				if '$d(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMSUBGRPDESC")) {
					&sql(insert into DHCWL_MKPI.DHCWLDimProperty
					(DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DimDr,DimPro_DefaultFlag) 
					values ('ItemSubGrpDesc','统计子组描述','统计子组描述','GetBSSubDesc^DHCWLBuildDimDataGetSubGrp',:dimTypeID,'N') )
					if SQLCODE'=0 {
						S isSuccess=SQLCODE
						q
					}
				}
				if '$d(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMSUBGRPCODE")) {
					&sql(insert into DHCWL_MKPI.DHCWLDimProperty
					(DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DimDr,DimPro_DefaultFlag) 
					values ('ItemSubGrpCode','统计子组代码','统计子组代码','GetBSSubCode^DHCWLBuildDimDataGetSubGrp',:dimTypeID,'N') )
					if SQLCODE'=0 {
						S isSuccess=SQLCODE
						q
					}
				}
				if '$d(^DHCWL.MKPI.DimPropertyI("DimCodeI",dimTypeID,"ITEMSUBGRPORDER")) {
					&sql(insert into DHCWL_MKPI.DHCWLDimProperty
					(DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DimDr,DimPro_DefaultFlag) 
					values ('ItemSubGrpOrder','统计子组顺序','统计子组顺序','GetBSSubOrder^DHCWLBuildDimDataGetSubGrp',:dimTypeID,'N') )
					if SQLCODE'=0 {
						S isSuccess=SQLCODE
						q
					}
				}
			}
			
		}
			
		if isSuccess=0 w "{success:true,tip:'ok'}"
		e  w "{success:false,tip:'"_isSuccess_"'}"

	}elseif "AddDimPro"=action {
	}

</script>