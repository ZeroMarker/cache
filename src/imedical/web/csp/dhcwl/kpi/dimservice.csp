<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s requestParams="",deli="&"
    s val="" f  s val=$o(%request.Data(val)) q:val=""  d
	.s ind="" f  s ind=$o(%request.Data(val,ind)) q:ind=""  d
	..;w val_"="_$g(%request.Data(val,ind)),!
	..i requestParams'="" s requestParams=requestParams_deli_val_"="_$g(%request.Data(val,ind))
	..e  s requestParams=val_"="_$g(%request.Data(val,ind))
	;w "requestParams="_requestParams_"<br>"
	
	s action=$g(%request.Data("action",1))
	s start=$g(%request.Data("start",1))
	set pageSize = $g(%request.Data("limit",1))
	s end=start+pageSize
	s:start>1 start=start+1
	i "GetDimProList"=action {
		s isArrayType=$g(%request.Data("isArrayType",1))
		s dimId=$g(%request.Data("dimId",1))
		s dimId=##class(DHCWL.MKPIService.ConfigService).GetDimIdByCode(dimId)
		;w "dimId="_dimId
		s sql="select ID,DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DefaultFlag,DimPro_ValueDeli from DHCWL_MKPI.DHCWLDimProperty  where DimPro_DimDr=? order by ID"
		s jsonPro="ID,Code,Name,Desc,ExcuteCode,DefaultFlag,ValueDeli"
		i isArrayType=1 {
			s sql="select DimPro_Code,DimPro_Name,DimPro_Desc,DimPro_ExcCode,DimPro_DefaultFlag,DimPro_ValueDeli from DHCWL_MKPI.DHCWLDimProperty  where DimPro_DimDr=? order by ID"
			s jsonPro="Code,Name,Desc,ExcuteCode,DefaultFlag,ValueDeli"
		}
		i isArrayType=1 s start=0,end=0
		s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro,dimId)
		i isArrayType=1 {
			w "["
			d {
				s obj=json.GetNextJsonArray()
				i obj'="" w obj,","
			}while(obj'="")
			w "]"
			q
		}
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif "AddDimPro"=action {
		s dimId=$g(%request.Data("DimDr",1))
		s ID=$g(%request.Data("ID",1))
		s Code=$g(%request.Data("Code",1))
		s Name=$g(%request.Data("Name",1))
		s Desc=$g(%request.Data("Desc",1))
		s ExcuteCode=$g(%request.Data("ExcuteCode",1))
		s DefaultFlag=$g(%request.Data("DefaultFlag",1))
		s ValueDeli=$g(%request.Data("ValueDeli",1))
		s deli="@"
		s dimId=##class(DHCWL.MKPIService.ConfigService).GetDimIdByCode(dimId)
		if ID="" {
			s dimCode=##class(DHCWL.MKPIIO.XMLIOConfige).GetCodeById(dimId,"DHCWL.MKPI.MKPIDimType")
			s tempId=##class(DHCWL.MKPIIO.XMLIOConfige).GetIdByCode(dimCode_"||"_Code,"DHCWL.MKPI.DimProperty")
			i tempId'="" {
				w "{success:true,tip:'同一个维度下维度属性编码不能重复!'}"
				q
			}
		}
		s setPro="Code="_Code_deli_"DimDr="_dimId_deli_"Name="_Name_deli_"Desc="_Desc_deli_"ExcuteCode="_ExcuteCode_deli_"DefaultFlag="_DefaultFlag_deli_"ValueDeli="_ValueDeli
		s ope="I",whereStr=""
		i ID'="" {
			s ope="U",whereStr=" where ID="_ID
			s setPro="DimDr="_dimId_deli_"Name="_Name_deli_"Desc="_Desc_deli_"ExcuteCode="_ExcuteCode_deli_"DefaultFlag="_DefaultFlag_deli_"ValueDeli="_ValueDeli
		}else {
			  s ope="I"
		}
		i $g(DefaultFlag)="Y" {
			d ##class(DHCWL.util.GetSetService).SetPropertyByStr("DHCWL.MKPI.DimProperty","DefaultFlag=N",deli,"U","where DimPro_DimDr="_dimId)
		}
		;w setPro_"<br>"_ope_"  "_whereStr_"<br>"
		d ##class(DHCWL.util.GetSetService).SetPropertyByStr("DHCWL.MKPI.DimProperty",setPro,deli,ope,whereStr)
		w "{success:true,tip:'ok'}"
		
	}elseif "DeleteDimPro"=action {
		s dimProId=$g(%request.Data("dimProId",1))
		q:+dimProId=0
		&sql(delete from DHCWL_MKPI.DHCWLDimProperty where ID =:dimProId)
	}elseif "GetSecProList"=action {
		s secProCode=$g(%request.Data("secProCode",1))
		s secDimId=$g(%request.Data("secDimId",1))
		s isArrayType=$g(%request.Data("isArrayType",1))
		;s sql="select SecDimPro_Code,SecDimPro_Name,SecDimPro_Desc,SecDimPro_DefaultFlag,SecDimPro_Code from DHCWL_MKPI.DHCWLSectionProperty "
		//modify by wk.2016-02-16
		s sql="select ID,SecDimPro_Code,SecDimPro_Name,SecDimPro_Desc,SecDimPro_DefaultFlag,SecDimPro_ExcCode from DHCWL_MKPI.DHCWLSectionProperty "
		i $g(secProCode)'="" {
			s sql=sql_" where SecDimPro_Code='"_secProCode_"'"
		}
		//add by wk.2016-02-18
		i $g(secDimId)'=""{
			s sql=sql_" where SecDimPro_DimDr='"_secDimId_"'"
		}
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		//w !,sql
		//读入可选项结束
		s deli=","
		;s json=##class(DHCWL.util.Json).Json("Code"_deli_"Name"_deli_"Desc"_deli_"DefaultFlag"_deli_"OldCode","result","root",deli)
		//modify by wk.2016-02-16
		s json=##class(DHCWL.util.Json).Json("ID"_deli_"Code"_deli_"Name"_deli_"Desc"_deli_"DefaultFlag"_deli_"ExcuteCode","result","root",deli)
		s recCnt=0				;记录条数计数
		While(rs.Next()){
			s code=rs.Data("SecDimPro_Code")
			continue:$d(^TEMPDHCWL($J,code))		
			s recCnt=recCnt+1

			/*
			i (recCnt<start) continue
			i (recCnt>end) continue
			*/
			s ID=rs.Data("ID")
			s name=rs.Data("SecDimPro_Name")
			s desc=rs.Data("SecDimPro_Desc")
			s defaultFlag=rs.Data("SecDimPro_DefaultFlag")
			s exeCode=rs.Data("SecDimPro_ExcCode")
			d json.Insert("'"_ID_"'"_deli_"'"_code_"'"_deli_"'"_name_"'"_deli_"'"_desc_"'"_deli_"'"_defaultFlag_"'"_deli_"'"_exeCode_"'")
			s ^TEMPDHCWL($J,code)=""
		}
	
		d rs.Close()
		d json.SetTotalNum(recCnt)
		/*s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"*/
		i (+isArrayType=1) {
			w "["
			d {
				s obj=json.GetNextJsonArray()
				i obj'="" w obj,","
			}while(obj'="")
			w "]"			
			//k ^TEMPDHCWL($J)
		}
	    else{
		    s jsonHead=json.GetHead()
			w jsonHead
			d{
				s obj=json.Next()
				w obj
			}while(obj'="")
			i json.GetCount()=0 w "]}"
	    }
	    k ^TEMPDHCWL($J)
		Q
		/*
		s secDimId=$g(%request.Data("secDimId",1))
		s secDimId=##class(DHCWL.MKPI.Section).GetIdByCode(secDimId)
		s isArrayType=$g(%request.Data("isArrayType",1))
		s sql="select ID,SecDimPro_Code,SecDimPro_Name,SecDimPro_Desc,SecDimPro_ExcCode,SecDimPro_DefaultFlag from DHCWL_MKPI.DHCWLSectionProperty  where SecDimPro_DimDr=? order by ID"
		s jsonPro="ID,Code,Name,Desc,ExcuteCode,DefaultFlag"
		i isArrayType=1 {
			s sql="select ID,SecDimPro_Code,SecDimPro_Name,SecDimPro_Desc,SecDimPro_ExcCode,SecDimPro_DefaultFlag from DHCWL_MKPI.DHCWLSectionProperty  where SecDimPro_DimDr=? order by ID"
			s jsonPro="ID,Code,Name,Desc,ExcuteCode,DefaultFlag"
		}
		i isArrayType=1 s start=0,end=0
		s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro,secDimId)
		i isArrayType=1 {
			w "["
			d {
				s obj=json.GetNextJsonArray()
				i obj'="" w obj,","
			}while(obj'="")
			w "]"
			q
		}
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
		*/
	}elseif "AddSecDimProOld"=action {
		s oldCode=$g(%request.Data("oldCode",1))
		s Code=$g(%request.Data("Code",1))
		s Name=$g(%request.Data("Name",1))
		s Desc=$g(%request.Data("Desc",1))
		s DefaultFlag=$g(%request.Data("DefaultFlag",1))

		if (oldCode="") {	//新增
			//判断编码是否重复
			s repFlag=0
			s secID=""
			f {
				s secID=$o(^DHCWL.MKPI.SectionD(secID))
				q:secID=""
				s alphCode=$SYSTEM.SQL.ALPHAUP(Code) 
				if $d(^DHCWL.MKPI.SectionPropertyI("SecDimCodeI",secID,alphCode)) {
					s repFlag=1
					q	
				}
			}
			
			if repFlag=1 {
				w "{success:true,tip:'维度属性编码不能重复!'}"
				q
			}
			
			//新增操作
			s secID=0
			f {
				s secID=$o(^DHCWL.MKPI.SectionD(secID))
				q:secID=""

				&sql(INSERT INTO DHCWL_MKPI.DHCWLSectionProperty (SecDimPro_Code, SecDimPro_Name, SecDimPro_Desc, SecDimPro_ExcCode, SecDimPro_DimDr, SecDimPro_DefaultFlag)
					VALUES (:Code, :Name, :Desc, '', :secID, :DefaultFlag))
				
				i +$g(SQLCODE)'=0 {
					q
				}
			}
		
			i +$g(SQLCODE)'=0 {
				w "{success:true,tip:'添加失败！',SQLCODE:"_SQLCODE_"}"	
			}else{
				w "{success:true,tip:'ok'}"	
			}
			
		}else{	//修改
			
			&sql(UPDATE DHCWL_MKPI.DHCWLSectionProperty SET SecDimPro_Code = :Code, SecDimPro_Name = :Name
				, SecDimPro_Desc = :Desc, SecDimPro_DefaultFlag = :DefaultFlag	WHERE SecDimPro_Code = :oldCode)
			i +$g(SQLCODE)'=0 {
				q
			}
			
			i +$g(SQLCODE)'=0 {
				w "{success:true,tip:'保存失败！',SQLCODE:"_SQLCODE_"}"	
			}else{
				w "{success:true,tip:'ok'}"	
			}
		}
	}elseif "AddSecDimPro"=action{
		//add by wk.2016-2-22
		s id=$g(%request.Data("ID",1))	
		s Code=$g(%request.Data("Code",1))
		s Name=$g(%request.Data("Name",1))
		s Desc=$g(%request.Data("Desc",1))
		s DefaultFlag=$g(%request.Data("DefaultFlag",1))
		s SecDimDr=$g(%request.Data("SecDimDr",1))
		s ExcuteCode=$g(%request.Data("ExcuteCode",1))
		if (id=""){//新增
			//判断编码是否重复
			s repFlag=0
			s secID=""
			f {
				s secID=$o(^DHCWL.MKPI.SectionD(secID))
				q:secID=""
				s alphCode=$SYSTEM.SQL.ALPHAUP(Code) 
				if $d(^DHCWL.MKPI.SectionPropertyI("SecDimCodeI",secID,alphCode)) {
					s repFlag=1
					q	
				}
			}
			
		if repFlag=1 {
			w "{success:true,tip:'维度属性编码不能重复!'}"
			q
		}
		&sql(INSERT INTO DHCWL_MKPI.DHCWLSectionProperty (SecDimPro_Code, SecDimPro_Name, SecDimPro_Desc, SecDimPro_ExcCode, SecDimPro_DimDr, SecDimPro_DefaultFlag)
				VALUES (:Code, :Name, :Desc, :ExcuteCode, :SecDimDr, :DefaultFlag))
		i +$g(SQLCODE)'=0 {
			w "{success:true,tip:'添加失败！',SQLCODE:"_SQLCODE_"}"	
		}else{
			w "{success:true,tip:'ok'}"	
		}
	    }else{//修改
			&sql(UPDATE DHCWL_MKPI.DHCWLSectionProperty SET SecDimPro_Code = :Code, SecDimPro_Name = :Name
				, SecDimPro_Desc = :Desc, SecDimPro_ExcCode= :ExcuteCode,SecDimPro_DefaultFlag = :DefaultFlag	WHERE ID = :id)
			i +$g(SQLCODE)'=0 {
				w "{success:true,tip:'保存失败！',SQLCODE:"_SQLCODE_"}"	
			}else{
				w "{success:true,tip:'ok'}"	
			}
	    }
	}elseif "DeleteSecDimPro"=action {
			s dimProId=$g(%request.Data("secDimProId",1))
			q:+dimProId=0
			&sql(delete from DHCWL_MKPI.DHCWLSectionProperty where ID=:dimProId)
			//modify by wk.2016-02-16
			//w "{success:true,tip:'操作成功！'}"
			w "{success:true,tip:'ok'}"
			q
	}elseif "GetKpiDimAndPro"=action {
		/*
		s kpiCodes=$g(%request.Data("kpiCodes",1))
		s kpiLen=$l(kpiCodes,",")
		w "{data:["
		f i=1:1:kpiLen d
		.s kpiCode=$p(kpiCodes,",",i)
		.d ##class(DHCWL.CSPService.dimservice).GetKpiDimAndPro(kpiCode)
		.i i<kpiLen w ","
		w "],success:true,tip:'ok'}"	
		*/	
		s kpiCodes=$g(%request.Data("kpiCodes",1))
		s treeDeep=$g(%request.Data("treeDeep",1))
		
		;s kpiId=##class(DHCWL.MKPIIO.XMLIOConfige).GetIdByCode(kpiCodes,"DHCWL.MKPI.MKPI")
		
		w "{data:"
		d ##class(DHCWL.CSPService.dimservice).GetKpiDimAndPro(kpiCodes,treeDeep)
		w ",success:true,tip:'ok'}"	

		q
	}elseif "GetDimAndPro"=action {	
		s dimCodes=$g(%request.Data("dimCodes",1))
		s treeDeep=$g(%request.Data("treeDeep",1))
		w "{data:"
		d ##class(DHCWL.CSPService.dimservice).GetDimAndPro(dimCodes)
		w ",success:true,tip:'ok'}"	
		q
	}elseif "GetSecExcCodeList"=action {
		s secProCode=$g(%request.Data("secProCode",1))
		s sql="SELECT ID,SecDimPro_DimDr->Sec_Code,SecDimPro_DimDr->Sec_Name,SecDimPro_ExcCode FROM DHCWL_MKPI.DHCWLSectionProperty "
		s jsonPro="ID,SecCode,SecName,ExcuteCode"
		//if $g(secProCode)'="" {
			 s sql=sql_"WHERE SecDimPro_Code='"_secProCode_"'" 	
		//}
		s start=1
		s end=10
		s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro,"")

		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
		Q
	}elseif "AddSecPros"=action {
		s secProCode=$g(%request.Data("secProCode",1))
		s name=$g(%request.Data("Name",1))
		s desc=$g(%request.Data("Desc",1))
		s defaultFlag=$g(%request.Data("DefaultFlag",1))
		
		s exeRes=0
		s secID=""
		f {
			s secID=$o(^DHCWL.MKPI.SectionD(secID))
			q:secID=""
			s alphCode=$SYSTEM.SQL.ALPHAUP(secProCode) 
			continue:$d(^DHCWL.MKPI.SectionPropertyI("SecDimCodeI",secID,alphCode))
			
		
			&sql(INSERT INTO DHCWL_MKPI.DHCWLSectionProperty (SecDimPro_Code, SecDimPro_Name, SecDimPro_Desc, SecDimPro_ExcCode, SecDimPro_DimDr, SecDimPro_DefaultFlag)
				VALUES (:secProCode, :name, :desc, '', :secID, 'N'))
				
			i +$g(SQLCODE)'=0 {
				q
			}
		}
		
		i +$g(SQLCODE)'=0 {
			w "{success:true,tip:'添加失败！',SQLCODE:"_SQLCODE_"}"	
		}else{
			w "{success:true,tip:'ok'}"	
		}

		Q
	}elseif "DeleteSecDimProByCode"=action {
		b
		s secDimCode=$g(%request.Data("secDimCode",1))
		&sql(DELETE FROM DHCWL_MKPI.DHCWLSectionProperty WHERE SecDimPro_Code =:secDimCode) 
		i +$g(SQLCODE)'=0 {
			w "{success:true,tip:'操作失败！',SQLCODE:"_SQLCODE_"}"	
		}else{
			w "{success:true,tip:'ok'}"	
		}

		q
	
	}elseif "updateSecDimProExCode"=action {
		s ID=$g(%request.Data("ID",1))
		s excuteCode=$g(%request.Data("ExcuteCode",1))
		&sql(UPDATE DHCWL_MKPI.DHCWLSectionProperty SET SecDimPro_ExcCode = :excuteCode	WHERE ID = :ID)
		i +$g(SQLCODE)'=0 {
			w "{success:true,tip:'操作失败！',SQLCODE:"_SQLCODE_"}"	
		}else{
			w "{success:true,tip:'ok'}"	
		}

		q
	
	}elseif "dimView"=action{
		s dimId=$g(%request.Data("dimId",1))
		s filterRule=$g(%request.Data("filterRule",1))
		s start=$g(%request.Data("start",1))
		set pageSize = $g(%request.Data("limit",1))
		s end=start+pageSize
		s:start>1 start=start+1
		s queryJsonPros="{start:"_start_",end:"_end_",jsonProDeli:&}"
		s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.Interface.MkpiData:QryDimValues",queryJsonPros,dimId,filterRule)
		if ($o(^||TEMPDHCWL("exeCodeError",$J,"saveExCode",""))'=""){
			s exeCode=$o(^||TEMPDHCWL("exeCodeError",$J,"saveExCode",""))
			w "执行代码 "_exeCode_"不存在,请维护后再进行操作"
			q 
		}
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
		q
	}


</script>