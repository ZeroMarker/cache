<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s action=$g(%request.Data("action",1))
	if "addMeasure"=action {
		s meaCodes=$g(%request.Data("meaCode",1))
		s kpiId=$g(%request.Data("kpiId",1))
		s kpiId=##class(DHCWL.MKPIIO.XMLIOConfige).GetIdByCode(kpiId,"DHCWL.MKPI.MKPI")
		i +kpiId=0 {
			w "{success:false,info:'不存在该指标'}"
			q
		}
		s flag=0
		s nowDate=$p($h,",",1)
		s len=$l(meaCodes,",")
		for i=1:1:len {
			s meaCode=$p(meaCodes,",",i)
			continue:meaCode=""
			s meaID="",finalMeaID=""
			for {  //**---排除被作废的度量
				s meaID=$o(^DHCWL.MeasureDimrole.MeasureI("Code"," "_$zcvt(meaCode,"U"),meaID))
				q:meaID=""
				s voidFlag=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),9)
				if (voidFlag=""){
					s finalMeaID=meaID
					q
				}
			}
			continue:finalMeaID=""
			s meaID=finalMeaID
			if ('$d(^DHCWL.MKPI.MKPIMeasureI("MKPIMeaI",kpiId,meaID))){
				&sql(INSERT INTO DHCWL_MKPI.DHCWLMKPIMeasure (MKPI_MeaDr,MKPI_KpiDr,Mea_CreateDate) VALUES(:meaID,:kpiId,:nowDate))
				if SQLCODE'=0 {
					s flag="保存失败"
					q
				}
			}
		}
		if (flag=1){
			w "{success:true,tip:'fail',info:'保存出错啦'}"
		}else{
			w "{success:true,tip:'ok'}"
		}
	}elseif "getKpiMeasure"=action{
		s kpiId=$g(%request.Data("kpiId",1))
		s sql="select b.ID,a.Mea_Code,a.Mea_Desc,a.Mea_DataSource,a.Mea_DsDesc,a.Measure_CalItem,a.Mea_CalDesc,a.Mea_StaCal,a.Mea_StaDesc from DHCWL_MKPI.DHCWLMKPIMeasure b,DHCWL_MeasureDimrole.DHCWLMeasure a where b.MKPI_MeaDr=a.ID and a.Mea_VoidFlag is null and b.MKPI_KpiDr="_kpiId
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s deli="&"
		s json=##class(DHCWL.util.Json).Json("ID"_deli_"MKPIMeasureCode"_deli_"MKPIMeasureDes"_deli_"MKPIDataSource"_deli_"MKPIstaCal"_deli_"MKPICalItem","result","root",deli)
		While(rs.Next()){
			s dsource=rs.Data("Mea_DataSource")_":"_rs.Data("Mea_DsDesc")
			s calItem=rs.Data("Measure_CalItem")_":"_rs.Data("Mea_CalDesc")
			s staCal=rs.Data("Mea_StaCal")_":"_rs.Data("Mea_StaDesc")
			d json.Insert("'"_rs.Data("ID")_"'"_deli_"'"_rs.Data("Mea_Code")_"'"_deli_"'"_rs.Data("Mea_Desc")_"'"_deli_"'"_dsource_"'"_deli_"'"_staCal_"'"_deli_"'"_calItem_"'")
		}
		d rs.Close()
		w json.GetHead()
		;有一些代替此方法（因为数据量大时string会溢出）
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif "deleteKpiMea"=action{
		s meaID=$g(%request.Data("meaID",1))
		i +meaID=0 {
			w "{success:false,info:'不存在该度量'}"
			q
		}
		&sql(delete from DHCWL_MKPI.DHCWLMKPIMeasure where ID=:meaID)
		if SQLCODE'=0 {
			w "{success:false,info:'删除失败'}"
			q
		}else{
			w "{success:true,tip:'ok'}"
			q
		}
	}
</script>