<csp:content charset="gb2312">
<csp:content charset="UTF-8">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s action=$g(%request.Data("action",1))
	set start = $g(%request.Data("start",1))
	set pageSize = $g(%request.Data("limit",1))
	set action=$g(%request.Data("action",1))
	set isArrayType=$g(%request.Data("isArrayType",1))
	set className=$g(%request.Data("className",1))
	s onePage=$g(%request.Data("onePage",1))
	set condSql=""
	;s start=1,pageSize=9999999
	s:start>1 start=start+1
	s end=start+pageSize
	s deli="&"
	if "getDataSource"=action {
		d ##class(DHCWL.MeasureDimroleData.FunctionModule).GetDataSource(.dataSourceList)
		s ID=""
		s deli=",",str="['',''],"
		for{
			s ID=$o(dataSourceList(ID))
			q:ID=""
			s dataSource=dataSourceList(ID)
			s str=str_"['"_ID_"'"_deli_"'"_dataSource_"'],"
		}
		w "["_$e(str,1,$l(str)-1)_"]"
		
	}elseif "getCalItem"=action {
		s dataSourceID=$g(%request.Data("ID",1))
		d ##class(DHCWL.MeasureDimroleData.FunctionModule).GetCalItem(dataSourceID,.dataSourceList)
		s ID=""
		s deli=",",str="['',''],"
		for{
			s ID=$o(dataSourceList(ID))
			q:ID=""
			s dataSource=dataSourceList(ID)
			s str=str_"['"_ID_"'"_deli_"'"_dataSource_"'],"
		}
		w "["_$e(str,1,$l(str)-1)_"]"
		
	}elseif "getMeastaCal"=action {
		s dataSourceID=$g(%request.Data("ID",1))
		d ##class(DHCWL.MeasureDimroleData.FunctionModule).GetMeastaCal(dataSourceID,.dataSourceList)
		s ID=""
		s deli=",",str="['',''],"
		for{
			s ID=$o(dataSourceList(ID))
			q:ID=""
			s dataSource=dataSourceList(ID)
			s str=str_"['"_ID_"'"_deli_"'"_dataSource_"'],"
		}
		w "["_$e(str,1,$l(str)-1)_"]"
		
	}elseif "addMeasure"=action {
		s code=$g(%request.Data("code",1))
		s dataSource=$g(%request.Data("dataSource",1))
		//s dataSource=$p(dataSource,":",1)
		s calItem=$g(%request.Data("calItem",1))
		//s calItem=$p(calItem,":",1)
		s meastaCal=$g(%request.Data("meastaCal",1))
		//s meastaCal=$p(meastaCal,":",1)
		s desc=$g(%request.Data("desc",1))
		s creator=$g(%request.Data("creator",1))
		s result=##class(DHCWL.MeasureDimroleData.FunctionModule).AddMeasure(code,dataSource,calItem,meastaCal,desc,creator)
		w "{success:true,tip:'"_result_"'}"
	}elseif "getMeasureInforold"=action{
		i $g(onePage)=1 {
			s code=$g(%request.Data("code",1))
			s dataSource=$g(%request.Data("dataSource",1))
			s calItem=$g(%request.Data("calItem",1))
			s meastaCal=$g(%request.Data("meastaCal",1))
			s desc=$g(%request.Data("desc",1))
			s creator=$g(%request.Data("creator",1))
			s %session.Data("code")=code
			s %session.Data("dataSource")=dataSource
			s %session.Data("calItem")=calItem
			s %session.Data("meastaCal")=meastaCal
			s %session.Data("desc")=desc
			s %session.Data("creator")=creator
		}else{
			s code=$g(%session.Data("code"))
			s dataSource=$g(%session.Data("dataSource"))
			s calItem=$g(%session.Data("calItem"))
			s meastaCal=$g(%session.Data("meastaCal"))
			s desc=$g(%session.Data("desc"))
			s creator=$g(%session.Data("creator"))
		}
		s queryJsonPros="{start:"_start_",end:"_end_",jsonProDeli:&}"
		s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.MeasureDimroleData.FunctionModule:getMeasureInforQuery",queryJsonPros,measureSearch)
		i json="" {
			w "{result:0,totalNum:0,root:[]}"
			q
		}
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif "getMeasureInfor"=action{
		i $g(onePage)=1 {
			s nodeID=$g(%request.Data("nodeID",1))
			s measureSearch=$g(%request.Data("measureSearch",1))
			s ds=$p(nodeID,".",2)
			s cal=""
			s sta=""
			s %session.Data("ds")=$p(nodeID,".",2)
			s %session.Data("measureSearch")=measureSearch
			s code=$p(nodeID,".",3)
			if (code=""){
				s %session.Data("cal")=""
				s %session.Data("sta")=""
			}else{
				s infor=$p(code,"-",1)
				if (infor="cal"){
					s cal=$p(code,"-",2)
					s %session.Data("cal")=$p(code,"-",2)
				}elseif(infor="sta"){
					s sta=$p(code,"-",2)
					s %session.Data("cal")=$p(code,"-",2)
				}
			}
		}else{
			s measureSearch=$g(%session.Data("measureSearch"))
			s ds=$g(%session.Data("ds"))
			s cal=$g(%session.Data("cal"))
			s sta=$g(%session.Data("sta"))
		}
		s queryJsonPros="{start:"_start_",end:"_end_",jsonProDeli:&}"
		s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.MeasureDimroleData.FunctionModule:getMeasureInforQuery",queryJsonPros,measureSearch,ds,cal,sta)
		i json="" {
			w "{result:0,totalNum:0,root:[]}"
			q
		}
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif "modifyMeasure"=action{
		s desc=$g(%request.Data("meaMoifyDesc",1))
		s ID=$g(%request.Data("ID",1))
		s result=##class(DHCWL.MeasureDimroleData.FunctionModule).ModifyMeasure(ID,desc)
		w "{success:true,tip:'"_result_"'}"
	}elseif "deleteMeasure"=action{
		s ID=$g(%request.Data("ID",1))
		s result=##class(DHCWL.MeasureDimroleData.FunctionModule).DeleteMeasure(ID)
		w "{success:true,tip:'"_result_"'}"
	}elseif "getMeasureTree"=action{
		s node=$g(%request.Data("node",1))
		s id=$g(%request.Data("id",1))
		s:node="" node=id
		s len=$l(node,".")
		if (len=1){
			k dsList
			s flag=0
			w "["
			s dataSource=""
			for{
				s dataSource=$o(^DHCWL.MeasureDimrole.MeasureI("DataSource",dataSource))
				q:dataSource=""
				s meaID=""
				for{
					s meaID=$o(^DHCWL.MeasureDimrole.MeasureI("DataSource",dataSource,meaID))
					q:meaID=""
					s dsCode=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),4)
					s dsDesc=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),11)
					s voidFlag=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),9)
					continue:(voidFlag=1)
					continue:$d(dsList(dsCode))
					s dsList(dsCode)=""
					if (flag>0){
						w ","
					}
					s allDsCode=dsCode_":"_dsDesc
					s treecode="root"_"."_dsCode
					w "{""text"":"""_allDsCode_""",""id"":"""_treecode_""",""code"":"""_dsCode_""",""cls"":""folder"",leaf: false}"
					s flag=flag+1
				}
			}
			w "]"
		}elseif(len=2){
			k meaSureList
			s flag=""
			s dsCode=$p(node,".",2)
			s meaID=""
			for{
				s meaID=$o(^DHCWL.MeasureDimrole.MeasureI("DataSource"," "_$zcvt(dsCode,"U"),meaID))
				q:meaID=""
				s calItem=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),5)
				s stacal=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),6)
				s voidFlag=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),9)
				s staDesc=$lg(^DHCWL.MeasureDimrole.MeasureD(meaID),12)
				continue:voidFlag=1
				s:calItem'="" meaSureList("calItem",calItem)=""
				s meaSureList("stacal",stacal)=staDesc
			}
			s infor="",flag=0
			w "["
			s infor=""
			for{
				s infor=$o(meaSureList("stacal",infor))
				q:infor=""
				if (flag>0){
					w ","
				}
				s allInfor=infor_":"_meaSureList("stacal",infor)
				s treecode=node_"."_"sta-"_infor
				w "{""text"":"""_allInfor_""",""id"":"""_treecode_""",""code"":"""_infor_""",""iconCls"":""staDir"",""cls"":""folder"",leaf: true}"
				s flag=flag+1
			}
			w "]"
		}
	}elseif "getConfCal"=action{
		s sql="select ID,DsItem_Name,DsItem_Desc,DsItem_ItemDataType from DHCWL_MeasureDimrole.DSItem where DsItem_ItemType='度量'"
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s deli="&"
		s json=##class(DHCWL.util.Json).Json("ID"_deli_"name"_deli_"description"_deli_"type","result","root",deli)
		//d json.Insert("''"_deli_"''"_deli_"''"_deli_"''")
		While(rs.Next()){
			d json.Insert("'"_rs.Data("ID")_"'"_deli_"'"_rs.Data("DsItem_Name")_"'"_deli_"'"_rs.Data("DsItem_Desc")_"'"_deli_"'"_rs.Data("DsItem_ItemDataType")_"'")
		}
		d rs.Close()
		w json.GetHead()
		;有一些代替此方法（因为数据量大时string会溢出）
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
	}
</script>