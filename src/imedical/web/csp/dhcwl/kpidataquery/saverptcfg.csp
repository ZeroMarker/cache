<csp:content charset="gb2312">
<csp:content charset="UTF-8">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s action=$g(%request.Data("action",1))

	if "isRptExist"=action {
	 	s rptCode=$g(%request.Data("rptCode",1))
	 	s exist=0
	 	s isRptUser=0
		if $d(^DHCWL.DataQuery.ReportCfgI("InxCode",rptCode)) {
			s rptID=$o(^DHCWL.DataQuery.ReportCfgI("InxCode",rptCode,""))
			s rptUser=$lg(^DHCWL.DataQuery.ReportCfgD(rptID),7)
			
			s exist=1
			s isRptUser=(%session.Get("LOGON.USERID")=rptUser)
			
		}
		w "{success:true,tip:'ok',exist:"_exist_",isRptUser:"_isRptUser_"}"
	}elseif "saveRpt"=action {

		b
		s recCnt=0
		f {
			s recCnt=$o(%request.Data("recs",recCnt))
			q:$g(recCnt)=""
			s recs=$g(%request.Data("recs",recCnt))
			s fieldLen=$l(recs,",")
			f i=1:1:fieldLen {
				s field=$p(recs,",",i)
				//inParam("items",记录序号,字段名)=字段值
				s inParam("items",recCnt,$p(field,$c(2),1))=$p(field,$c(2),2)
			}
		}
		
		s recCnt=0
		f {
			s recCnt=$o(%request.Data("searchItem",recCnt))
			q:$g(recCnt)=""
			s searchItem=$g(%request.Data("searchItem",recCnt))
			s fieldLen=$l(searchItem,$c(3))
			f i=1:1:fieldLen {
				s field=$p(searchItem,$c(3),i)
				continue:$g(field)=""
				//inParam("items",记录序号,字段名)=字段值
				s inParam("searchItem",recCnt,$p(field,$c(2),1))=$p(field,$c(2),2)
			}
		}		
		//zw inParam("searchItem")
		
		s inParam("RptCode")=$g(%request.Data("rptCode",1))
		s inParam("Descript")=$g(%request.Data("descript",1))
		s inParam("DataSrcType")=$g(%request.Data("dataSrcType",1))
		s inParam("RptType")=$g(%request.Data("rptType",1))
		s inParam("filterText")=$g(%request.Data("filterText",1))
		s inParam("BusinessType")=$g(%request.Data("businessType",1))
		s inParam("UserID")=%session.Get("LOGON.USERID")
		//如果是tempSysRpt报表，需要使用指定的USERID。目的是为了避免该报表
		//被查询到
		if (inParam("RptCode")="tempSysRpt") s inParam("UserID")="tempSysViewUser"
		
		
		//w !,"UserID:"_inParam("UserID")
		//s inParam("remarks")=$g(%request.Data("remarks",1))

		s recAct=""
		if $d(^DHCWL.DataQuery.ReportCfgI("InxCode",$g(%request.Data("rptCode",1)))) {
			s recAct="update"		//如果已经存在，就更新
		}else{
			s recAct="insert"		//如果不存在，就插入
		}
		
		
		
		TSTART
		//s ret=##class(DHCWL.DataQuery.Serv).saveRptCfg(.inParam,.outParam)
		s ret=""

		if recAct="insert" {
			//1、插入报表
			s ret=##class(DHCWL.DataQuery.ReportCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}
			//2、插入维度	
			s ret=##class(DHCWL.DataQuery.RptSubDimCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}			
			//3、插入度量
			s ret=##class(DHCWL.DataQuery.RptSubMeasureCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}
			//4、插入过滤
			s ret=##class(DHCWL.DataQuery.RptSubFilterCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}
			//5、插入查询项
			s ret=##class(DHCWL.DataQuery.RptSubSItemCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}			
		}else{
			//1、插入报表
			s ret=##class(DHCWL.DataQuery.ReportCfg).Update(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}			
			//2、插入维度	
			s ret=##class(DHCWL.DataQuery.ReportSubCfg).Delete(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}


			//2、插入维度	
			s ret=##class(DHCWL.DataQuery.RptSubDimCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}			
			//3、插入度量
			s ret=##class(DHCWL.DataQuery.RptSubMeasureCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}
			//4、插入过滤
			s ret=##class(DHCWL.DataQuery.RptSubFilterCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}
			//5、插入查询项
			s ret=##class(DHCWL.DataQuery.RptSubSItemCfg).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}			
		}

		TCOMMIT
		w "{success:true,tip:'ok',MSG:'操作成功!'}"
		q
	}elseif "getRtpCfg"=action {
		s usedFor=$g(%request.Data("usedFor",1))
		s rptType=$g(%request.Data("rptType",1))
		s sql=""
		s sql="SELECT t1.ID AS RptID, Code, Descript, RptType, BusinessType,t2.SSUSR_RowId || '-' || t2.SSUSR_Name AS UserName , CreatDate  FROM DHCWL_DataQuery.ReportCfg t1, SS_User t2 WHERE t1.userID=t2.SSUSR_RowId"

		if usedFor="exec" {//统计数据时，只加载当前用户被赋予过权限的报表
			s sql=sql_" AND t1.Code IN (SELECT rptCode FROM DHCWL_DataQuery.URMap WHERE userID="_%session.Get("LOGON.USERID")_")"

		}elseif usedFor="load" {	//编辑报表是时，只加载作者自己配置过的报表
			s sql=sql_" AND t1.userID='"_%session.Get("LOGON.USERID")_"'"
			if rptType'="" {
				s sql=sql_" AND t1.rptType='"_rptType_"'"
			}
		}elseif usedFor="save" {	//保存配置时，显示所有报表，以免重名
		}
		//w !,sql		
		s start=0,end=0
		
	
		s jsonPro="RptID,Code,Descript,RtpType,BusinessType,UserName,CreatDate"
		//s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro)
		s qryName="%DynamicQuery:SQL"  //固定写法
		s json=##class(DHCWL.CommonUtil.JsonUtil).GetJsonByQry(qryName,"",sql,start,end,jsonPro)
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"			
		
	}elseif "getRptDetailCfgData"=action {
		s rptCode=$g(%request.Data("rptCode",1))
		s inParam("rptCode")=rptCode

		s ret=##class(DHCWL.DataQuery.ServOfCSP).GetJsonOfRptDetailData(.inParam,.outParam)
		if ret'="" {
			w "{success:true,tip:'fail',MSG:'"_ret_"'}"
			
		}
		if $d(outParam("jsonStr")) {
			w outParam("jsonStr")
		}
		q		
		
	} 
	
</script>
