<csp:content charset="gb2312">
<csp:content charset="UTF-8">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s action=$g(%request.Data("action",1))

	if "getItemNode"=action {

		set currentNode = $g(%request.Data("node",1))	
		s qryObjName=$g(%request.Data("QryObjName",1))
		s inParam("qryObjName")=qryObjName
		s ret=##CLASS(DHCWL.BaseDataQuery.Util).getItemByQryName(.inParam,.outParam)
		if ret'="" {
			w "{success:true,tip:'false',MSG:'"_ret_"'}"	
			q
		}

		s ID=""
		w "["
		f {
			s ID=$o(outParam(ID))
			q:ID=""
			s objInfo=outParam(ID)
			s name=$p(objInfo,"^",1)
			s descript=$p(objInfo,"^",2)
			s dimCode=$p(objInfo,"^",3)
			if dimCode'="" {
				s leaf="false"
				s cls="folder"
			}else{
				s leaf="true"
				s cls="file"
			}
			s checked="false"
			s temp="{""text"":"""_descript_""",""id"":"""_name_""",""leaf"":"_leaf_",""itemName"":"""_name_"""}"
			w temp_","
		}
		w "]"
		
		q			
	}elseif "getPropertyNode"=action {
		s itemName=$g(%request.Data("ItemID",1))
		s ret=##CLASS(DHCWL.BaseDataQuery.Util).getPropertyByItemID(.itemName,.outParam)
		if ret'="" {
			w "{success:true,tip:'false',MSG:'"_ret_"'}"	
			q
		}


		s ID=""
		w "["
		s checked="false"
		s leaf="true"
		f {
			s ID=$o(outParam(ID))
			q:ID=""
			s objInfo=outParam(ID)
			
			s itemName=$p(objInfo,"^",1)
			s DimProCode=$p(objInfo,"^",2)
			s DimProName=$p(objInfo,"^",3)
			s nodeID=itemName_"->"_DimProCode
			s temp="{""text"":"""_DimProName_""",""id"":"""_nodeID_""",""leaf"":"_leaf_",""DimProCode"":"""_DimProCode_"""}"
			w temp_","
		}
		w "]"
		
		q				
	}elseif "previewDetailData"=action {
				
		s inParam("qryType")=$g(%request.Data("qryType",1))
		s inParam("paramCols")=$g(%request.Data("paramCols",1))
		s inParam("qryObjName")=$g(%request.Data("qryObjName",1))
		
		s inParam("inPamCols")=$g(%request.Data("inPamCols",1))
		s inParam("inPamfilter")=$g(%request.Data("inPamfilter",1))
		
		
		s inParam("daterangeItem")=$g(%request.Data("daterangeItem",1))
		s inParam("daterangeStart")=$g(%request.Data("daterangeStart",1))
		s inParam("daterangeEnd")=$g(%request.Data("daterangeEnd",1))
		
		/*
		s startDate=##class(DHCWL.CommonUtil.DateUtil).DateHtmlToLogical($g(%request.Data("daterangeStart",1)))
		s inParam("daterangeStart")=$zd(startDate,3)
		s endDate=##class(DHCWL.CommonUtil.DateUtil).DateHtmlToLogical($g(%request.Data("daterangeEnd",1)))
		s inParam("daterangeEnd")=$zd(endDate,3)	
		*/
	
	
		s inParam("filterIDs")=$g(%request.Data("filterIDs",1))
		s inParam("filterOperas")=$g(%request.Data("filterOperas",1))
		s inParam("filterValues")=$g(%request.Data("filterValues",1))

		
		s start=$g(%request.Data("start",1))
		s inParam("limit")=$g(%request.Data("limit",1))
		s inParam("end")=start+inParam("limit")
		s inParam("start")=start+1	
		
		s ret=""
		
		if $g(inParam("qryType"))="aggregat" {
			//inParam("paramMeasure")
			d ##CLASS(DHCWL.BaseDataQuery.Util).GetQryDetailMeasureParam(.inParam)
			s inParam("actFrom")="http"
			s ret=##CLASS(DHCWL.BaseDataQuery.Interface).GetQrySummaryItemJson(.inParam,.json)
		}
		if $g(inParam("qryType"))="detail" {
			//s ret=##CLASS(DHCWL.BaseDataQuery.Interface).GetQryDetailItem(.inParam,.json)
			s inParam("actFrom")="http"
			s ret=##CLASS(DHCWL.BaseDataQuery.Interface).GetQryDetailItemJson(.inParam,.json)
		}
		//s ret=##CLASS(DHCWL.BaseDataQuery.Util).GetQryDetailItem(.inParam,.json)
		if ret'="" {
			w "{success:true,tip:'false',MSG:"""_ret_"""}"	
			q
		}
		
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"	
		
		q		
	}elseif "getDateItem"=action {
		b
		s qryObjNam=$g(%request.Data("qryObjName",1))
		
		s sql="SELECT ifnull(Descript,Name,Descript) || '[' || Name || ']' As description, Name As value FROM DHCWL_BaseDataQuery.Item WHERE ColType= 2 and QueryObjName='"_qryObjNam_"'"
		//w !,sql
		s start=0,end=0
		s jsonPro="description,value"
		//s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro)
		s qryName="%DynamicQuery:SQL"  //固定写法
		s json=##class(DHCWL.CommonUtil.JsonUtil).GetJsonByQry(qryName,"",sql,start,end,jsonPro)		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		

		q	
	}elseif "getSumItemNode"=action {

		set currentNode = $g(%request.Data("node",1))	
		s qryObjName=$g(%request.Data("QryObjName",1))
		if currentNode="root" {
			
			w "["
			w "{""text"":""维度"",""id"":""dimChild"",""leaf"":false,""draggable"":false},"
			w "{""text"":""度量"",""id"":""measureChild"",""leaf"":false,""draggable"":false}"
			w "]"
			q	
		}else{
			s itemType= $g(%request.Data("itemType",1))	
			s qryObjName=$g(%request.Data("QryObjName",1))
			s inParam("qryObjName")=qryObjName
			s inParam("itemType")=itemType
			s ret=##CLASS(DHCWL.BaseDataQuery.Util).getItemByQryName(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				q
			}


			s ID=""
			w "["
			f {
				s ID=$o(outParam(ID))
				q:ID=""
				s objInfo=outParam(ID)
				s name=$p(objInfo,"^",1)
				s descript=$p(objInfo,"^",2)
				s dimCode=$p(objInfo,"^",3)
				if dimCode'="" {
					s leaf="false"
					s cls="folder"
				}else{
					s leaf="true"
					s cls="file"
				}
				s checked="false"
				//s temp="{""text"":"""_descript_""",""id"":"""_name_""",""leaf"":"_leaf_",""itemName"":"""_name_""",""checked"":"_checked_"}"
				s temp="{""text"":"""_descript_""",""id"":"""_name_""",""leaf"":"_leaf_",""itemName"":"""_name_"""}"
				
				w temp_","
			}
			w "]"
		
			q	
		}		
	/*}elseif "previewSummaryData"=action {
		
		s inParam("paramRows")=$g(%request.Data("paramRows",1))
		s inParam("paramCols")=$g(%request.Data("paramCols",1))
		s inParam("paramMeasure")=$g(%request.Data("paramMeasure",1))
		s inParam("qryObjName")=$g(%request.Data("qryObjName",1))
		
		s inParam("inPamRows")=$g(%request.Data("inPamRows",1))
		s inParam("inPamCols")=$g(%request.Data("inPamCols",1))
		s inParam("inPamfilter")=$g(%request.Data("inPamfilter",1))
		
		s inParam("daterangeItem")=$g(%request.Data("daterangeItem",1))
		s inParam("daterangeStart")=$g(%request.Data("daterangeStart",1))
		s inParam("daterangeEnd")=$g(%request.Data("daterangeEnd",1))
	
		s inParam("filterIDs")=$g(%request.Data("filterIDs",1))
		s inParam("filterOperas")=$g(%request.Data("filterOperas",1))
		s inParam("filterValues")=$g(%request.Data("filterValues",1))
		
		s start=$g(%request.Data("start",1))
		s inParam("limit")=$g(%request.Data("limit",1))
		s inParam("end")=start+inParam("limit")
		s inParam("start")=start+1	
		
		s ret=##CLASS(DHCWL.BaseDataQuery.Util).GetQrySummaryItem(.inParam,.json)
		if ret'="" {
			w "{success:true,tip:'false',MSG:'"_ret_"'}"	
			q
		}
		
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"	
		
		q
		*/
	}elseif "saveRptCfg"=action {
		s inParam("recAct")=$g(%request.Data("recAct",1))
		s inParam("rptName")=$g(%request.Data("rptName",1))
		s inParam("qryObjName")=$g(%request.Data("qryObjName",1))
		
		s inParam("paramRows")=$g(%request.Data("paramRows",1))
		s inParam("paramCols")=$g(%request.Data("paramCols",1))
		s inParam("paramMeasure")=$g(%request.Data("paramMeasure",1))
		s inParam("daterangeItem")=$g(%request.Data("daterangeItem",1))
		s inParam("filterIDs")=$g(%request.Data("filterIDs",1))
		s inParam("rptType")=$g(%request.Data("rptType",1))
		s inParam("IsAggregat")=+$g(%request.Data("IsAggregat",1))
		s inParam("userID")=%session.Get("LOGON.USERID")
		s inParam("Remarks")=$g(%request.Data("Remarks",1))
		if "saveTempSysRpt"=inParam("recAct") {
			if $d(^DHCWL.BaseDataQuery.ReportCfgI("InxName",inParam("rptName"))) s inParam("recAct")="update"
			else  s inParam("recAct")="insert"
		}
		
		TSTART
		if inParam("recAct")="insert" {
			s ret=##class(DHCWL.BaseDataQuery.ReportCfg).Insert(.inParam,.outParam)

			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}
			
			s ret=##class(DHCWL.BaseDataQuery.ReportCfgSub).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}
			
			s ret=##class(DHCWL.BaseDataQuery.URMap).Insert(.inParam,.outParam)
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"	
				Trollback
				q		
			}			
			
			TCOMMIT
			
			w "{success:true,tip:'ok',MSG:'操作成功',RptID:'"_inParam("RptID")_"'}"
		}
		
		if inParam("recAct")="update" {
			s userID = %session.Get("LOGON.USERID")
		 	s rptName=$g(%request.Data("rptName",1))
			s rptType=$g(%request.Data("rptType",1))
			//s rptID=$o(^DHCWL.BaseDataQuery.ReportCfgI("InxName",rptName,userID,rptType,""))
			s rptID=$o(^DHCWL.BaseDataQuery.ReportCfgI("InxName",rptName,""))
			s inParam("RptID")=rptID	
			
			s ret=##class(DHCWL.BaseDataQuery.ReportCfg).Update(.inParam,.outParam)	
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"
				Trollback	
				q		
			}
			
			s ret=##class(DHCWL.BaseDataQuery.ReportCfgSub).Update(.inParam,.outParam)	
			if ret'="" {
				w "{success:true,tip:'false',MSG:'"_ret_"'}"
				Trollback	
				q		
			}else{
				TCOMMIT
				w "{success:true,tip:'ok',MSG:'操作成功',RptID:'"_inParam("RptID")_"'}"
			}
		}
		q
		
	}elseif "getRtpCfg"=action {
		s rptType=$g(%request.Data("rptType",1))
		s usedFor=$g(%request.Data("usedFor",1))
		//s sql="SELECT Name, FROM DHCWL_BaseDataQuery.ReportCfg WHERE Type='"_rptType_"'"
		
		s sql="SELECT t1.ID AS rptID,t1.Name AS Name,t2.SSUSR_Name AS userName,t1.CreatDate,t1.Remarks, "
		
		s sql=sql_" CASE Type WHEN 'grpRpt' THEN '网格/分组' WHEN 'corssRpt' THEN '交叉' END AS Type, "
		s sql=sql_" CASE IsAggregat WHEN '1' THEN '是' WHEN '0' THEN '否' END AS IsAggregat,BaseObjName,DateItemName "
		
		//s sql=sql_"FROM DHCWL_BaseDataQuery.ReportCfg t1, SS_User t2, DHCWL_BaseDataQuery.URMap t3 WHERE t1.userID=t2.SSUSR_RowId"

		if usedFor="load" {
			s sql=sql_"FROM DHCWL_BaseDataQuery.ReportCfg t1, SS_User t2 WHERE t1.userID=t2.SSUSR_RowId"

			s sql=sql_" AND t1.userID='"_%session.Get("LOGON.USERID")_"'"
			if rptType'="" {
				s sql=sql_" AND t1.Type='"_rptType_"'"
			}
		}elseif usedFor="exec" {
			//数据展示页面使用
			s sql=sql_"FROM DHCWL_BaseDataQuery.ReportCfg t1, SS_User t2, DHCWL_BaseDataQuery.URMap t3 WHERE t1.userID=t2.SSUSR_RowId"

			s rptName=$g(%request.Data("rptName",1))
			s BaseObjName=$g(%request.Data("BaseObjName",1))
			s userID = %session.Get("LOGON.USERID")
			s sql=sql_" AND t3.userID = "_userID_" and t1.Name=t3.rptName"
			if rptName'="" s sql=sql_" AND t1.Name like '%"_rptName_"%'"
			if BaseObjName'="" s sql=sql_" AND t1.BaseObjName like '%"_BaseObjName_"%'"
			
		}elseif usedFor="save" {
			s sql=sql_"FROM DHCWL_BaseDataQuery.ReportCfg t1, SS_User t2 WHERE t1.userID=t2.SSUSR_RowId"
		}
		
		//w !,sql
		s start=0,end=0
		s jsonPro="rptID,Name,userName,CreatDate,Remarks,Type,IsAggregat,BaseObjName,DateItemName"
		//s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro)
		s qryName="%DynamicQuery:SQL"  //固定写法
		s json=##class(DHCWL.CommonUtil.JsonUtil).GetJsonByQry(qryName,"",sql,start,end,jsonPro)		
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		
		
	}elseif "getLoadRptCfgData"=action {
		
		s rptID=$g(%request.Data("rptID",1))
		s baseObjName=""
		s dateItemName=""
		s Name=""
		s IsAggregat=""
		s rptType=""
		s item=""
		s type=""
		s itemID=""
		s baseObjNameDesc=""
		s dateItemNameDesc=""
		//&sql(SELECT BaseObjName, DateItemName, IsAggregat ,Type into :baseObjName,:dateItemName,:IsAggregat,:rptType FROM DHCWL_BaseDataQuery.ReportCfg WHERE ID = :rptID)
		&sql(SELECT t1.BaseObjName, t1.DateItemName, t1.IsAggregat ,t1.Type , t2.BaseObjDesc,t3.Descript into :baseObjName,:dateItemName,:IsAggregat,:rptType,:baseObjNameDesc,:dateItemNameDesc  FROM DHCWL_BaseDataQuery.ReportCfg t1,DHCWL_BaseDataQuery.QueryObj t2,DHCWL_BaseDataQuery.Item t3 WHERE  t1.BaseObjName=t2.BaseObjName AND t3.QueryObjName=t1.BaseObjName AND t3.Name=t1.DateItemName AND t1.ID= :rptID)
		if SQLCODE'=0 {
			w "{success:true,tip:'ok',MSG:'FAIL'}"
			q
		}
		
		&sql(
			DECLARE C1 CURSOR FOR
			SELECT %ID,Item, Type 
			into :rptID,:item,:type 
			FROM DHCWL_BaseDataQuery.ReportCfgSub
			WHERE RptID = :rptID
		)
	
	
		&sql(OPEN C1)
		&sql(FETCH C1)
		s rptsub=""
		While (SQLCODE = 0) {
			i rptsub'="" s rptsub=rptsub_","
			
			s descript=##CLASS(DHCWL.BaseDataQuery.Util).GetBDQRptItemDesc(baseObjName,item)
			s rptsub=rptsub_"{item:'"_item_"',type:'"_type_"',descript:'"_descript_"'}"		 
			&sql(FETCH C1)
		}
    
		&sql(CLOSE C1)
		w "{success:true,tip:'ok',MSG:'SUCESS',cfgData:{baseObjName:'"_baseObjName_"',DateItemName:'"_dateItemName_"',IsAggregat:'"_IsAggregat_"',rptType:'"_rptType_"',baseObjNameDesc:'"_baseObjNameDesc_"',dateItemNameDesc:'"_dateItemNameDesc_"',rptsub:["_rptsub_"]}}"

		q
	
	}elseif "getCurUser"=action {
		s userID = %session.Get("LOGON.USERID")
	 	s userName 	= %session.Get("LOGON.USERNAME")
	 	s grpID=%session.Get("LOGON.GROUPID")
	 	s statGrp=##class(DHCWL.BaseDataQuery.Interface).BelongToStatGrp(userID)
	 	//s $p(^SSU("SSGRP",grpID),"^",
		//s ctLocID 	= %session.Get("LOGON.CTLOCID")
		//s ssGroupID	= %session.Get("LOGON.GROUPID")
		w "{success:true,tip:'ok',userID:'"_userID_"',userName:'"_userName_"',grpID:'"_grpID_"',statGrp:'"_statGrp_"'}"
	}elseif "isRptExist"=action {
		//s userID = %session.Get("LOGON.USERID")
	 	s rptName=$g(%request.Data("rptName",1))
	 	//s rptType=$g(%request.Data("rptType",1))
	 	s exist=0
	 	s isRptUser=0
		if $d(^DHCWL.BaseDataQuery.ReportCfgI("InxName",rptName)) {
			s rptID=$o(^DHCWL.BaseDataQuery.ReportCfgI("InxName",rptName,""))
			s rptUser=$lg(^DHCWL.BaseDataQuery.ReportCfgD(rptID),7)
			
			s exist=1
			s isRptUser=(%session.Get("LOGON.USERID")=rptUser)
			
		}
		w "{success:true,tip:'ok',exist:"_exist_",isRptUser:"_isRptUser_"}"
	}elseif "getURMap"=action {
	 	s searchObj=$g(%request.Data("searchObj",1))
	 	s sql=""
		if searchObj="user" {
			s userID=$g(%request.Data("userID",1))
			s sql="SELECT t1.ID,t2.SSUSR_Name As name,t2.SSUSR_Group->SSGRP_Desc As ssGrp FROM DHCWL_BaseDataQuery.URMap t1, SS_User t2 WHERE t1.userID=t2.SSUSR_RowId"
			if userID'="all" {
				s sql=sql_" and userID="_userID
			}
			s sql=sql_"  ORDER BY ID"
			s start=0,end=0
			s jsonPro="ID,name,ssGrp"
		}elseif searchObj="rpt" {
			s rptName=$g(%request.Data("rptName",1))
			s sql="SELECT ID ,Name AS rptName, BaseObjName, t2.SSUSR_Name AS userName  FROM DHCWL_BaseDataQuery.ReportCfg t1,SS_User t2 WHERE t1.userID=t2.SSUSR_RowId"
			if rptName'="all" {
				s sql=sql_" and Name='"_rptName_"'"
			}
			s sql=sql_"  ORDER BY ID"
			
			s start=0,end=0
			s jsonPro="ID,rptName,BaseObjName,userName"
		}
			//w !,sql

			//s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro)
			
			s qryName="%DynamicQuery:SQL"  //固定写法
			s json=##class(DHCWL.CommonUtil.JsonUtil).GetJsonByQry(qryName,"",sql,start,end,jsonPro)			
			w json.GetHead()
			d{
				s obj=json.Next()
				w obj
			}while(obj'="")
			i json.GetCount()=0 w "]}"	
	}
	
</script>
