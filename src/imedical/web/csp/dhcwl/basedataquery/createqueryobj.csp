<csp:content charset="gb2312">
<csp:content charset="UTF-8">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s action=$g(%request.Data("action",1))

	if "getBDQObjFields"=action {
		s QueryObjDr=$g(%request.Data("QueryObjDr",1))
		s sqlTableName=$g(%request.Data("className",1))
		//s className=$g(%request.Data("className",1))
		
		s jsonPro="ColType,Name,Descript,ItemType,DimType,DimCode"
		s json=##class(DHCWL.BaseDataQuery.Util).GetBDQObjFields(sqlTableName,jsonPro)
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		
		
		
		q			
	}elseif "searchdimcode"=action {
		s dimType=$g(%request.Data("dimType",1))
		i dimType="" {
			w "{result:0,totalNum:0,root:[{}]}"			
			q
		}
		s sql=""
		if dimType="标准维度" s sql="SELECT KDT_Code as value, KDT_Name||'-'||KDT_Code as description FROM DHCWL_MKPI.DHCWLMKPIDimType"
		i dimType="对象维度" s sql="SELECT '对象属性'  as value, '对象属性' as description "
		s start=0,end=0
		s jsonPro="value,description"
		//s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro)
		s qryName="%DynamicQuery:SQL"  //固定写法
		s json=##class(DHCWL.CommonUtil.JsonUtil).GetJsonByQry(qryName,"",sql,start,end,jsonPro)
		
		
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		
		
		q
	}elseif "createBDQObj"=action {
		s inParam("sqlTableName")=$g(%request.Data("sqlTableName",1))
		s inParam("ItemName")=$g(%request.Data("strItemName",1))
		s inParam("ItemDesc")=$g(%request.Data("strItemDesc",1))
		s inParam("ItemType")=$g(%request.Data("strItemType",1))
		s inParam("DimType")=$g(%request.Data("strDimType",1))
		s inParam("DimCode")=$g(%request.Data("strDimCode",1))
		s inParam("ColType")=$g(%request.Data("strColType",1))
		//w !,inParam("ColType")
		s inParam("sqlTableNameDesc")=$g(%request.Data("sqlTableNameDesc",1))
		TSTART
		s ret=##class(DHCWL.BaseDataQuery.QueryObj).Insert(.inParam,.outParam)
		if ret'="" {
			w "{success:true,tip:'false',MSG:'"_ret_"'}"	
			Trollback
			q		
		}
		s ret=##class(DHCWL.BaseDataQuery.Item).Insert(.inParam,.outParam)
		if ret'="" {
			w "{success:true,tip:'false',MSG:'"_ret_"'}"	
			Trollback
			q		
		}
		TCOMMIT
		w "{success:true,tip:'ok',MSG:'操作成功!'}"
	}elseif "getBDQObjItems"=action {
		s BaseObjName=$g(%request.Data("BaseObjName",1))
		s start=$g(%request.Data("start",1))
		s limit=$g(%request.Data("limit",1))
		s end=start+limit
		s start=start+1
		s sql="SELECT ID,Name,  Descript, Type as ItemType, LinkDimType as DimType, LinkDimCode as DimCode FROM DHCWL_BaseDataQuery.Item WHERE QueryObjName = '"_BaseObjName_"'"
		//w !,sql
		s jsonPro="ID,Name,Descript,ItemType,DimType,DimCode"

		//s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro)
		s qryName="%DynamicQuery:SQL"  //固定写法
		s json=##class(DHCWL.CommonUtil.JsonUtil).GetJsonByQry(qryName,"",sql,start,end,jsonPro)
				
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		
		
		
		q		
	}elseif "updateBDQItems"=action {
		s inParam("ItemID")=$g(%request.Data("strItemID",1))
		s inParam("ItemDesc")=$g(%request.Data("strItemDesc",1))
		s inParam("ItemType")=$g(%request.Data("strItemType",1))
		s inParam("DimType")=$g(%request.Data("strDimType",1))
		s inParam("DimCode")=$g(%request.Data("strDimCode",1))
		TSTART
		s ret=##class(DHCWL.BaseDataQuery.Item).update(.inParam,.outParam)
		if ret'="" {
			w "{success:true,tip:'false',MSG:'"_ret_"'}"	
			Trollback
			q		
		}
		TCOMMIT
		w "{success:true,tip:'ok',MSG:'操作成功!'}"      
		
	}elseif "searchbasetab"=action {
		s sql=""
		if dimType="标准维度" s sql="SELECT KDT_Code as value, KDT_Name||'-'||KDT_Code as description FROM DHCWL_MKPI.DHCWLMKPIDimType"
		i dimType="对象维度" s sql="SELECT '对象属性'  as value, '对象属性' as description "
		s start=0,end=0
		s jsonPro="value,description"
		//s json=##class(DHCWL.util.GetSetService).GetJsonBySQL(sql,start,end,jsonPro)
		
		s qryName="%DynamicQuery:SQL"  //固定写法
		s json=##class(DHCWL.CommonUtil.JsonUtil).GetJsonByQry(qryName,"",sql,start,end,jsonPro)		
		w json.GetHead()
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		
		
		q
	}
</script>
