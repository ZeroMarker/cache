<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	set start = $g(%request.Data("start",1))
	set pageSize = $g(%request.Data("limit",1))
	i start="" s start=0
	i pageSize="" s pageSize=20 ;$g(%request.Data("pageSize",1))
	s end=start+pageSize
	s:start>1 start=start+1
	set searcheCond = $g(%request.Data("searcheCond",1))
	set searcheValue = $g(%request.Data("searcheValue",1))
	set action=$g(%request.Data("action",1))
	s onePage=$g(%request.Data("onePage",1))
	s mark=$g(%request.Data("mark",1)),searcheDimFlag=0
	s isArrayType=$g(%request.Data("isArrayType",1))
	//w "searcheValue="_searcheValue,!,"searcheCond="_searcheCond,!,"action="_action
	//q

	;w "mark="_mark_"     ,searcheCond="_searcheCond,"    searcheValue="_searcheValue,!
	s deli="&"
	s sql="select ID,MKPI_Code,MKPI_Name,MKPI_Desc,MKPI_EXCode,MKPI_GlobalFlag,MKPI_User,MKPI_UpdateDate,MKPI_Remark,MKPI_TypeDr,MKPI_Cate,MKPI_SectionFlag,MKPI_DataNod from DHCWL_MKPI.DHCWLMKPI"
	s orderSql=" order by ID",condSql="",noCond=" "
	if (action="mulSearch"){
		i $g(onePage)=1 {
			s kpiId = $Get(%request.Data("kpiId",1))
			s kpiCode = $Get(%request.Data("kpiCode",1))
			s kpiName = $Get(%request.Data("kpiName",1))
			s kpiDesc = $Get(%request.Data("kpiDesc",1))
			s kpiExcode = $Get(%request.Data("kpiExcode",1))
			s createUser = $Get(%request.Data("createUser",1))
			s updateDate = $Get(%request.Data("updateDate",1))
			s nodeMark=$Get(%request.Data("nodeMark",1))
			s dataNode=$Get(%request.Data("dataNode",1))
			s dimType=$Get(%request.Data("dimType",1))
			s category=$Get(%request.Data("category",1))
			s section=$Get(%request.Data("section",1))
			s globalFlag=$Get(%request.Data("globalFlag",1))
			s %session.Data("kpiId")=kpiId
			s %session.Data("kpiCode")=kpiCode
			s %session.Data("kpiName")=kpiName
			s %session.Data("kpiDesc")=kpiDesc
			s %session.Data("kpiExcode")=kpiExcode
			s %session.Data("createUser")=createUser
			s %session.Data("updateDate")=updateDate
			s %session.Data("nodeMark")=nodeMark
			s %session.Data("dimType")=dimType
			s %session.Data("category")=category
			s %session.Data("section")=section
			s %session.Data("globalFlag")=globalFlag
		}elseif (action="mulSearchCY"){
	
		//set type=$g(%request.Data("type",1))
		//set mDepType=$g(%request.Data("mDepType",1))
		//s ^cy("fdasf")=mDepType
		//s ^cy("type")=type
		//i type="" s type=mDepType	
		set json = ##class(DHCWL.MRIPDayTask.MRIPDayTaskServer).GetDisConditiont()
		set start = $g(%request.Data("start",1))
		set maxRecordNum = $g(%request.Data("pageSize",1))
		set limit=$g(%request.Data("limit",1))
		if (""'=limit) set maxRecordNum=limit
		if (""'=json){
			write json.GetHead()
			set json.privor=start
			do{
				set obj=json.Next()
				if ((json.privor)=(start+maxRecordNum)){
					set obj=$p(obj,"}",1)
				 	set obj=obj_"}]}"
				}
				write obj
			}while((obj'="")&&(json.privor<(start+maxRecordNum))&&(json.privor<json.count))
		}else {
			w "{result:0,totalNum:0,root:[]}"
		}	
		
	}
	
	
		if section'="" {
			;if condSql="" s condSql=condSql_" where "
			;e  s condSql=condSql_" and "
			s searcheSql="select ID from DHCWL_MKPI.DHCWLSection where Sec_Name like '%"_section_"%'"
			s condRs=##class(%Library.ResultSet).%New()
			d condRs.Prepare(searcheSql)
			d condRs.Execute()
			While(condRs.Next()){
				s ID(condRs.Data("ID"))=""
			}
			d condRs.Close()
			s ids="",tempId="" f  s tempId=$o(ID(tempId)) q:tempId=""  d
			.s ids=ids_tempId_","
			s ids=$e(ids,1,$l(ids)-1)
			if $g(ids)'="" {
				if condSql="" s condSql=condSql_" where "
				e  s condSql=condSql_" and "
				s condSql=condSql_" MKPI_SectionFlag in ("_ids_")"
			}
			;s condSql=condSql_" MKPI_SectionFlag in ("_ids_")"
			k ID
		}
	}
	s sql=sql_" "_condSql_orderSql
	;w "sql="_sql
	;q
	s rs=##class(%Library.ResultSet).%New()
	d rs.Prepare(sql)
	d rs.Execute()
	s json=##class(DHCWL.util.Json).Json("id"_deli_"kpiCode"_deli_"kpiName"_deli_"kpiDesc"_deli_"kpiExcode"_deli_"MKPIGlobalFlag"_deli_"createUser"_deli_"updateDate"_deli_"nodeMark"_deli_"dimType"_deli_"category"_deli_"section"_deli_"dataNode","result","root",deli)
	s num=0
	;zw filterKpiArr
	//读入可选项结束
	While(rs.Next()){
		;i (num-start)>pageSize q
		s rowKpiId=rs.Data("ID")
		i searcheDimFlag=1 {
			if ('$d(filterKpiArr(rowKpiId))) continue
		}
		s num=num+1
		i (+isArrayType'=1)&&(num<(start)) continue
		i (+isArrayType'=1)&&((end)<num) continue
		s date=rs.Data("MKPI_UpdateDate"),cate=rs.Data("MKPI_Cate"),dim=rs.Data("MKPI_TypeDr"),sect=rs.Data("MKPI_SectionFlag")
		s cateId=cate,dimId=dim,sectId=sect
		if cate="" {
			s cate=""
		}elseif $g(^DHCWL.MKPI.MKPIFLD(cate))'="" {
			;s cateCode=$list(^DHCWL.MKPI.MKPIFLD(cate),2)
			s cate=$list(^DHCWL.MKPI.MKPIFLD(cate),5)
			;s cate=cate
		}else{
			s cate=""
		}
		;w "dim="_dim
		i (1=1)||(dim="")||(dim=$c(0)) {
			s tempRes=""
			s tempDim="" 
			;w "tempDim="_tempDim_"  rowKpiId="_rowKpiId
			k kpiDimOrdered
			f {
				s tempDim=$o(^DHCWL.MKPI.MKPIDimensionsI("MKPIDimKPII",rowKpiId,tempDim))
				q:($g(tempDim)="")||(tempDim=$c(0))
				continue:(+tempDim<=0) //||('$d(^DHCWL.MKPI.MKPIDimTypeD(tempDim)))
				;w "tempDim="_tempDim_"  rowKpiId="_rowKpiId
				s kpiDimId=""
				f {
					s kpiDimId=$o(^DHCWL.MKPI.MKPIDimensionsI("MKPIDimKPII",rowKpiId,tempDim,kpiDimId))
					q:kpiDimId=""
					s dimOrder=$lg(^DHCWL.MKPI.MKPIDimensionsD(kpiDimId),6)
					s:(dimOrder="")||(dimOrder=$c(0)) dimOrder=1
					s kpiDimOrdered(dimOrder)=$lg(^DHCWL.MKPI.MKPIDimensionsD(kpiDimId),4)   ;$list(^DHCWL.MKPI.MKPIDimTypeD(tempDim),5)
				}	
			}
			s dimOrder=""
			f {
				s dimOrder=$o(kpiDimOrdered(dimOrder))
				q:dimOrder=""
				i tempRes="" s tempRes=kpiDimOrdered(dimOrder)
				e  s tempRes=tempRes_","_kpiDimOrdered(dimOrder)
			}
			//s dim=$list(^DHCWL.MKPI.MKPIDimTypeD(dim),5)
			//s:($g(tempRes)="") tempRes=$list(^DHCWL.MKPI.MKPIDimTypeD(dim),5)
			s dim=$g(tempRes)
			;s dim=""
		}elseif $d(^DHCWL.MKPI.MKPIDimTypeD(dim)) {
			;s dimCode=$list(^DHCWL.MKPI.MKPIDimTypeD(dim),2)
			;w "test"
			s tempRes=""
			s tempDim="" 
			;w "tempDim="_tempDim_"  rowKpiId="_rowKpiId
			f {
				s tempDim=$o(^DHCWL.MKPI.MKPIDimensionsI("MKPIDimKPII",rowKpiId,tempDim))
				q:($g(tempDim)="")||(tempDim=$c(0))
				continue:(+tempDim<=0)||('$d(^DHCWL.MKPI.MKPIDimTypeD(tempDim)))
				;w "tempDim="_tempDim_"  rowKpiId="_rowKpiId
				i tempRes="" s tempRes=$list(^DHCWL.MKPI.MKPIDimTypeD(tempDim),5)
				e  s tempRes=tempRes_","_$list(^DHCWL.MKPI.MKPIDimTypeD(tempDim),5)
			}
			//s dim=$list(^DHCWL.MKPI.MKPIDimTypeD(dim),5)
			s:($g(tempRes)="") tempRes=$list(^DHCWL.MKPI.MKPIDimTypeD(dim),5)
			s dim=$g(tempRes)
		}
		i sect="" {
			s setc=""
		}elseif $g(^DHCWL.MKPI.SectionD(sect))'="" {
			;s sectCode=$list(^DHCWL.MKPI.SectionD(sect),2)
			s sect=$list(^DHCWL.MKPI.SectionD(sect),4)
		}else {
			s sect=""
		}
		s:date'="" date=$zd(+date,3)
		//插入一个json对象格式
		d json.Insert(rs.Data("ID")_""_deli_"'"_rs.Data("MKPI_Code")_"'"_deli_"'"_rs.Data("MKPI_Name")_"'"_deli_"'"_rs.Data("MKPI_Desc")_"'"_deli_"'"_rs.Data("MKPI_EXCode")_"'"_deli_"'"_rs.Data("MKPI_GlobalFlag")_"'"_deli_"'"_rs.Data("MKPI_User")_"'"_deli_"'"_date_"'"_deli_"'"_rs.Data("MKPI_Remark")_"'"_deli_"'"_dim_"'"_deli_"'"_cate_"'"_deli_"'"_sect_"'"_deli_"'"_rs.Data("MKPI_DataNod")_"'")
	}
	;s num=rs.%ROWCOUNT
	d rs.Close()
	d json.SetTotalNum(num)
	i (+isArrayType=1) {
		w "["
		d {
			s obj=json.GetNextJsonArray()
			i obj'="" w obj,","
		}while(obj'="")
		w "]"
		q
	}
	
	//added by JEFF@2013-09-11
	//写日志模块调用
	//if ("mulSearch"=action) {
	//	s mjson=json
	//	s logInfoUserId=$g(%session.Data("LOGON.USERID"))
	//	s logInfoResult=##class(DHCWL.MKPIService.LogInfo).LogInfoAddMkpiSelect("DHCWL.MKPI.MKPI","select","CSP:getkpidata,action:"_action,logInfoUserId,mjson,"id:")
	//}
	//写日志模块调用
	
	s jsonHead=json.GetHead()
	//w json.GetJson()有一些代替此方法（因为数据量大时string会溢出）
	w jsonHead
	d{
		s obj=json.Next()
		w obj
	}while(obj'="")
	i json.GetCount()=0 w "]}"
</script>

