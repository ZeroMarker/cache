<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	s action=$g(%request.Data("action",1))
	s start=$g(%request.Data("start",1))
	s pageSize = $g(%request.Data("limit",1))
	s onePage=$g(%request.Data("onePage",1))
	i +start=0 s start=1
	i +pageSize=0 s pageSize=20
	s:start>1 start=start+1
	s end=start+pageSize-1
	s deli="&"
	
	if "GetKpiDimAndPro"=action {
		s flag=$g(%request.Data("Flag",1))
		w "{data:"
		if flag="dim"{
			d ##class(DHCWL.ComplexRptData.RptService).GetStatDim()
			w ",success:true,tip:'ok'}"	
			q
		}else{
			s statCodes=$g(%request.Data("statCodes",1))
			d ##class(DHCWL.ComplexRptData.RptService).GetStatDimPro(statCodes,flag)
			w ",success:true,tip:'ok'}"	
			q
		}
	}elseif "getStatModeCombo"=action {
		s sql="select StMode_Code,StMode_Desc from DHCWL_ComplexRpt.StatMode where StMode_Flag='Y'"
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s deli=",",str=""
		While(rs.Next()){
			s str=str_"['"_rs.Data("StMode_Code")_"'"_deli_"'"_rs.Data("StMode_Desc")_"'],"
		}
		d rs.Close()
		w "["_$e(str,1,$l(str)-1)_"]"
	}elseif "getRptCfg"=action {
		s rptCode=$g(%request.Data("rptCode",1))
		s codeType=$g(%request.Data("codeType",1))
		s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.ComplexRptData.ReportCfg:RptCfgQuery","",rptCode,codeType)
		i json="" {
			w "{result:0,totalNum:0,root:[]}"
			q
		}
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif "getRptCfgContent"=action {
		s rptCode=$g(%request.Data("rptCode",1))
		s codeType=$g(%request.Data("codeType",1))
		s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.ComplexRptData.ReportCfg:RptContentQuery","",rptCode,codeType)
		i json="" {
			w "{result:0,totalNum:0,root:[]}"
			q
		}
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif "getRptCfgMode"=action {
		s rptCode=$g(%request.Data("rptCode",1))
		&sql(SELECT ID into :rptIDs FROM DHCWL_ComplexRpt.RptCfg WHERE Rpt_Code=:rptCode)
		//s inSql="SELECT ID FROM DHCWL_ComplexRpt.RptCfg WHERE Rpt_Code="_"'"_rptCode_"'"
		s sqla="SELECT RC_Mode FROM DHCWL_ComplexRpt.RowsColCfg WHERE RC_RptDr IN ("_rptIDs_")"
		s sql="SELECT StMode_Code,StMode_Desc FROM DHCWL_ComplexRpt.StatMode WHERE StMode_Code IN ("_sqla_")"
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s deli=",",str=""
		While(rs.Next()){
			s str=str_"{""modeCode"":"""_rs.Data("StMode_Code")_""""_"},{""modeDesc"":"""_rs.Data("StMode_Desc")_""""_"},"
		}
		d rs.Close()
		w "{data:"
		w "["_$e(str,1,$l(str)-1)_"]"
		w ",success:true,tip:'ok'}"	
		
	}elseif "getRptCfgFilter"=action {
		s rptCode=$g(%request.Data("rptCode",1))
		s inSql="SELECT ID FROM DHCWL_ComplexRpt.RptCfg WHERE Rpt_Code="_"'"_rptCode_"'"
		s sql="SELECT RC_FilterExp,RC_Remark FROM DHCWL_ComplexRpt.RowsColCfg WHERE RC_RptDr IN ("_inSql_")"
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s deli=",",str=""
		While(rs.Next()){
			i rs.Data("RC_FilterExp")=$c(0) s resultCode=""
			e  s resultCode=rs.Data("RC_FilterExp")
			i resultCode["\" s resultCode=$REPLACE(resultCode,"\","\\\")
			s str=str_"{""filterStr"":"""_resultCode_""""_"},"
		}
		d rs.Close()
		w "{data:"
		w "["_$e(str,1,$l(str)-1)_"]"
		w ",success:true,tip:'ok'}"
	}elseif "getRptDimProValue"=action {
		s statCode=$g(%request.Data("sCode",1))
		s dimProCode=$g(%request.Data("dimProCode",1))
		s filterValue=$g(%request.Data("filterValue",1))
		if dimProCode="" {
			s dimProCode=##class(DHCWL.ComplexRptData.SaveData).GetDimProCodeByStatCode(statCode) ;ƒ¨»œŒ¨∂» Ù–‘
		}
		s para="{start:"_start_",end:"_end_",jsonProDeli:&,}"
		if ((statCode="ItemSubGrpCode")!(statCode="ItemSubGrpDesc")!(statCode="ItemSubGrpOrder")){
			s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.ComplexRptData.RptService:GetSubGrpListByCode",para,dimProCode,statCode,filterValue)
		}else{
			s json=##class(DHCWL.util.UniteQueryData).GetJsonFromQuery("DHCWL.ComplexRptData.ReportCfg:GetDimProValue",para,statCode,dimProCode,filterValue)
		}
		i json="" {
			w "{result:0,totalNum:0,root:[]}"
			q
		}
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	}elseif "getFilterFunCombo"=action {
		s sql="SELECT FilterFunc_Prototype,FilterFunc_Code,FilterFunc_ExecCode,FilterFunc_FuncDesc FROM DHCWL_MKPI.SysFilterFunc"
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s deli=",",str=""
		While(rs.Next()){
			s funCode=rs.Data("FilterFunc_Code")
			s funPro=rs.Data("FilterFunc_FuncDesc")
			i funCode[$c(10) s funCode=$tr(funCode,$c(10),"")
			i funPro[$c(10) s funPro=$tr(funPro,$c(10),"")
			s str=str_"["_""""_funCode_""""_deli_""""_funPro_"""],"
		}
		d rs.Close()
		w "["_$e(str,1,$l(str)-1)_"]"
	}elseif "getStatTreeData"=action {
		set parentNode = $g(%request.Data("node",1))
		d ##class(DHCWL.ComplexRptData.RptService).GetLoadStatDim()

	}

</script>