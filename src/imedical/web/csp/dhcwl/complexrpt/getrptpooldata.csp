<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	set start = $g(%request.Data("start",1))
	set pageSize = $g(%request.Data("limit",1))
	set action=$g(%request.Data("action",1))
	set onePage=$g(%request.Data("onePage",1))
	set isArrayType=$g(%request.Data("isArrayType",1))
	set searcheCond = $g(%request.Data("searcheCond",1))
	set searcheValue = $g(%request.Data("searcheValue",1))
	i +start=0 s start=1
	i +pageSize=0 s pageSize=30
	s:start>1 start=start+1
	s end=start+pageSize-1
	s deli="&"
	if (action="singleSearche"){
		s sql="SELECT MKpi_KpiDr,MKpi_Mode,MKpi_Content,MKpi_DimStr FROM DHCWL_ComplexRpt.MKpi"
		s orderSql=" order by ID",condSql="",noCond=""
		if ((($g(searcheCond)'="")||($g(searcheValue)'=""))) {
			s likeSV="%"_$g(searcheValue)_"%"
			i $g(searcheCond)="kpiCode"{ ;根据指标代码搜索
				i $g(searcheValue)="" {
					s condSql=noCond
				}else{
					s searcheSql="SELECT ID FROM DHCWL_MKPI.DHCWLMKPI WHERE MKPI_Code like '"_likeSV_"'"
					s condRs=##class(%Library.ResultSet).%New()
					d condRs.Prepare(searcheSql)
					d condRs.Execute()
					While(condRs.Next()){
						s ID(condRs.Data("ID"))=""
					}
					d condRs.Close()
					s ids="",tempId="" f  s tempId=$o(ID(tempId)) q:tempId=""  d
					.s ids=ids_tempId_","
					s ids=$e(ids,1,$l(ids)-1)
					s condSql=" where MKpi_KpiDr in ("_ids_")"
				}
			}elseif $g(searcheCond)="statText"{ ;根据统计内容搜索
				i $g(searcheValue)="" {
					s condSql=noCond
				}else{
					s condSql=" where MKpi_Content like '"_likeSV_"'"
				}
			}elseif $g(searcheCond)="statMode"{ ;根据统计模式搜索
				i $g(searcheValue)="" {
					s condSql=noCond
				}else{
					s condSql=" where MKpi_Mode like '"_likeSV_"'"
				}
			}elseif $g(searcheCond)="dimCode"{ ;根据维度代码搜索
				i $g(searcheValue)="" {
					s condSql=noCond
				}else{
					s condSql=" where MKpi_DimStr like '"_likeSV_"'"
				}
			}
		
		}
		
		s sql=sql_" "_condSql_orderSql
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s json=##class(DHCWL.util.Json).Json("rKpiCode"_deli_"rKpiCont"_deli_"rKpiMode"_deli_"rKpiDimStr","result","root",deli)
		s num=0
		//读入可选项结束
		While(rs.Next()){
			s poolKpi=rs.Data("MKpi_KpiDr")
			&sql(SELECT MKPI_Code INTO :poolCode FROM DHCWL_MKPI.DHCWLMKPI WHERE ID=:poolKpi)
			continue:$g(poolCode)="" ;指标不存在时，指标池中不显示
			s poolCont=rs.Data("MKpi_Content")
			&sql(SELECT St_Desc INTO :pCont FROM DHCWL_ComplexRpt.StatItem WHERE St_Code=:poolCont)
			s poolMode=rs.Data("MKpi_Mode")
			&sql(SELECT StMode_Desc INTO :pMode FROM DHCWL_ComplexRpt.StatMode WHERE StMode_Code=:poolMode)
			s poolDimStr=rs.Data("MKpi_DimStr")
			s pDimStr=##class(DHCWL.ComplexRptData.RptKpiPoolService).GetKpiDimDescStr(poolDimStr)
			//插入一个json对象格式
			d json.Insert("'"_poolCode_"'"_deli_"'"_pCont_"'"_deli_"'"_pMode_"'"_deli_"'"_pDimStr_"'")
			s num=num+1
			continue:(num<(start)) 
			continue:((end)<num)
		}
		d rs.Close()
		d json.SetTotalNum(num)
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	
	}elseif(action="getLinkRpt"){
		s sql="SELECT Rpt_Code,Rpt_Name FROM DHCWL_ComplexRpt.RptCfg"
		s orderSql=" order by ID",condSql="",noCond=""
		s rptCode=$g(%request.Data("RptCode",1))
		i $g(rptCode)="" {
			i $g(rptCode)=""{
				w "{result:0,totalNum:0,root:[]}"
				q
			}
		}else{
			&sql(SELECT ID INTO :kpi FROM DHCWL_MKPI.DHCWLMKPI WHERE MKPI_Code=:rptCode)
			i $g(kpi)=""{
				w "{result:0,totalNum:0,root:[]}"
				q
			}
			&sql(SELECT ID into :poolkpi FROM DHCWL_ComplexRpt.MKpi where MKpi_KpiDr=:kpi)
			i $g(poolkpi)=""{
				w "{result:0,totalNum:0,root:[]}"
				q
			}
			s searcheSql="SELECT RptLink_Rpt FROM DHCWL_ComplexRpt.RptLinkMkpi WHERE RptLink_Kpi = "_poolkpi
			s condRs=##class(%Library.ResultSet).%New()
			d condRs.Prepare(searcheSql)
			d condRs.Execute()
			While(condRs.Next()){
				s RptLink(condRs.Data("RptLink_Rpt"))=""
			}
			d condRs.Close()
			s ids="",tempId="" f  s tempId=$o(RptLink(tempId)) q:tempId=""  d
			.s ids=ids_tempId_","
			s ids=$e(ids,1,$l(ids)-1)
			s condSql=" where ID in ("_ids_")"
		}
		s sql=sql_" "_condSql_orderSql
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s json=##class(DHCWL.util.Json).Json("rptCode"_deli_"rptName","result","root",deli)
		s num=0
		//读入可选项结束
		While(rs.Next()){
			s num=num+1
			continue:(num<(start)) 
			continue:((end)<num)
			//插入一个json对象格式
			d json.Insert("'"_rs.Data("Rpt_Code")_"'"_deli_"'"_rs.Data("Rpt_Name")_"'")
		}
		d rs.Close()
		d json.SetTotalNum(num)
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"		
	}
	
</script>