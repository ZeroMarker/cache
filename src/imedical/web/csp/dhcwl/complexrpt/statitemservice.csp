<csp:content charset="gb2312">
<csp:content charset="UTF-8">
	<script language="cache" runat="server">
	set start = $g(%request.Data("start",1))
	set pageSize = $g(%request.Data("limit",1))
	set action=$g(%request.Data("action",1))
	set onePage=$g(%request.Data("onePage",1))
	set isArrayType=$g(%request.Data("isArrayType",1))
	set searcheCond = $g(%request.Data("searcheCond",1))
	set searcheValue = $g(%request.Data("searcheValue",1))
	i +start=0 s start=1
	i +pageSize=0 s pageSize=20
	s:start>1 start=start+1
	s end=start+pageSize-1
	s deli="&"
	s sql="SELECT ID,St_Code,St_Desc,St_ExcCode,St_Type,St_WorkLoad,St_DimDr,St_Flag,St_UpdateDate,St_StatisListFlag FROM DHCWL_ComplexRpt.StatItem"
	s orderSql=" order by ID",condSql="",noCond=""
	if (action="singleSearche"){
		s statType=$g(%request.Data("statType",1))
		s statFlag=$g(%request.Data("statFlag",1))
		if ((($g(searcheCond)'="")||($g(searcheValue)'=""))) {
			s likeSV="%"_$g(searcheValue)_"%"
			i $g(searcheCond)="Code"{ ;根据代码搜索
				i $g(searcheValue)="" {
					s condSql=noCond
				}else{
					s condSql=" where St_Code like '"_likeSV_"'"
				}
			}elseif $g(searcheCond)="Name"{ ;根据名称搜索
				i $g(searcheValue)="" {
					s condSql=noCond
				}else{
					s condSql=" where St_Desc like '"_likeSV_"'"
				}
			}
		
		}
		if statType'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_Type = '"_statType_"'"
		}
		if statFlag'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_Flag = '"_statFlag_"'"
		}
		
		s sql=sql_" "_condSql_orderSql
		s rs=##class(%Library.ResultSet).%New()
		d rs.Prepare(sql)
		d rs.Execute()
		s json=##class(DHCWL.util.Json).Json("statCode"_deli_"statDesc"_deli_"statExcCode"_deli_"statType"_deli_"statFlag","result","root",deli)
		s num=0
		//读入可选项结束
		While(rs.Next()){
			s num=num+1
			continue:(num<(start)) 
			continue:((end)<num)
			//插入一个json对象格式
			d json.Insert("'"_rs.Data("St_Code")_"'"_deli_"'"_rs.Data("St_Desc")_"'"_deli_"'"_rs.Data("St_ExcCode")_"'"_deli_"'"_rs.Data("St_Type")_"'"_deli_"'"_rs.Data("St_Flag")_"'")
			
		}
		d rs.Close()
		d json.SetTotalNum(num)
		s jsonHead=json.GetHead()
		w jsonHead
		d{
			s obj=json.Next()
			w obj
		}while(obj'="")
		i json.GetCount()=0 w "]}"
	
	}elseif action="mulSearch" {
		i $g(onePage)=1 {
			s statId=$g(%request.Data("statId",1))
			s statCode=$g(%request.Data("statCode",1))
			s statDesc=$g(%request.Data("statDesc",1))
			s statExcCode=$g(%request.Data("statExcCode",1))
			s statType=$g(%request.Data("statType",1))
			s statWorkLoad=$g(%request.Data("statWorkLoad",1))
			s statDimDr=$g(%request.Data("statDimDr",1))
			s statFlag=$g(%request.Data("statFlag",1))
			s statSort=$g(%request.Data("statSort",1))
			
			s %session.Data("statId",1)=statId
			s %session.Data("statCode",1)=statCode
			s %session.Data("statDesc",1)=statDesc
			s %session.Data("statExcCode",1)=statExcCode
			s %session.Data("statType",1)=statType
			s %session.Data("statWorkLoad",1)=statWorkLoad
			s %session.Data("statDimDr",1)=statDimDr
			s %session.Data("statFlag",1)=statFlag
			s %session.Data("statSort",1)=statSort
		}else{
			s statId=$g(%session.Data("statId",1))
			s statCode=$g(%session.Data("statCode",1))
			s statDesc=$g(%session.Data("statDesc",1))
			s statExcCode=$g(%session.Data("statExcCode",1))
			s statType=$g(%session.Data("statType",1))
			s statWorkLoad=$g(%session.Data("statWorkLoad",1))
			s statDimDr=$g(%session.Data("statDimDr",1))
			s statFlag=$g(%session.Data("statFlag",1))
			s statSort=$g(%session.Data("statSort",1))	
		}
		if statId'="" {
			if condSql="" s condSql=condSql_" where"
			e  s condSql=condSql_" and "
			s condSql=condSql_" ID="_statId
		}
		if statCode'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_Code like '%"_statCode_"%'"
		}
		if statDesc'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_Desc like '%"_statDesc_"%'"
		}
		if statExcCode'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_ExcCode like '%"_statExcCode_"%'"
		}
		if statType'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_Type like '%"_statType_"%'"
		}
		if statWorkLoad'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_WorkLoad="_statWorkLoad
		}
		if statDimDr'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_DimDr="_statDimDr
		}
		if statFlag'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_Flag like '%"_statFlag_"%'"
		}
		if statSort'="" {
			if condSql="" s condSql=condSql_" where "
			e  s condSql=condSql_" and "
			s condSql=condSql_" St_StatisListFlag like '%"_statSort_"%'"
		}
		
	s sql=sql_" "_condSql_orderSql
	s rs=##class(%Library.ResultSet).%New()
	d rs.Prepare(sql)
	d rs.Execute()
	s json=##class(DHCWL.util.Json).Json("statId"_deli_"statCode"_deli_"statDesc"_deli_"statExcCode"_deli_"statType"_deli_"statWorkLoad"_deli_"statDimDr"_deli_"statFlag"_deli_"statUpDateDate"_deli_"statWLDesc"_deli_"statDimDesc"_deli_"statSort","result","root",deli)
	;s dhcwlArray=##class(DHCWL.ComplexRptData.SaveData).QueryObjsByClassName("Data","DHCWorkLoad")
	s dhcwlArray=##class(DHCWL.ComplexRptData.SaveData).SetObjsByClassName("User","DHCWorkLoad")
	s num=0
	//读入可选项结束
	While(rs.Next()){
		s num=num+1
		i (+isArrayType'=1)&&(num<(start)) continue
		i (+isArrayType'=1)&&((end)<num) continue
		s date=rs.Data("St_UpdateDate")
		//s:date'="" date=$zd(+date,3)
		s:date'="" date=##class(websys.Conversions).DateLogicalToHtml(+date)
		s stType=rs.Data("St_Type")
		i stType="S" s stType="统计项"
		i stType="C" s stType="统计内容"
		s stFlag=rs.Data("St_Flag")
		i stFlag="Y" s stFlag="是"
		i stFlag="N" s stFlag="否"
		s stSort=rs.Data("St_StatisListFlag")
		i stSort="stat" s stSort="统计项"
		i stSort="list" s stSort="列表项"
		s dimDr=rs.Data("St_DimDr")
		s dimDesc=##class(DHCWL.ComplexRptData.SaveData).GetDimDescByID(dimDr)
		;&sql(SELECT KDT_Name INTO :dimDr FROM DHCWL_MKPI.DHCWLMKPIDimType WHERE KDT_Code=:dimDr)
		s dhcwl=rs.Data("St_WorkLoad")
		i +dhcwl=0 s wlDesc=""
		e  s wlDesc=dhcwlArray.GetAt(dhcwl)
		//插入一个json对象格式
		d json.Insert(rs.Data("ID")_""_deli_"'"_rs.Data("St_Code")_"'"_deli_"'"_rs.Data("St_Desc")_"'"_deli_"'"_rs.Data("St_ExcCode")_"'"_deli_"'"_stType_"'"_deli_"'"_dhcwl_"'"_deli_"'"_dimDr_"'"_deli_"'"_stFlag_"'"_deli_"'"_date_"'"_deli_"'"_wlDesc_"'"_deli_"'"_dimDesc_"'"_deli_"'"_stSort_"'")
			
	}
	d rs.Close()
	d json.SetTotalNum(num)
	i (+isArrayType=1) {
		w "["
		d {
			s obj=json.GetNextJsonArray()
			i obj'="" w obj,","
		}while(obj'="")
		w "]"
		q
	}
	s jsonHead=json.GetHead()
	//w json.GetJson()有一些代替此方法（因为数据量大时string会溢出）
	w jsonHead
	d{
		s obj=json.Next()
		w obj
	}while(obj'="")
	i json.GetCount()=0 w "]}"
	
}elseif action="addStat" {
	s dim("ID")=$g(%request.Data("statId",1))
	s dim("StatCode")=$g(%request.Data("statCode",1))
	s dim("StatDesc")=$g(%request.Data("statDesc",1))
	s dim("StatExcCode")=$g(%request.Data("statExcCode",1))
	s dim("StatType")=$g(%request.Data("statType",1))
	s dim("StatWorkLoad")=$g(%request.Data("statWorkLoad",1))
	s dim("StatDimDr")=$g(%request.Data("statDimDr",1))
	s dim("StatFlag")=$g(%request.Data("statFlag",1))
	s dim("StatSort")=$g(%request.Data("statSort",1))
	s result=##class(DHCWL.ComplexRptData.SaveData).AddStatItem(.dim)
	w "{success:true,tip:'"_result_"'}"
}elseif action="updateStat" {
	s dim("ID")=$g(%request.Data("statId",1))
	s dim("StatCode")=$g(%request.Data("statCode",1))
	s dim("StatDesc")=$g(%request.Data("statDesc",1))
	s dim("StatExcCode")=$g(%request.Data("statExcCode",1))
	s dim("StatType")=$g(%request.Data("statType",1))
	s dim("StatWorkLoad")=$g(%request.Data("statWorkLoad",1))
	s dim("StatDimDr")=$g(%request.Data("statDimDr",1))
	s dim("StatFlag")=$g(%request.Data("statFlag",1))
	s dim("StatSort")=$g(%request.Data("statSort",1))
	s result=##class(DHCWL.ComplexRptData.SaveData).UpdateStatItem(.dim)
	w "{success:true,tip:'"_result_"'}"
}elseif action="deleteStat" {
	s id=$g(%request.Data("statId",1))
	s result=##class(DHCWL.ComplexRptData.SaveData).DeleteStatItem(id)
	w "{success:true,tip:'"_result_"'}"
}
	
</script>