<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	Set TestSetRow=$g(%request.Data("TestSetRow",1))      //检验号
	Set LabNo=$p(TestSetRow,"||",1)
	Set TS=$p(TestSetRow,"||",2)
	Set TSCNT=$p(TestSetRow,"||",3)
	Quit:(LabNo="")||(TS="")||(TSCNT="") 1
	Set OrdItemDate=$p($g(^TEPI(LabNo)),"\",12)
	Set:OrdItemDate'="" OrdItemDate=$zd(OrdItemDate,3)
	Set OrdItemTime=$p($g(^TEPI(LabNo)),"\",50)
	Set:OrdItemTime'="" OrdItemTime=$zt(OrdItemTime,1)
	Set SpecDate=$p($g(^TEPI(LabNo,1,TS,TSCNT)),"\",44)
	Set:SpecDate'="" SpecDate=$zd(SpecDate,3)
	Set SpecTime=$p($g(^TEPI(LabNo,1,TS,TSCNT)),"\",45)
	Set:SpecTime'="" SpecTime=$zt(SpecTime,1)
	Set OrdID=0,OrderID=""
	For {
		Set OrdID=$o(^OEORD(0,"EpisNo",LabNo,OrdID))
		Quit:OrdID=""
		Set SubID=0
		For {
			Set SubID=$o(^OEORD(0,"EpisNo",LabNo,OrdID,SubID))
			Quit:SubID=""
			Continue:$p(^OEORD(OrdID,"I",SubID,3),"^",35)'=TestSetRow
			Set OrderID=OrdID_"||"_SubID
		}
	}
	Quit:OrderID="" 1
	Set EpisodeID=$p($g(^OEORD(+OrderID)),"^",1)
	Set PatientID=$p($g(^PAADM(+EpisodeID)),"^",1)
 	Set UserID=$G(%session.Data("LOGON.USERID"))
 	Set UserInitial=$p($g(^SSU("SSUSR",+UserID)),"^",1)
 	Set UserPassword=$p($g(^SSU("SSUSR",+UserID)),"^",3)
 	Set LocID=$G(%session.Data("LOGON.CTLOCID"))
 	Set LocDesc=$p($g(^CTLOC(+LocID)),"^",2)
	
	s url=$c(0)_"OrdItemDate"_$c(1)_OrdItemDate
	s url=url_$c(0)_"OrdItemTime"_$c(1)_OrdItemTime
	s url=url_$c(0)_"SpecDate"_$c(1)_SpecDate
	s url=url_$c(0)_"SpecTime"_$c(1)_SpecTime
	s url=url_$c(0)_"OrderID"_$c(1)_OrderID
	s url=url_$c(0)_"EpisodeID"_$c(1)_EpisodeID
	s url=url_$c(0)_"PatientID"_$c(1)_PatientID
	s url=url_$c(0)_"USERID"_$c(1)_UserID
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url,"%","%25")
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url,"+","%2B")
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url," ","%20")
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url,"/","%2F")
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url,"?","%3F")
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url,"#","%23")
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url,"&","%26")
 	s url=##Class(DHCMed.INFService.DrugSenStaSrv).Translate(url,"=","%3D")
 	s url=$tr(url,$c(0),"&")
 	s url=$tr(url,$c(1),"=")
 	s url="dhclabviewresult.csp?1=1"_url_"&2=2"
 	//dhclabdoctorreport.csp
 	//dhclabviewresult.csp
 	
	//通过Portal登录
	s %request.Data("USERNAME",1)=UserInitial
 	s %request.Data("PASSWORD",1)=UserPassword
	s %request.Data("DEPARTMENT",1)=LocDesc
	s %response.ServerSideRedirect=url
	s myrtnflag=##Class(web.portal.SessionLogon).Logon()
	if +myrtnflag=0 {
		//s %response.ServerSideRedirect=url    //登录成功,跳转到临床路径表单界面
	}else{
		s %response.ServerSideRedirect="logon.csp"    //转向登录页面
	}
 	
	q 1
</csp:method>