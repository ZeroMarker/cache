<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(DHCMRQ.Base.Util.Verification).SessionVerifi() q 1
	q 1
</csp:method>
<html>
	<head>
		<script>
		if (top == self) {
    		top.location = 'dhcmrq.index.csp';
		}
	   </script>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title></title>
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/datatable-1.10.12/datatables.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/css/main.css">
		<style>
			.file-link {
    			display: inline-block;
    			margin: 5px;
    			padding:10px;
    			text-align: center;
			}
			.file-link:hover{
    			box-shadow:0 0 10px rgba(0,0,0,.2) inset;
			}
			.file-link .fa {
    			font-size: 40px;
			}
		</style>
		<!--[if lte IE 6]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap-ie6.css">
	  <![endif]-->
	  <!--[if lte IE 8]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/ie.css">
			<style media="screen">
				.col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9{
					padding-left: 0;
					padding-right: 0;
				}
			</style>
	  <![endif]-->
	</head>
	<body>
		<div class="navbar navbar-static-top" style="background-color:#fff;">
			<div class="container-fluid">
				<div class="navbar-header">
					<button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a href="#" class="navbar-brand"></a>
				</div>
				<nav id="bs-navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
						<!--
						<li class="active">
							<a href="../getting-started/">Getting started</a>
						</li>
						 -->
					</ul>
					<ul class="nav navbar-nav navbar-right">
					</ul>

				</nav>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row">
				<div class="boxcq">
					<div class="ti">
						<i class="fa fa-stack-overflow fa-lg"></i>数据导出
					</div>
					<ul class="nav nav-tabs boxnavcq" role="tablist">
						<li><a class="licenseWarning" style="color:red;"></a></li>
					</ul>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-12" id="formDiv">
									<form id="form1" style="text-align:center;" class="form-inline" role="form">
										<label for="verCode" class="control-label">首页版本:</label>
										<select class="form-control" name="verCode" id="verCode">
											<option value="V2012.BJ">V2012.BJ</option>
										</select>&nbsp;&nbsp;
										<label for="appCode" class="control-label">应用版本:</label>
										<select class="form-control" name="appCode" id="appCode">
											<option value="BJ.XH.Clinic">临床</option>
											<option value="BJ.XH.Coding">编目</option>
											<option value="BJ.XH.HQMS">HQMS</option>
											<option value="BJ.XH.WT-01">卫统4-1</option>
											<option value="BJ.XH.WT-02">卫统4-2</option>
										</select>
										<input id="startDate" name="startDate" class="form-control input-sm" readonly>
											~
										<input id="endDate" name="endDate" class="form-control input-sm" readonly>
										
										<a class="btn btn-success" href="javascript:exportData()" id="uploadBtn" style="width:100px;">导出</a>
									</form>
								</div>
							</div>
						</div>
						
					</div>
				</div>
			</div>
			
			<div class="row">
				<div class="boxcq">
					<div class="ti">
						<i class="fa fa-download fa-lg"></i>导出结果
					</div>
					<ul class="nav nav-tabs boxnavcq" role="tablist">
						<li></li>
					</ul>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-12" id="exportResult">
									
								</div>
							</div>
						</div>
						
					</div>
				</div>
			</div>
			
		</div>

		 <div id="loading">
		 	<img src="../scripts/dhcmrq/images/loading.gif"/>
		 	<h3 class="info">正在导出<br>...</h3>
		 </div>
		 <input type="text" id="url" style="display:none;"/>
		<DHCMRQ:HEAD></DHCMRQ:HEAD>
<script type="text/javascript">
	  $("#startDate,#endDate").datetimepicker({
	     format: "yyyy-mm-dd",
	     autoclose: true,
	     todayBtn: true,
	     minView: 2,
	     startView:2,
	     language: 'zh-CN'
	  });
	  
	  var dateNow = new Date();
	  var year = dateNow.getFullYear();
	  var month = dateNow.getMonth();
	  
	  if(month==0){
		  month = 12;
		  year--;
	  }
	  
	  var lastDay = new Date(year,month,0).getDate();
	  
	  if(month<10) month = '0'+month;
	  if(lastDay<10) lastDay = '0'+lastDay;
	  
	  $("#startDate").val(year+'-'+month+'-01');
	  $("#endDate").val(year+'-'+month+'-'+lastDay);
	  
if(session['LOGON.VALIDLIC']=='0') {
	$('.licenseWarning').html('License已过期，将不能导出数据，请更新License！');
}
$('#url').val(getConf('mrDownloadURL'));


//上传导临时表
function exportData(){
	  
	if(session['LOGON.VALIDLIC']=='0') {
		msg('warning','License已过期，请更新License！');
		return;
	} else if ($('#url').val()==''){
		msg('warning','首页导出地址未配置，请先配置导出地址！');
		return;
	} else if(!getConf('hospCode') || getConf('hospCode').trim()==''){
		msg('warning','医院代码未配置，请先配置医院代码：hospCode！');
		return;
	}
	
	$('#uploadBtn').html('<i class="fa fa-spinner fa-spin fa-fw"></i>&nbsp;正在导出').attr('disabled','disabled');
	
	var formData = new FormData($('#form1')[0]);
	
	$.ajax({
	    url: $('#url').val(),
	    type: 'POST',
	    cache: false,
	    data: formData,
	    processData: false,
	    contentType: false
	}).done(function(result) {
		
		if(result.success){
			console.log(result)
			msg('success',result.msg);
			$('#exportResult').html('');
			$.each(result.data,function(i,n){
				$('#exportResult').append('<a class="file-link" href="'+n.url+'" download><i class="fa fa-file-text"></i><br>'+n.fileName+'</a>');
				
			})
		} else if(result){
			msg('danger',result.msg);
			console.log(result.msg)
			console.log(result.data)
		}
		
		$('#uploadBtn').html('导出').removeAttr('disabled');
		
	}).fail(function(res) {
		console.error(res)
		msg('danger','请检查解析服务是否正常');
		console.log(res)
		$('#uploadBtn').html('导出').removeAttr('disabled');
	});
}

</script>
	</body>
</html>
