<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(websys.SessionEvents).SessionExpired() q 1
	q 1
</csp:method>
<csp:content charset="UTF-8">

<script language="cache" runat="server">

	s Action=$Get(%request.Data("actiontype",1))
	s Start=$Get(%request.Data("start",1))
	s Limit=$Get(%request.Data("limit",1))
	s Sort=$Get(%request.Data("sort",1))
	s Dir=$Get(%request.Data("dir",1)) 

	s conditionCode=$Get(%request.Data("conditionCode",1))
	s conditionName=$Get(%request.Data("conditionName",1))
	s listData=$Get(%request.Data("data",1))
	s RowId=$Get(%request.Data("rowid",1))

//查询厂商信息
i Action = "query" d
	.s activeFlag=$Get(%request.Data("activeFlag",1))
	.d ##class(web.DHCSTM.ItmManf).Query(Start,Limit,Sort,Dir,conditionCode,conditionName,activeFlag)
	
//新建厂商信息
i Action = "insert" d
	.s result = ##class(web.DHCSTM.ItmManf).Save(listData)
	.i +result>0 d
	..w "{success:'true',info:'"_result_"'}"
	.e  d
	..w "{success:'false',info:'"_result_"'}"

//根据厂商的RowId查询厂商的明细信息
i Action = "queryByRowId" d
	.s result=##class(web.DHCSTM.ItmManf).Select(RowId)
	.s result=##class(web.DHCSTM.Common.UtilCommon).hJsonChar(result)
	.w "{success:'true',info:'"_result_"'}"

//更新厂商信息
i Action = "update" d
	.s result = ##class(web.DHCSTM.ItmManf).Update(listData)
	.i result =0 d
	..w "{success:'true',info:'"_result_"'}"
	.e  d
	..w "{success:'false',info:'"_result_"'}"

i Action="GetManfPic" d
 .s manf=$Get(%request.Data("manf",1))
 .s type=$Get(%request.Data("type",1))
 .s result = ##class(web.DHCSTM.ItmManf).GetManfPic(manf,type)
 .i result = "" d
 ..w "{results:0,rows:[]}"
 .e  d
 ..w result 
 ..

 i Action = "DeleteManfPic" d
 .s RowId=$G(%request.Data("rowid",1))
 .s PicSrc=$Get(%request.Data("picsrc",1))
 .s GroupId=$G(%session.Data("LOGON.GROUPID"))
 .s LocId=$G(%session.Data("LOGON.CTLOCID"))
 .s UserId=$G(%session.Data("LOGON.USERID"))
 .s Param=GroupId_"^"_LocId_"^"_UserId
 .s result = ##class(web.DHCSTM.ItmManf).DeleteManfPic(RowId,PicSrc,Param)
 .i result = 0 d
 ..w "{success:'true',info:''}"
 .e  d
 ..w "{success:'false',info:'"_result_"'}"

 i Action="UploadManfPic" d
 .s manf=$Get(%request.Data("manf",1))
 .s type=$Get(%request.Data("type",1))
 .s GroupId=$G(%session.Data("LOGON.GROUPID"))
 .s LocId=$G(%session.Data("LOGON.CTLOCID"))
 .s UserId=$G(%session.Data("LOGON.USERID"))
 .s Param=GroupId_"^"_LocId_"^"_UserId
 .
 .s File=$Get(%request.MimeData("files",1))
 .s result = ##class(web.DHCSTM.ItmManf).SaveManfPic(File,Param,manf,type)
 .i result=0 d
 ..w "{success:'true',message:'上传成功'}"
 .e  d
 ..w "{success:'false',message:'上传失败'}" 
 ..
 .

 i Action="UpdateManfPic" d
 .s rowid=$Get(%request.Data("rowid",1))
 .s type=$Get(%request.Data("type",1))
 .s result=##class(web.DHCSTM.ItmManf).UpdatePicInfo(rowid,type)
 .
 .i result=0 d
 ..w "{success:'true',info:''}"
 .e  d
 ..w "{success:'false',info:'"_result_"'}"
 .
 
 i Action="InsManfPic" d   //zhwh 2015-04-02
 .s manfName=$Get(%request.Data("manfName",1))
 .s fileName=$Get(%request.Data("fileName",1))
 .s type=$Get(%request.Data("type",1))
 .&sql(select phmnf_rowid into :manf from ph_manufacturer where phmnf_name=:manfName)
 .i SQLCODE'=0 d
 ..w "{success:'false',info:'"_SQLCODE_"'}"
 .q:SQLCODE'=0
 .
 .s result=##class(web.DHCSTM.ItmManf).InsManfPic(manf,fileName,type)
 .i result=0 d
 ..w "{success:'true',info:''}"
 .e  d
 ..w "{success:'false',info:'"_result_"'}"
 . 
 
 
</script>