<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. -->
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	s EpisodeID=$g(%request.Data("EpisodeID",1))
 	s PatientID=$p($g(^PAADM(+EpisodeID)),"^",1)
 	s MRAdm=$p($g(^PAADM(+EpisodeID)),"^",61)
 	s UserID=$g(%request.Data("UserID",1))
 	s UserInitial=$p($g(^SSU("SSUSR",+UserID)),"^",1)
 	s UserPassword=$p($g(^SSU("SSUSR",+UserID)),"^",3)
 	s LocID=$g(%request.Data("LocID",1))
 	s LocDesc=$p($g(^CTLOC(+LocID)),"^",2)
 	
 	s SubjectID=##Class(DHCMed.SS.Config).GetValueByKeyHosp("NINFInfCtrlID","")
 	
	s url=$c(0)_"EpisodeID"_$c(1)_EpisodeID
	s url=url_$c(0)_"SubjectID"_$c(1)_SubjectID
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url,"%","%25")
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url,"+","%2B")
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url," ","%20")
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url,"/","%2F")
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url,"?","%3F")
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url,"#","%23")
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url,"&","%26")
 	s url=##Class(DHCMed.NINFService.Srv.CommonCls).Translate(url,"=","%3D")
 	s url=$tr(url,$c(0),"&")
 	s url=$tr(url,$c(1),"=")
 	//s url="dhcmed.ninf.yyyy.clinreport.csp?1=1"_url_"&2=2"
 	s url="dhcmed.ninf.clinrepview.csp?1=1&EpisodeID=?1=1"_url_"&ExtWinOpen=1&2=2"
 	
 	s %response.ServerSideRedirect=url
 	if $d(%session.Data("LOGON.USERID"))&&($g(%session.Data("LOGON.USERID"))'="") {
 		s %response.ServerSideRedirect=url
 	}else{
		//通过Portal登录
		s %request.Data("USERNAME",1)=UserInitial
	 	s %request.Data("PASSWORD",1)=UserPassword
		s %request.Data("DEPARTMENT",1)=LocDesc
		s myrtnflag=##Class(web.portal.SessionLogon).Logon()
		if +myrtnflag=0 {
			s %response.ServerSideRedirect=url    //登录成功,跳转到临床路径表单界面
		}else{
			//s %response.ServerSideRedirect="logon.csp"    //转向登录页面
		}
 	}
 	
	q 1
</csp:method>