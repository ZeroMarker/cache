<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
	i ##Class(DHCMRQ.Base.Util.Verification).SessionVerifi() q 1
	q 1
</csp:method>
<!DOCTYPE html>
<html>
	<head>
		<script>
		if (top == self) {
    		top.location = 'dhcmrq.index.csp';
		}
	   </script>
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/bootstrap-validator/css/bootstrapValidator.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/datatable-1.10.12/datatables.min.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/css/main.css">
		<link rel="stylesheet" href="../scripts/dhcmrq/zTree/css/metroStyle/metroStyle.css">
		<!--[if lte IE 6]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/bootstrap-ie6.css">
	  <![endif]-->
	  <!--[if lte IE 8]>
	  	<link rel="stylesheet" type="text/css" href="../scripts/dhcmrq/bootstrap-3.3.5-dist/css/ie.css">
			<style media="screen">
				.col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9{
					padding-left: 0;
					padding-right: 0;
				}
			</style>
	  <![endif]-->
		
		

		<style media="screen">
			label.col-sm-3{
				padding-right: 0;
			}
			.table>tbody>tr.selected{
				background-color: #16c79e;
				color: #fff;
				transition: all .2s;
			}
			#menuDiv .col-sm-5{
				border: 1px solid #16c79e;
				min-height: 200px;
			}
			.panel-footer{
				text-align: right;
			}
			.table th, .table td{
				text-align: left;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="boxcq">
					<div class="ti">

					</div>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active">
							<div class="row">
								<div class="col-sm-8">
									<table id="roleTable" class="table table-striped" width="100%">
										<thead>
											<tr><th>角色代码</th><th>角色描述</th><th>操作</th></tr>
										</thead>
										<tbody>

										</tbody>
									</table>
								</div>
								<div class="col-sm-4">
									<div class="panel panel-info">
									  <div class="panel-heading">角色信息</div>
									  <div class="panel-body">
									  <input type="hidden" id="roleId">
											<form id="roleForm" class="form-horizontal" role="form">
												<div class="form-group">
											    <label for="roleCode" class="col-sm-3 control-label">角色代码</label>
											    <div class="col-sm-9">
											      <input type="text" class="form-control" id="roleCode" name="Params" placeholder="角色代码">
											    </div>
											  </div>
												<div class="form-group">
											    <label for="roleDesc" class="col-sm-3 control-label">角色名称</label>
											    <div class="col-sm-9">
											      <input type="text" class="form-control" id="roleDesc" name="roleDesc" placeholder="角色名称">
											    </div>
											  </div>
											</form>
									  </div>
										<div class="panel-footer">
											<button type="button" onclick="saveRole()" class="btn btn-info">保存</button>
											<!--<button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModal">删除</button>-->
										</div>
									</div>

									<div class="panel panel-info">
									  <div class="panel-heading">菜单分配</div>
									  <div class="panel-body">
											<div class="ztree" id="menuDiv">

											</div>
									  </div>
										<div class="panel-footer">
											<button type="button" onclick="saveMenu()" class="btn btn-info">保存</button>
										</div>
									</div>

								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">确认</h4>
      </div>
      <div class="modal-body">
        确定要删除吗？
      </div>
      <div class="modal-footer">
        
        <button type="button" class="btn btn-danger" onclick="deleteRole()" data-dismiss="modal">删除</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>
		<DHCMRQ:HEAD></DHCMRQ:HEAD>
		<script type="text/javascript" src="../scripts/dhcmrq/zTree/js/jquery.ztree.all.min.js" charset="utf-8"></script>
		<script type="text/javascript">
			var dt;
			var menuTree;
			var allMenu;
			$(function(){
				loadTable();
				getAllMenu();
				
				//code值改变时，认为要新增记录，所以启动验证
				$('#roleCode').on('input',function(){
					$('#roleForm').bootstrapValidator('enableFieldValidators', 'Params', true);
				})
				
	$('#roleForm').bootstrapValidator({
		//live: 'disabled',
        message: 'This value is not valid',
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            roleDesc: {
                validators: {
                    notEmpty: {
                        message: '角色名不能为空'
                    }
                }
            },
            Params: {
                message: 'The cfgCode is not valid',
                validators: {
                    notEmpty: {
                        message: '角色代码不能为空'
                    },
                    stringLength: {
                        min: 4 ,
                        max: 30,
                        message: '角色代码要大于4位小于30位字符'
                    },
                    regexp: {
                        regexp: /^[a-zA-Z0-9_]+$/,
                        message: '角色代码只能包含字母数字和下划线'
                    },
                    remote: {
                        url: 'dhcmrq.service.csp?ClassName=DHCMRQ.Base.MRQRole&MethodName=CheckRoleCode',
                        message: '角色代码已存在'
                    }
                }
            }
        }
    });

			});

			function getAllMenu(){
				$.ajax({
						type: 'post',
						url: 'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQMenu',
									 MethodName:'GetAllMenu',
									 Params:''
						},
						success: function (res) {
							//console.log(res);
							allMenu = JSON.parse(res).sort(function(a,b){return a.mOrder-b.mOrder});
		        }
		    });
			}

			function loadRoleMenu(allMenus,roleCode){
				$.ajax({
						type: 'post',
						url: 'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQRoleMenu',
									 MethodName:'GetMenuByRole',
									 Params:roleCode
						},
						success: function (res) {
							try{
								res = JSON.parse(res);
							}catch(err){
								res = [];
							}
							//console.log(allMenu)
							//console.log(res)
							var menuNodes = [];
							$.each(allMenu,function(i,n){
								var menu = {open:true};
								menu['id'] = n.mId;
								menu['name'] = n.mDesc;
								$.each(res,function(i,m){
									if(m.menuCode==n.mCode){
										menu['checked'] = true;
									}
								})
								if(n.children){
									var menu = {open:true};
									menu['id'] = n.children.mId;
									menu['name'] = n.children.mDesc;
									$.each(n.children,function(i,cm){
										if(cm.menuCode==n.children.mCode){
											menu['checked'] = true;
										}
									})
								}
								menuNodes.push(menu);
							});
							//console.log(menuNodes)
							// zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
					    	var setting = {
								check: {enable: true,
										autoCheckTrigger: true}
							};
							menuTree = $.fn.zTree.init($("#menuDiv"), setting, menuNodes);
					    }
		    });
			}

			function loadTable(){
				$.ajax({
						type: 'post',
						url: 'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQRole',
									 MethodName:'GetAllRole',
									 Params:''
						},
						success: function (res) {
							//console.log(res);
							dt = $('#roleTable').DataTable( {
									data: JSON.parse(res),
									lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "全部"] ],
									columns: [
												{ "data": "roleCode" },
												{ "data": "roleDesc" },
												{ "data": "oper" ,
													"render": function ( data, type, full, meta ) {
														return '<a class="link" href="#" onclick="deleteRole(\''+full.roleId+'\')">删除</a>'
															
													}
												}
										]
							});

							$('#roleTable tbody').on( 'click', 'tr', function () {
									dt.$('tr.selected').removeClass('selected');
									$(this).addClass('selected');
									var rowData = dt.rows('.selected').data()[0];
									for (var key in rowData) {
										$('#'+key).val(rowData[key]);
									}
									loadRoleMenu(allMenu,rowData.roleCode);
									
									$('#roleForm').bootstrapValidator('enableFieldValidators', 'Params', false);

							});
		        }
		    });
			}


			function saveRole(){
				//验证表单
				$('#roleForm').bootstrapValidator('validate');
				if(!$('#roleForm').data('bootstrapValidator').isValid()) return;
				
				$.ajax({
						type: 'post',
						url:  'dhcmrq.service.csp',
		        data: {ClassName:'DHCMRQ.Base.MRQRole',
							 	   MethodName:'Update',
							 	   Params:$('#roleCode').val()+'^'+$('#roleDesc').val()
					  },
		        success: function (res) {
							console.log(res);
		                    loadTable();
		                    msg('success','更新成功!',2000);
		        }
		    });
			}

			function deleteRole(roleId){
				if(confirm('确定删除吗？')){
					$.ajax({
						type: 'post',
						url:  'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQRole',
									 MethodName:'DeleteById',
									 Params:roleId
						},
						success: function (res) {
							//console.log(res);
							//loadTable();
							location.reload();
							msg('success','角色删除成功!',2000);
						}
					});
				}
			}
function array_diff(array1, array2) {
	var o = {};
	for(var i = 0, len = array2.length; i < len; i++) {
		o[array2[i]] = true;
	}

	var result = [];
	for(i = 0, len = array1.length; i < len; i++) {
		var v = array1[i];
		if(o[v]) continue;
		result.push(v);
	}
	return result;
}
			function saveMenu(){
				var changeMenu = menuTree.getChangeCheckedNodes();
				var checkedMenu = menuTree.getCheckedNodes();
				var deletedMenu = [];
				var menuArray = [];
				
				$.each(checkedMenu,function(i,n){
					menuArray.push(n.id);
				});
				$.each(changeMenu,function(i,n){
					deletedMenu.push(n.id);
				});
				deletedMenu = array_diff(deletedMenu,menuArray);//得到改变的减去已选择的差集
				//新增
				$.ajax({
						type: 'post',
						url:  'dhcmrq.service.csp',
						data: {ClassName:'DHCMRQ.Base.MRQRoleMenu',
									 MethodName:'BatchUpdate',
									 Params:$('#roleId').val()+','+menuArray.join('^')
						},
						success: function (res) {
							//console.log(res)
							//减去
							$.ajax({
								type: 'post',
								url:  'dhcmrq.service.csp',
								data: {ClassName:'DHCMRQ.Base.MRQRoleMenu',
									 MethodName:'DeleteMenu',
									 Params:$('#roleId').val()+','+deletedMenu.join('^')
								},
								success: function (res) {
									//console.log(res)
									loadRoleMenu(allMenu,$('#roleCode').val());
									msg('success','菜单分配成功!',2000);
								}
							});
						}
				});
				
				
			}
		</script>
	</body>
</html>
