<csp:content charset="UTF-8">
<SERVER>
s Action=$Get(%request.Data("actiontype",1))
s Start=$Get(%request.Data("start",1))
s Limit=$Get(%request.Data("limit",1))
s Sort=$Get(%request.Data("sort",1))
s Dir=$Get(%request.Data("dir",1))
s User=$G(%session.Data("LOGON.USERID"))
s sLoc=$G(%session.Data("LOGON.CTLOCID"))
s Groupid=$G(%session.Data("LOGON.GROUPID"))
s HOSPID=$G(%session.Data("LOGON.HOSPID"))
i Action = "Save" d
    .s InitId=$Get(%request.Data("Rowid",1))
    .s MainInfo=$Get(%request.Data("MainInfo",1))
    .s ListDetail=$Get(%request.Data("ListDetail",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).Save(InitId,MainInfo,ListDetail)
    .i +ret<=0  d
    ..w "{success:'false',info:'"_ret_"'}"
    .e  d
    ..w "{success:'true',info:'"_ret_"'}"
    
i Action = "Select" d
    .S InitId=$Get(%request.Data("Rowid",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).Select(InitId)    
    .w "{success:'true',info:'"_ret_"'}"
    
i Action = "QueryDetail" d
    .S Parref=$Get(%request.Data("Parref",1))
    .d ##class(web.DHCSTM.DHCINIsTrfItm).jsDHCINIsTrfD(Start,Limit,Parref)

i Action = "QueryDetailHV" d
	.S Parref=$Get(%request.Data("Parref",1))
	.d ##class(web.DHCSTM.Common.JsonObj).getJsonByQuery("web.DHCSTM.DHCINIsTrfItm","DHCINIsTrfDetail",Start,Limit,Parref)

i Action = "Delete" d
    .S Parref=$Get(%request.Data("Rowid",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).Delete(Parref)
    .i +ret'=0  d
    ..w "{success:'false',info:'"_ret_"'}"
    .e  d
    ..w "{success:'true',info:'"_ret_"'}"

i Action = "DeleteDetail" d
    .S Initi=$Get(%request.Data("RowId",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrfItm).Delete(Initi)
    .i +ret'=0  d
    ..w "{success:'false',info:'"_ret_"'}"
    .e  d
    ..w "{success:'true',info:'"_ret_"'}"

i Action = "Query" d
    .s ListParam=$Get(%request.Data("ParamStr",1))
    .d ##class(web.DHCSTM.DHCINIsTrf).jsDHCINIsTrfM(Start,Limit,Sort,Dir,ListParam)

i Action = "MakeComplete" d
    .s InitId=$Get(%request.Data("Rowid",1))
    .s Status=$Get(%request.Data("Status",1))
    .s Complete=$Get(%request.Data("Complete",1))
    .s BCFlag=$Get(%request.Data("BCFlag",1))
    .s GroupId=$Get(%request.Data("GroupId",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).SetCompleted(InitId,Complete,Status,BCFlag,GroupId)
    .i +ret'=0  d
    ..w "{success:'false',info:'"_ret_"'}"
    .e  d
    ..w "{success:'true',info:'"_ret_"'}"

i Action = "Audit" d
    .s Init=$Get(%request.Data("Rowid",1))
    .s UserId=$Get(%request.Data("User",1))
    .s BCFlag=$Get(%request.Data("BCFlag",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).TransOutAuditYes(Init,UserId,BCFlag,Groupid)
    .i +ret=0  d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"

i Action = "AuditNo" d
    .s Init=$Get(%request.Data("Rowid",1))
    .s UserId=$Get(%request.Data("User",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).TransOutAuditNo(Init,UserId)
    .i ret=0  d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"

i Action = "QueryReq" d
    .s ListParam=$Get(%request.Data("ParamStr",1))
    .d ##class(web.DHCSTM.DHCINIsTrf).jsINReqForTransfer(Start,Limit,Sort,Dir,ListParam)
    .
///SelReq.js调用, 显示请求单明细信息
i Action = "GetReqDetail" d
	.s Req=$Get(%request.Data("req",1))
	.s showFlag=$g(%request.Data("TransferedFlag",1))
	.s refuseflag=$g(%request.Data("refuseflag",1))
	.s handletype=$g(%request.Data("handletype",1))
	.s canceled=$g(%request.Data("canceled",1))
	.s ListParam=$g(%request.Data("ListParam",1))
	.d ##class(web.DHCSTM.Common.JsonObj).getJsonByQuery("web.DHCSTM.DHCINIsTrfItm","INReqD",Start,Limit,Req,showFlag,refuseflag,handletype,canceled,HOSPID,ListParam)

i Action = "QueryReqDetail" d
    .s Parref=$Get(%request.Data("Parref",1))
    .d ##class(web.DHCSTM.DHCINIsTrfItm).GetDetailForTransByReq(Parref)

///库存转移单明细,inclb等按照接收科室取值
i Action="InitToLocDetail" d
	.S Parref=$Get(%request.Data("Parref",1))
	.d ##class(web.DHCSTM.Common.JsonObj).getJsonByQuery("web.DHCSTM.DHCINIsTrfItm","InitToLocDetail",Start,Limit,Parref)

i Action = "QueryDetailForTransByLim" d
    .s ParamStr=$Get(%request.Data("ParamStr",1))
    .d ##class(web.DHCSTM.DHCINIsTrfAuxByLim).jsRecLocItmForTransfer(Start,Limit,Sort,Dir,ParamStr,User,sLoc)

i Action = "QueryDetailForTransByConsume" d
    .s ParamStr=$Get(%request.Data("ParamStr",1))
    .d ##class(web.DHCSTM.DHCINIsTrfAuxByConsume).jsRecLocItmForTransfer(Start,Limit,Sort,Dir,ParamStr,User,sLoc)

i Action = "AuditIn" d
    .s Init=$Get(%request.Data("Rowid",1))
    .s UserId=$Get(%request.Data("User",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).TransInAuditYes(Init,UserId)
    .i ret=0  d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"

i Action = "AuditInNo" d
    .s Init=$Get(%request.Data("Rowid",1))
    .s UserId=$Get(%request.Data("User",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).TransInAuditNo(Init,UserId)
    .i ret=0  d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"

i Action = "QueryImport" d
    .s ListParam=$Get(%request.Data("ParamStr",1))
    .d ##class(web.DHCSTM.DHCINIsTrfAuxByRec).QueryImportForTrans(Start,Limit,Sort,Dir,ListParam,User,sLoc)

i Action = "QueryImportDetail" d
    .s Parref=$Get(%request.Data("Parref",1))
    .d ##class(web.DHCSTM.DHCINIsTrfAuxByRec).QueryInportDetailForTrans(Parref)

i Action = "CreateTransferByReq" d
    .S MainInfo=$Get(%request.Data("MainInfo",1))
    .S ReqId=$Get(%request.Data("ReqId",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).CreateTransferByReq(MainInfo,ReqId)
    .i +ret<=0  d
    ..w "{success:'false',info:'"_ret_"'}"
    .e  d
    ..w "{success:'true',info:'"_ret_"'}"   

i Action = "GetParamProp" d
    .s GroupId=$g(%request.Data("GroupId",1))
    .s LocId=$g(%request.Data("LocId",1))
    .s UserId=$g(%request.Data("UserId",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).GetParamProp(GroupId,LocId,UserId)
    .w "{success:'true',info:'"_ret_"'}"

///根据转移单反向制作转移单据(被服管理用到,高值退库)
i Action = "CreateInIsTrf" d
    .s InIt=$g(%request.Data("InIt",1))
    .s ListDetail=$g(%request.Data("ListDetail",1))
    .s UserId=$g(%request.Data("UserId",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).CreateInIsTrf(InIt,ListDetail,UserId)
    .i +ret<=0  d
    ..w "{success:'false',info:'"_ret_"'}"
    .e  d
    ..w "{success:'true',info:'"_ret_"'}"

///返回科室批次信息用于制单
i Action = "QueryInclbDetail" d
    .S StrParam=$Get(%request.Data("StrParam",1))
    .d ##class(web.DHCSTM.Common.JsonObj).getJsonByQuery("web.DHCSTM.DHCINIsTrfItm","QueryInclbDetail",0,"",StrParam)

///库存转移单库房确认
 i Action = "Confirm" d
    .s Init=$Get(%request.Data("Rowid",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).Confirm(Init)
    .i +ret=0  d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"
    
///批量生成出库单子
i Action = "CreateTransferByReqStr" d
    .S MainInfo=$Get(%request.Data("MainInfo",1))
    .S ReqIdStr=$Get(%request.Data("ReqIdStr",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).CreateTransferByReqStr(MainInfo,ReqIdStr,Groupid_"^"_sLoc_"^"_User_"^"_HOSPID)
    .i +ret<=0  d
    ..w "{success:'false',info:'"_ret_"'}"
    .e  d
    ..w "{success:'true',info:'"_ret_"'}"   

///2016-04-14批量生成出库单(高值)
i Action = "CreateTransferByReqStrHV" d
	.S MainInfo=$Get(%request.Data("MainInfo",1))
	.S ReqIdStr=$Get(%request.Data("ReqIdStr",1))
	.s ret=##class(web.DHCSTM.DHCINIsTrf).CreateTransferByReqStrHV(MainInfo,ReqIdStr)
	.i +ret<=0  d
	..w "{success:'false',info:'"_ret_"'}"
	.e  d
	..w "{success:'true',info:'"_ret_"'}"  
	
///返回所有新生成的转移单
 i Action = "QueryTrans" d
    .S InitStr=$Get(%request.Data("InitStr",1))
    .d ##class(web.DHCSTM.DHCINIsTrf).QueryTrans(InitStr)
    
i Action = "AuditStr" d
    .s InitStr=$Get(%request.Data("RowidStr",1))
    .s UserId=$Get(%request.Data("User",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).TransOutAuditYesStr(InitStr,UserId,Groupid)
    .w "{success:'true',info:'"_ret_"'}"
    
i Action = "PrintFlag" d
	.S Rowid=$Get(%request.Data("Rowid",1))
	.s ret=##class(web.DHCSTM.DHCINIsTrf).PrintFlag(Rowid)	
	.w "{success:'true',info:'"_ret_"'}"
	
i Action = "GetInclbByReq" d
    .s strinfo=$Get(%request.Data("strinfo",1))
    .s ret= ##class(web.DHCSTM.DHCINIsTrf).GetInclbByReq(strinfo)
    .w "{success:'true',info:'"_ret_"'}"
    
i Action = "PrintMBPL" d
	.S TrfRowid=$Get(%request.Data("Rowid",1))
	.s HospId=$Get(%request.Data("HospId",1))
	.s UserId=$Get(%request.Data("user",1))
	.s ret=##class(web.DHCSTM.DHCINIsTrf).InserMBPL(TrfRowid,HospId,UserId)	
	.w "{success:'true',info:'"_ret_"'}"

i Action = "CheckHVBarCode" d
    .s Init=$Get(%request.Data("Rowid",1))
    .s UserId=$Get(%request.Data("User",1))
    .s HvBarcode=$Get(%request.Data("HvBarcode",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).CheckHVBarCode(Init,UserId,HvBarcode)
    .i ret=0  d
    ..w "{success:'true',info:'"_ret_"'}"
    .e  d
    ..w "{success:'false',info:'"_ret_"'}"	
i Action = "CreateBarCode" d
    .s initidstr=$Get(%request.Data("initidstr",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).CreateBarCodeStr(initidstr)
    .w "{success:'true',info:'"_ret_"'}"
i Action = "GetinclbByINCLBBarCode" d
    .s Barcode=$Get(%request.Data("Barcode",1))
    .s ret=##class(web.DHCSTM.DHCINIsTrf).GetinclbByINCLBBarCode(Barcode)
    .w "{success:'true',info:'"_ret_"'}"
</SERVER>
