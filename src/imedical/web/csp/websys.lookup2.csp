<!-- Copyright (c) 2010 DHC Software Co.,Ltd. ALL RIGHTS RESERVED. --> 
<csp:method name=OnPreHTTP arguments="" returntype=%Boolean>
 //i ##Class(websys.SessionEvents).SessionExpired()
 i ##Class(websys.SessionEvents).SessionExpired() q 1
 quit 1
</csp:method>
<HTML XMLNS=TRAK>
<HEAD>
<TITLE><TRAK:TRANSLATE id=title>##(%session.Get("TITLE"))##</TRAK:TRANSLATE></TITLE>
<!-- <TRAK:HEAD></TRAK:HEAD> -->
<EXTHEALTH:HEAD></EXTHEALTH:HEAD>

<SERVER>
	//a very nasty hack for a very strange error !
	i $g(%request.Data("WEBSYS.TCOMPONENT",1))["Profile",$g(%request.Data("ID",1))="" {
		k %request.Data("WEBSYS.TCOMPONENT",1)
		w "<SCR","IPT language=javascript>",!
		w "	window.location.reload(true);",!
		w "</SCR","IPT>",!
	}
</SERVER>
<SCRIPT language=javascript>
var FindComponent="#(%request.Get("WEBSYS.TCOMPONENT"))#";
this.focus();
function TR_OnMouseDown(row) {
	if (selectedrow>-1) {
		RowUnHighlight(selectedrow);
	}
	selectedrow=row;
	RowHighlight(selectedrow);
}

function OnKeyDownHandler(e) {
	if (maxrows>-1) {
		var eKey=websys_getKey(e);
		switch (eKey) {
		case 9: //Don't allow to tab off lookup table - therefore select
			//RowSelect(selectedrow);
			//TN:5-Apr-02:as lookup can now have search component(fields) need tabbing
			var eSrc=websys_getSrcElement(e);
			//if (eSrc.tagName!="INPUT") RowSelect(selectedrow);
			if (FindComponent=="") RowSelect(selectedrow);
			break;
		case 13: //Enter select
			//RowSelect(selectedrow);
			//TN:5-Apr-02:as lookup can now have search component(fields) need to determine enter find or enter select
			var eSrc=websys_getSrcElement(e);
			if (eSrc.tagName!="A") RowSelect(selectedrow);
			break;
		case 33: //Page Up
			PrevPage();
			break;
		case 34: //Page Down
			NextPage();
			break;
		case 35: //End
			RowUnHighlight(selectedrow);
			selectedrow=maxrows;
			RowHighlight(selectedrow);
			break;
		case 36: //Home
			RowUnHighlight(selectedrow);
			selectedrow=0;
			RowHighlight(selectedrow);
			break;
		case 38: //Cursor up
			if (selectedrow>0) {
				RowUnHighlight(selectedrow);
				selectedrow-=1;
				RowHighlight(selectedrow);
			}
			break;
		case 40: //Cursor down
			if (selectedrow<maxrows) {
				RowUnHighlight(selectedrow);
				selectedrow+=1;
				RowHighlight(selectedrow);
			}
			break;
		} //switch
		//event.cancelBubble;
	} //maxrow>0
}

function RowHighlight(row) {
	var eTR=document.getElementById('tblLookup').rows[row];
	eTR.className='clsLookUpSelected';
	selectedrow=row;
}
function RowUnHighlight(row) {
	var eTR=document.getElementById('tblLookup').rows[row];
	eTR.className='';
}
function docHandler() {
	//if (FindComponent=="") websys_reSizeT();
	websys_reSizeT();
}
//call resize after body has loaded... see body onload
//window.onload=docHandler;

//function RowSelect is generated by lookup method of cache object
//md 20/03/2003
function PrevPage() { 
	isSelected=1;
	window.location.href="websys.lookup2.csp"; 
} 
function NextPage() { 
	isSelected=1; 
	window.location.href="websys.lookup2.csp"; 
} 
//md 20/03/2003
</SCRIPT>
</HEAD>
<BODY bottomMargin=0 leftMargin=0 rightMargin=0 topMargin=0  CLASS="clsLookUp" onload="docHandler();">
<DIV>
<server>
 ;KM 21-Nov-2001: For addition additional find components to a LookUp.
 i %request.Get("WEBSYS.TCOMPONENT")'="" {
 	s frm=##Class(websys.Component).OpenName(%request.Get("WEBSYS.TCOMPONENT"))
   i frm  {
		//w "<TABLE style=""POSITION: RELATIVE; LEFT: 0px; TOP: 270px""><TR><TD>"
		w "<TABLE><TR><TD>"
		d frm.Show()
		d frm.%Close()
		w "</TABLE>"
	}
 }	
 ;s ^zmeto("component",12)=%request.Get("WEBSYS.TCOMPONENT")	
 n id,compid,comp,name,j,frm
 s id=%request.Get("ID")
 i id="",%request.Get("TFORM")'="" d
 . s id=%request.Get("TFORM") k %request.Data("TFORM")
 . s name=$p(id,"^",2,99)
 . s id=$p(id,"^",1),id=##Class(websys.Component).GetIdFromCodeOrDescription(id)
 . s id="d"_id_"i"_name d %request.Set("ID",id)
 ;
 i id'="" d
 . s compid=$e($p(id,"i",1),2,999)
 . s name=$p(id,"i",2,99)
 . s comp=##Class(websys.Component).%OpenId(compid)
 . i comp d  //find the item which matches (optimise...)
 . . f j=1:1:comp.Items.Count() i comp.Items.GetAt(j).Name=name d comp.Items.GetAt(j).Lookup(%request.Get("TPAGCNT")) q
 . . d comp.%Close()
 ;
 ;
  //s %response.TraceDump=1
</server>
</DIV>
</BODY>
</HTML>
